<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PCMStreamConverter.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.client.sound.system.processors</a> &gt; <span class="el_source">PCMStreamConverter.java</span></div><h1>PCMStreamConverter.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.client.sound.system.processors;

import games.stendhal.client.sound.system.SignalProcessor;
import games.stendhal.common.memory.Field;
import java.io.IOException;
import java.io.InputStream;
import javax.sound.sampled.AudioFormat;

/**
 *
 * @author silvio
 */
<span class="nc bnc" id="L25" title="All 2 branches missed.">public class PCMStreamConverter extends SignalProcessor</span>
{
    private InputStream mInputStream;
    private AudioFormat mAudioFormat;
<span class="nc" id="L29">    private float[]     mOutputBuffer = null;</span>
<span class="nc" id="L30">    private byte[]      mInputBuffer  = null;</span>
    private int         mNumSamplesToBuffer;
    private boolean     mEndOfStream;
    private boolean     mConverterIsOpened;

    public PCMStreamConverter(InputStream stream, AudioFormat format, int outputNumSamplesPerChannel)
<span class="nc" id="L36">    {</span>
<span class="nc" id="L37">        init(stream, format, outputNumSamplesPerChannel);</span>
<span class="nc" id="L38">    }</span>

    public boolean reachedEndOfStream()
    {
<span class="nc" id="L42">        return mEndOfStream;</span>
    }

    public void open(InputStream stream, AudioFormat format, int outputNumSamplesPerChannel)
    {
<span class="nc bnc" id="L47" title="All 2 branches missed.">        if(!mConverterIsOpened)</span>
<span class="nc" id="L48">            init(stream, format, outputNumSamplesPerChannel);</span>
<span class="nc" id="L49">    }</span>

    public void close()
    {
<span class="nc" id="L53">        mEndOfStream       = true;</span>
<span class="nc" id="L54">        mConverterIsOpened = false;</span>

<span class="nc bnc" id="L56" title="All 2 branches missed.">		if(mInputStream != null)</span>
		{
			try
			{
<span class="nc" id="L60">				 mInputStream.close();</span>
			}
<span class="nc" id="L62">			catch(IOException exception)</span>
			{
<span class="nc bnc" id="L64" title="All 2 branches missed.">				assert false: exception.toString();</span>
<span class="nc" id="L65">			}</span>

<span class="nc" id="L67">			mInputStream = null;</span>
		}
<span class="nc" id="L69">    }</span>

    private void init(InputStream stream, AudioFormat format, int outputNumSamplesPerChannel)
    {
<span class="nc bnc" id="L73" title="All 6 branches missed.">        assert stream != null &amp;&amp; format != null;</span>
<span class="nc bnc" id="L74" title="All 4 branches missed.">        assert outputNumSamplesPerChannel &gt; 0:          &quot;given buffer size too small&quot;;</span>
<span class="nc bnc" id="L75" title="All 4 branches missed.">        assert (format.getSampleSizeInBits() % 8) == 0: &quot;invalid sample size&quot;;</span>
<span class="nc bnc" id="L76" title="All 4 branches missed.">        assert !format.isBigEndian():                   &quot;cannot convert fom big-endian TO little-endian (not implemented jet)&quot;;</span>

<span class="nc" id="L78">        int outputBufferSize = outputNumSamplesPerChannel * format.getChannels();</span>
<span class="nc" id="L79">        int inputBufferSize  = outputNumSamplesPerChannel * format.getFrameSize();</span>

<span class="nc" id="L81">		mInputBuffer        = Field.expand(mInputBuffer , inputBufferSize , false);</span>
<span class="nc" id="L82">		mOutputBuffer       = Field.expand(mOutputBuffer, outputBufferSize, false);</span>
<span class="nc" id="L83">        mInputStream        = stream;</span>
<span class="nc" id="L84">        mAudioFormat        = format;</span>
<span class="nc" id="L85">        mNumSamplesToBuffer = outputNumSamplesPerChannel;</span>
<span class="nc" id="L86">        mEndOfStream        = false;</span>
<span class="nc" id="L87">        mConverterIsOpened  = true;</span>
<span class="nc" id="L88">    }</span>

    private void convertToUniformPCM(int numSamplesToConvert)
    {
<span class="nc" id="L92">        int  numBytesPerSample = mAudioFormat.getSampleSizeInBits() / 8;</span>
<span class="nc" id="L93">        int  numChannels       = mAudioFormat.getChannels();</span>
<span class="nc" id="L94">        int  numBytesPerFrame  = mAudioFormat.getFrameSize();</span>
<span class="nc" id="L95">        long maxValue          = (long)(Math.pow(2, mAudioFormat.getSampleSizeInBits()));</span>
<span class="nc" id="L96">        long maxValueHalf      = maxValue / 2;</span>

<span class="nc bnc" id="L98" title="All 2 branches missed.">        if((numChannels * numBytesPerSample) == numBytesPerFrame)</span>
        {
<span class="nc bnc" id="L100" title="All 2 branches missed.">            for(int i=0; i&lt;(numSamplesToConvert * numChannels); ++i)</span>
            {
<span class="nc" id="L102">                int  index = i * numBytesPerSample;</span>
<span class="nc" id="L103">                long value  = 0;</span>

<span class="nc bnc" id="L105" title="All 2 branches missed.">                for(int b=0; b&lt;numBytesPerSample; ++b)</span>
<span class="nc" id="L106">                    value |= (mInputBuffer[index + b] &amp; 0x00000000000000FF) &lt;&lt; (b * 8);</span>
                
<span class="nc bnc" id="L108" title="All 2 branches missed.">                if(value &gt;= maxValueHalf)</span>
<span class="nc" id="L109">                    value -= maxValue;</span>
                
<span class="nc" id="L111">                mOutputBuffer[i] = ((float)value / (float)maxValueHalf);</span>
            }
        }
        else
        {
<span class="nc bnc" id="L116" title="All 2 branches missed.">            for(int i=0; i&lt;numSamplesToConvert; ++i)</span>
            {
<span class="nc" id="L118">                int index = i * numChannels;</span>
<span class="nc" id="L119">                int frame = i * numBytesPerFrame;</span>

<span class="nc bnc" id="L121" title="All 2 branches missed.">                for(int c=0; c&lt;numChannels; ++c)</span>
                {
<span class="nc" id="L123">                    long value = 0;</span>

<span class="nc bnc" id="L125" title="All 2 branches missed.">                    for(int b=0; b&lt;numBytesPerSample; ++b)</span>
<span class="nc" id="L126">                        value |= (mInputBuffer[frame + b] &amp; 0x00000000000000FF) &lt;&lt; (b * 8);</span>

<span class="nc bnc" id="L128" title="All 2 branches missed.">                    if(value &gt;= maxValueHalf)</span>
<span class="nc" id="L129">                        value -= maxValue;</span>
                    
<span class="nc" id="L131">                    mOutputBuffer[index + c] = (float)value / (float)maxValueHalf;</span>
<span class="nc" id="L132">                    frame                   += numBytesPerSample;</span>
                }
            }
        }
<span class="nc" id="L136">    }</span>

    @Override
    protected boolean generate()
    {
<span class="nc bnc" id="L141" title="All 2 branches missed.">        if(reachedEndOfStream())</span>
        {
<span class="nc" id="L143">            super.quit();</span>
<span class="nc" id="L144">            return false;</span>
        }
        
        try
        {
<span class="nc" id="L149">            int numBytesToRead      = mNumSamplesToBuffer * mAudioFormat.getFrameSize();</span>
<span class="nc" id="L150">            int numBytesRead        = mInputStream.read(mInputBuffer, 0, numBytesToRead);</span>
<span class="nc" id="L151">            int numSamplesToConvert = numBytesRead / mAudioFormat.getFrameSize();</span>

<span class="nc" id="L153">            convertToUniformPCM(numSamplesToConvert);</span>
<span class="nc" id="L154">            super.propagate(mOutputBuffer, numSamplesToConvert, mAudioFormat.getChannels(), (int)mAudioFormat.getSampleRate());</span>

<span class="nc bnc" id="L156" title="All 2 branches missed.">            if(numBytesRead &lt; numBytesToRead)</span>
<span class="nc" id="L157">                close();</span>
        }
<span class="nc" id="L159">        catch(IOException exception)</span>
        {
<span class="nc" id="L161">            close();</span>
<span class="nc" id="L162">        }</span>

<span class="nc" id="L164">        return true;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>