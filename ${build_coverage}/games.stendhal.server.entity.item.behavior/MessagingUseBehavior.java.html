<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MessagingUseBehavior.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.entity.item.behavior</a> &gt; <span class="el_source">MessagingUseBehavior.java</span></div><h1>MessagingUseBehavior.java</h1><pre class="source lang-java linenums"> /**************************************************************************
 *                 (C) Copyright 2003-2013 - Stendhal team                 *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.entity.item.behavior;

import games.stendhal.common.grammar.Grammar;
import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.entity.Entity;
import games.stendhal.server.entity.RPEntity;
import games.stendhal.server.entity.item.Item;
import games.stendhal.server.entity.npc.NPC;
import games.stendhal.server.entity.player.Player;

import java.util.Map;

import marauroa.common.game.RPObject;

import org.apache.log4j.Logger;

/**
 * A UseBehavior that can a public and private messages.
 */
public class MessagingUseBehavior implements UseBehavior {
<span class="fc" id="L32">	private static final Logger LOGGER = Logger.getLogger(MessagingUseBehavior.class);</span>
	
	private final String publicMessage;
	private final String privateMessage;
	
	/**
	 * Create a new MessagingUseBehavior with specified public and private
	 * messages. Either of those can be &lt;code&gt;null&lt;/code&gt;, but a warning is
	 * logged if neither is specified.
	 * 
	 * @param publicMessage message send as public text
	 * @param privateMessage message sent only to the using player
	 */
<span class="fc" id="L45">	private MessagingUseBehavior(String publicMessage, String privateMessage) {</span>
<span class="fc" id="L46">		this.publicMessage = publicMessage;</span>
<span class="fc" id="L47">		this.privateMessage = privateMessage;</span>
<span class="pc bpc" id="L48" title="1 of 4 branches missed.">		if ((publicMessage == null) &amp;&amp; (privateMessage == null)) {</span>
<span class="nc" id="L49">			LOGGER.warn(&quot;MessagingUseBehavior with no messages&quot;);</span>
		}
<span class="fc" id="L51">	}</span>
	
	/**
	 * Create a new MessagingUseBehavior. This constructor is meant for the
	 * item XML loader.
	 * 
	 * @param params map of parameters. The values of &quot;public&quot; and &quot;private&quot;
	 * 	should contain the wanted public and private messages respectively
	 */
	public MessagingUseBehavior(Map&lt;String, String&gt; params) {
<span class="fc" id="L61">		this(params.get(&quot;public&quot;), params.get(&quot;private&quot;));</span>
<span class="fc" id="L62">	}</span>

	@Override
	public boolean use(RPEntity user, Item item) {
<span class="fc" id="L66">		RPObject base = item.getBaseContainer();</span>

<span class="pc bpc" id="L68" title="1 of 4 branches missed.">		if ((base instanceof Entity) &amp;&amp; user.nextTo((Entity) base)) {</span>
<span class="fc" id="L69">			sendMessages(user);</span>
<span class="fc" id="L70">			return true;</span>
		}
<span class="fc" id="L72">		int amount = item.getQuantity();</span>
<span class="fc" id="L73">		sendPrivateMessage(user, Grammar.ThatThose(amount) + &quot; &quot;</span>
				+ Grammar.plnoun(amount, item.getName()) + &quot; &quot;
				+ Grammar.isare(amount) + &quot; too far away.&quot;);

<span class="fc" id="L77">		return false;</span>
	}
	
	/**
	 * Send the messages.
	 * 
	 * @param user entity using the item
	 */
	private void sendMessages(RPEntity user) {
<span class="fc bfc" id="L86" title="All 2 branches covered.">		if (publicMessage != null) {</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">			if (user instanceof Player) {</span>
<span class="fc" id="L88">				Player player = (Player) user;</span>
<span class="fc" id="L89">				player.put(&quot;text&quot;, publicMessage);</span>
<span class="fc" id="L90">				SingletonRepository.getRuleProcessor().removePlayerText(player);</span>
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">			} else if (user instanceof NPC) {</span>
<span class="fc" id="L92">				((NPC) user).say(publicMessage);</span>
			}
		}
<span class="fc bfc" id="L95" title="All 2 branches covered.">		if (privateMessage != null) {</span>
<span class="fc" id="L96">			sendPrivateMessage(user, privateMessage);</span>
		}
<span class="fc" id="L98">		user.notifyWorldAboutChanges();</span>
<span class="fc" id="L99">	}</span>
	
	/**
	 * Send the private message. This is only sent if the recipient is a player.
	 * 
	 * @param user using entity
	 * @param message message text
	 */
	private void sendPrivateMessage(RPEntity user, String message) {
<span class="fc bfc" id="L108" title="All 2 branches covered.">		if (user instanceof Player) {</span>
<span class="fc" id="L109">			Player player = (Player) user;</span>
<span class="fc" id="L110">			player.sendPrivateText(message);</span>
		}
<span class="fc" id="L112">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>