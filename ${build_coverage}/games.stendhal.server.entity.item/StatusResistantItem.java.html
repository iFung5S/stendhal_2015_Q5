<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>StatusResistantItem.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.entity.item</a> &gt; <span class="el_source">StatusResistantItem.java</span></div><h1>StatusResistantItem.java</h1><pre class="source lang-java linenums">package games.stendhal.server.entity.item;

import games.stendhal.common.constants.Testing;
import games.stendhal.server.entity.RPEntity;
import games.stendhal.server.entity.status.StatusResistancesList;
import games.stendhal.server.entity.status.StatusType;

import java.util.Map;
import java.util.Map.Entry;

import marauroa.common.game.RPSlot;
import marauroa.common.game.SlotOwner;

import org.apache.log4j.Logger;

/**
 * An item that is resistant to status attacks when equipped.
 * 
 * @author AntumDeluge
 */
public class StatusResistantItem extends SlotActivatedItem {
	
	/** The logger instance */
<span class="fc" id="L24">	final Logger logger = Logger.getLogger(StatusResistantItem.class);</span>
	
	/** List of status types that this item is resistant to. */
	private StatusResistancesList resistances;
	
	
/* XXX --- CONSTRUCTORS --- XXX */
	
	/**
	 * Default constructor.
	 * 
	 * @param name
	 * 		Item's name
	 * @param clazz
	 * 		Item's class or type
	 * @param subclass
	 * 		Item's subclass
	 * @param attributes
	 * 		Attributes available to this item
	 */
	public StatusResistantItem(String name, String clazz, String subclass,
			Map&lt;String, String&gt; attributes) {
<span class="fc" id="L46">		super(name, clazz, subclass, attributes);</span>
		
		/* FIXME: Resistance should be adjusted for equipping entity if item
		 * is constructed in active slot.
		 *
		 * FIXME: If item is destroyed while in active slot resistance is not
		 * adjusted.
		 */
		
		/* Initialize resistances. */
<span class="fc" id="L56">		this.resistances = new StatusResistancesList();</span>
<span class="fc" id="L57">	}</span>
	
	/**
	 * Copy constructor.
	 * 
	 * @param item
	 * 		Item to copy
	 */
	public StatusResistantItem(final StatusResistantItem item) {
<span class="fc" id="L66">		super(item);</span>
<span class="fc" id="L67">		initializeStatusResistancesList(item.resistances.getMap());</span>
<span class="fc" id="L68">	}</span>
	
	
/* XXX --- ITEM INITIALIZATION --- XXX */
	
	/**
	 * Create or reset resistances to status types for this item.
	 * 
	 * @param list
	 * 		Status types and resistant values
	 */
	@Override
	public void initializeStatusResistancesList(final Map&lt;StatusType, Double&gt; list) {
		/* FIXME: Here is where constructed item should checked if equipped
		 * in active slot.
		 */
		
<span class="fc bfc" id="L85" title="All 2 branches covered.">		if (this.resistances == null) {</span>
<span class="fc" id="L86">			this.resistances = new StatusResistancesList();</span>
		}
		
<span class="fc" id="L89">		this.resistances.setStatusResistances(list);</span>
		
		/* Slot that the item is initialized/created in. */
<span class="fc" id="L92">		final RPSlot slotObject = this.getContainerSlot();</span>
		final String slot;
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">		if (slotObject != null) {</span>
<span class="nc" id="L95">			slot = slotObject.getName();</span>
			
<span class="nc bnc" id="L97" title="All 4 branches missed.">			if (logger.isDebugEnabled() || Testing.DEBUG) {</span>
<span class="nc" id="L98">				logger.info(this.getName() + &quot; initialized in \&quot;&quot; + slot + &quot;\&quot;&quot;);</span>
			}
		}
		
<span class="pc bpc" id="L102" title="2 of 4 branches missed.">		if (logger.isDebugEnabled() || Testing.DEBUG){</span>
<span class="nc" id="L103">			logger.info(&quot;StatusResistantItem: Initializing status resistances list&quot;);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">			if (this.resistances == null) {</span>
<span class="nc" id="L105">				logger.error(&quot;Could not initialize status resistances list&quot;);</span>
			}
		}
<span class="fc" id="L108">	}</span>
	
	/**
	 * Create or reset resistances to status types for this item.
	 * 
	 * @param list
	 * 		Status types and resistant values
	 */
	public void initializeStatusResistancesList(final StatusResistancesList list) {
<span class="nc" id="L117">		this.resistances = list;</span>
		
<span class="nc bnc" id="L119" title="All 4 branches missed.">		if (logger.isDebugEnabled() || Testing.DEBUG) {</span>
<span class="nc" id="L120">			logger.info(&quot;StatusResistantItem: Initializing status resistances&quot;);</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">			if (this.resistances == null) {</span>
<span class="nc" id="L122">				logger.error(&quot;Could not initialize status resistances list&quot;);</span>
			}
		}
<span class="nc" id="L125">	}</span>
	
	
/* XXX --- ITEM MANIPULATION --- XXX */
	
	/**
	 * Applies or removes a status resistance value for the owning entity.
	 * 
	 * @param statusType
	 * 		The resisted status effect
	 * @param apply
	 * 		Applies resistance for &lt;b&gt;true&lt;/b&gt;, removes for false
	 * @return
	 * 		Resistance value was successfully adjusted
	 */
	private boolean adjustOwnerStatusResistance(final StatusType statusType,
			final boolean apply) {
		
<span class="nc" id="L143">		SlotOwner slotOwner = this.getContainerBaseOwner();</span>
		
		/* XXX: Is there any usefulness in casting to RPEntity? Would it be
		 *      better to simply only allow resistances for Player?
		 */
<span class="nc bnc" id="L148" title="All 2 branches missed.">		if (slotOwner instanceof RPEntity) {</span>
<span class="nc" id="L149">			RPEntity owner = (RPEntity)slotOwner;</span>
			
<span class="nc" id="L151">			final String statusName = statusType.getName().toLowerCase();</span>
<span class="nc" id="L152">			final String resistAttribute = &quot;resist_&quot;</span>
					+ statusName;
			final double currentResistance;
<span class="nc" id="L155">			double newResistance = this.getStatusResistanceValue(statusType);</span>
			
<span class="nc bnc" id="L157" title="All 2 branches missed.">			if (!apply) {</span>
				/* Invert the new resistance value for removal instead of
				 * application.
				 */
<span class="nc" id="L161">				newResistance *= -1;</span>
			}
			
			/* Apply current resistance value if applicable. */
<span class="nc bnc" id="L165" title="All 2 branches missed.">			if (owner.has(resistAttribute)) {</span>
<span class="nc" id="L166">				currentResistance = owner.getDouble(resistAttribute);</span>
				
				/* If for some reason the owner already has the resistance
				 * attribute is 0 or less when trying to remove it.
				 */
<span class="nc bnc" id="L171" title="All 4 branches missed.">				if (!apply &amp;&amp; currentResistance &lt;= 0.0) {</span>
					/* Remove the residual attribute. */
<span class="nc" id="L173">					owner.remove(resistAttribute);</span>
<span class="nc" id="L174">					return false;</span>
				}
				
<span class="nc" id="L177">				newResistance += currentResistance;</span>
			}
			
			/* Safeguarding. Entity cannot be more than 100% resistant. Do not
			 * need to worry about less than zero because resistance will be
			 * removed in such case.
			 * 
			 * FIXME: Removing items will subtract from effective resistance
			 *        even when potential resistance is greater than 1.0.
			 *        Should implement separate variables for effective and
			 *        potential resistance. Will probably need to be calculated
			 *        from owning entity.
			 */
<span class="nc bnc" id="L190" title="All 2 branches missed.">			if (newResistance &gt; 1.0) {</span>
<span class="nc" id="L191">				newResistance = 1.0;</span>
			}
			
			/* Remove reference if entity is no longer resistant. This can be
			 * changed to allow a less than 0 value for items that cause a
			 * weakness to status effects.
			 */
<span class="nc bnc" id="L198" title="All 2 branches missed.">			if (newResistance &lt;= 0.0) {</span>
<span class="nc" id="L199">				owner.remove(resistAttribute);</span>
				
<span class="nc bnc" id="L201" title="All 4 branches missed.">				if (logger.isDebugEnabled() || Testing.DEBUG) {</span>
<span class="nc" id="L202">					logger.info(owner.getName() + &quot; new &quot;</span>
							+ statusName + &quot; resistance: 0.0&quot;);
				}
				
<span class="nc" id="L206">				return true;</span>
			} else {
<span class="nc" id="L208">				owner.put(resistAttribute, newResistance);</span>
				
<span class="nc bnc" id="L210" title="All 4 branches missed.">				if (logger.isDebugEnabled() || Testing.DEBUG) {</span>
<span class="nc" id="L211">					logger.info(owner.getName() + &quot; new &quot;</span>
							+ statusName + &quot; resistance: &quot;
							+ Double.toString(newResistance));
				}
				
<span class="nc" id="L216">				return true;</span>
			}
		}
		
<span class="nc" id="L220">		return false;</span>
	}
	
	
/* XXX --- ITEM ACTIVATION --- XXX */
	
	/**
	 * Actions to take when activated. Super class sets activationState by
	 * calling this method via onEquipped().
	 * 
	 * @return
	 * 		Item activation state
	 */
	@Override
	protected boolean onActivate() {
<span class="nc" id="L235">		boolean active = this.isActivated();</span>

<span class="nc bnc" id="L237" title="All 2 branches missed.">		if (active) {</span>
			/* If the item is already activated do not change the state or
			 * attributes. Active item state = true.
			 */
<span class="nc" id="L241">			return active;</span>
		}
		
		StatusType statusType;
<span class="nc bnc" id="L245" title="All 4 branches missed.">		if ((resistances != null) &amp;&amp; !resistances.isEmpty()) {</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">			for (Entry&lt;StatusType, Double&gt; entry : resistances.getMap().entrySet()) {</span>
<span class="nc" id="L247">				statusType = entry.getKey();</span>
				
				/* Attempt to adjust the entity's resistance. Should return
				 * &quot;true&quot; to show that attribute has been applied to owning
				 * entity.
				 */
<span class="nc" id="L253">				active = this.adjustOwnerStatusResistance(statusType, true);</span>
				
<span class="nc bnc" id="L255" title="All 2 branches missed.">				if (!active) {</span>
					/* FIXME: Should revert any previous adjustments and
					 * return &quot;active&quot; state.
					 */
					
<span class="nc" id="L260">					logger.warn(&quot;Failed application of status resistance \&quot;&quot;</span>
							+ statusType.getName() + &quot;\&quot;&quot;);
				}
<span class="nc" id="L263">			}</span>
		} else {
<span class="nc" id="L265">			logger.warn(&quot;Status resistance list is empty&quot;);</span>
		}
		
<span class="nc" id="L268">		return active;</span>
	}
	
	/**
	 * Actions to take when deactivated. Super class sets activationState by
	 * calling this method via onUnequipped().
	 * 
	 * @return
	 * 		Deactivated
	 */
	@Override
	protected boolean onDeactivate() {
<span class="nc" id="L280">		boolean active = this.isActivated();</span>

<span class="nc bnc" id="L282" title="All 2 branches missed.">		if (!active) {</span>
			/* If the item is already inactive do not change the state or
			 * attributes. Inactive item state = false.
			 */
<span class="nc" id="L286">			return active;</span>
		}
		
		StatusType statusType;
<span class="nc bnc" id="L290" title="All 4 branches missed.">		if ((resistances != null) &amp;&amp; !resistances.isEmpty()) {</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">			for (Entry&lt;StatusType, Double&gt; entry : resistances.getMap().entrySet()) {</span>
<span class="nc" id="L292">				statusType = entry.getKey();</span>
				
				/* Attempt to adjust the entity's resistance. Should get
				 * &quot;false&quot; value confirming that attribute has been removed
				 * from owning entity.
				 */
<span class="nc bnc" id="L298" title="All 2 branches missed.">				active = !adjustOwnerStatusResistance(statusType, false);</span>
				
<span class="nc bnc" id="L300" title="All 2 branches missed.">				if (active) {</span>
					/* FIXME: Should revert any previous adjustments and
					 * return &quot;active&quot; state.
					 */
					
<span class="nc" id="L305">					logger.warn(&quot;Failed removal of status resistance \&quot;&quot;</span>
							+ statusType.getName() + &quot;\&quot;&quot;);
				}
<span class="nc" id="L308">			}</span>
		} else {
<span class="nc" id="L310">			logger.warn(&quot;Status resistance list is empty&quot;);</span>
		}
		
<span class="nc" id="L313">		return active;</span>
	}
	
/* XXX --- ITEM INFORMATION --- XXX */
	
	/**
	 * Add resistance values to description.
	 */
	@Override
	public String describe() {
<span class="nc" id="L323">		String description = super.describe();</span>
<span class="nc" id="L324">		StringBuilder res = new StringBuilder();</span>
		
		/* Add statuses resistance stats to description. */
<span class="nc bnc" id="L327" title="All 2 branches missed.">		if (this.resistances == null) {</span>
<span class="nc" id="L328">			return description;</span>
		}
<span class="nc" id="L330">		Map&lt;StatusType, Double&gt; resistances = this.resistances.getMap();</span>
<span class="nc bnc" id="L331" title="All 4 branches missed.">		if ((resistances != null) &amp;&amp; !resistances.isEmpty()) {</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">			for (Entry&lt;StatusType, Double&gt; entry : resistances.entrySet()) {</span>
<span class="nc" id="L333">				String statusType = entry.getKey().toString().toLowerCase();</span>
				
				/* Special treatment for status names ending in &quot;ed&quot; where
				 * only &quot;d&quot; should be removed. 
				 */
<span class="nc bnc" id="L338" title="All 2 branches missed.">				if (statusType.equals(&quot;confused&quot;)) {</span>
<span class="nc" id="L339">					statusType = &quot;confuse&quot;;</span>
				}
				
				/* Remove &quot;ed&quot; suffix from status name. */
<span class="nc" id="L343">				final int nameLength = statusType.length();</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">				if (statusType.substring(nameLength - 2).equals(&quot;ed&quot;)) {</span>
<span class="nc" id="L345">					statusType = statusType.substring(0, nameLength - 2);</span>
				}
<span class="nc" id="L347">				statusType = statusType.substring(0, 1).toUpperCase() +</span>
						statusType.substring(1);
<span class="nc" id="L349">				res.append(&quot; &quot;);</span>
<span class="nc" id="L350">				res.append(statusType);</span>
<span class="nc" id="L351">				res.append(&quot; resist: &quot;);</span>
<span class="nc" id="L352">				res.append(Math.round(100 * entry.getValue()));</span>
<span class="nc" id="L353">				res.append(&quot;%&quot;);</span>
<span class="nc" id="L354">			}</span>
		}
		
<span class="nc bnc" id="L357" title="All 2 branches missed.">		if (res.length() &gt; 0) {</span>
<span class="nc" id="L358">			description = description + &quot; Resistances (&quot; + res.toString().trim() + &quot;).&quot;;</span>
		}
		
<span class="nc" id="L361">		return description;</span>
	}
	
	/**
	 * Get the item's ability to resist a status attack.
	 * 
	 * @param type
	 * 		The type of status to be resisted
	 * @return
	 * 		The resistance value
	 */
	public double getStatusResistanceValue(StatusType type) {
<span class="nc" id="L373">		Double resistValue = resistances.getStatusResistance(type);</span>
<span class="nc bnc" id="L374" title="All 2 branches missed.">		if (resistValue == null) {</span>
<span class="nc" id="L375">			return 0.0;</span>
		}
		
<span class="nc" id="L378">		return resistValue.doubleValue();</span>
	}
	
	/**
	 * Gets all status types and resistance values for this item.
	 * 
	 * @return
	 * 		List containing types and resistance values
	 */
	public StatusResistancesList getStatusResistancesList() {
<span class="nc" id="L388">		return this.resistances;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>