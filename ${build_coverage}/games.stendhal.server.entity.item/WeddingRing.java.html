<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WeddingRing.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.entity.item</a> &gt; <span class="el_source">WeddingRing.java</span></div><h1>WeddingRing.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                      (C) Copyright 2003 - Marauroa                      *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.entity.item;

import games.stendhal.common.Direction;
import games.stendhal.common.NotificationType;
import games.stendhal.server.core.engine.ItemLogger;
import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.core.engine.StendhalRPZone;
import games.stendhal.server.core.events.TeleportNotifier;
import games.stendhal.server.entity.Entity;
import games.stendhal.server.entity.RPEntity;
import games.stendhal.server.entity.player.Player;
import games.stendhal.server.util.TimeUtil;

import java.util.Map;

import marauroa.common.game.RPObject;
import marauroa.common.game.RPSlot;
import marauroa.common.game.SlotOwner;

import org.apache.log4j.Logger;

/**
 * A special ring that allows the owner to teleport to his or her spouse. The
 * spouse's name is engraved into the ring. Technically, the name is stored in
 * the item's infostring.
 * 
 * Wedding rings should always be bound to the owner.
 * 
 * @author daniel
 */
public class WeddingRing extends Item {
	/** The cooling period of players of same level in seconds */ 
	private static final long MIN_COOLING_PERIOD = 5 * 60;
	
	private static final String LAST_USE = &quot;amount&quot;;

<span class="fc" id="L49">	private static final Logger logger = Logger.getLogger(WeddingRing.class);</span>

	/**
	 * Creates a new wedding ring.
	 * 
	 * @param name
	 * @param clazz
	 * @param subclass
	 * @param attributes
	 */
	public WeddingRing(final String name, final String clazz, final String subclass,
			final Map&lt;String, String&gt; attributes) {
<span class="fc" id="L61">		super(name, clazz, subclass, attributes);</span>
<span class="fc" id="L62">		setPersistent(true);</span>
<span class="fc" id="L63">	}</span>

	/**
	 * Copy constructor.
	 * 
	 * @param item
	 *            item to copy
	 */
	public WeddingRing(final WeddingRing item) {
<span class="fc" id="L72">		super(item);</span>
<span class="fc" id="L73">	}</span>

	@Override
	public boolean onUsed(final RPEntity user) {
<span class="fc" id="L77">		RPObject base = getBaseContainer();</span>

<span class="pc bpc" id="L79" title="2 of 4 branches missed.">		if ((user instanceof Player) &amp;&amp; user.nextTo((Entity) base)) {</span>
<span class="fc" id="L80">			return teleportToSpouse((Player) user);</span>
		}
<span class="nc" id="L82">		return false;</span>
	}
	
	/**
	 * Get the last use time in seconds
	 * @return last use time
	 */
	private int getLastUsed() {
<span class="fc bfc" id="L90" title="All 2 branches covered.">		if (has(LAST_USE)) {</span>
<span class="fc" id="L91">			return getInt(LAST_USE);</span>
		} else {
<span class="fc" id="L93">			return -1;</span>
		}
	}
	
	/**
	 * Store current system time as the last used
	 */
	private void storeLastUsed() {
<span class="fc" id="L101">		put(LAST_USE, (int) (System.currentTimeMillis() / 1000));</span>
<span class="fc" id="L102">	}</span>
	
	/**
	 * Get the required cooling period for wedding ring use between players
	 * @param player1 either player using the ring or the spouse 
	 * @param player2 either player using the ring or the spouse
	 * @return Required cooling time
	 */
	private int getCoolingPeriod(final Player player1, final Player player2) {
<span class="fc" id="L111">		final int level1 = player1.getLevel();</span>
<span class="fc" id="L112">		final int level2 = player2.getLevel();</span>
<span class="fc" id="L113">		final double levelRatio = (Math.max(level1, level2) + 1.0) / (Math.min(level1, level2) + 1.0);</span>
		
<span class="fc" id="L115">		return (int) (MIN_COOLING_PERIOD * levelRatio * levelRatio);</span>
	}

	/**
	 * Teleports the given player to his/her spouse, but only if the spouse is
	 * also wearing the wedding ring.
	 * 
	 * @param player
	 *            The ring's owner.
	 * @return &lt;code&gt;true&lt;/code&gt; if the teleport was successful, otherwise
	 * 	&lt;code&gt;false&lt;/code&gt;
	 */
	private boolean teleportToSpouse(final Player player) {
		// check if pets and sheep are near
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">		if (!player.isZoneChangeAllowed()) {</span>
<span class="nc" id="L130">			player.sendPrivateText(&quot;You were told to watch your pet, weren't you?&quot;);</span>
<span class="nc" id="L131">			return false;</span>
		}

<span class="fc" id="L134">		final String spouseName = getInfoString();</span>

<span class="fc bfc" id="L136" title="All 2 branches covered.">		if (spouseName == null) {</span>
<span class="fc" id="L137">			player.sendPrivateText(&quot;This wedding ring hasn't been engraved yet.&quot;);</span>
<span class="fc" id="L138">			logger.debug(player.getName()</span>
					+ &quot;tried to use a wedding ring without a spouse name engraving.&quot;);
<span class="fc" id="L140">			return false;</span>
		}

<span class="fc" id="L143">		final Player spouse = SingletonRepository.getRuleProcessor().getPlayer(spouseName);</span>
<span class="fc bfc" id="L144" title="All 2 branches covered.">		if (spouse == null) {</span>
<span class="fc" id="L145">			player.sendPrivateText(spouseName + &quot; is not online.&quot;);</span>
<span class="fc" id="L146">			return false;</span>
		}

<span class="fc bfc" id="L149" title="All 2 branches covered.">		if (spouse.isEquipped(&quot;wedding ring&quot;)) { </span>
			// spouse is equipped with ring but could be divorced and
			// have another

<span class="fc" id="L153">			final Item weddingRing = spouse.getFirstEquipped(&quot;wedding ring&quot;);</span>

<span class="fc bfc" id="L155" title="All 2 branches covered.">			if (weddingRing.getInfoString() == null) { </span>
				// divorced with ring and engaged again
<span class="fc" id="L157">				player.sendPrivateText(&quot;Sorry, &quot;</span>
						+ spouseName
						+ &quot; has divorced you and is now engaged to someone else.&quot;);
<span class="fc" id="L160">				return false;</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">			} else if (!(weddingRing.getInfoString().equals(player.getName()))) { </span>
				// divorced and remarried
<span class="fc" id="L163">				player.sendPrivateText(&quot;Sorry, &quot; + spouseName</span>
						+ &quot; has divorced you and is now remarried.&quot;);

<span class="fc" id="L166">				return false;</span>
			}

<span class="fc" id="L169">		} else {</span>
			// This means trouble ;)
<span class="fc" id="L171">			player.sendPrivateText(spouseName</span>
					+ &quot; is not wearing the wedding ring.&quot;);
<span class="fc" id="L173">			return false;</span>
		}

<span class="fc" id="L176">		final int secondsNeeded = getLastUsed() + getCoolingPeriod(player, spouse) - (int) (System.currentTimeMillis() / 1000);</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">		if (secondsNeeded &gt; 0) {</span>
<span class="fc" id="L178">			player.sendPrivateText(&quot;The ring has not yet regained its power. You think it might be ready in &quot; </span>
					+ TimeUtil.approxTimeUntil(secondsNeeded) + &quot;.&quot;);
			
<span class="fc" id="L181">			return false;</span>
		}

<span class="fc" id="L184">		final StendhalRPZone sourceZone = player.getZone();</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">		if (!sourceZone.isTeleportOutAllowed(player.getX(), player.getY())) {</span>
<span class="fc" id="L186">			player.sendPrivateText(&quot;The strong anti magic aura in this area prevents the wedding ring from working!&quot;);</span>
<span class="fc" id="L187">			return false;</span>
		}

<span class="fc" id="L190">		final StendhalRPZone destinationZone = spouse.getZone();</span>
<span class="fc" id="L191">		final int x = spouse.getX();</span>
<span class="fc" id="L192">		final int y = spouse.getY();</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">		if (!destinationZone.isTeleportInAllowed(x, y)) {</span>
<span class="fc" id="L194">			player.sendPrivateText(&quot;The strong anti magic aura in the destination area prevents the wedding ring from working!&quot;);</span>
<span class="fc" id="L195">			return false;</span>
		}

<span class="fc" id="L198">		final String zoneName =  destinationZone.getName();</span>
		// check if player has visited zone before
<span class="fc bfc" id="L200" title="All 2 branches covered.">		if (player.getKeyedSlot(&quot;!visited&quot;, zoneName) == null) {</span>
<span class="fc" id="L201">			player.sendPrivateText(&quot;Although you have heard a lot of rumors about the destination, &quot;</span>
								+ &quot;you cannot join &quot; + spouseName + &quot; there because it is still an unknown place for you.&quot;);
<span class="fc" id="L203">			return false;</span>
		}

<span class="fc" id="L206">		final Direction dir = spouse.getDirection();</span>

<span class="pc bpc" id="L208" title="1 of 2 branches missed.">		if (player.teleport(destinationZone, x, y, dir, player)) {</span>
<span class="fc" id="L209">			TeleportNotifier.get().notify(player, true);</span>
<span class="fc" id="L210">			storeLastUsed();</span>
<span class="fc" id="L211">			return true;</span>
		}
		
<span class="nc" id="L214">		return false;</span>
	}

	@Override
	public String describe() {
<span class="fc" id="L219">		final String spouseName = getInfoString();</span>

<span class="fc bfc" id="L221" title="All 2 branches covered.">		if (spouseName != null) {</span>
<span class="fc" id="L222">			return &quot;You see a ยง'wedding ring'. Its engraving says: \&quot;In eternal love to &quot;</span>
					+ spouseName + &quot;\&quot;.&quot;;
		} else {
<span class="fc" id="L225">			return &quot;You see a ยง'wedding ring'.&quot;;</span>
		}
	}
	
	// Check if there are more rings in the slot where this ring was added
	@Override
	public void setContainer(final SlotOwner container, final RPSlot slot) {
<span class="fc" id="L232">		WeddingRing oldRing = null;</span>
		// only bound rings destroy others
<span class="fc bfc" id="L234" title="All 4 branches covered.">		if ((slot != null) &amp;&amp; (getBoundTo() != null)) {</span>
<span class="fc bfc" id="L235" title="All 2 branches covered.">			for (final RPObject object : slot) {</span>
<span class="fc bfc" id="L236" title="All 4 branches covered.">				if ((object instanceof WeddingRing) </span>
						&amp;&amp; (!getID().equals(object.getID()))) {
<span class="fc" id="L238">					final WeddingRing ring = (WeddingRing) object;</span>
<span class="fc bfc" id="L239" title="All 2 branches covered.">					if (getBoundTo().equals(ring.getBoundTo())) {</span>
<span class="fc" id="L240">						oldRing = (WeddingRing) object;</span>
<span class="fc" id="L241">						break;</span>
					}
				}
<span class="fc" id="L244">			}</span>
		}
	
<span class="fc bfc" id="L247" title="All 2 branches covered.">		if (oldRing != null) {</span>
			// The player is cheating with multiple rings. Explode the 
			// old ring, and use up the energy of this one
<span class="fc" id="L250">			destroyRing(container, oldRing, slot);</span>
<span class="fc" id="L251">			storeLastUsed();</span>
		}
		
<span class="fc" id="L254">		super.setContainer(container, slot);</span>
<span class="fc" id="L255">	}</span>
	
	/**
	 * Destroy a wedding ring.
	 * To be used when a ring is put in a same slot with another.
	 *
	 * @param container 
	 * @param ring the ring to be destroyed
	 * @param slot the slot holding the ring
	 */
	private void destroyRing(SlotOwner container, final WeddingRing ring, final RPSlot slot) {
		// The players need to be told first, while the ring still
		// exist in the world
<span class="fc" id="L268">		informNearbyPlayers(ring);</span>

<span class="fc" id="L270">		RPEntity player = null;</span>
<span class="pc bpc" id="L271" title="1 of 2 branches missed.">		if (container instanceof RPEntity) {</span>
<span class="fc" id="L272">			player = (RPEntity) container;</span>
		}

<span class="fc" id="L275">		new ItemLogger().destroy(player, slot, ring, &quot;another ring&quot;);</span>
<span class="fc" id="L276">		ring.removeFromWorld();</span>
<span class="fc" id="L277">		logger.info(&quot;Destroyed a wedding ring: &quot; + ring);</span>
<span class="fc" id="L278">	}</span>
	
	/**
	 * Give a nice message to nearby players when rings get destroyed.
	 * 
	 * @param ring the ring that got destroyed
	 */
	private void informNearbyPlayers(final WeddingRing ring) {
		try {
<span class="fc" id="L287">			final Entity container = (Entity) ring.getBaseContainer();</span>
<span class="fc" id="L288">			final StendhalRPZone zone = getZone();</span>
			
<span class="pc bpc" id="L290" title="1 of 2 branches missed.">			if (zone != null) {</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">				for (final Player player : zone.getPlayers()) {</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">					if (player.nextTo(container)) {</span>
<span class="nc" id="L293">						player.sendPrivateText(NotificationType.SCENE_SETTING, </span>
						&quot;There's a flash of light when a wedding ring disintegrates in a magical conflict.&quot;);
					}
<span class="nc" id="L296">				}</span>
			}
<span class="nc" id="L298">		} catch (final Exception e) {</span>
<span class="nc" id="L299">			logger.error(e);</span>
<span class="fc" id="L300">		}</span>
<span class="fc" id="L301">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>