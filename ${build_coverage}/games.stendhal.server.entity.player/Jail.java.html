<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Jail.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.entity.player</a> &gt; <span class="el_source">Jail.java</span></div><h1>Jail.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.entity.player;

import games.stendhal.common.Direction;
import games.stendhal.common.MathHelper;
import games.stendhal.common.NotificationType;
import games.stendhal.common.grammar.Grammar;
import games.stendhal.server.core.config.ZoneConfigurator;
import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.core.engine.StendhalRPZone;
import games.stendhal.server.core.events.LoginListener;
import games.stendhal.server.core.events.TurnListener;
import games.stendhal.server.core.events.ZoneEnterExitListener;
import games.stendhal.server.entity.RPEntity;
import games.stendhal.server.entity.mapstuff.office.ArrestWarrant;
import games.stendhal.server.entity.mapstuff.office.ArrestWarrantList;

import java.awt.Point;
import java.awt.Rectangle;
import java.util.Arrays;
import java.util.Collections;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;

import marauroa.common.game.RPObject;

import org.apache.log4j.Logger;

/**
 * This class is responsible of keeping players who have misbehaved in a special
 * jail area where they can't do any harm. The misbehaving player will be
 * automatically released after a specified number of minutes.
 *
 * @author daniel
 */
<span class="fc" id="L48">public class Jail implements ZoneConfigurator, LoginListener {</span>

	static StendhalRPZone jailzone;

<span class="fc" id="L52">	private static final Logger LOGGER = Logger.getLogger(Jail.class);</span>
<span class="fc" id="L53">	private static final List&lt;Point&gt; cellEntryPoints = Arrays.asList(</span>
			new Point(3, 3),
			new Point(8, 3),
			// elf cell(13, 3),
			new Point(18, 3),
			new Point(23, 3),
			new Point(28, 3),
			new Point(8, 11),
			new Point(13, 11),
			new Point(18, 11),
			new Point(23, 11),
			new Point(28, 11)
		);

<span class="fc" id="L67">		private static final Rectangle[] cellBlocks = {</span>
			new Rectangle(1, 1, 30, 4),
			new Rectangle(7, 10, 30, 4)
		};

	private ArrestWarrantList arrestWarrants;

<span class="fc" id="L74">	private final List&lt;Cell&gt; cells = new LinkedList&lt;Cell&gt;();</span>

<span class="fc" id="L76">	private final ZoneEnterExitListener listener = new ZoneEnterExitListener() {</span>
		@Override
		public void onEntered(final RPObject object, final StendhalRPZone zone) {
<span class="fc bfc" id="L79" title="All 2 branches covered.">			if (object.getRPClass().subclassOf(&quot;player&quot;)) {</span>
				//TODO: could this be a bug ? (durkham)

			}
<span class="fc" id="L83">		}</span>

		@Override
		public void onExited(final RPObject object, final StendhalRPZone zone) {
<span class="pc bpc" id="L87" title="3 of 4 branches missed.">			if (object instanceof RPEntity &amp;&amp; object.getRPClass().subclassOf(&quot;player&quot;)) {</span>
<span class="nc" id="L88">				String playerName = ((RPEntity)object).getName();</span>

<span class="nc bnc" id="L90" title="All 2 branches missed.">				for (final Cell cell : cells) {</span>
<span class="nc" id="L91">					cell.remove(playerName);</span>
<span class="nc" id="L92">				}</span>
			}
<span class="fc" id="L94">		}</span>
	};


<span class="fc" id="L98">	private final class Jailer implements TurnListener {</span>

		private final String criminalName;

<span class="fc" id="L102">		Jailer(final String name) {</span>
<span class="fc" id="L103">			criminalName = name;</span>
<span class="fc" id="L104">		}</span>

		@Override
		public boolean equals(final Object obj) {
<span class="fc bfc" id="L108" title="All 2 branches covered.">			if (obj instanceof Jailer) {</span>
<span class="fc" id="L109">				final Jailer other = (Jailer) obj;</span>
<span class="fc" id="L110">				return criminalName.equals(other.criminalName);</span>
			}
<span class="fc" id="L112">			return false;</span>
		}

		@Override
		public int hashCode() {
<span class="fc" id="L117">			return criminalName.hashCode();</span>
		}

		@Override
		public void onTurnReached(final int currentTurn) {
<span class="fc" id="L122">			release(criminalName);</span>
<span class="fc" id="L123">		}</span>

		@Override
		public String toString() {
<span class="fc" id="L127">			return &quot;Jailer [criminalName=&quot; + criminalName + &quot;]&quot;;</span>
		}
	}

	/**
	 * @param criminalName
	 *            The name of the player who should be jailed
	 * @param policeman
	 *            The object for the RPEntity or admin who wants to jail the criminal
	 * @param minutes
	 *            The duration of the sentence
	 * @param reason why criminal was jailed
	 */
	public void imprison(final String criminalName, final RPEntity policeman,
			final int minutes, final String reason) {

<span class="fc" id="L143">		final Player criminal = SingletonRepository.getRuleProcessor().getPlayer(</span>
						criminalName);

<span class="fc" id="L146">		arrestWarrants.removeByName(criminalName);</span>
<span class="fc" id="L147">		final ArrestWarrant arrestWarrant = new ArrestWarrant(criminalName, policeman.getName(), minutes, reason);</span>

<span class="fc" id="L149">		policeman.sendPrivateText(&quot;You have jailed &quot; + criminalName</span>
			+ &quot; for &quot; + minutes + &quot; &quot; + Grammar.plnoun(minutes, &quot;minute&quot;) + &quot;. Reason: &quot; + reason + &quot;.&quot;);
<span class="fc" id="L151">		SingletonRepository.getRuleProcessor().sendMessageToSupporters(&quot;JailKeeper&quot;,</span>
			policeman.getName() + &quot; jailed &quot; + criminalName
			+ &quot; for &quot; + minutes + &quot; &quot; + Grammar.plnoun(minutes, &quot;minute&quot;) + &quot;. Reason: &quot; + reason
			+ &quot;.&quot;);

<span class="fc bfc" id="L156" title="All 2 branches covered.">		if (criminal == null) {</span>
<span class="fc" id="L157">			final String text = &quot;Player &quot; + criminalName + &quot; is not online, but the arrest warrant has been recorded anyway.&quot;;</span>
<span class="fc" id="L158">			policeman.sendPrivateText(text);</span>
<span class="fc" id="L159">			LOGGER.info(text);</span>
<span class="fc" id="L160">		} else {</span>
<span class="fc" id="L161">			arrestWarrant.setStarted();</span>
<span class="fc" id="L162">			imprison(criminal, policeman, minutes);</span>
<span class="fc" id="L163">			criminal.sendPrivateText(NotificationType.SUPPORT,</span>
					&quot;You have been jailed for &quot; + minutes
					+ &quot; &quot; + Grammar.plnoun(minutes, &quot;minute&quot;) + &quot;. Reason: &quot; + reason + &quot;.&quot;);
<span class="fc" id="L166">			LOGGER.info(criminal.getName() + &quot; has been jailed for &quot; + minutes</span>
					+ &quot; &quot; + Grammar.plnoun(minutes, &quot;minute&quot;) + &quot;. Reason: &quot; + reason + &quot;.&quot;);
		}
<span class="fc" id="L169">		arrestWarrants.add(arrestWarrant);</span>
<span class="fc" id="L170">	}</span>

	protected void imprison(final Player criminal, final RPEntity policeman, final int minutes) {

<span class="pc bpc" id="L174" title="1 of 2 branches missed.">		if (jailzone == null) {</span>
			final String text = &quot;No zone has been configured to be Jailzone&quot;;
<span class="nc" id="L176">			policeman.sendPrivateText(text);</span>
<span class="nc" id="L177">			LOGGER.error(text);</span>
<span class="nc" id="L178">			return;</span>
		}
<span class="fc" id="L180">		final boolean successful = teleportToAvailableCell(criminal, policeman);</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">		if (successful) {</span>
<span class="fc" id="L182">			final Jailer jailer = new Jailer(criminal.getName());</span>
<span class="fc" id="L183">			SingletonRepository.getTurnNotifier().dontNotify(jailer);</span>

			// Set a timer so that the inmate is automatically released after
			// serving his sentence. Negative times are treated as &quot;forever&quot;,
			// thus no turn notifiers are needed. Zero is useful for freeing
			// players, so we handle that normally.
<span class="fc" id="L189">			LOGGER.info(&quot;Setting turn notifier for &quot; + (minutes * 60) + &quot; &quot; + jailer);</span>
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">			if (minutes &gt;= 0) {</span>
<span class="fc" id="L191">				SingletonRepository.getTurnNotifier().notifyInSeconds(minutes * 60, jailer);</span>
			}
<span class="fc" id="L193">		} else {</span>
<span class="nc" id="L194">			policeman.sendPrivateText(&quot;Could not find a cell for &quot; + criminal.getName());</span>
<span class="nc" id="L195">			LOGGER.error(&quot;Could not find a cell for &quot; + criminal.getName());</span>
		}
<span class="fc" id="L197">	}</span>

	private boolean teleportToAvailableCell(final Player criminal,
			final RPEntity policeman) {
<span class="fc" id="L201">		Collections.shuffle(cells);</span>
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">		for (final Cell cell : cells) {</span>
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">			if (cell.isEmpty()) {</span>
				// could make the last parameter the policeman, if the policeman is a player
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">				if (criminal.teleport(jailzone, cell.getEntry().x, cell</span>
						.getEntry().y, Direction.DOWN, null)) {
<span class="fc" id="L207">					cell.add(criminal.getName());</span>
<span class="fc" id="L208">					return true;</span>
				}
			}

<span class="nc" id="L212">		}</span>

<span class="nc" id="L214">		return false;</span>
	}

	/**
	 * Releases an inmate and teleports him to Semos city, but only if he is
	 * still in jail.
	 *
	 * @param inmateName
	 *            the name of the inmate who should be released
	 * @return true if the player has not logged out before he was released
	 */
	public boolean release(final String inmateName) {
<span class="fc" id="L226">		final Player inmate = SingletonRepository.getRuleProcessor().getPlayer(inmateName);</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">		if (inmate == null) {</span>
<span class="fc" id="L228">			LOGGER.info(&quot;Jailed player &quot; + inmateName + &quot; has logged out.&quot;);</span>
<span class="fc" id="L229">			return false;</span>
		}

<span class="fc" id="L232">		release(inmate);</span>
<span class="fc" id="L233">		return true;</span>
	}

	void release(final Player inmate) {
		// Only teleport the player if he is still in jail.
		// It could be that an admin has teleported him out earlier.
<span class="fc bfc" id="L239" title="All 2 branches covered.">		if (isInJail(inmate)) {</span>

<span class="fc" id="L241">			final StendhalRPZone exitZone = jailzone;</span>

<span class="fc" id="L243">			inmate.teleport(exitZone, 8, 7, Direction.LEFT, null);</span>
<span class="fc" id="L244">			inmate.sendPrivateText(NotificationType.SUPPORT,</span>
					&quot;Your sentence is over. You can walk out now.&quot;);
<span class="fc" id="L246">			LOGGER.info(&quot;Player &quot; + inmate.getName() + &quot; released from jail.&quot;);</span>
<span class="fc" id="L247">		} else {</span>
<span class="fc" id="L248">			LOGGER.info(&quot;Tried to release player &quot; + inmate.getName() + &quot;, but &quot; + inmate.getName() + &quot; is not in jail.&quot;);</span>
		}

		// The player completed his sentence and did not logout
		// so destroy the ArrestWarrant
<span class="fc" id="L253">		arrestWarrants.removeByName(inmate.getName());</span>
<span class="fc" id="L254">	}</span>

	/**
	 * Is player in a jail cell? Ignores visitors outside of cells.
	 *
	 * @param inmate
	 *            player to check
	 * @return true, if it is in jail, false otherwise.
	 */
	public static boolean isInJail(final Player inmate) {
<span class="fc" id="L264">		final StendhalRPZone zone = inmate.getZone();</span>

<span class="fc bfc" id="L266" title="All 4 branches covered.">		if ((zone != null) &amp;&amp; zone.equals(jailzone)) {</span>
<span class="fc bfc" id="L267" title="All 2 branches covered.">			for (final Rectangle cellBlock : cellBlocks) {</span>
<span class="fc bfc" id="L268" title="All 2 branches covered.">				if (cellBlock.contains(inmate.getX(), inmate.getY())) {</span>
<span class="fc" id="L269">					return true;</span>
				}
			}
		}
<span class="fc" id="L273">		return false;</span>
	}

	/**
	 * Destroy the arrest warrant so that the player is not jailed again on next login.
	 * @param player
	 */
	public void grantParoleIfPlayerWasAPrisoner(final Player player) {

<span class="fc" id="L282">		arrestWarrants.removeByName(player.getName());</span>
<span class="fc" id="L283">	}</span>

	@Override
	public void onLoggedIn(final Player player) {
		// we need to do this on the next turn because the
		// client does not get any private messages otherwise
		// sometime the client does not get the map content
		// if it gets a cross zone teleport too early. so we wait
		// 5 seconds.
<span class="nc" id="L292">		SingletonRepository.getTurnNotifier().notifyInSeconds(5, new TurnListener() {</span>
			@Override
			public void onTurnReached(final int currentTurn) {
<span class="nc" id="L295">				final String name = player.getName();</span>

<span class="nc" id="L297">				final ArrestWarrant arrestWarrant = arrestWarrants.getByName(name);</span>
<span class="nc bnc" id="L298" title="All 2 branches missed.">				if (arrestWarrant == null) {</span>
<span class="nc" id="L299">					return;</span>
				}

<span class="nc bnc" id="L302" title="All 2 branches missed.">				if (removeVeryOldWarrants(arrestWarrant)) {</span>
<span class="nc" id="L303">					LOGGER.warn(&quot;Removed very old:&quot; + arrestWarrant);</span>
<span class="nc" id="L304">					release(player);</span>
<span class="nc" id="L305">					return;</span>
				}

<span class="nc" id="L308">				final long timestamp = arrestWarrant.getTimestamp();</span>
<span class="nc" id="L309">				player.sendPrivateText(NotificationType.SUPPORT,</span>
						&quot;You have been jailed &quot;
					+ &quot; for &quot; + arrestWarrant.getMinutes()
					+ &quot; &quot; + Grammar.plnoun(arrestWarrant.getMinutes(), &quot;minute&quot;) + &quot; on &quot; + String.format(&quot;%tF&quot;, timestamp)
					+ &quot;. Reason: &quot; + arrestWarrant.getReason() + &quot;.&quot;);
<span class="nc" id="L314">				LOGGER.info(player.getName() + &quot; logged in who has been jailed &quot;</span>
						+ &quot; for &quot; + arrestWarrant.getMinutes()
						+ &quot; &quot; + Grammar.plnoun(arrestWarrant.getMinutes(), &quot;minute&quot;) + &quot; on &quot; + String.format(&quot;%tF&quot;, timestamp)
						+ &quot;. Reason: &quot; + arrestWarrant.getReason() + &quot;.&quot;);

<span class="nc" id="L319">				handleEscapeMessages(arrestWarrant);</span>
<span class="nc" id="L320">				imprison(player, player, arrestWarrant.getMinutes());</span>
<span class="nc" id="L321">			}</span>

			public boolean removeVeryOldWarrants(final ArrestWarrant arrestWarrant) {
<span class="nc" id="L324">				final long timestamp = arrestWarrant.getTimestamp();</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">				if (timestamp + 30 * MathHelper.MILLISECONDS_IN_ONE_DAY &lt; System.currentTimeMillis()) {</span>
<span class="nc" id="L326">					arrestWarrants.removeByName(arrestWarrant.getCriminal());</span>
<span class="nc" id="L327">					return true;</span>
				}

<span class="nc" id="L330">				return false;</span>
			}


			public void handleEscapeMessages(final ArrestWarrant arrestWarrant) {
<span class="nc bnc" id="L335" title="All 2 branches missed.">				if (arrestWarrant.isStarted()) {</span>
					// Notify player that his sentences is starting again because he tried to escape by logging out
<span class="nc" id="L337">					player.sendPrivateText(NotificationType.SUPPORT,</span>
							&quot;Although you already spent some &quot;
							+ &quot;time in jail, your sentence has been restarted &quot;
							+ &quot;because of your failed escape attempt.&quot;);
				} else {
					// Jail player who was offline at the time /jail was issued.
<span class="nc" id="L343">					arrestWarrant.setStarted();</span>
				}
<span class="nc" id="L345">			}</span>
		});
<span class="nc" id="L347">	}</span>

	public String listJailed() {
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">		if (arrestWarrants != null) {</span>
<span class="fc" id="L351">			return arrestWarrants.toString();</span>
		}
<span class="nc" id="L353">		return &quot;jail not inited ?&quot;;</span>
	}

	/**
	 * Get the ArrestWarrant of a jailed player.
	 *
	 * @param name the name of the player
	 * @return the ArrestWarrant for the player, or null if there is none
	 */
	public ArrestWarrant getWarrant(final String name) {
<span class="nc" id="L363">		return arrestWarrants.getByName(name);</span>
	}

	@Override
	public void configureZone(final StendhalRPZone zone, final Map&lt;String, String&gt; attributes) {
<span class="fc" id="L368">		SingletonRepository.getLoginNotifier().addListener(this);</span>
<span class="fc" id="L369">		SingletonRepository.setJail(this);</span>
<span class="fc" id="L370">		zone.addZoneEnterExitListener(listener);</span>
<span class="fc" id="L371">		initCells();</span>
<span class="fc" id="L372">		arrestWarrants = new ArrestWarrantList(zone);</span>
<span class="fc" id="L373">		jailzone = zone;</span>
<span class="fc" id="L374">	}</span>

	private void initCells() {
<span class="fc bfc" id="L377" title="All 2 branches covered.">		for (final Point p : cellEntryPoints) {</span>
<span class="fc" id="L378">			cells.add(new Cell(p));</span>
<span class="fc" id="L379">		}</span>

<span class="fc" id="L381">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>