<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SoundManager.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.client.sound.manager</a> &gt; <span class="el_source">SoundManager.java</span></div><h1>SoundManager.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.client.sound.manager;

import games.stendhal.client.sound.facade.AudibleArea;
import games.stendhal.client.sound.facade.InfiniteAudibleArea;
import games.stendhal.client.sound.facade.SoundFileType;
import games.stendhal.client.sound.facade.Time;
import games.stendhal.client.sound.system.SignalProcessor;
import games.stendhal.client.sound.system.SoundSystem;
import games.stendhal.client.sound.system.processors.DirectedSound;
import games.stendhal.client.sound.system.processors.Interruptor;
import games.stendhal.client.sound.system.processors.SoundLayers;
import games.stendhal.client.sound.system.processors.VolumeAdjustor;
import games.stendhal.common.math.Algebra;

import java.io.IOException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.concurrent.atomic.AtomicBoolean;
import java.util.concurrent.atomic.AtomicReference;

import javax.sound.sampled.AudioFormat;

import org.apache.log4j.Logger;

/**
 * Old implementation of the sound manager.
 * @author silvio
 */
public final class SoundManager
{
<span class="nc" id="L45">    private final static Logger              logger                   = Logger.getLogger(SoundManager.class);</span>
    private final static int                 OUTPUT_NUM_SAMPLES       = 256;
	private final static int                 SOUND_CHANNEL_LIMIT      = 0;
	private final static int                 USE_NUM_MIXER_LINES      = 0;
    private final static int                 DIMENSION                = 2;
<span class="nc" id="L50">    private final static float[]             HEARER_LOOKONG_DIRECTION = { 0.0f, 1.0f };</span>
<span class="nc" id="L51">    private final static AudioFormat         AUDIO_FORMAT             = new AudioFormat(44100, 16, 2, true, false);</span>
<span class="nc" id="L52">    private final static InfiniteAudibleArea INFINITE_AUDIBLE_AREA    = new InfiniteAudibleArea();</span>
<span class="nc" id="L53">    public  final static Time                ZERO_DURATION            = new Time();</span>

<span class="nc" id="L55">    public final static class Sound implements Cloneable</span>
    {
<span class="nc" id="L57">        final AtomicReference&lt;SoundFile&gt;    file    = new AtomicReference&lt;SoundFile&gt;(null);</span>
<span class="nc" id="L58">        final AtomicReference&lt;SoundChannel&gt; channel = new AtomicReference&lt;SoundChannel&gt;(null);</span>
<span class="nc" id="L59">		Object                              object  = null;</span>

		@Override
		public Sound clone()
		{
<span class="nc" id="L64">			Sound sound = new Sound();</span>
<span class="nc" id="L65">			sound.file.set(file.get().clone());</span>
<span class="nc" id="L66">			sound.object = object;</span>
<span class="nc" id="L67">			return sound;</span>
		}

		@SuppressWarnings(&quot;unchecked&quot;)
		public &lt;T&gt; T getAttachment(Class&lt;T&gt; clazz)
		{
<span class="nc bnc" id="L73" title="All 2 branches missed.">			if(clazz.isInstance(object)) {</span>
<span class="nc" id="L74">				return (T)object;</span>
			}

<span class="nc" id="L77">			return null;</span>
		}

<span class="nc" id="L80">		public Object  getAttachment()           { return object;                                            }</span>
<span class="nc bnc" id="L81" title="All 4 branches missed.">        public boolean isActive()                { return channel.get() != null &amp;&amp; channel.get().isActive(); }</span>
<span class="nc" id="L82">		public void    setAttachment(Object obj) { object = obj;                                             }</span>
    }

    private final class SoundChannel extends SignalProcessor
    {
<span class="nc" id="L87">        final float[]                      mSoundPosition = new float[DIMENSION];</span>
<span class="nc" id="L88">        final AtomicBoolean                mAutoRepeat    = new AtomicBoolean(false);</span>
<span class="nc" id="L89">        final AtomicBoolean                mIsActive      = new AtomicBoolean(false);</span>
<span class="nc" id="L90">        final AtomicReference&lt;AudibleArea&gt; mAudibleArea   = new AtomicReference&lt;AudibleArea&gt;(INFINITE_AUDIBLE_AREA);</span>
<span class="nc" id="L91">        final Interruptor                  mInterruptor   = new Interruptor();</span>
<span class="nc" id="L92">        final DirectedSound                mDirectedSound = new DirectedSound();</span>
<span class="nc" id="L93">        final VolumeAdjustor               mGlobalVolume  = new VolumeAdjustor();</span>
        final SoundLayers.VolumeAdjustor   mLayerVolume;
        final SoundSystem.Output           mOutput;
<span class="nc" id="L96">        Sound                              mSound = null;</span>

        SoundChannel()
<span class="nc" id="L99">        {</span>
<span class="nc" id="L100">            mOutput      = mSoundSystem.openOutput(AUDIO_FORMAT);</span>
<span class="nc" id="L101">            mLayerVolume = mSoundLayers.createVolumeAdjustor(0);</span>

<span class="nc" id="L103">            SignalProcessor.createChain(mInterruptor, this, mLayerVolume, mGlobalVolume, mDirectedSound, mOutput);</span>
<span class="nc" id="L104">        }</span>

<span class="nc" id="L106">        boolean isActive      ()                            { return mIsActive.get();                      }</span>
<span class="nc" id="L107">        void    setAutoRepeat (boolean repeat)              { mAutoRepeat.set(repeat);                     }</span>
<span class="nc" id="L108">        void    setVolume     (float volume)                { mGlobalVolume.setVolume(volume);             }</span>
<span class="nc" id="L109">        void    startFading   (float volume, Time duration) { mGlobalVolume.startFading(volume, duration); }</span>
<span class="nc" id="L110">		void    startFading   (Time duration)               { mGlobalVolume.startFading(duration);         }</span>
<span class="nc" id="L111">        void    setLayer      (int level)                   { mLayerVolume.setLayer(level);                }</span>
<span class="nc" id="L112">        void    resumePlayback()                            { mInterruptor.play();                         }</span>
<span class="nc" id="L113">		void    close         ()                            { mSoundSystem.closeOutput(mOutput);           }</span>
<span class="nc" id="L114">		Sound   getSoundObject()                            { return mSound;                               }</span>

		void setAudibleArea(AudibleArea area)
		{
<span class="nc bnc" id="L118" title="All 2 branches missed.">			if(area == null) {</span>
<span class="nc" id="L119">				area = INFINITE_AUDIBLE_AREA;</span>
			}

<span class="nc" id="L122">			mAudibleArea.set(area);</span>
<span class="nc" id="L123">		}</span>

        synchronized void playSound(Sound newSound, float volume, Time time)
        {
<span class="nc bnc" id="L127" title="All 2 branches missed.">            if(mSound != null)</span>
            {
<span class="nc" id="L129">                mSound.file.get().disconnect();</span>
<span class="nc" id="L130">                mSound.file.get().restart();</span>
<span class="nc" id="L131">                mSound.channel.set(null);</span>
<span class="nc" id="L132">                mLayerVolume.setIntensity(0.0f);</span>
            }

<span class="nc bnc" id="L135" title="All 2 branches missed.">            if(newSound != null)</span>
            {
<span class="nc bnc" id="L137" title="All 2 branches missed.">                if(time == null) {</span>
<span class="nc" id="L138">					time = ZERO_DURATION;</span>
				}

<span class="nc" id="L141">                mInterruptor.play();</span>
<span class="nc" id="L142">                mGlobalVolume.setVolume(0.0f);</span>
<span class="nc" id="L143">                mGlobalVolume.startFading(volume, time);</span>
<span class="nc" id="L144">                newSound.channel.set(this);</span>
<span class="nc" id="L145">                newSound.file.get().connectTo(mInterruptor, true);</span>
            }

<span class="nc" id="L148">            mSound = newSound;</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">			mIsActive.set(newSound != null);</span>
<span class="nc" id="L150">        }</span>

        void stopPlayback(Time time)
        {
<span class="nc bnc" id="L154" title="All 2 branches missed.">			if(time == null) {</span>
<span class="nc" id="L155">				time = ZERO_DURATION;</span>
			}

<span class="nc" id="L158">            mAutoRepeat.set(false);</span>
<span class="nc" id="L159">            mGlobalVolume.startFading(0.0f, time);</span>
<span class="nc" id="L160">            mInterruptor.stop(time);</span>
<span class="nc" id="L161">        }</span>

        void update()
        {
<span class="nc" id="L165">            float intensity = mAudibleArea.get().getHearingIntensity(mHearerPosition);</span>
<span class="nc" id="L166">            mAudibleArea.get().getClosestPoint(mSoundPosition, mHearerPosition);</span>
<span class="nc" id="L167">            mDirectedSound.setPositions2D(mSoundPosition, mHearerPosition, HEARER_LOOKONG_DIRECTION, intensity);</span>
<span class="nc" id="L168">            mLayerVolume.setIntensity(intensity);</span>
<span class="nc" id="L169">        }</span>

        @Override
        protected void finished()
        {
<span class="nc bnc" id="L174" title="All 2 branches missed.">            if(mAutoRepeat.get())</span>
            {
<span class="nc" id="L176">                mSound.file.get().restart();</span>
            }
            else
            {
<span class="nc" id="L180">                playSound(null, 0, null);</span>
<span class="nc" id="L181">                super.quit();</span>
            }
<span class="nc" id="L183">        }</span>
    }

<span class="nc" id="L186">    private final LinkedList&lt;SoundChannel&gt; mChannels       = new LinkedList&lt;SoundChannel&gt;();</span>
<span class="nc" id="L187">    private final float[]                  mHearerPosition = new float[DIMENSION];</span>
<span class="nc" id="L188">    private final SoundLayers              mSoundLayers    = new SoundLayers();</span>
<span class="nc" id="L189">	private boolean                        mMute           = false;</span>
	private final SoundSystem                    mSoundSystem;

    protected SoundManager()
<span class="nc" id="L193">    {</span>
<span class="nc" id="L194">        Algebra.mov_Vecf(mHearerPosition, 0.0f);</span>

<span class="nc" id="L196">		mSoundSystem = new SoundSystem(null, AUDIO_FORMAT, new Time(15, Time.Unit.MILLI), USE_NUM_MIXER_LINES);</span>
<span class="nc" id="L197">		mSoundSystem.setDaemon(true);</span>
<span class="nc" id="L198">		mSoundSystem.start();</span>
<span class="nc" id="L199">    }</span>

	public Sound openSound(AudioResource AudioResource, SoundFileType fileType)
    {
<span class="nc" id="L203">		return openSound(AudioResource, fileType, OUTPUT_NUM_SAMPLES, true);</span>
    }

	public synchronized Sound openSound(AudioResource AudioResource, SoundFileType fileType, int numSamplesPerChunk, boolean enableStreaming)
    {
<span class="nc" id="L208">		Sound sound = null;</span>

        try
        {
<span class="nc" id="L212">            SoundFile file = new SoundFile(AudioResource, fileType, numSamplesPerChunk, enableStreaming);</span>
<span class="nc" id="L213">            sound = new Sound();</span>
<span class="nc" id="L214">            sound.file.set(file);</span>
        }
<span class="nc" id="L216">        catch(IOException exception)</span>
		{
<span class="nc" id="L218">			logger.warn(exception);</span>
<span class="nc" id="L219">			return null;</span>
<span class="nc" id="L220">		}</span>

<span class="nc" id="L222">		return sound;</span>
    }

    public synchronized void setHearerPosition(float[] position)
    {
<span class="nc" id="L227">        Algebra.mov_Vecf(mHearerPosition, position);</span>
<span class="nc" id="L228">    }</span>

    public synchronized void update()
    {
<span class="nc bnc" id="L232" title="All 2 branches missed.">        for(SoundChannel channel: mChannels)</span>
        {
<span class="nc bnc" id="L234" title="All 2 branches missed.">            if(channel.isActive()) {</span>
<span class="nc" id="L235">				channel.update();</span>
			}
<span class="nc" id="L237">        }</span>
<span class="nc" id="L238">    }</span>

	public synchronized void play(Sound sound, float volume, int layerLevel, AudibleArea area, boolean autoRepeat, Time fadeInDuration)
    {
<span class="nc bnc" id="L242" title="All 2 branches missed.">        if(sound == null) {</span>
<span class="nc" id="L243">			return;</span>
		}

<span class="nc bnc" id="L246" title="All 2 branches missed.">        if(sound.isActive())</span>
        {
<span class="nc" id="L248">            SoundChannel channel = sound.channel.get();</span>
<span class="nc" id="L249">            channel.setAutoRepeat(autoRepeat);</span>
<span class="nc" id="L250">            channel.startFading(1.0f, fadeInDuration);</span>
<span class="nc" id="L251">			channel.setVolume(volume);</span>
<span class="nc" id="L252">            channel.setLayer(layerLevel);</span>
<span class="nc" id="L253">            channel.setAudibleArea(area);</span>
<span class="nc" id="L254">            channel.resumePlayback();</span>
<span class="nc" id="L255">			channel.update();</span>
<span class="nc" id="L256">        }</span>
        else
        {
<span class="nc bnc" id="L259" title="All 2 branches missed.">			if(!mMute)</span>
			{
<span class="nc" id="L261">				SoundChannel channel = getInactiveChannel();</span>
<span class="nc" id="L262">				channel.setAutoRepeat(autoRepeat);</span>
<span class="nc" id="L263">				channel.setLayer(layerLevel);</span>
<span class="nc" id="L264">				channel.setAudibleArea(area);</span>
<span class="nc" id="L265">				channel.playSound(sound, volume, fadeInDuration);</span>
<span class="nc" id="L266">				channel.update();</span>

<span class="nc" id="L268">				closeInactiveChannels(SOUND_CHANNEL_LIMIT);</span>
			}
        }
<span class="nc" id="L271">    }</span>

    public synchronized void stop(Sound sound, Time fadeOutDuration)
    {
<span class="nc bnc" id="L275" title="All 4 branches missed.">        if(sound != null &amp;&amp; sound.isActive()) {</span>
<span class="nc" id="L276">			sound.channel.get().stopPlayback(fadeOutDuration);</span>
		}
<span class="nc" id="L278">    }</span>

    public synchronized void changeVolume(Sound sound, float volume)
    {
<span class="nc bnc" id="L282" title="All 4 branches missed.">        if(sound != null &amp;&amp; sound.isActive()) {</span>
<span class="nc" id="L283">			sound.channel.get().setVolume(volume);</span>
		}
<span class="nc" id="L285">    }</span>

    public synchronized void changeLayer(Sound sound, int layerLevel)
    {
<span class="nc bnc" id="L289" title="All 4 branches missed.">        if(sound != null &amp;&amp; sound.isActive()) {</span>
<span class="nc" id="L290">			sound.channel.get().setLayer(layerLevel);</span>
		}
<span class="nc" id="L292">    }</span>

    public synchronized void changeAudibleArea(Sound sound, AudibleArea area)
    {
<span class="nc bnc" id="L296" title="All 4 branches missed.">        if(sound != null &amp;&amp; sound.isActive()) {</span>
<span class="nc" id="L297">			sound.channel.get().setAudibleArea(area);</span>
		}
<span class="nc" id="L299">    }</span>

	public synchronized void mute(boolean turnOffSound, boolean useFading, Time delay)
	{
<span class="nc bnc" id="L303" title="All 4 branches missed.">		if(turnOffSound &amp;&amp; !mMute)</span>
		{
<span class="nc" id="L305">			logger.info(&quot;turning off audio&quot;);</span>
<span class="nc" id="L306">			mSoundSystem.suspend(delay);</span>

<span class="nc bnc" id="L308" title="All 2 branches missed.">			if(useFading)</span>
			{
<span class="nc bnc" id="L310" title="All 2 branches missed.">				for(SoundChannel channel: mChannels) {</span>
<span class="nc bnc" id="L311" title="All 2 branches missed.">					if(channel.isActive()) {</span>
<span class="nc" id="L312">						channel.startFading(0, delay);</span>
					}
<span class="nc" id="L314">				}</span>
			}
		}

<span class="nc bnc" id="L318" title="All 4 branches missed.">		if(!turnOffSound &amp;&amp; mMute)</span>
		{
<span class="nc" id="L320">			logger.info(&quot;turning on audio&quot;);</span>
<span class="nc" id="L321">			mSoundSystem.proceed(null);</span>

<span class="nc bnc" id="L323" title="All 2 branches missed.">			if(useFading)</span>
			{
<span class="nc bnc" id="L325" title="All 2 branches missed.">				for(SoundChannel channel: mChannels) {</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">					if(channel.isActive()) {</span>
<span class="nc" id="L327">						channel.startFading(delay);</span>
					}
<span class="nc" id="L329">				}</span>
			}
		}

<span class="nc" id="L333">		mMute = turnOffSound;</span>
<span class="nc" id="L334">	}</span>

	public synchronized Collection&lt;Sound&gt; getActiveSounds()
	{
<span class="nc" id="L338">		ArrayList&lt;Sound&gt; sounds = new ArrayList&lt;Sound&gt;(mChannels.size());</span>

<span class="nc bnc" id="L340" title="All 2 branches missed.">		for(SoundChannel channel: mChannels)</span>
		{
<span class="nc" id="L342">			Sound sound = channel.getSoundObject();</span>

<span class="nc bnc" id="L344" title="All 4 branches missed.">			if(sound != null &amp;&amp; sound.isActive()) {</span>
<span class="nc" id="L345">				sounds.add(sound);</span>
			}
<span class="nc" id="L347">		}</span>

<span class="nc" id="L349">		sounds.trimToSize();</span>
<span class="nc" id="L350">		return sounds;</span>
	}

    public synchronized void exit()
    {
<span class="nc" id="L355">		mSoundSystem.exit(null);</span>

		try
		{
<span class="nc" id="L359">			mSoundSystem.join();</span>
		}
<span class="nc" id="L361">		catch(InterruptedException exception)</span>
		{
<span class="nc" id="L363">			logger.warn(&quot;joining sound system thread was interrupted: &quot; + exception);</span>
<span class="nc" id="L364">		}</span>
<span class="nc" id="L365">    }</span>

	private void closeInactiveChannels(int leaveNumChannelsOpen)
	{
<span class="nc" id="L369">		int                    numChannels = mChannels.size();</span>
<span class="nc" id="L370">		Iterator&lt;SoundChannel&gt; iChannel    = mChannels.iterator();</span>

<span class="nc bnc" id="L372" title="All 2 branches missed.">		while(iChannel.hasNext())</span>
		{
<span class="nc bnc" id="L374" title="All 2 branches missed.">			if(mChannels.size() &lt;= leaveNumChannelsOpen) {</span>
<span class="nc" id="L375">				break;</span>
			}

<span class="nc" id="L378">			SoundChannel currChannel = iChannel.next();</span>

<span class="nc bnc" id="L380" title="All 2 branches missed.">			if(!currChannel.isActive())</span>
			{
<span class="nc" id="L382">				currChannel.close();</span>
<span class="nc" id="L383">				iChannel.remove();</span>
			}
<span class="nc" id="L385">		}</span>

<span class="nc" id="L387">		numChannels -= mChannels.size();</span>

<span class="nc bnc" id="L389" title="All 2 branches missed.">		if(numChannels &gt; 0) {</span>
<span class="nc" id="L390">			logger.debug(&quot;close &quot; + numChannels + &quot; inactive sound channels&quot;);</span>
		}
<span class="nc" id="L392">	}</span>

    private SoundChannel getInactiveChannel()
    {
<span class="nc" id="L396">        SoundChannel foundChannel = null;</span>

<span class="nc bnc" id="L398" title="All 2 branches missed.">        for(SoundChannel channel: mChannels)</span>
        {
<span class="nc bnc" id="L400" title="All 2 branches missed.">            if(!channel.isActive())</span>
			{
<span class="nc" id="L402">                foundChannel = channel;</span>
<span class="nc" id="L403">				break;</span>
			}
<span class="nc" id="L405">        }</span>

<span class="nc bnc" id="L407" title="All 2 branches missed.">        if(foundChannel == null)</span>
		{
<span class="nc" id="L409">			foundChannel = new SoundChannel();</span>
<span class="nc" id="L410">            mChannels.add(foundChannel);</span>

<span class="nc" id="L412">			logger.debug(&quot;open new sound channel (number &quot; + mChannels.size() + &quot;)&quot;);</span>
        }

<span class="nc" id="L415">        return foundChannel;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>