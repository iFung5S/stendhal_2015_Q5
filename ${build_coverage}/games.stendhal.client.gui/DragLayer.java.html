<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DragLayer.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.client.gui</a> &gt; <span class="el_source">DragLayer.java</span></div><h1>DragLayer.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.client.gui;

import games.stendhal.client.entity.IEntity;
import games.stendhal.client.entity.StackableItem;
import games.stendhal.client.gui.j2d.entity.Entity2DView;
import games.stendhal.client.gui.j2d.entity.EntityViewFactory;
import games.stendhal.client.gui.j2d.entity.StackableItem2DView;
import games.stendhal.client.sprite.Sprite;
import games.stendhal.client.sprite.SpriteStore;

import java.awt.AWTEvent;
import java.awt.Component;
import java.awt.Container;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.Point;
import java.awt.Toolkit;
import java.awt.event.AWTEventListener;
import java.awt.event.MouseEvent;

import javax.swing.JComponent;
import javax.swing.SwingUtilities;

/**
 * A glass pane component for drawing dragged items. Using ideas (though no
 * code) from Alexander Potochkin of the swing team. His blog entry describing
 * the tricks used:
 * http://weblogs.java.net/blog/2006/09/20/well-behaved-glasspane
 */
public class DragLayer extends JComponent implements AWTEventListener {
	/**
	 * serial version uid
	 */
	private static final long serialVersionUID = -726066169323112688L;
	
	private static DragLayer instance;
	/**
	 * Icon to show when a dragged object is not in a place where it can be
	 * dropped.
	 */
<span class="nc" id="L53">	private static final Sprite dropForbiddenIcon = SpriteStore.get().getSprite(&quot;data/gui/forbidden.png&quot;);</span>

	/** The dragged entity, or &lt;code&gt;null&lt;/code&gt; if nothing is being dragged. */
	private Entity2DView&lt;?&gt; dragged;
	/** Current mouse location. */
	private Point point;

	private int oldX, oldY, width, height;
	
	/**
	 * A speed hack for detecting the underlying component. Keep it in memory
	 * unless the mouse location has changed to avoid scanning the component
	 * tree at every redraw.
	 */
	private Component underlyingComponent;

	/**
	 * Create a new DragLayer.
	 */
<span class="nc" id="L72">	private DragLayer() {</span>
		/*
		 * Not a pretty way to listen to mouse events, but adding a mouse
		 * movement listener eats any events that should go below. Redispatching
		 * them does not really work (despite being what the official swing
		 * tutorial recommends), because enter and leave events to the
		 * components have already been lost.
		 *
		 * Adding a mouse movement listener after the drag has started does not
		 * work either, because it does not get the mouse events belonging to
		 * the drag, but starts working only later.
		 */
<span class="nc" id="L84">		Toolkit.getDefaultToolkit().addAWTEventListener(this, AWTEvent.MOUSE_EVENT_MASK | AWTEvent.MOUSE_MOTION_EVENT_MASK);</span>

<span class="nc" id="L86">		setOpaque(false);</span>
<span class="nc" id="L87">	}</span>

	@Override
	public boolean contains(int x, int y) {
		/*
		 * To get the correct mouse cursors, the pane needs to lie a bit to
		 * AWT and claim to not contain any point of the screen. Then the mouse
		 * handling is properly passed to the components below.
		 */
<span class="nc" id="L96">		return false;</span>
	}

	/**
	 * Get the DragLayer instance.
	 *
	 * @return drag layer
	 */
	public static DragLayer get() {
<span class="nc bnc" id="L105" title="All 2 branches missed.">		if (instance == null) {</span>
<span class="nc" id="L106">			instance = new DragLayer();</span>
		}
<span class="nc" id="L108">		return instance;</span>
	}

	/**
	 * Start dragging an entity. The DragLayer will take care of drawing,
	 * updating the position and dropping it to the right DropTarget.
	 *
	 * @param entity dragged entity
	 */
	@SuppressWarnings(&quot;rawtypes&quot;) // cannot cast from &lt;IEntity&gt; to &lt;? extends StackableItem&gt; in Java 5
	public void startDrag(IEntity entity) {
<span class="nc bnc" id="L119" title="All 2 branches missed.">		if (entity != null) {</span>
<span class="nc" id="L120">			Entity2DView&lt;IEntity&gt; dragged = (Entity2DView&lt;IEntity&gt;) EntityViewFactory.create(entity);</span>
			/*
			 * Make it contained, so that the view knows to ignore the entity
			 * coordinates
			 */
<span class="nc" id="L125">			dragged.setContained(true);</span>
			/*
			 * Hide quantity until it can be made context sensitive to drag
			 * modifiers.
			 */
<span class="nc bnc" id="L130" title="All 2 branches missed.">			if (dragged instanceof StackableItem2DView) {</span>
<span class="nc" id="L131">				((StackableItem2DView) dragged).setShowQuantity(false);</span>
			}

<span class="nc" id="L134">			this.dragged = dragged;</span>
		}
<span class="nc" id="L136">	}</span>

	@Override
	public void paintComponent(Graphics g) {
<span class="nc bnc" id="L140" title="All 4 branches missed.">		if ((point != null) &amp;&amp; (dragged != null)) {</span>
<span class="nc" id="L141">			Graphics2D g2d = (Graphics2D) g;</span>
<span class="nc" id="L142">			g2d.translate(point.x, point.y);</span>
<span class="nc" id="L143">			dragged.draw(g2d);</span>
			
			// Draw an indicator about invalid dropping area, if needed
<span class="nc bnc" id="L146" title="All 2 branches missed.">			if (getCurrentDropTarget() == null) {</span>
<span class="nc" id="L147">				dropForbiddenIcon.draw(g2d, dragged.getWidth() - dropForbiddenIcon.getWidth(),</span>
						dragged.getHeight() - dropForbiddenIcon.getHeight());
			}
		}
<span class="nc" id="L151">	}</span>
	
	/**
	 * Get the drop target capable of accepting the dragged entity at the
	 * current location.
	 * 
	 * @return drop target, or &lt;code&gt;null&lt;/code&gt; if the component below is not a
	 * 	DropTarget, or it is not capable of accepting the dragged entity 
	 */
	private DropTarget getCurrentDropTarget() {
<span class="nc bnc" id="L161" title="All 2 branches missed.">		if (underlyingComponent == null) {</span>
<span class="nc" id="L162">			Container parent = getParent();</span>
<span class="nc" id="L163">			Point containerPoint = SwingUtilities.convertPoint(this, point, parent);</span>
<span class="nc" id="L164">			underlyingComponent = SwingUtilities.getDeepestComponentAt(parent, containerPoint.x, containerPoint.y);</span>
		}
<span class="nc bnc" id="L166" title="All 4 branches missed.">		if ((underlyingComponent instanceof DropTarget) </span>
				&amp;&amp; (((DropTarget) underlyingComponent).canAccept(dragged.getEntity()))) {
<span class="nc" id="L168">			return (DropTarget) underlyingComponent;</span>
		}
<span class="nc" id="L170">		return null;</span>
	}

	/**
	 * Stop dragging the item, and let the component below the cursor handle
	 * the dropped entity.
	 *
	 * @param event The mouse event that triggered the drop
	 */
	private void stopDrag(MouseEvent event) {
<span class="nc" id="L180">		IEntity entity = dragged.getEntity();</span>
<span class="nc" id="L181">		DropTarget target = getCurrentDropTarget();</span>
<span class="nc bnc" id="L182" title="All 6 branches missed.">		if ((target != null) &amp;&amp; target.canAccept(entity)</span>
				&amp;&amp; (target instanceof Component)) {
<span class="nc bnc" id="L184" title="All 2 branches missed.">			if (entity != null) {</span>
<span class="nc" id="L185">				Point componentPoint = SwingUtilities.convertPoint(this, point, (Component) target);</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">				if (showAmountChooser(event, entity)) {</span>
					// Delegate dropping to the amount chooser
<span class="nc" id="L188">					DropAmountChooser chooser = new DropAmountChooser((StackableItem) entity, target, componentPoint);</span>
<span class="nc" id="L189">					chooser.show((Component) target, componentPoint);</span>
<span class="nc" id="L190">				} else {</span>
					// Dropping everything
<span class="nc" id="L192">					target.dropEntity(entity, -1, componentPoint);</span>
				}
			}
		}

<span class="nc" id="L197">		dragged.release();</span>
<span class="nc" id="L198">		dragged = null;</span>
<span class="nc" id="L199">	}</span>

	/**
	 * Determine if the user should be given a chooser popup for selecting the
	 * amount of items to be dropped.
	 *
	 * @param event the mouse event that triggered the drop
	 * @param entity dropped entity
	 *
	 * @return &lt;code&gt;true&lt;/code&gt; if a chooser should be displayed,
	 * 	&lt;code&gt;false&lt;/code&gt; otherwise
	 */
	private boolean showAmountChooser(MouseEvent event, IEntity entity) {
<span class="nc bnc" id="L212" title="All 4 branches missed.">		if (((event.getModifiersEx() &amp; (MouseEvent.CTRL_DOWN_MASK|MouseEvent.META_DOWN_MASK)) != 0)</span>
				&amp;&amp; (entity instanceof StackableItem)) {
<span class="nc bnc" id="L214" title="All 2 branches missed.">			return ((StackableItem) entity).getQuantity() &gt; 1;</span>
		}
<span class="nc" id="L216">		return false;</span>
	}

	/*
	 * (non-Javadoc)
	 * @see java.awt.event.AWTEventListener#eventDispatched(java.awt.AWTEvent)
	 */
	@Override
	public void eventDispatched(AWTEvent e) {
<span class="nc bnc" id="L225" title="All 2 branches missed.">		if (e instanceof MouseEvent) {</span>
<span class="nc" id="L226">			MouseEvent event = (MouseEvent) e;</span>

<span class="nc" id="L228">			MouseEvent converted = SwingUtilities.convertMouseEvent(event.getComponent(), event, this);</span>
<span class="nc" id="L229">			point = converted.getPoint();</span>

<span class="nc bnc" id="L231" title="All 2 branches missed.">			if (e.getID() == MouseEvent.MOUSE_DRAGGED) {</span>
<span class="nc" id="L232">				underlyingComponent = null;</span>
<span class="nc" id="L233">				requestDraw();</span>
<span class="nc bnc" id="L234" title="All 4 branches missed.">			} else if ((event.getID() == MouseEvent.MOUSE_RELEASED) &amp;&amp; (dragged != null)) {</span>
<span class="nc" id="L235">				underlyingComponent = null;</span>
<span class="nc" id="L236">				stopDrag(event);</span>
<span class="nc" id="L237">				requestDraw();</span>
<span class="nc" id="L238">				point = null;</span>
			}
			// We are interested only in DnD, so we can ignore any other events
		}
<span class="nc" id="L242">	}</span>

	/**
	 * Request drawing the component after a drag related mouse event
	 */
	private void requestDraw() {
		/*
		 * Optimize the repaints a bit. Drawing the whole layer is
		 * expensive due to the paint requests to the components below,
		 * so try to keep the drawn area small.
		 */
<span class="nc bnc" id="L253" title="All 4 branches missed.">		if ((width != 0) &amp;&amp; (height != 0)) {</span>
			/*
			 * Paint over the old occupied area. This will probably be
			 * merged with the next repaint by the RepaintManager.
			 */
<span class="nc" id="L258">			repaint(oldX, oldY, width, height);</span>
		}
<span class="nc" id="L260">		oldX = point.x;</span>
<span class="nc" id="L261">		oldY = point.y;</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">		if (dragged != null) {</span>
<span class="nc" id="L263">			width = dragged.getWidth();</span>
<span class="nc" id="L264">			height = dragged.getHeight();</span>
<span class="nc" id="L265">			repaint(point.x, point.y, width, height);</span>
		} else {
<span class="nc" id="L267">			width = 0;</span>
<span class="nc" id="L268">			height = 0;</span>
		}
<span class="nc" id="L270">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>