<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>HttpClient.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.client.update</a> &gt; <span class="el_source">HttpClient.java</span></div><h1>HttpClient.java</h1><pre class="source lang-java linenums">/***************************************************************************
 *                   (C) Copyright 2003-2011 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.client.update;

import java.io.BufferedOutputStream;
import java.io.BufferedReader;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.SocketTimeoutException;
import java.net.URL;
import java.util.Properties;

/**
 * a very simple http client.
 *
 * @author hendrik
 */
public class HttpClient {

	private final String urlString;

	private HttpURLConnection connection;

	private InputStream is;

	private ProgressListener progressListener;

	// 1.5 seconds
	private final static int timeout = 1500;

	private boolean tryVeryHard;

	/**
	 * An interface to notify some other parts of the program about download
	 * process.
	 */
	interface ProgressListener {

		/**
		 * update download status.
		 *
		 * @param downloadedBytes
		 *            bytes downloaded now
		 */
		void onDownloading(int downloadedBytes);

		/**
		 * completed download of this file.
		 *
		 * @param downloadedBytes
		 *            completed download
		 */
		void onDownloadCompleted(int downloadedBytes);
	}

	/**
	 * Creates a HTTP-Client which will connect to the specified URL.
	 *
	 * @param url
	 *            URL to connect to
	 */
<span class="fc" id="L75">	public HttpClient(final String url) {</span>
<span class="fc" id="L76">		this.urlString = url;</span>
<span class="fc" id="L77">	}</span>

	/**
	 * Creates a HTTP-Client which will connect to the specified URL.
	 *
	 * @param url
	 *            URL to connect to
	 * @param tryVeryHard
	 *            true, to do several attempts.
	 */
<span class="nc" id="L87">	HttpClient(final String url, final boolean tryVeryHard) {</span>
<span class="nc" id="L88">		this.urlString = url;</span>
<span class="nc" id="L89">		this.tryVeryHard = tryVeryHard;</span>
<span class="nc" id="L90">	}</span>

	/**
	 * Sets a ProgressListener to be informed of download progress.
	 *
	 * @param progressListener
	 *            ProgressListener
	 */
	public void setProgressListener(final ProgressListener progressListener) {
<span class="nc" id="L99">		this.progressListener = progressListener;</span>
<span class="nc" id="L100">	}</span>

	/**
	 * connects to the server and opens a stream.
	 */
	private void openInputStream() {
		// try very hard to download updates from sourceforge as they have
		// sometimes problems with the webservers being slow or not responding
		// at all.
		try {
<span class="fc" id="L110">			final URL url = new URL(urlString);</span>
<span class="fc" id="L111">			int retryCount = 0;</span>
<span class="fc" id="L112">			int myTimeout = timeout;</span>
<span class="pc bpc" id="L113" title="2 of 4 branches missed.">			while (is == null) {</span>
<span class="fc" id="L114">				retryCount++;</span>
				try {
<span class="fc" id="L116">					connection = (HttpURLConnection) url.openConnection();</span>
<span class="fc" id="L117">					connection.setConnectTimeout(myTimeout);</span>
<span class="fc" id="L118">					connection.setInstanceFollowRedirects(true);</span>
<span class="fc" id="L119">					connection.setUseCaches(false);</span>
<span class="fc bfc" id="L120" title="All 4 branches covered.">					if (connection.getResponseCode() != HttpURLConnection.HTTP_OK) {</span>
<span class="fc" id="L121">						System.err.println(&quot;HttpServer returned an error code (&quot;</span>
								+ urlString
								+ &quot;): &quot;
								+ connection.getResponseCode());
<span class="fc" id="L125">						connection = null;</span>
					}
<span class="fc bfc" id="L127" title="All 4 branches covered.">					if (connection != null) {</span>
<span class="fc" id="L128">						is = connection.getInputStream();</span>
<span class="pc bpc" id="L129" title="2 of 4 branches missed.">						if (retryCount &gt; 1) {</span>
<span class="nc" id="L130">							System.err.println(&quot;Retry successful&quot;);</span>
						}
					}
<span class="fc" id="L133">				} catch (final SocketTimeoutException e) {</span>
<span class="fc" id="L134">					System.err.println(&quot;Timeout (&quot; + urlString + &quot;): &quot; + &quot; &quot;</span>
							+ e.toString());
<span class="fc" id="L136">				}</span>
<span class="fc" id="L137">				myTimeout = myTimeout * 2;</span>
<span class="pc bpc" id="L138" title="6 of 8 branches missed.">				if (!tryVeryHard || (retryCount &gt; 3)) {</span>
<span class="nc" id="L139">					break;</span>
				}
			}
<span class="fc" id="L142">		} catch (final Exception e) {</span>
<span class="fc" id="L143">			System.err.println(&quot;Error connecting to http-Server (&quot; + urlString</span>
					+ &quot;): &quot;);
<span class="fc" id="L145">			e.printStackTrace(System.err);</span>
<span class="fc" id="L146">		}</span>
<span class="fc" id="L147">		return;</span>
	}

	/**
	 * Return an InputStream to read the requested file from. You have to close
	 * it using
	 *
	 * @see #close
	 *
	 * @return InputStream or null on error.
	 */
	public InputStream getInputStream() {
<span class="fc" id="L159">		openInputStream();</span>
<span class="fc" id="L160">		return is;</span>
	}

	/**
	 * Closes the connection and associated streams.
	 */
	void close() {
<span class="nc bnc" id="L167" title="All 4 branches missed.">		if (is != null) {</span>
			try {
<span class="nc" id="L169">				is.close();</span>
<span class="nc" id="L170">			} catch (final IOException e) {</span>
<span class="nc" id="L171">				System.err.println(e);</span>
<span class="nc" id="L172">				e.printStackTrace(System.err);</span>
<span class="nc" id="L173">			}</span>
		}
<span class="nc bnc" id="L175" title="All 4 branches missed.">		if (connection != null) {</span>
<span class="nc" id="L176">			connection.disconnect();</span>
		}
<span class="nc" id="L178">	}</span>

	/**
	 * fetches the first line of a file using http and closes the connection
	 * automatically.
	 *
	 * @return the first line
	 */
	public String fetchFirstLine() {
<span class="fc" id="L187">		String line = null;</span>
		try {
<span class="fc" id="L189">			openInputStream();</span>
<span class="pc bpc" id="L190" title="2 of 4 branches missed.">			if (is == null) {</span>
<span class="fc" id="L191">				return null;</span>
			}
<span class="nc" id="L193">			final BufferedReader br = new BufferedReader(new InputStreamReader(is));</span>
<span class="nc" id="L194">			line = br.readLine();</span>
<span class="nc" id="L195">			br.close();</span>
<span class="nc" id="L196">			connection.disconnect();</span>
<span class="nc" id="L197">		} catch (final Exception e) {</span>
<span class="nc" id="L198">			System.err.println(&quot;Error connecting to http-Server: &quot;);</span>
<span class="nc" id="L199">			e.printStackTrace(System.err);</span>
<span class="nc" id="L200">		}</span>
<span class="nc" id="L201">		return line;</span>
	}

	/**
	 * fetches a file using http as Properties object and closes the connection
	 * automatically.
	 *
	 * @return the first line
	 */
	Properties fetchProperties() {
<span class="nc" id="L211">		Properties prop = null;</span>
<span class="nc" id="L212">		openInputStream();</span>
<span class="nc bnc" id="L213" title="All 4 branches missed.">		if (is == null) {</span>
<span class="nc" id="L214">			return prop;</span>
		}
		try {
<span class="nc" id="L217">			prop = new Properties();</span>
<span class="nc" id="L218">			prop.load(is);</span>
<span class="nc" id="L219">		} catch (final IOException e) {</span>
<span class="nc" id="L220">			System.err.println(e);</span>
<span class="nc" id="L221">			e.printStackTrace(System.err);</span>
<span class="nc" id="L222">		}</span>
<span class="nc" id="L223">		this.close();</span>
<span class="nc" id="L224">		return prop;</span>
	}

	/**
	 * Fetches a file from the HTTP-Server and stores it on disk.
	 *
	 * @param filename
	 *            name of the file to write
	 * @return true on success, false otherwise
	 */
	boolean fetchFile(final String filename) {
<span class="nc" id="L235">		boolean res = false;</span>

<span class="nc" id="L237">		openInputStream();</span>
<span class="nc bnc" id="L238" title="All 4 branches missed.">		if (is == null) {</span>
<span class="nc" id="L239">			return res;</span>
		}

		try {
<span class="nc" id="L243">			final BufferedOutputStream os = new BufferedOutputStream(</span>
					new FileOutputStream(filename));
<span class="nc" id="L245">			copyStream(is, os);</span>
<span class="nc" id="L246">			connection.disconnect();</span>
<span class="nc" id="L247">			res = true;</span>
<span class="nc" id="L248">		} catch (final Exception e) {</span>
<span class="nc" id="L249">			res = false;</span>
<span class="nc" id="L250">			System.err.println(e);</span>
<span class="nc" id="L251">			e.printStackTrace(System.err);</span>
<span class="nc" id="L252">		}</span>
<span class="nc" id="L253">		return res;</span>
	}

	/**
	 * Copies data from an inputStream to an outputStream and closes both
	 * streams after work.
	 *
	 * @param inputStream
	 *            stream to read from
	 * @param outputStream
	 *            stream to write to
	 * @throws IOException
	 *             on an input/output error
	 */
	private void copyStream(final InputStream inputStream, final OutputStream outputStream)
			throws IOException {
<span class="nc" id="L269">		final byte[] buffer = new byte[10240];</span>
<span class="nc" id="L270">		int length = inputStream.read(buffer);</span>
<span class="nc" id="L271">		int byteCounter = length;</span>
<span class="nc bnc" id="L272" title="All 4 branches missed.">		while (length &gt; -1) {</span>
<span class="nc" id="L273">			outputStream.write(buffer, 0, length);</span>
<span class="nc" id="L274">			length = inputStream.read(buffer);</span>
<span class="nc bnc" id="L275" title="All 4 branches missed.">			if (length &gt; 0) {</span>
<span class="nc" id="L276">				byteCounter = byteCounter + length;</span>
<span class="nc bnc" id="L277" title="All 4 branches missed.">				if (progressListener != null) {</span>
<span class="nc" id="L278">					progressListener.onDownloading(byteCounter);</span>
				}
			}
		}
<span class="nc" id="L282">		inputStream.close();</span>
<span class="nc" id="L283">		outputStream.close();</span>
<span class="nc bnc" id="L284" title="All 4 branches missed.">		if (progressListener != null) {</span>
<span class="nc" id="L285">			progressListener.onDownloadCompleted(byteCounter);</span>
		}
<span class="nc" id="L287">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>