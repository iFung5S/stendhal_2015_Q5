<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ZekielsPracticalTestQuest.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.quests</a> &gt; <span class="el_source">ZekielsPracticalTestQuest.java</span></div><h1>ZekielsPracticalTestQuest.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.maps.quests;

import games.stendhal.common.Direction;
import games.stendhal.server.entity.npc.ConversationPhrases;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.SpeakerNPC;
import games.stendhal.server.entity.npc.action.DropItemAction;
import games.stendhal.server.entity.npc.action.ExamineChatAction;
import games.stendhal.server.entity.npc.action.IncreaseKarmaAction;
import games.stendhal.server.entity.npc.action.IncreaseXPAction;
import games.stendhal.server.entity.npc.action.MultipleActions;
import games.stendhal.server.entity.npc.action.SetQuestAction;
import games.stendhal.server.entity.npc.action.TeleportAction;
import games.stendhal.server.entity.npc.condition.AndCondition;
import games.stendhal.server.entity.npc.condition.GreetingMatchesNameCondition;
import games.stendhal.server.entity.npc.condition.NotCondition;
import games.stendhal.server.entity.npc.condition.OrCondition;
import games.stendhal.server.entity.npc.condition.PlayerHasItemWithHimCondition;
import games.stendhal.server.entity.npc.condition.QuestCompletedCondition;
import games.stendhal.server.entity.npc.condition.QuestInStateCondition;
import games.stendhal.server.entity.npc.condition.QuestNotStartedCondition;
import games.stendhal.server.entity.player.Player;
import games.stendhal.server.maps.Region;

import java.util.Arrays;
import java.util.LinkedList;
import java.util.List;

/**
 * QUEST: Zekiels practical test
 * 
 * PARTICIPANTS:
 * &lt;ul&gt;
 * &lt;li&gt; Zekiel, guardian of the wizard's tower &lt;/li&gt;
 * &lt;/ul&gt;
 * 
 * STEPS:
 * &lt;ul&gt;
 * &lt;li&gt; Zekiel the guardian asks you to bring him 6 beeswax and 2 iron to make magic candles with. &lt;/li&gt;
 * &lt;li&gt; Bring the items to Zekiel. &lt;/li&gt;
 * &lt;li&gt; You can start the practical test. &lt;/li&gt;
 * &lt;li&gt; Zekiel informs you about the test and wizards. &lt;/li&gt;
 * &lt;li&gt; You will be send to 6 levels now at which you have to choose the right creature. &lt;/li&gt;
 * &lt;li&gt; If you made the right choices, you'll be able to reach the spire everytime you want. &lt;/li&gt;  
 * &lt;/ul&gt;
 * 
 * REWARD:
 * &lt;ul&gt;
 * &lt;li&gt; 9,000 XP total &lt;/li&gt;
 * &lt;li&gt; some karma (20 total) &lt;/li&gt;
 * &lt;/ul&gt;
 * 
 * REPETITIONS:
 * &lt;ul&gt;
 * &lt;li&gt; None &lt;/li&gt;
 * &lt;/ul&gt;
 */
<span class="nc" id="L70">public class ZekielsPracticalTestQuest extends AbstractQuest {</span>

	private static final int REQUIRED_IRON = 2;

	private static final int REQUIRED_BEESWAX = 6;

	private static final String QUEST_SLOT = &quot;zekiels_practical_test&quot;;

	@Override
	public String getSlotName() {
<span class="nc" id="L80">		return QUEST_SLOT;</span>
	}

	private void prepareQuestOfferingStep() {
<span class="nc" id="L84">		final SpeakerNPC npc = npcs.get(&quot;Zekiel the guardian&quot;);</span>

		// player asks about quest when he has not started it
<span class="nc" id="L87">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES, 
				new QuestNotStartedCondition(QUEST_SLOT),
				ConversationStates.ATTENDING, 
				&quot;First you need six magic candles. Bring me six pieces of #beeswax and two pieces of #iron, &quot; +
				&quot;then I will summon the candles for you. After this you can start the practical test.&quot;,
				new SetQuestAction(QUEST_SLOT,&quot;start&quot;));
		
		// player asks about quest when he has already completed it
<span class="nc" id="L96">		npc.add(ConversationStates.ATTENDING,</span>
			ConversationPhrases.QUEST_MESSAGES,
			new QuestCompletedCondition(QUEST_SLOT),
			ConversationStates.ATTENDING, 
			&quot;You have already passed the practical test and you are free to explore this tower. I will #teleport you &quot; +
			&quot;to the spire, or I can #help you some other way.&quot;,
			null);
		
		// player asks about quest when he is in the initial bringing candles stage
<span class="nc" id="L105">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES, 
				new QuestInStateCondition(QUEST_SLOT, &quot;start&quot;),
				ConversationStates.ATTENDING, 
				&quot;You haven't brought me the #ingredients for the magic candles.&quot;,
				null);

		// player asks about quest when he is in the practical test stage
<span class="nc" id="L113">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES, 
				new QuestInStateCondition(QUEST_SLOT, &quot;candles_done&quot;),
				ConversationStates.ATTENDING, 
				&quot;You haven't finished the practical test. You can #start with it, or you can learn &quot; +
				&quot;more about the #wizards before you begin.&quot;,
				null);
		
		// we should only answer to these ingredients questions if the candles stage is not yet done
<span class="nc" id="L122">		npc.add(ConversationStates.ATTENDING,</span>
				&quot;beeswax&quot;, 
				new QuestInStateCondition(QUEST_SLOT, &quot;start&quot;),
				ConversationStates.ATTENDING, 
			    &quot;I will summon magic candles for you, but I will need beeswax for that. Beekeepers usually sell beeswax.&quot;,
			    null);
		
		// we should only answer to these ingredients questions if the candles stage is not yet done
<span class="nc" id="L130">		npc.add(ConversationStates.ATTENDING,</span>
				&quot;iron&quot;, 
				new QuestInStateCondition(QUEST_SLOT, &quot;start&quot;),
				ConversationStates.ATTENDING, 
				&quot;The candlestick needs to be made of iron. The blacksmith in Semos can help you.&quot;,
				null);
		
		// we should only answer to these ingredients questions if the candles stage is not yet done
<span class="nc" id="L138">		npc.add(ConversationStates.ATTENDING,</span>
				&quot;ingredients&quot;, 
				new QuestInStateCondition(QUEST_SLOT, &quot;start&quot;),
				ConversationStates.ATTENDING, 
				&quot;I will need six pieces of #beeswax and two pieces of #iron to summon the candles.&quot;,
				null);
<span class="nc" id="L144">	}</span>

	private void bringItemsStep() {
<span class="nc" id="L147">		final SpeakerNPC npc = npcs.get(&quot;Zekiel the guardian&quot;);</span>

		// player returns with iron but no beeswax
<span class="nc" id="L150">		npc.add(ConversationStates.IDLE, ConversationPhrases.GREETING_MESSAGES,</span>
			new AndCondition(
					new GreetingMatchesNameCondition(npc.getName()),
					new QuestInStateCondition(QUEST_SLOT,&quot;start&quot;),
					new NotCondition(new PlayerHasItemWithHimCondition(&quot;beeswax&quot;,REQUIRED_BEESWAX)),
					new PlayerHasItemWithHimCondition(&quot;iron&quot;,REQUIRED_IRON)),
			ConversationStates.ATTENDING, 
			&quot;Greetings, I see you have the iron, but I still need six pieces of beeswax. Please come back when you &quot; +
			&quot;have all #ingredients with you.&quot;, 
			null);

		// player returns with beeswax but no iron
<span class="nc" id="L162">		npc.add(ConversationStates.IDLE, ConversationPhrases.GREETING_MESSAGES,</span>
			new AndCondition(
					new GreetingMatchesNameCondition(npc.getName()),
					new QuestInStateCondition(QUEST_SLOT,&quot;start&quot;),
					new NotCondition(new PlayerHasItemWithHimCondition(&quot;iron&quot;,REQUIRED_IRON)),
					new PlayerHasItemWithHimCondition(&quot;beeswax&quot;,REQUIRED_BEESWAX)),
			ConversationStates.ATTENDING, 
			&quot;Greetings, I see you have the beeswax, but I still need two pieces of iron. Please come back when you &quot; +
			&quot;have all #ingredients with you.&quot;, 
			null);
		
		//player returns with beeswax and iron
<span class="nc" id="L174">		npc.add(ConversationStates.IDLE, ConversationPhrases.GREETING_MESSAGES,</span>
			new AndCondition(
					new GreetingMatchesNameCondition(npc.getName()),
					new QuestInStateCondition(QUEST_SLOT,&quot;start&quot;),
					new PlayerHasItemWithHimCondition(&quot;iron&quot;,REQUIRED_IRON),
					new PlayerHasItemWithHimCondition(&quot;beeswax&quot;,REQUIRED_BEESWAX)),
			ConversationStates.ATTENDING,
			&quot;Greetings, finally you have brought me all ingredients that I need to summon the magic candles. Now you &quot; +
			&quot;can #start with the practical test.&quot;,
			new MultipleActions(
					new SetQuestAction(QUEST_SLOT,&quot;candles_done&quot;),
					new DropItemAction(&quot;beeswax&quot;, 6),
					new DropItemAction(&quot;iron&quot;, 2),
					new IncreaseXPAction(4000),
					new IncreaseKarmaAction(10)));

		// player returned after climbing the tower partially. reset status to candles done and start again
<span class="nc" id="L191">		npc.add(ConversationStates.IDLE, ConversationPhrases.GREETING_MESSAGES,</span>
				new AndCondition(new GreetingMatchesNameCondition(npc.getName()),
						new OrCondition(
								new QuestInStateCondition(QUEST_SLOT,&quot;first_step&quot;),
								new QuestInStateCondition(QUEST_SLOT,&quot;second_step&quot;),
								new QuestInStateCondition(QUEST_SLOT,&quot;third_step&quot;),
								new QuestInStateCondition(QUEST_SLOT,&quot;fourth_step&quot;),
								new QuestInStateCondition(QUEST_SLOT,&quot;fifth_step&quot;),
								new QuestInStateCondition(QUEST_SLOT,&quot;sixth_step&quot;),
								new QuestInStateCondition(QUEST_SLOT,&quot;last_step&quot;))),
			ConversationStates.ATTENDING, 
			&quot;Greetings! You have so far failed the practical test. Tell me, if you want me to #send you on it again &quot; +
			&quot;right now, or if there is anything you want to #learn about it first.&quot;,
			new SetQuestAction(QUEST_SLOT, &quot;candles_done&quot;));
<span class="nc" id="L205">	}</span>

	private void practicalTestStep() {
<span class="nc" id="L208">		final SpeakerNPC npc = npcs.get(&quot;Zekiel the guardian&quot;);</span>

		// player returns after bringing the candles but hasn't tried to climb tower
<span class="nc" id="L211">		npc.add(ConversationStates.IDLE, </span>
			ConversationPhrases.GREETING_MESSAGES,
			new AndCondition(new GreetingMatchesNameCondition(npc.getName()),
					new QuestInStateCondition(QUEST_SLOT,&quot;candles_done&quot;)),
			ConversationStates.ATTENDING, 
			&quot;Greetings, I suppose you came back to #start with the practical test.&quot;,
			null);

		// player asks to start the practical part of the quest
<span class="nc" id="L220">		npc.add(ConversationStates.ATTENDING,</span>
			&quot;start&quot;,
			new QuestInStateCondition(QUEST_SLOT,&quot;candles_done&quot;),
			ConversationStates.ATTENDING, 
			&quot;First you should #know some important things about the test and the wizards. &quot; +
			&quot;I will #send you to the first step, if you are ready.&quot;,
			null);

		// player wants to know how the practical quest works
<span class="nc" id="L229">		npc.add(ConversationStates.ATTENDING,</span>
			Arrays.asList(&quot;know&quot;, &quot;learn&quot;),
			new QuestInStateCondition(QUEST_SLOT,&quot;candles_done&quot;),
			ConversationStates.ATTENDING, 
			&quot;At each step there is a northern, southern, eastern and western cell, which contains a creature.&quot; +
			&quot; Choose the creature, that you associate with the #wizards domain and history, by using the magical spot&quot; +
			&quot; between the two warlock statues in front of the cell. Don't worry, you don't have to fight the creature&quot; +
			&quot; that you choose. If you choose wisely, then I will summon a candle for you, if not you will be teleported&quot; +
			&quot; back to me. Use the candle at the shimmering corner of the hexagramm and the step is done. If you want to&quot; +
			&quot; leave the practical test, just use the magical spot in the middle of the hexagramm.&quot; +
			&quot; So if you think are ready, I will #send you to the first step.&quot;,
			null);
		
		// player asks about wizards: give him a parchment of information. 
		// this overrides the normal answer to wizards if the player is in the correct quest slot
<span class="nc" id="L244">		npc.add(ConversationStates.ATTENDING,</span>
				&quot;wizards&quot;,
				new QuestInStateCondition(QUEST_SLOT,&quot;candles_done&quot;),
				ConversationStates.ATTENDING, 
				&quot;Take this parchment with hints about the seven wizards, you will need it at each step I #send you on. &quot; +
				&quot;Listen for my message telling you whose domain you entered, at each step, or you cannot choose the correct creature.&quot;,
				new ExamineChatAction(&quot;wizards-parchment.png&quot;, &quot;Parchment&quot;, &quot;The wizards circle&quot;));

		// incase the player still has candles, remove them from him
<span class="nc" id="L253">		npc.add(ConversationStates.ATTENDING,</span>
			&quot;send&quot;,
			new AndCondition(
					new QuestInStateCondition(QUEST_SLOT,&quot;candles_done&quot;),
					new PlayerHasItemWithHimCondition(&quot;candle&quot;)),
			ConversationStates.ATTENDING, 
			&quot;Before I can send you on the first step, you have to drop any candles you are carrying.&quot;,
			null);

		// send the player, so long as he doesn't not have candles, and record which step he is on
<span class="nc" id="L263">		npc.add(ConversationStates.ATTENDING,</span>
			&quot;send&quot;,
			new AndCondition(
					new QuestInStateCondition(QUEST_SLOT,&quot;candles_done&quot;),
					new NotCondition(new PlayerHasItemWithHimCondition(&quot;candle&quot;))),
			ConversationStates.IDLE, 
			null,
			new MultipleActions(
					new SetQuestAction(QUEST_SLOT, &quot;first_step&quot;),
					new TeleportAction(&quot;int_semos_wizards_tower_1&quot;, 15, 16, Direction.DOWN)));
<span class="nc" id="L273">	}</span>

	private void finishQuestStep() {
		
		// NOTE: this is a different NPC from Zekiel the guardian used above. This one 'finishes' the quest
		// and is in int_semos_wizards_tower_7, not the basement.
<span class="nc" id="L279">		final SpeakerNPC npc = npcs.get(&quot;Zekiel&quot;);</span>

		// player got to the last level of the tower
<span class="nc" id="L282">		npc.add(ConversationStates.IDLE, </span>
			ConversationPhrases.GREETING_MESSAGES,
			new AndCondition(new GreetingMatchesNameCondition(npc.getName()),
					new QuestInStateCondition(QUEST_SLOT,&quot;last_step&quot;)),
			ConversationStates.ATTENDING, 
			&quot;Very well, adventurer! You have passed the practical test. You can now enter the spire whenever you want.&quot;,
			new MultipleActions(
				new IncreaseXPAction(5000),
				new IncreaseKarmaAction(10),
				new SetQuestAction(QUEST_SLOT, &quot;done&quot;)));
<span class="nc" id="L292">	}</span>

	private void questFinished() {
		
		// this is the basement level normal Zekiel the guardian again
<span class="nc" id="L297">		final SpeakerNPC npc = npcs.get(&quot;Zekiel the guardian&quot;);</span>

		// player returns having completed the quest
<span class="nc" id="L300">		npc.add(ConversationStates.IDLE, ConversationPhrases.GREETING_MESSAGES,</span>
			new AndCondition(new GreetingMatchesNameCondition(npc.getName()),
					new QuestCompletedCondition(QUEST_SLOT)),
			ConversationStates.ATTENDING, 
			&quot;Greetings adventurer, how can I #help you this time?&quot;,
			null);
		
		// player asks for help, having completed the quest
<span class="nc" id="L308">		npc.add(ConversationStates.ATTENDING, </span>
			ConversationPhrases.HELP_MESSAGES,
			new QuestCompletedCondition(QUEST_SLOT),
			ConversationStates.ATTENDING,
			&quot;I can #teleport you to the spire and I am also the #storekeeper of the #wizards tower.&quot;,
			null);

		// player asks about the store, having completed the quest
<span class="nc" id="L316">		npc.add(ConversationStates.ATTENDING,</span>
			&quot;storekeeper&quot;,
			new QuestCompletedCondition(QUEST_SLOT),
			ConversationStates.ATTENDING,
			&quot;The store is at the floor under the spire. I will be there when you enter it.&quot;,
			null);

		// send a player who has completed the quest to the top spire
<span class="nc" id="L324">		npc.add(ConversationStates.ATTENDING,</span>
			&quot;teleport&quot;,
			new QuestCompletedCondition(QUEST_SLOT),
			ConversationStates.IDLE, null,
			new TeleportAction(&quot;int_semos_wizards_tower_8&quot;, 21, 22, Direction.UP));

		// player who has completed quest asks about the tower or test, offer the teleport or help
<span class="nc" id="L331">		npc.add(ConversationStates.ATTENDING,</span>
			Arrays.asList(&quot;tower&quot;, &quot;test&quot;),
			new QuestCompletedCondition(QUEST_SLOT),
			ConversationStates.ATTENDING,
			&quot;You have already passed the practical test and you are free to explore this tower. I will #teleport you to the spire, or can I #help you some other way?&quot;,
			null);
<span class="nc" id="L337">	}</span>

	@Override
	public void addToWorld() {
<span class="nc" id="L341">		fillQuestInfo(</span>
				&quot;Zekiels Practical Test&quot;,
				&quot;Zekiel, the guardian of the magic tower, knows all about the wizards domain and history.&quot;,
				true);
		
<span class="nc" id="L346">		prepareQuestOfferingStep();</span>
<span class="nc" id="L347">		bringItemsStep();</span>
<span class="nc" id="L348">		practicalTestStep();</span>
<span class="nc" id="L349">		finishQuestStep();</span>
<span class="nc" id="L350">		questFinished();</span>
<span class="nc" id="L351">	}</span>

	@Override
	public List&lt;String&gt; getHistory(final Player player) {
<span class="nc" id="L355">		LinkedList&lt;String&gt; history = new LinkedList&lt;String&gt;();</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">		if (!player.hasQuest(QUEST_SLOT)) {</span>
<span class="nc" id="L357">			return history;</span>
		}
<span class="nc" id="L359">		final String questState = player.getQuest(QUEST_SLOT);</span>
<span class="nc" id="L360">		history.add(&quot;I entered the Wizards Circle tower. Zekiel the guardian asked me for items to make magic candles.&quot;);</span>
<span class="nc bnc" id="L361" title="All 12 branches missed.">		if (questState.equals(&quot;start&quot;) &amp;&amp; player.isEquipped(&quot;beeswax&quot;, REQUIRED_BEESWAX) &amp;&amp; player.isEquipped(&quot;iron&quot;, REQUIRED_IRON)</span>
				|| questState.equals(&quot;candles_done&quot;) || questState.endsWith(&quot;_step&quot;) || questState.equals(&quot;done&quot;)) {
<span class="nc" id="L363">			history.add(&quot;I collected beeswax and iron for the magic candles which I will find on the next steps, if I pass each test.&quot;);</span>
		}
<span class="nc bnc" id="L365" title="All 2 branches missed.">		if (questState.endsWith(&quot;_step&quot;)) {</span>
<span class="nc" id="L366">			history.add(&quot;I have reached the &quot; + questState.replace(&quot;_&quot;, &quot; &quot;) + &quot; of the Wizards Circle Tower. Zekiel will teach me what I have to do here.&quot;);</span>
		}
<span class="nc bnc" id="L368" title="All 2 branches missed.">		if (questState.equals(&quot;done&quot;)) {</span>
<span class="nc" id="L369">			history.add(&quot;I completed the Practical Test and can enter the spire or visit the store.&quot;);</span>
		}
<span class="nc" id="L371">		return history;</span>
	}

	@Override
	public String getName() {
<span class="nc" id="L376">		return &quot;ZekielsPracticalTest&quot;;</span>
	}

	@Override
	public String getNPCName() {
<span class="nc" id="L381">		return &quot;Zekiel the guardian&quot;;</span>
	}
	
	@Override
	public String getRegion() {
<span class="nc" id="L386">		return Region.SEMOS_SURROUNDS;</span>
	}
	
	@Override
	public int getMinLevel() {
<span class="nc" id="L391">		return 30;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>