<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Maze.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.quests</a> &gt; <span class="el_source">Maze.java</span></div><h1>Maze.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.maps.quests;

import games.stendhal.common.Direction;
import games.stendhal.common.MathHelper;
import games.stendhal.common.parser.Sentence;
import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.core.engine.StendhalRPZone;
import games.stendhal.server.entity.mapstuff.portal.Portal;
import games.stendhal.server.entity.npc.ChatAction;
import games.stendhal.server.entity.npc.ConversationPhrases;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.EventRaiser;
import games.stendhal.server.entity.npc.SpeakerNPC;
import games.stendhal.server.entity.npc.action.SayTimeRemainingAction;
import games.stendhal.server.entity.npc.action.SetQuestAction;
import games.stendhal.server.entity.npc.action.SetQuestToTimeStampAction;
import games.stendhal.server.entity.npc.condition.NotCondition;
import games.stendhal.server.entity.npc.condition.TimePassedCondition;
import games.stendhal.server.entity.player.Player;
import games.stendhal.server.maps.Region;
import games.stendhal.server.maps.quests.maze.MazeGenerator;
import games.stendhal.server.maps.quests.maze.MazeSign;

import java.util.ArrayList;
import java.util.List;

<span class="fc" id="L39">public class Maze extends AbstractQuest {</span>
	/** Minimum time between repeats. */
	private static final int COOLING_TIME = MathHelper.MINUTES_IN_ONE_HOUR * 24;
	private MazeSign sign;
<span class="fc" id="L43">	private MazeGenerator maze = null;</span>
	
	@Override
	public void addToWorld() {
<span class="fc" id="L47">		fillQuestInfo(</span>
				&quot;Maze&quot;,
				&quot;Haizen's maze is a great challenge for path finders.&quot;,
				false);
<span class="fc" id="L51">		addMazeSign();</span>
<span class="fc" id="L52">		setupConversation();</span>
<span class="fc" id="L53">	}</span>
	
	@Override
	public List&lt;String&gt; getHistory(final Player player) {
<span class="nc" id="L57">			final List&lt;String&gt; res = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L58" title="All 2 branches missed.">			if (!player.hasQuest(getSlotName())) {</span>
<span class="nc" id="L59">				return res;</span>
			}
<span class="nc" id="L61">			res.add(&quot;Haizen created a magical maze for me to solve.&quot;);</span>

<span class="nc bnc" id="L63" title="All 2 branches missed.">			if (player.getZone().getName().endsWith(&quot;_maze&quot;)) {</span>
<span class="nc" id="L64">				res.add(&quot;I am currently trapped in the maze.&quot;);</span>
			} else {
<span class="nc bnc" id="L66" title="All 2 branches missed.">				if (!isCompleted(player)) {</span>
<span class="nc" id="L67">					res.add(&quot;I couldn't solve the last maze.&quot;);</span>
				} else {
<span class="nc" id="L69">					res.add(&quot;I solved the maze!&quot;);</span>
				}
<span class="nc bnc" id="L71" title="All 2 branches missed.">				if (isRepeatable(player)) {</span>
<span class="nc" id="L72">					res.add(&quot;I could have another try to solve a maze now.&quot;);</span>
				} else {
<span class="nc" id="L74">					res.add(&quot;Haizen won't make me a new maze yet.&quot;);</span>
				}
			}
<span class="nc" id="L77">			final int repetitions = player.getNumberOfRepetitions(getSlotName(), 2);</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">			if (repetitions &gt; 1) {</span>
<span class="nc" id="L79">				res.add(&quot;So far I've solved the maze &quot; + repetitions + &quot; times already!&quot;);</span>
			}

<span class="nc" id="L82">			return res;</span>
	}

	@Override
	public String getName() {
<span class="nc" id="L87">		return &quot;Maze&quot;;</span>
	}

	@Override
	public String getSlotName() {
<span class="fc" id="L92">		return &quot;maze&quot;;</span>
	}
	
	@Override
	public boolean isRepeatable(Player player) {
<span class="nc" id="L97">		return new TimePassedCondition(getSlotName(), 1, COOLING_TIME).fire(player, null, null);</span>
	}
	
	private SpeakerNPC getNPC() {
<span class="fc" id="L101">		return npcs.get(&quot;Haizen&quot;);</span>
	}
	
	private void addMazeSign() {
<span class="fc" id="L105">		setSign(new MazeSign());</span>
<span class="fc" id="L106">		getSign().setPosition(10, 7);</span>
<span class="fc" id="L107">		getNPC().getZone().add(getSign());</span>
<span class="fc" id="L108">	}</span>
	
	private void setupConversation() {
<span class="fc" id="L111">		SpeakerNPC npc = getNPC();</span>
		
<span class="fc" id="L113">		npc.addQuest(&quot;I can send you to a #maze you need to find your way out. I keep the a list of the fast and frequent maze solvers in that blue book on the table.&quot;);</span>
	
<span class="fc" id="L115">		npc.add(ConversationStates.ATTENDING,</span>
				&quot;maze&quot;,
				new TimePassedCondition(getSlotName(), 1, COOLING_TIME),
				ConversationStates.QUEST_OFFERED,
				&quot;There will be a portal out in the opposite corner of the maze. I'll also add scrolls to the two other corners you can try to get if you are fast enough. Do you want to try?&quot;,
				null);
		
<span class="fc" id="L122">		npc.add(ConversationStates.ATTENDING,</span>
				&quot;maze&quot;,
				new NotCondition(new TimePassedCondition(getSlotName(), 1, COOLING_TIME)),
				ConversationStates.ATTENDING,
				null,
				new SayTimeRemainingAction(getSlotName(), 1, 
						COOLING_TIME, &quot;I can send you to the maze only once in a day. You can go there again in&quot;));

<span class="fc" id="L130">		npc.add(ConversationStates.QUEST_OFFERED,</span>
				ConversationPhrases.YES_MESSAGES,
				null,
				ConversationStates.IDLE,
				null,
				new SendToMazeChatAction());
		
<span class="fc" id="L137">		npc.add(ConversationStates.QUEST_OFFERED,</span>
				ConversationPhrases.NO_MESSAGES,
				null,
				ConversationStates.ATTENDING,
				&quot;OK. You look like you'd only get lost anyway.&quot;,
				null);
<span class="fc" id="L143">	}</span>
	
	private void setSign(MazeSign sign) {
<span class="fc" id="L146">		this.sign = sign;</span>
<span class="fc" id="L147">	}</span>

	public MazeSign getSign() {
<span class="fc" id="L150">		return sign;</span>
	}

<span class="fc" id="L153">	private class SendToMazeChatAction implements ChatAction {</span>
<span class="fc" id="L154">		public SendToMazeChatAction() {</span>
			// empty constructor to prevent warning
<span class="fc" id="L156">		}</span>

		@Override
		public void fire(final Player player, final Sentence sentence, final EventRaiser raiser) {
<span class="fc" id="L160">			maze = new MazeGenerator(player.getName() + &quot;_maze&quot;, 128, 128);</span>
<span class="fc" id="L161">			maze.setReturnLocation(player.getZone().getName(), player.getX(), player.getY());</span>
<span class="fc" id="L162">			maze.setSign(getSign());</span>
<span class="fc" id="L163">			StendhalRPZone zone = maze.getZone();</span>
<span class="fc" id="L164">			SingletonRepository.getRPWorld().addRPZone(zone);</span>
<span class="fc" id="L165">			new SetQuestAction(getSlotName(), 0, &quot;start&quot;).fire(player, sentence, raiser);</span>
<span class="fc" id="L166">			new SetQuestToTimeStampAction(getSlotName(), 1).fire(player, sentence, raiser);</span>
<span class="fc" id="L167">			maze.startTiming();</span>
<span class="fc" id="L168">			player.teleport(zone, maze.getStartPosition().x, maze.getStartPosition().y, Direction.DOWN, player);</span>
<span class="fc" id="L169">		}</span>
	}

	/**
	 * Access the portal from MazeTest.
	 * 
	 * @return return portal from the maze
	 */
	protected Portal getPortal() {
<span class="fc" id="L178">		return maze.getPortal();</span>
	}

	@Override
	public String getNPCName() {
<span class="nc" id="L183">		return &quot;Haizen&quot;;</span>
	}
	
	@Override
	public String getRegion() {
<span class="nc" id="L188">		return Region.ADOS_SURROUNDS;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>