<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MeetMarieHenri.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.quests</a> &gt; <span class="el_source">MeetMarieHenri.java</span></div><h1>MeetMarieHenri.java</h1><pre class="source lang-java linenums">package games.stendhal.server.maps.quests;

import games.stendhal.common.parser.ConversationParser;
import games.stendhal.common.parser.Expression;
import games.stendhal.common.parser.JokerExprMatcher;
import games.stendhal.common.parser.Sentence;
import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.entity.item.Item;
import games.stendhal.server.entity.npc.ChatAction;
import games.stendhal.server.entity.npc.ConversationPhrases;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.EventRaiser;
import games.stendhal.server.entity.npc.SpeakerNPC;
import games.stendhal.server.entity.npc.action.SetQuestAction;
import games.stendhal.server.entity.npc.action.SetQuestAndModifyKarmaAction;
import games.stendhal.server.entity.npc.condition.AndCondition;
import games.stendhal.server.entity.npc.condition.NotCondition;
import games.stendhal.server.entity.npc.condition.QuestInStateCondition;
import games.stendhal.server.entity.player.Player;
import games.stendhal.server.maps.Region;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

/**
 * QUEST: Meet Marie-Henri
 * &lt;p&gt;
 *
 * PARTICIPANTS:
 * &lt;ul&gt;
 * &lt;li&gt;Marie-Henrie, the famous french writer in Ados library&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * STEPS:
 * &lt;ul&gt;
 * &lt;li&gt;Marie-Henri asks you to find out the pseudonym he uses when writing
 * novels&lt;/li&gt;
 * &lt;li&gt;Find out the pseudonym (the Wikipedian might help)&lt;/li&gt;
 * &lt;li&gt;Name the pseudonym to Marie-Henrie&lt;/li&gt;
 * &lt;li&gt;Marie-Henri gives you a reward&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * REWARD:
 * &lt;ul&gt;
 * &lt;li&gt;Karma +5&lt;/li&gt;
 * &lt;li&gt;An empty scroll&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * REPETITIONS:
 * &lt;ul&gt;
 * &lt;li&gt;No repetitions.&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * @author RedQueen
 */
<span class="fc" id="L57">public class MeetMarieHenri extends AbstractQuest {</span>

	public static final String QUEST_SLOT = &quot;meet_marie_henri&quot;;

	@Override
	public void addToWorld() {
<span class="fc" id="L63">		fillQuestInfo(&quot;Meet Marie-Henri&quot;,</span>
				&quot;A famous French writer tests general knowledge in Ados Library.&quot;,
				false);
<span class="fc" id="L66">		createSteps();</span>
<span class="fc" id="L67">	}</span>

	@Override
	public String getSlotName() {
<span class="nc" id="L71">		return QUEST_SLOT;</span>
	}

	@Override
	public String getName() {
<span class="nc" id="L76">		return &quot;MeetMarieHenri&quot;;</span>
	}

	@Override
	public String getRegion() {
<span class="nc" id="L81">		return Region.ADOS_CITY;</span>
	}
	
	@Override
	public String getNPCName() {
<span class="nc" id="L86">		return &quot;Marie-Henri&quot;;</span>
	}
	
	@Override
	public List&lt;String&gt; getHistory(final Player player) {
<span class="nc" id="L91">		final List&lt;String&gt; res = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">		if (!player.hasQuest(QUEST_SLOT)) {</span>
<span class="nc" id="L93">			return res;</span>
		}
<span class="nc" id="L95">		res.add(&quot;I met Marie-Henri in Ados library.&quot;);</span>
<span class="nc" id="L96">		final String questState = player.getQuest(QUEST_SLOT);</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">		if (&quot;rejected&quot;.equals(questState)) {</span>
<span class="nc" id="L98">			res.add(&quot;He asked me to find out the pseudonym he uses when writing his novels. But I don't feel smart enough for such a big task.&quot;);</span>
		}
<span class="nc bnc" id="L100" title="All 4 branches missed.">		if (&quot;start&quot;.equals(questState) || &quot;done&quot;.equals(questState)) {</span>
<span class="nc" id="L101">			res.add(&quot;I will try to find out the pseudonym he uses when writing his novels.&quot;);</span>
		}
<span class="nc bnc" id="L103" title="All 2 branches missed.">		if (&quot;done&quot;.equals(questState)) {</span>
<span class="nc" id="L104">			res.add(&quot;I answered the question correctly and Marie-Henri gave me a nice reward.&quot;);</span>
		}
<span class="nc" id="L106">		return res;</span>
	}

	private void createSteps() {
		// player is asking for a quest
<span class="fc" id="L111">		SpeakerNPC npc = npcs.get(&quot;Marie-Henri&quot;);</span>


		// TODO: rewrite this to use standard conditions and actions
<span class="fc" id="L115">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES, null,
<span class="fc" id="L117">				ConversationStates.QUEST_OFFERED, null, new ChatAction() {</span>
					@Override
					public void fire(final Player player,
							final Sentence sentence, final EventRaiser npc) {
<span class="fc" id="L121">						final String questState = player.getQuest(QUEST_SLOT);</span>
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">						if (&quot;done&quot;.equals(questState)) {</span>
<span class="nc" id="L123">							npc.say(&quot;I already know you are a smart one. I do not have another task for you to solve at the moment.&quot;);</span>
<span class="nc" id="L124">							npc.setCurrentState(ConversationStates.ATTENDING);</span>
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">						} else if (&quot;start&quot;.equals(questState)) {</span>
<span class="nc" id="L126">							npc.say(&quot;Have you already found out my pseudonym?&quot;);</span>
<span class="nc" id="L127">							npc.setCurrentState(ConversationStates.QUESTION_1);</span>
						} else {
<span class="fc" id="L129">							npc.say(&quot;I am currently testing the general knowledge of the adventurers around here. &quot;</span>
									+ &quot;If you are able to tell me the #pseudonym I am using for my novels, I'll reward you. &quot;
									+ &quot;Do you feel smart enough for that?&quot;);
						}
<span class="fc" id="L133">					}</span>
				});

		// player accepts quest
<span class="fc" id="L137">		npc.add(ConversationStates.QUEST_OFFERED,</span>
				ConversationPhrases.YES_MESSAGES,
				null,
				ConversationStates.IDLE,
				&quot;Fine! Think about the question and visit me again when you think you know the answer.&quot;,
				new SetQuestAction(QUEST_SLOT, &quot;start&quot;));

		// player rejects quest
<span class="fc" id="L145">		npc.add(ConversationStates.QUEST_OFFERED,</span>
				ConversationPhrases.NO_MESSAGES,
				null,
				ConversationStates.IDLE,
				&quot;So you don't even want to try solving this easy task... How disappointing.&quot;,
				new SetQuestAndModifyKarmaAction(QUEST_SLOT, &quot;rejected&quot;, -5.0));

		// player asks for 'pseudonym' when asked to accept quest
<span class="fc" id="L153">		npc.add(ConversationStates.QUEST_OFFERED,</span>
				&quot;pseudonym&quot;,
				null,
				ConversationStates.QUEST_OFFERED,
				&quot;I do not sign my works with my real name, I use a 'pen name'. So will you try to solve that task?&quot;,
				null);

		// player wants to answer the question
<span class="fc" id="L161">		npc.add(ConversationStates.ATTENDING,</span>
				Arrays.asList(&quot;pseudonym&quot;, &quot;answer&quot;, &quot;question&quot;),
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, &quot;start&quot;), new NotCondition(new QuestInStateCondition(QUEST_SLOT, &quot;done&quot;))),
				ConversationStates.QUESTION_1,
				&quot;Have you already found out my pseudonym?&quot;, null);

		// player says 'yes' when asked if he knows the correct answer
<span class="fc" id="L168">		npc.add(ConversationStates.QUESTION_1,</span>
				ConversationPhrases.YES_MESSAGES, null,
				ConversationStates.QUESTION_2, &quot;So, what is it?&quot;, null);

		// player says 'no' when asked if he knows the correct answer
<span class="fc" id="L173">		npc.add(ConversationStates.QUESTION_1,</span>
				ConversationPhrases.NO_MESSAGES,
				null,
				ConversationStates.IDLE,
				&quot;Take your time to think about it. Follow the #hints around you to find the answer.&quot;,
				null);

		// player asks for hints
<span class="fc" id="L181">		npc.add(ConversationStates.ATTENDING, Arrays.asList(&quot;hint&quot;, &quot;hints&quot;),</span>
				new QuestInStateCondition(QUEST_SLOT, &quot;start&quot;),
				ConversationStates.ATTENDING,
				&quot;Maybe the books on that table will give you a clue...&quot;, null);

		// analyzing the answer

		// TODO: rewrite this to use standard conditions and actions
<span class="fc" id="L189">		npc.addMatching(ConversationStates.QUESTION_2, Expression.JOKER,</span>
				new JokerExprMatcher(), null, ConversationStates.ATTENDING,
<span class="fc" id="L191">				null, new ChatAction() {</span>
					@Override
					public void fire(final Player player,
							final Sentence sentence, final EventRaiser npc) {
<span class="nc" id="L195">						final Sentence answer = sentence.parseAsMatchingSource();</span>
<span class="nc" id="L196">						final Sentence expected = ConversationParser.parse(&quot;stendhal&quot;);</span>
<span class="nc" id="L197">						final Sentence lastname = ConversationParser.parse(&quot;Beyle&quot;);</span>

<span class="nc bnc" id="L199" title="All 2 branches missed.">						if (answer.matchesFull(expected)) {</span>
							// answer is correct -&gt; get reward
<span class="nc" id="L201">							npc.say(&quot;Yes, that's it! Here, take this empty sheet of paper as a reward. It is the most valuable item for thinkers like us.&quot;);</span>
<span class="nc" id="L202">							final Item reward = SingletonRepository</span>
									.getEntityManager().getItem(&quot;empty scroll&quot;);
<span class="nc" id="L204">							reward.setBoundTo(player.getName());</span>
<span class="nc" id="L205">							player.equipOrPutOnGround(reward);</span>
<span class="nc" id="L206">							player.addXP(200);</span>
<span class="nc" id="L207">							player.setQuest(QUEST_SLOT, &quot;done&quot;);</span>
<span class="nc" id="L208">							player.notifyWorldAboutChanges();</span>
<span class="nc" id="L209">							npc.setCurrentState(ConversationStates.IDLE);</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">						} else if (answer.matchesFull(lastname)) {</span>
							// player says 'Beyle'
<span class="nc" id="L212">							npc.say(&quot;You are on the right way. But I asked for my pseudonym, not for my last name.&quot;);</span>
<span class="nc" id="L213">							npc.setCurrentState(ConversationStates.IDLE);</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">						} else if (ConversationPhrases.GOODBYE_MESSAGES</span>
								.contains(sentence.getTriggerExpression()
										.getNormalized())) {
							// player says 'bye'
<span class="nc" id="L218">							npc.say(&quot;Au revoir!&quot;);</span>
<span class="nc" id="L219">							npc.setCurrentState(ConversationStates.IDLE);</span>
						} else {
							// answer is not correct
<span class="nc" id="L222">							npc.say(&quot;No, that is not correct. Follow the #hints around you to find the answer.&quot;);</span>
<span class="nc" id="L223">							npc.setCurrentState(ConversationStates.IDLE);</span>
						}
<span class="nc" id="L225">					}</span>
				});
<span class="fc" id="L227">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>