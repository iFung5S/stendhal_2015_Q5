<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>KoboldishTorcibud.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.quests</a> &gt; <span class="el_source">KoboldishTorcibud.java</span></div><h1>KoboldishTorcibud.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/

package games.stendhal.server.maps.quests;
 
import games.stendhal.common.MathHelper;
import games.stendhal.common.Rand;
import games.stendhal.common.grammar.Grammar;
import games.stendhal.common.parser.Sentence;
import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.entity.item.StackableItem;
import games.stendhal.server.entity.npc.ChatAction;
import games.stendhal.server.entity.npc.ConversationPhrases;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.EventRaiser;
import games.stendhal.server.entity.npc.SpeakerNPC;
import games.stendhal.server.entity.npc.action.CollectRequestedItemsAction;
import games.stendhal.server.entity.npc.action.DecreaseKarmaAction;
import games.stendhal.server.entity.npc.action.IncreaseKarmaAction;
import games.stendhal.server.entity.npc.action.IncreaseXPAction;
import games.stendhal.server.entity.npc.action.MultipleActions;
import games.stendhal.server.entity.npc.action.SayRequiredItemsFromCollectionAction;
import games.stendhal.server.entity.npc.action.SayTimeRemainingUntilTimeReachedAction;
import games.stendhal.server.entity.npc.action.SetQuestAction;
import games.stendhal.server.entity.npc.action.SetQuestToFutureRandomTimeStampAction;
import games.stendhal.server.entity.npc.condition.AndCondition;
import games.stendhal.server.entity.npc.condition.GreetingMatchesNameCondition;
import games.stendhal.server.entity.npc.condition.NotCondition;
import games.stendhal.server.entity.npc.condition.OrCondition;
import games.stendhal.server.entity.npc.condition.QuestActiveCondition;
import games.stendhal.server.entity.npc.condition.QuestCompletedCondition;
import games.stendhal.server.entity.npc.condition.QuestInStateCondition;
import games.stendhal.server.entity.npc.condition.QuestNotActiveCondition;
import games.stendhal.server.entity.npc.condition.QuestNotCompletedCondition;
import games.stendhal.server.entity.npc.condition.QuestNotInStateCondition;
import games.stendhal.server.entity.npc.condition.QuestNotStartedCondition;
import games.stendhal.server.entity.npc.condition.TimeReachedCondition;
import games.stendhal.server.entity.player.Player;
import games.stendhal.server.maps.Region;
import games.stendhal.server.util.ItemCollection;
import games.stendhal.server.util.TimeUtil;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Map;

import marauroa.common.game.IRPZone;

import org.apache.log4j.Logger;

/**
 * QUEST: V.S.O.P. Koboldish Torcibud
 * &lt;p&gt;
 * PARTICIPANTS: &lt;ul&gt;&lt;li&gt; Wrviliza, the Kobold Barmaid in Wo'fol bar &lt;/ul&gt;
 * &lt;p&gt;
 * STEPS: &lt;ul&gt;&lt;li&gt; Wrviliza will ask some items and ingredients 
 * to refurbish her stock of supplies for making her famous koboldish torcibud
 * &lt;li&gt; gather the items and ingredients and bring them to the bar
 * &lt;li&gt; some bottles of V.S.O.P. Koboldish Torcibud will be put on the bar counter
 * &lt;li&gt; drinking a bottle of V.S.O.P. Koboldish Torcibud will heal lost HP
 * &lt;li&gt; accepting the quest grants some Karma
 * &lt;li&gt; rejecting the quest wastes some Karma
 * &lt;/ul&gt;
 * &lt;p&gt;
 * REWARD:
 * &lt;ul&gt;
 * &lt;li&gt; healing V.S.O.P. Koboldish Torcibud
 * &lt;li&gt; 500 XP
 * &lt;li&gt; some karma (20 + (20 | -20))
 * &lt;/ul&gt;
 * &lt;p&gt;
 * REPETITIONS: &lt;ul&gt;&lt;li&gt; unlimited
 * &lt;li&gt;once every 3 to 6 days (randomly determined at quest completion time&lt;/ul&gt;
 *
 * @author omero
 */
<span class="nc" id="L88">public class KoboldishTorcibud extends AbstractQuest {</span>
 
<span class="nc" id="L90">    private static Logger logger = Logger.getLogger(KoboldishTorcibud.class);</span>

    /**
     * QUEST_SLOT will be used to hold the different states of the quest.
     *
     * QUEST_SLOT sub slot 0 will hold the main states, which can be:
     * - rejected, the player has refused to undertake the quest
     * - done, the player has completed the quest
     * - a list of semi-colon separated key=value pairs.
     *
     * When the quest is completed,
     * QUEST_SLOT sub slot 1 will hold a timestamp randomly determined to be
     * from 3 to 6 days in the future.
     */
    public static final String QUEST_SLOT = &quot;koboldish_torcibud&quot;;

    // the torcibud quest cannot be repeated before 3 to 6 days
    private static final int MIN_DELAY = 3 * MathHelper.MINUTES_IN_ONE_DAY;
    private static final int MAX_DELAY = 6 * MathHelper.MINUTES_IN_ONE_DAY;

    // how much XP is given as the reward
    private static final int XP_REWARD = 500;

    // a template of the items that wrviliza will ask for the quest,
    // it is only used to initialize the triggers in phase_2.
    private static final String REQUIRED_ITEMS_TEMPLATE =
        &quot;eared bottle=0;&quot; +
        &quot;slim bottle=0;&quot; +
        &quot;mandragora=0;&quot; +
        &quot;artichoke=0;&quot; +
        &quot;arandula=0;&quot; +
        &quot;sclaria=0;&quot; +
        &quot;kekik=0;&quot; +
        &quot;fierywater=0&quot;;

    @Override
    public void addToWorld() {
<span class="nc" id="L127">        fillQuestInfo(</span>
            &quot;Koboldish Torcibud&quot;,
            &quot;Wrviliza needs some stuff to prepare her famous Koboldish Torcibud.&quot;,
            true);
<span class="nc" id="L131">        phase_1();</span>
<span class="nc" id="L132">        phase_2();</span>
<span class="nc" id="L133">    }</span>

    @Override
    public List&lt;String&gt; getHistory(final Player player) {

<span class="nc" id="L138">        final List&lt;String&gt; res = new ArrayList&lt;String&gt;();</span>

<span class="nc bnc" id="L140" title="All 2 branches missed.">        if (!player.hasQuest(QUEST_SLOT)) {</span>
<span class="nc" id="L141">            return res;</span>
        }

<span class="nc" id="L144">        res.add(&quot;I made acquaintance with Wrviliza, the kobold barmaid in Wo'fol bar.&quot;);</span>

        /**
         * NOTE:
         * Retrieving QUEST_SLOT without sub slot index 0 will break the if/then logic below.
         */
<span class="nc" id="L150">        final String questState = player.getQuest(QUEST_SLOT, 0);</span>
<span class="nc" id="L151">        logger.debug(&quot;Quest state: &lt;&quot; + questState + &quot;&gt;&quot;);</span>
        
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (&quot;rejected&quot;.equals(questState)) {</span>
<span class="nc" id="L154">            res.add(&quot;She asked me to help her replenish her stock of supplies for preparing her Koboldish Torcibud, &quot;</span>
                + &quot; but I had more pressing matters to attend.&quot;);
<span class="nc bnc" id="L156" title="All 2 branches missed.">        } else if (&quot;done&quot;.equals(questState)) {</span>
<span class="nc" id="L157">            res.add(&quot;I helped her replenish her stock of supplies for preparing her Koboldish Torcibud.&quot;);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">            if (isRepeatable(player)) {</span>
                // enough time has passed, inform that the quest can be taken now.
<span class="nc" id="L160">                res.add(&quot;I might ask her again if she needs more stuff for her stock of supplies.&quot;);</span>
            } else {
                // inform about how much time has to pass before the quest can be taken again.
                long timestamp;
                try {
<span class="nc" id="L165">                    timestamp = Long.parseLong(player.getQuest(QUEST_SLOT, 1));</span>
<span class="nc" id="L166">                } catch (final NumberFormatException e) {</span>
<span class="nc" id="L167">                    timestamp = 0;</span>
<span class="nc" id="L168">                }</span>
<span class="nc" id="L169">                final long timeRemaining = timestamp - System.currentTimeMillis();</span>
<span class="nc" id="L170">                res.add(&quot;Her stock of supplies will be fine for &quot; + TimeUtil.approxTimeUntil((int) (timeRemaining / 1000L)) + &quot;.&quot;);</span>
<span class="nc" id="L171">            }</span>
        } else {
<span class="nc" id="L173">            final ItemCollection missingItems = new ItemCollection();</span>
            /**
             * NOTE:
             * The quest is running,
             * QUEST_SLOT sub slot 0 holds a semicolon separated list of key=value token pairs.
             * Do not use player.getQuest(QUEST_SLOT, 0) as that would only retrieve the first token pair.
             */
<span class="nc" id="L180">            missingItems.addFromQuestStateString(player.getQuest(QUEST_SLOT));</span>
<span class="nc" id="L181">            res.add(&quot;I'm helping her replenish her stock of supplies for preparing her Koboldish Torcibud.&quot;</span>
                + &quot; I still have to bring her &quot; + Grammar.enumerateCollection(missingItems.toStringList()));
        }

<span class="nc" id="L185">        return res;</span>
    }
 
    @Override
    public String getSlotName() {
<span class="nc" id="L190">        return QUEST_SLOT;</span>
    }
 
    @Override
        public String getName() {
<span class="nc" id="L195">        return &quot;KoboldishTorcibud&quot;;</span>
    }

    // Not for kids but not too hard to undertake either.
    @Override
        public int getMinLevel() {
<span class="nc" id="L201">        return 18;</span>
    }
    
	@Override
	public String getRegion() {
<span class="nc" id="L206">		return Region.SEMOS_MINES;</span>
	}

	@Override
	public String getNPCName() {
<span class="nc" id="L211">		return &quot;Wrviliza&quot;;</span>
	}

    @Override
    public boolean isRepeatable(final Player player) {
<span class="nc" id="L216">        return new AndCondition(</span>
            new QuestCompletedCondition(QUEST_SLOT),
            new TimeReachedCondition(QUEST_SLOT, 1)).fire(player,null, null);
    }

    @Override
    public boolean isCompleted(final Player player) {
<span class="nc" id="L223">        return new QuestCompletedCondition(QUEST_SLOT).fire(player, null, null);</span>
    }

    /**
     * Returns the items to collect and required quantity
     *
     * @param pLevel The level of the player undertaking the quest, affects the required quantity of some items.
     * @return A string composed of semi-colon separated key=value token pairs.
     */
    private String getRequiredItemsCollection(int pLevel) {

<span class="nc" id="L234">        int FACTOR_BOTTLE_SLIM = 60;</span>
<span class="nc" id="L235">        int FACTOR_BOTTLE_EARED = 80;</span>
<span class="nc" id="L236">		int FACTOR_MANDRAGORA = 100;</span>

<span class="nc" id="L238">        int required_bottle_eared = Rand.roll1D6() + pLevel / FACTOR_BOTTLE_EARED;</span>
<span class="nc" id="L239">        int required_bottle_slim = Rand.roll1D6() + pLevel / FACTOR_BOTTLE_SLIM;</span>
<span class="nc" id="L240">		int required_mandragora = Rand.randUniform(1,3) + pLevel / FACTOR_MANDRAGORA;</span>

<span class="nc" id="L242">        return</span>
            &quot;eared bottle=&quot; + required_bottle_eared + &quot;;&quot; +
            &quot;slim bottle=&quot; + required_bottle_slim + &quot;;&quot; +
            &quot;mandragora=&quot; + required_mandragora + &quot;;&quot; +
            &quot;artichoke=&quot; + Rand.roll1D6() + &quot;;&quot; +
            &quot;arandula=&quot; + Rand.roll1D6() + &quot;;&quot; +
            &quot;sclaria=&quot; + Rand.roll1D6() + &quot;;&quot; +
            &quot;kekik=&quot; + Rand.roll1D6() + &quot;;&quot; +
            &quot;fierywater=&quot; + Rand.roll1D6() + &quot;;&quot;;
    }

    /**
     * The player meets the Kobold Barmaid Wrviliza and possibly gets a quest from her
     */
    public void phase_1() {
     
<span class="nc" id="L258">        final SpeakerNPC npc = npcs.get(&quot;Wrviliza&quot;);</span>

        // Player sends his greetings and never asked for a quest is handled in NPC class

        // Player sends his greetings to Wrviliza and has rejected the quest in the past
<span class="nc" id="L263">        npc.add(ConversationStates.IDLE,</span>
            ConversationPhrases.GREETING_MESSAGES,
            new AndCondition(new GreetingMatchesNameCondition(npc.getName()),
            		new QuestInStateCondition(QUEST_SLOT, &quot;rejected&quot;)),
            ConversationStates.QUEST_OFFERED,
            &quot;Wroff! Welcome back wanderer... Are you back to help me gather #stuff to make good #torcibud this time?&quot;,
            null);

        // Player asks for a quest
<span class="nc" id="L272">        npc.add(ConversationStates.ATTENDING,</span>
            ConversationPhrases.QUEST_MESSAGES,
            new QuestNotStartedCondition(QUEST_SLOT),
            ConversationStates.QUEST_OFFERED,
            &quot;Wrof! My stock of supplies for preparing koboldish #torcibud is running thin. Would you help me getting some #stuff?&quot;,
            null
        );

        // Player has previously done the quest, enough time has passed since completing it
<span class="nc" id="L281">        npc.add(ConversationStates.ATTENDING,</span>
            ConversationPhrases.QUEST_MESSAGES,
            new AndCondition(
                new QuestCompletedCondition(QUEST_SLOT),
                new TimeReachedCondition(QUEST_SLOT, 1)),
            ConversationStates.QUEST_OFFERED,
            &quot;Wroff! Indeed I'd need some #stuff for making some more koboldish #torcibud. Will you help?&quot;,
            null);

        // Player has done the quest already but it's too early to get another
<span class="nc" id="L291">        npc.add(ConversationStates.ATTENDING,</span>
            ConversationPhrases.QUEST_MESSAGES,
            new AndCondition(
                new QuestCompletedCondition(QUEST_SLOT),
                new NotCondition(new TimeReachedCondition(QUEST_SLOT, 1))),
            ConversationStates.ATTENDING, null,
            new SayTimeRemainingUntilTimeReachedAction(QUEST_SLOT, 1,
                &quot;Wrof! Thank you but my stock of supplies for making good #torcibud will be fine for&quot;));

        // Player is curious about torcibud when offered the quest
<span class="nc" id="L301">        npc.add(ConversationStates.QUEST_OFFERED,</span>
            &quot;torcibud&quot;,
            new QuestNotStartedCondition(QUEST_SLOT),
            ConversationStates.QUEST_OFFERED,
            &quot;Wruff. I will make more when I have enough #stuff! Are you going to help?&quot;,
            null);

        // Player is curious about stuff, ingredients or supplies when offered the quest
        // NOTE:
        // the answer given by the NPC does not contain any trigger words on pourpose
        // as it should only hint what's kind of things are needed.
        // some details about the required items are given only once the quest has been accepted.
<span class="nc" id="L313">        npc.add(ConversationStates.QUEST_OFFERED,</span>
            Arrays.asList(&quot;stuff&quot;,&quot;ingredients&quot;,&quot;supplies&quot;),
            new OrCondition(
                new QuestNotStartedCondition(QUEST_SLOT),
                new QuestInStateCondition(QUEST_SLOT, &quot;rejected&quot;)),
            ConversationStates.QUEST_OFFERED,
            &quot;Wrof! Some bottles, artichokes, a few herbs and fierywater... Things like that. So, will you help?&quot;,
            null);

        // Player accepts the quest and gets to know what Wrviliza needs (switch to phase_2)
<span class="nc" id="L323">        npc.add(ConversationStates.QUEST_OFFERED,</span>
            ConversationPhrases.YES_MESSAGES, null,
            ConversationStates.QUESTION_1, null,
            new MultipleActions(
<span class="nc" id="L327">            		new ChatAction() {</span>
            			@Override
						public void fire(final Player player, final Sentence sentence, final EventRaiser raiser) {
<span class="nc" id="L330">            				int pLevel = player.getLevel();</span>
<span class="nc" id="L331">            				player.setQuest(QUEST_SLOT, getRequiredItemsCollection(pLevel));</span>
<span class="nc" id="L332">            			}</span>
            		},
            		// here we have been careful to say the items from the collection only after the quest slot was set, 
            		// because in this quest, the amounts depend on level, above.
            		new SayRequiredItemsFromCollectionAction(
                        QUEST_SLOT,
                        &quot;Wroff! Right now, I need [items]. Do you by chance have anything of that with you already?&quot;)));

        // Player is not inclined to comply with the request and has not already rejected it once
<span class="nc" id="L341">        npc.add(ConversationStates.QUEST_OFFERED,</span>
            ConversationPhrases.NO_MESSAGES,
            new AndCondition(
                new QuestNotActiveCondition(QUEST_SLOT),
                new QuestNotInStateCondition(QUEST_SLOT, &quot;rejected&quot;)),
            ConversationStates.ATTENDING,
            &quot;Wruff... I guess I will have to ask to someone with a better attitude!&quot;,
            new MultipleActions(
            		new SetQuestAction(QUEST_SLOT, &quot;rejected&quot;),
            		new DecreaseKarmaAction(20.0)));

        //Player is not inclined to comply with the request and he has rejected it last time
        //If player wants to buy any beverage here, he should really take the quest now
        //Wrviliza holds a grudge by turning idle again.
<span class="nc" id="L355">        npc.add(ConversationStates.QUEST_OFFERED,</span>
            ConversationPhrases.NO_MESSAGES,
            new QuestInStateCondition(QUEST_SLOT, &quot;rejected&quot;),
            ConversationStates.IDLE,
            &quot;Wruff... I guess you will wander around with a dry gulch then...&quot;,
            new MultipleActions(
            		new SetQuestAction(QUEST_SLOT, &quot;rejected&quot;),
            		new DecreaseKarmaAction(20.0)));
<span class="nc" id="L363">    }</span>

    /**
     * The player meets the Kobold Barmaid Wrviliza after he has started the quest
     */
    public void phase_2() {

<span class="nc" id="L370">        final SpeakerNPC npc = npcs.get(&quot;Wrviliza&quot;);</span>

        // Player says his greetings to Wrviliza and the quest is running
<span class="nc" id="L373">        npc.add(ConversationStates.IDLE,</span>
            ConversationPhrases.GREETING_MESSAGES,
            new AndCondition(new GreetingMatchesNameCondition(npc.getName()),
            		new QuestActiveCondition(QUEST_SLOT)),
            ConversationStates.QUESTION_1,
            &quot;Wrof! Welcome back. Did you gather any #stuff for me?&quot;,
            null);

        // Player is curious about artichokes
<span class="nc" id="L382">        npc.add(ConversationStates.ATTENDING,</span>
            Arrays.asList(&quot;artichoke&quot;,&quot;artichokes&quot;),
            new QuestActiveCondition(QUEST_SLOT),
            ConversationStates.ATTENDING,
            &quot;Wrof! Not so common vegetables,&quot;
                + &quot; but I know that there are some being grown outside a farm&quot;
                + &quot; near Semos city.&quot;,
            null);

        // Player is curious about fierywater
<span class="nc" id="L392">        npc.add(ConversationStates.ATTENDING,</span>
            Arrays.asList(&quot;fierywater&quot;),
            new QuestActiveCondition(QUEST_SLOT),
            ConversationStates.ATTENDING,
            &quot;Wroof! Powerful fluid, that is.&quot;
                + &quot; I buy mine in Ados market whenever I got the time to make a trip there.&quot;,
            null);

        // Player is curious about herbs
<span class="nc" id="L401">        npc.add(ConversationStates.ATTENDING,</span>
            Arrays.asList(&quot;arandula&quot;,&quot;sclaria&quot;,&quot;kekik&quot;),
            new QuestActiveCondition(QUEST_SLOT),
            ConversationStates.ATTENDING,
            &quot;Wrof! Common herb that grow outside in the plains or woods... Easy to spot!&quot;,
            null);

        // Player is curious about mandragora
<span class="nc" id="L409">        npc.add(ConversationStates.ATTENDING,</span>
            Arrays.asList(&quot;mandragora&quot;),
            new QuestActiveCondition(QUEST_SLOT),
            ConversationStates.ATTENDING,
            &quot;Wrof! All I know is that it is rare root that grows better outside in the woods,&quot;
                + &quot; expecially near places soaked with magic...&quot;
                + &quot; Not easy to spot either!&quot;,
            null);

        // Player says stuff to be reminded of what is still missing
<span class="nc" id="L419">        npc.add(ConversationStates.QUESTION_1,</span>
            &quot;stuff&quot;, null,
            ConversationStates.QUESTION_1,
            null,
            new SayRequiredItemsFromCollectionAction(
                QUEST_SLOT,
                &quot;Wrof! I still need [items]. Did you bring anything of that sort?&quot;));

        // Player answers yes when asked if he has brought any items
<span class="nc" id="L428">        npc.add(ConversationStates.QUESTION_1,</span>
            ConversationPhrases.YES_MESSAGES, null,
            ConversationStates.QUESTION_1,
            &quot;Fine, what did you bring?&quot;,
            null);
    
        // Player answers no when asked if he has brought any items
<span class="nc" id="L435">        npc.add(ConversationStates.QUESTION_1,</span>
            ConversationPhrases.NO_MESSAGES,
            new QuestNotCompletedCondition(QUEST_SLOT),
            ConversationStates.ATTENDING,
            &quot;Wruf! Take your time... No hurry!&quot;,
            null);

        // create the ChatAction to reward the player
<span class="nc" id="L443">        ChatAction addRewardAction = new ChatAction() {</span>
            @Override
			public void fire(final Player player, final Sentence sentence, final EventRaiser npc) {
                final StackableItem
<span class="nc" id="L447">                    koboldish_torcibud_vsop = (StackableItem)</span>
                        SingletonRepository
                            .getEntityManager().getItem(&quot;vsop koboldish torcibud&quot;);
<span class="nc" id="L450">                final int torcibud_bottles = 1 + Rand.roll1D6();</span>
<span class="nc" id="L451">                koboldish_torcibud_vsop.setQuantity(torcibud_bottles);</span>
<span class="nc" id="L452">                koboldish_torcibud_vsop.setBoundTo(player.getName());</span>
                // vsop torcibud will heal up to 75% of the player's base HP he has when getting rewarded
                // all vsop koboldish torcibud is persistent (set in the xml for this item) so this value will last
<span class="nc" id="L455">                koboldish_torcibud_vsop.put(&quot;amount&quot;, player.getBaseHP()*75/100);</span>

                //player.equipOrPutOnGround(koboldish_torcibud_vsop);
                //put the rewarded bottles on the counter
<span class="nc" id="L459">                final IRPZone zone = SingletonRepository.getRPWorld().getZone(&quot;int_wofol_bar&quot;);</span>
<span class="nc" id="L460">                koboldish_torcibud_vsop.setPosition(3, 3);</span>
<span class="nc" id="L461">                zone.add(koboldish_torcibud_vsop);</span>

<span class="nc" id="L463">                npc.say(</span>
                    &quot;Wrof! Here take &quot;
                    + Integer.toString(torcibud_bottles)
                    + &quot; bottles of my V.S.O.P. Koboldish Torcibud with my best wishes for you!&quot;);
<span class="nc" id="L467">            }</span>
        };

        // Player collected all the items. grant the XP before handing out the torcibud
<span class="nc" id="L471">        ChatAction completeAction = new MultipleActions(</span>
            new SetQuestAction(QUEST_SLOT, &quot;done&quot;),
            new SetQuestToFutureRandomTimeStampAction(QUEST_SLOT, 1, MIN_DELAY, MAX_DELAY),
            new IncreaseXPAction(XP_REWARD),
            new IncreaseKarmaAction(20),
            addRewardAction);

        // add triggers for the item names
<span class="nc" id="L479">        final ItemCollection items = new ItemCollection();</span>
<span class="nc" id="L480">        items.addFromQuestStateString(REQUIRED_ITEMS_TEMPLATE);</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">        for (final Map.Entry&lt;String, Integer&gt; item : items.entrySet()) {</span>
<span class="nc" id="L482">            npc.add(ConversationStates.QUESTION_1,</span>
                item.getKey(), null,
                ConversationStates.QUESTION_1, null,
                new CollectRequestedItemsAction(
                		item.getKey(),
                        QUEST_SLOT,
                        &quot;Wroff! do you have anything else?&quot;,
                        &quot;Wruff! You have already brought that to me!&quot;,
                        completeAction, ConversationStates.ATTENDING));
<span class="nc" id="L491">        }</span>
<span class="nc" id="L492">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>