<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>GuessKills.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.quests</a> &gt; <span class="el_source">GuessKills.java</span></div><h1>GuessKills.java</h1><pre class="source lang-java linenums">/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.maps.quests;

import games.stendhal.common.MathHelper;
import games.stendhal.common.Rand;
import games.stendhal.common.grammar.Grammar;
import games.stendhal.common.parser.Expression;
import games.stendhal.common.parser.Sentence;
import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.entity.Entity;
import games.stendhal.server.entity.creature.Creature;
import games.stendhal.server.entity.npc.ChatAction;
import games.stendhal.server.entity.npc.ChatCondition;
import games.stendhal.server.entity.npc.ConversationPhrases;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.EventRaiser;
import games.stendhal.server.entity.npc.SpeakerNPC;
import games.stendhal.server.entity.npc.action.IncreaseXPAction;
import games.stendhal.server.entity.npc.action.MultipleActions;
import games.stendhal.server.entity.npc.action.SayTimeRemainingAction;
import games.stendhal.server.entity.npc.action.SetQuestAction;
import games.stendhal.server.entity.npc.action.SetQuestToTimeStampAction;
import games.stendhal.server.entity.npc.condition.AndCondition;
import games.stendhal.server.entity.npc.condition.MinTotalCreaturesKilledCondition;
import games.stendhal.server.entity.npc.condition.NotCondition;
import games.stendhal.server.entity.npc.condition.OrCondition;
import games.stendhal.server.entity.npc.condition.QuestInStateCondition;
import games.stendhal.server.entity.npc.condition.TextHasNumberCondition;
import games.stendhal.server.entity.npc.condition.TimePassedCondition;
import games.stendhal.server.entity.npc.condition.TriggerInListCondition;
import games.stendhal.server.entity.player.Player;
import games.stendhal.server.maps.Region;
import games.stendhal.server.util.TimeUtil;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

/**
 * QUEST: The Guessing Game
 *
 * PARTICIPANTS:
 * &lt;ul&gt;
 * &lt;li&gt;Crearid, an old lady found in Nalwor city&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * STEPS:
 * &lt;ul&gt;
 * &lt;li&gt;Crearid asks if you want to play a game&lt;/li&gt;
 * &lt;li&gt;She picks a random creature you have killed and asks you to guess how
 * many of those you killed&lt;/li&gt;
 * &lt;li&gt;You get three guesses and get rewarded if your guess exactly matches the number
 * or a lower reward if your guess is close to the correct number&lt;/li&gt;
 * &lt;/ul&gt;
 * 
 * SLOTS: (subtract from list index to get slot index)
 * &lt;ol&gt;
 * &lt;li&gt;Quest state: done, 1, 2 or 3 (where 1, 2 and 3 represent what guess the player is on)&lt;/li&gt;
 * &lt;li&gt;Timestamp: last time quest was completed&lt;/li&gt;
 * &lt;li&gt;Creature: the creature that was asked about if quest was not completed&lt;/li&gt;
 * &lt;/ol&gt;
 *
 * REWARD:
 * &lt;ul&gt;
 * &lt;li&gt;150 XP if guess is exact&lt;/li&gt;
 * &lt;li&gt;90 XP if guess is close&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * REPETITIONS:
 * &lt;ul&gt;
 * &lt;li&gt;Weekly&lt;/li&gt;
 * &lt;/ul&gt;
 */
public class GuessKills extends AbstractQuest {
	public static final String QUEST_SLOT = &quot;guess_kills&quot;;

	private static final double ACCURACY = 0.02;
	private static final int MIN_KILLS_REQUIRED = 1000;
	private static final int EXACT_REWARD = 150;
	private static final int CLOSE_REWARD = 90;
	private static final int INTERVAL_BETWEEN_TRIES = MathHelper.MINUTES_IN_ONE_WEEK;
	/** List of existing creatures that may be asked about. */
<span class="fc" id="L93">	private static final List&lt;Creature&gt; POSSIBLE_CREATURES = new ArrayList&lt;Creature&gt;();</span>

<span class="fc" id="L95">	private String CREATURE = &quot;rat&quot;;</span>

	/**
	 * Create new quest instance.
	 */
<span class="fc" id="L100">	public GuessKills() {</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">		for (Creature creature : SingletonRepository.getEntityManager().getCreatures()) {</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">			if (!creature.isRare()) {</span>
<span class="fc" id="L103">				POSSIBLE_CREATURES.add(creature);</span>
			}
<span class="fc" id="L105">		}</span>
<span class="fc" id="L106">	}</span>

    @Override
    public void addToWorld() {
<span class="fc" id="L110">        fillQuestInfo(</span>
				&quot;The guessing game&quot;,
				&quot;Crearid plays a game where you guess how many creatures you have killed.&quot;,
				true);
<span class="fc" id="L114">        prepareQuestStep();</span>
<span class="fc" id="L115">    }</span>
    
    @Override
	public String getRegion() {
<span class="nc" id="L119">		return Region.NALWOR_CITY;</span>
	}
    
    @Override
    public boolean isRepeatable(final Player player) {
<span class="nc" id="L124">		return true;</span>
	}

    @Override
    public String getSlotName() {
<span class="fc" id="L129">        return QUEST_SLOT;</span>
    }

    @Override
    public String getName() {
<span class="nc" id="L134">        return &quot;GuessKills&quot;;</span>
    }

    @Override
    public List&lt;String&gt; getHistory(final Player player) {
<span class="nc" id="L139">    	final List&lt;String&gt; res = new ArrayList&lt;String&gt;();</span>
		
<span class="nc bnc" id="L141" title="All 2 branches missed.">    	if (!player.hasQuest(QUEST_SLOT)) {</span>
<span class="nc" id="L142">			return res;</span>
		}
		
<span class="nc" id="L145">		final String state = player.getQuest(QUEST_SLOT, 0);</span>
<span class="nc" id="L146">		final String time = player.getQuest(QUEST_SLOT, 1);</span>
<span class="nc" id="L147">		final String creature = player.getQuest(QUEST_SLOT, 2);</span>
		
<span class="nc" id="L149">		res.add(&quot;I have met Crearid. She is an old lady in Nalwor city.&quot;);</span>
<span class="nc" id="L150">		res.add(&quot;She asked me to guess how many &quot; + Grammar.pluralCreature(creature) + &quot; I have killed.&quot;);		</span>
		
<span class="nc bnc" id="L152" title="All 2 branches missed.">		if (&quot;1&quot;.equals(state)) {</span>
<span class="nc" id="L153">			res.add(&quot;I have three guesses left.&quot;);</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">		} else if (&quot;2&quot;.equals(state)) {</span>
<span class="nc" id="L155">			res.add(&quot;I have two guesses left.&quot;);</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">		} else if (&quot;3&quot;.equals(state)) {</span>
<span class="nc" id="L157">			res.add(&quot;I have one guess left.&quot;);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">		} else if (&quot;done&quot;.equals(state)) {</span>
<span class="nc" id="L159">			final long timeRemaining = MathHelper.parseLong(time) + INTERVAL_BETWEEN_TRIES * MathHelper.MILLISECONDS_IN_ONE_MINUTE</span>
					- System.currentTimeMillis();
			
<span class="nc bnc" id="L162" title="All 2 branches missed.">			if (timeRemaining &gt; 0) {</span>
<span class="nc" id="L163">				res.add(&quot;I can go see Crearid for another quiz in about &quot; + TimeUtil.approxTimeUntil((int) (timeRemaining / 1000L)));</span>
			} else {
<span class="nc" id="L165">				res.add(&quot;I can go see Crearid for another quiz now.&quot;);</span>
			}
		}
		
<span class="nc" id="L169">		return res;</span>
    }

    /**
     * Sets the FSM for the NPC with all required responses and interactions
     */
    public void prepareQuestStep() {
<span class="fc" id="L176">    	final SpeakerNPC npc = npcs.get(&quot;Crearid&quot;);</span>

<span class="fc" id="L178">        final ChatCondition requirement = new MinTotalCreaturesKilledCondition(MIN_KILLS_REQUIRED);</span>
<span class="fc" id="L179">        final ChatCondition isNumber = new TextHasNumberCondition(Integer.MIN_VALUE, Integer.MAX_VALUE);</span>
<span class="fc" id="L180">        final ChatCondition enoughTimePassed = new TimePassedCondition(QUEST_SLOT, 1, INTERVAL_BETWEEN_TRIES);</span>
<span class="fc" id="L181">        final ChatCondition wrongAndNotBye = new AndCondition(new NotCondition(isNumber), new NotCondition(new TriggerInListCondition(ConversationPhrases.GOODBYE_MESSAGES)));</span>
<span class="fc" id="L182">        final ChatCondition questNotDone = new OrCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;1&quot;),</span>
													 new QuestInStateCondition(QUEST_SLOT, 0, &quot;2&quot;),
													 new QuestInStateCondition(QUEST_SLOT, 0, &quot;3&quot;));

        //checks if guess is exact answer
<span class="fc" id="L187">        final ChatCondition exact = new ChatCondition() {</span>
            @Override
			public boolean fire(final Player player, final Sentence sentence, final Entity entity) {
<span class="fc" id="L190">                final Expression number = sentence.getNumeral();</span>
<span class="fc" id="L191">                final int kills = player.getSharedKill(CREATURE) + player.getSoloKill(CREATURE);</span>

<span class="pc bpc" id="L193" title="1 of 2 branches missed.">                if (number != null) {</span>
<span class="fc" id="L194">                    final int num = number.getAmount();</span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">                    if (num == kills) {</span>
<span class="fc" id="L196">                        return true;</span>
                    }
                }
<span class="fc" id="L199">                return false;</span>
            }
        };

        //checks if guess is close to actual answer
<span class="fc" id="L204">        final ChatCondition close = new ChatCondition() {</span>
            @Override
			public boolean fire(final Player player, final Sentence sentence, final Entity entity) {
<span class="fc" id="L207">                final Expression number = sentence.getNumeral();</span>
<span class="fc" id="L208">                final int kills = player.getSharedKill(CREATURE) + player.getSoloKill(CREATURE);</span>

<span class="pc bpc" id="L210" title="1 of 2 branches missed.">                if (number != null) {</span>
<span class="fc" id="L211">                    final int num = number.getAmount();</span>
<span class="fc bfc" id="L212" title="All 4 branches covered.">                    if (Math.abs(num - kills) &lt;= Math.max(ACCURACY * kills, 1) &amp;&amp; kills != num) {</span>
<span class="fc" id="L213">                        return true;</span>
                    }
                }
<span class="fc" id="L216">                return false;</span>
            }
        };

<span class="fc" id="L220">        final ConversationStates[] tries = {ConversationStates.QUESTION_1,</span>
	                                      ConversationStates.QUESTION_2,
	                                      ConversationStates.QUESTION_3};
        
        //gets the creature from unfinished quest
<span class="fc" id="L225">        final ChatAction getSavedCreature = new ChatAction() {</span>
			@Override
			public void fire(Player player, Sentence sentence, EventRaiser npc) {
<span class="fc" id="L228">				CREATURE = player.getQuest(QUEST_SLOT, 2);</span>
				
<span class="fc" id="L230">				int guesses = 4 - MathHelper.parseIntDefault(player.getQuest(QUEST_SLOT, 0), 1);</span>
				
<span class="fc" id="L232">				npc.say(&quot;Let me see... you have &quot; + Grammar.quantityplnounCreature(guesses, &quot;guess&quot;) + </span>
						&quot; left... and if I recall correctly I asked you...&quot; +
						&quot; how many &quot; + Grammar.pluralCreature(CREATURE) + &quot; do think you have killed?&quot;);
<span class="fc" id="L235">			}        	</span>
        };
        
<span class="fc" id="L238">        final String[] triggers = {&quot;game&quot;, &quot;games&quot;, &quot;play&quot;, &quot;play game&quot;, &quot;play games&quot;};</span>
        
        //if quest not finished and came back
<span class="fc" id="L241">        npc.add(ConversationStates.ATTENDING,</span>
        		Arrays.asList(triggers),
                new AndCondition(questNotDone, requirement),
                ConversationStates.QUEST_STARTED,
                &quot;We did not finish our game last time would you like to continue?&quot;,
                null);
        
        //if quest not finished and player wants to continue
<span class="fc" id="L249">        npc.add(ConversationStates.QUEST_STARTED,</span>
        		ConversationPhrases.YES_MESSAGES,
        		new QuestInStateCondition(QUEST_SLOT, 0, &quot;1&quot;),
                ConversationStates.QUESTION_1,
                null,
                getSavedCreature);
        
<span class="fc" id="L256">        npc.add(ConversationStates.QUEST_STARTED,</span>
        		ConversationPhrases.YES_MESSAGES,
                new QuestInStateCondition(QUEST_SLOT, 0, &quot;2&quot;),
                ConversationStates.QUESTION_2,
                null,
                getSavedCreature);
        
<span class="fc" id="L263">        npc.add(ConversationStates.QUEST_STARTED,</span>
        		ConversationPhrases.YES_MESSAGES,
                new QuestInStateCondition(QUEST_SLOT, 0, &quot;3&quot;),
                ConversationStates.QUESTION_3,
                null,
                getSavedCreature);
        
        //if quest not finished and player does not want to continue
<span class="fc" id="L271">        npc.add(ConversationStates.QUEST_STARTED,</span>
        		ConversationPhrases.NO_MESSAGES,
                null,
                ConversationStates.ATTENDING,
                &quot;Oh well. Your loss, now what can I do for you?&quot;,
                null);

        //if player has not killed enough creatures don't give quest
<span class="fc" id="L279">        npc.add(ConversationStates.ATTENDING,</span>
                Arrays.asList(triggers),
                new NotCondition(requirement),
                ConversationStates.ATTENDING,
                &quot;I'd like some entertainment but you don't look like you're up to it just yet.&quot; +
                &quot; Come back when you've gained a bit more experience fighting creatures.&quot;,
                null);

        //ask if player would like to take quest if player has killed enough creatures
<span class="fc" id="L288">        npc.add(ConversationStates.ATTENDING,</span>
                Arrays.asList(triggers),
                new AndCondition(requirement, enoughTimePassed, new NotCondition(questNotDone)),
                ConversationStates.QUEST_OFFERED,
                &quot;I'm a little bored at the moment. Would you like to play a game?&quot;,
                null);

        //tell player to come back later if one week has not passed
<span class="fc" id="L296">        npc.add(ConversationStates.ATTENDING,</span>
                Arrays.asList(triggers),
                new AndCondition(requirement, new NotCondition(enoughTimePassed), new NotCondition(questNotDone)),
                ConversationStates.ATTENDING,
                null,
                new SayTimeRemainingAction(QUEST_SLOT, 1, INTERVAL_BETWEEN_TRIES, &quot;I've had plenty of fun for now, thanks. Come back in, lets say&quot;));

        //ask quest question if quest accepted, also gets the creature type to ask about
<span class="fc" id="L304">        npc.add(ConversationStates.QUEST_OFFERED,</span>
                ConversationPhrases.YES_MESSAGES,
                null,
                ConversationStates.QUESTION_1,
                null,
                new MultipleActions(
<span class="fc" id="L310">	                new ChatAction() {</span>
	                    @Override
						public void fire(Player player, Sentence sentence, EventRaiser npc) {
	                        do {
<span class="fc" id="L314">	                            CREATURE = Rand.rand(POSSIBLE_CREATURES).getName();</span>
<span class="fc bfc" id="L315" title="All 2 branches covered.">	                        } while(!player.hasKilled(CREATURE));</span>
	                        
	                        // This can't be in a SetQuestAction because CREATURE is dynamic
<span class="fc" id="L318">	                        player.setQuest(QUEST_SLOT, 2, CREATURE);</span>
	
<span class="fc" id="L320">	                        npc.say(&quot;I've been counting how many creatures you have killed, now tell me, how many &quot; +</span>
	                                Grammar.pluralCreature(CREATURE) + &quot; do you think you've killed? You have three guesses and I'll accept &quot; +
	                                &quot;guesses that are close to the correct answer.&quot;);
<span class="fc" id="L323">	                    }</span>
	                },
	                new SetQuestAction(QUEST_SLOT, 0, &quot;1&quot;)));

        //if quest rejected
<span class="fc" id="L328">        npc.add(ConversationStates.QUEST_OFFERED,</span>
                ConversationPhrases.NO_MESSAGES,
                null,
                ConversationStates.ATTENDING,
                &quot;Bah, you're no fun at all.&quot;,
                null);

        //if invalid answer
<span class="fc" id="L336">        npc.add(ConversationStates.QUESTION_1,</span>
                &quot;&quot;,
                wrongAndNotBye,
                ConversationStates.QUESTION_1,
                &quot;How could that possibly be an answer? Give me a proper number.&quot;,
                null);
        
<span class="fc" id="L343">        npc.add(ConversationStates.QUESTION_2,</span>
                &quot;&quot;,
                wrongAndNotBye,
                ConversationStates.QUESTION_2,
                &quot;Is that even possible? Give me a valid answer.&quot;,
                null);
        
<span class="fc" id="L350">        npc.add(ConversationStates.QUESTION_3,</span>
                &quot;&quot;,
                wrongAndNotBye,
                ConversationStates.QUESTION_3,
                &quot;I've never heard of that number used to describe killings. Give me an explicable answer.&quot;,
                null);

        //if goodbye while guessing
<span class="fc" id="L358">        npc.add(tries,</span>
                ConversationPhrases.GOODBYE_MESSAGES,
                null,
                ConversationStates.IDLE,
                &quot;Goodbye, come back when you want to continue.&quot;,
                null);

        //if exact answer
<span class="fc" id="L366">        npc.add(tries,</span>
                &quot;&quot;,
                new AndCondition(isNumber, exact, new NotCondition(close)),
                ConversationStates.ATTENDING,
                &quot;Stupendous! That is the exact number! Either you're very lucky or you really pay attention.&quot;,
                new MultipleActions(
                    new SetQuestAction(QUEST_SLOT, 0, &quot;done&quot;),
                    new SetQuestToTimeStampAction(QUEST_SLOT, 1),
                    new IncreaseXPAction(EXACT_REWARD)));

        //if close answer
<span class="fc" id="L377">        npc.add(tries,</span>
                &quot;&quot;,
                new AndCondition(isNumber, close, new NotCondition(exact)),
                ConversationStates.ATTENDING,
                &quot;Wow, that was pretty close. Well done!&quot;,
                new MultipleActions(
                    new SetQuestAction(QUEST_SLOT, 0, &quot;done&quot;),
                    new SetQuestToTimeStampAction(QUEST_SLOT, 1),
                    new IncreaseXPAction(CLOSE_REWARD)));

        //if incorrect answer
<span class="fc" id="L388">        npc.add(ConversationStates.QUESTION_1,</span>
                &quot;&quot;,
                new AndCondition(isNumber, new NotCondition(close), new NotCondition(exact)),
                ConversationStates.QUESTION_2,
                &quot;Nope, that is not right. Try again.&quot;,
                new SetQuestAction(QUEST_SLOT, 0, &quot;2&quot;));
        
<span class="fc" id="L395">        npc.add(ConversationStates.QUESTION_2,</span>
                &quot;&quot;,
                new AndCondition(isNumber, new NotCondition(close), new NotCondition(exact)),
                ConversationStates.QUESTION_3,
                &quot;Wrong again. You have one more try.&quot;,
                new SetQuestAction(QUEST_SLOT, 0, &quot;3&quot;));
        
<span class="fc" id="L402">        npc.add(ConversationStates.QUESTION_3,</span>
                &quot;&quot;,
                new AndCondition(isNumber, new NotCondition(close), new NotCondition(exact)),
                ConversationStates.ATTENDING,
                null,
                new MultipleActions(
<span class="fc" id="L408">                    new ChatAction() {</span>
                        @Override
						public void fire(Player player, Sentence sentence, EventRaiser npc) {
<span class="fc" id="L411">                        	int exactNumber = player.getSoloKill(CREATURE) + player.getSharedKill(CREATURE);</span>
<span class="fc" id="L412">                        	npc.say(&quot;Unfortunately that is incorrect. The correct answer is in the region of &quot;</span>
                        	+ (int) Math.max(Math.floor(exactNumber - Math.max(exactNumber * 0.2, 10) + exactNumber * 0.1 * Rand.rand()), 0)
                        	+ &quot; and &quot; + Math.round(exactNumber + Math.max(exactNumber * 0.2, 10) - exactNumber * 0.1 * Rand.rand())
                        	+ &quot;. Good effort though.&quot;);
<span class="fc" id="L416">                        }</span>
                    },
                    new SetQuestAction(QUEST_SLOT, 0, &quot;done&quot;),
                    new SetQuestToTimeStampAction(QUEST_SLOT, 1)));
<span class="fc" id="L420">    }</span>

	@Override
	public String getNPCName() {
<span class="nc" id="L424">		return &quot;Crearid&quot;;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>