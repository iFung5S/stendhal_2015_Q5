<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FindJefsMom.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.quests</a> &gt; <span class="el_source">FindJefsMom.java</span></div><h1>FindJefsMom.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.maps.quests;

import games.stendhal.common.Rand;
import games.stendhal.common.grammar.Grammar;
import games.stendhal.common.parser.Sentence;
import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.entity.item.StackableItem;
import games.stendhal.server.entity.npc.ChatAction;
import games.stendhal.server.entity.npc.ConversationPhrases;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.EventRaiser;
import games.stendhal.server.entity.npc.SpeakerNPC;
import games.stendhal.server.entity.npc.action.DecreaseKarmaAction;
import games.stendhal.server.entity.npc.action.DropItemAction;
import games.stendhal.server.entity.npc.action.EquipItemAction;
import games.stendhal.server.entity.npc.action.IncreaseKarmaAction;
import games.stendhal.server.entity.npc.action.IncreaseXPAction;
import games.stendhal.server.entity.npc.action.IncrementQuestAction;
import games.stendhal.server.entity.npc.action.MultipleActions;
import games.stendhal.server.entity.npc.action.SayTimeRemainingAction;
import games.stendhal.server.entity.npc.action.SetQuestAction;
import games.stendhal.server.entity.npc.action.SetQuestToTimeStampAction;
import games.stendhal.server.entity.npc.condition.AndCondition;
import games.stendhal.server.entity.npc.condition.NotCondition;
import games.stendhal.server.entity.npc.condition.OrCondition;
import games.stendhal.server.entity.npc.condition.PlayerCanEquipItemCondition;
import games.stendhal.server.entity.npc.condition.PlayerHasItemWithHimCondition;
import games.stendhal.server.entity.npc.condition.QuestActiveCondition;
import games.stendhal.server.entity.npc.condition.QuestInStateCondition;
import games.stendhal.server.entity.npc.condition.QuestNotStartedCondition;
import games.stendhal.server.entity.npc.condition.QuestStateStartsWithCondition;
import games.stendhal.server.entity.npc.condition.TimePassedCondition;
import games.stendhal.server.entity.player.Player;
import games.stendhal.server.maps.Region;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;


/**
 * QUEST: Find Jefs mum
 *
 * PARTICIPANTS:
 * &lt;ul&gt;
 * &lt;li&gt;Jef&lt;/li&gt;
 * &lt;li&gt;Amber&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * STEPS:
 * &lt;ul&gt;
 * &lt;li&gt; Jef waits for his mum in Kirdneh for a longer time now and is frightened that something happened to her&lt;/li&gt;
 * &lt;li&gt; You go to find Amber somewhere in Fado forest&lt;/li&gt;
 * &lt;li&gt; She gives you a flower which you have to bring to Jef&lt;/li&gt;
 * &lt;li&gt; You return and give the flower to Jef&lt;/li&gt;
 * &lt;li&gt; Jef will reward you well&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * REWARD:
 * &lt;ul&gt;
 * &lt;li&gt; 800 XP&lt;/li&gt;
 * &lt;li&gt; Red lionfish which Jef got by someone who made holidays on Amazon island earlier (between 1-6)&lt;/li&gt;
 * &lt;li&gt; Karma: 15&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * REPETITIONS:
 * &lt;ul&gt;
 * &lt;li&gt; Once every 4320 minutes. (3 days)&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * @author Vanessa Julius
 *
 */
<span class="fc" id="L86">public class FindJefsMom extends AbstractQuest {</span>

	// 4320 minutes (3 days)
	private static final int REQUIRED_MINUTES = 4320;

	private static final String QUEST_SLOT = &quot;find_jefs_mom&quot;;


	@Override
	public String getSlotName() {
<span class="fc" id="L96">		return QUEST_SLOT;</span>
	}
	private void offerQuestStep() {
<span class="fc" id="L99">		final SpeakerNPC npc = npcs.get(&quot;Jef&quot;);</span>

<span class="fc" id="L101">		npc.add(ConversationStates.ATTENDING,</span>
			ConversationPhrases.QUEST_MESSAGES,
			new OrCondition(new QuestNotStartedCondition(QUEST_SLOT), new QuestInStateCondition(QUEST_SLOT, 0, &quot;rejected&quot;)),
			ConversationStates.QUEST_OFFERED,
			&quot;I miss my mother! She wanted to go to the market but didn't return so far. Can you watch out for her please?&quot;,
			null);

		// player asks about quest which he has done already and he is allowed to repeat it
<span class="fc" id="L109">				npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES,
				new AndCondition(new QuestStateStartsWithCondition(QUEST_SLOT, &quot;done&quot;), new TimePassedCondition(QUEST_SLOT, 1, REQUIRED_MINUTES)),
				ConversationStates.QUEST_OFFERED,
				&quot;It is a long time ago that you watched out for my mum. May I ask you to take a look at her again and tell me if she is still fine, please?&quot;,
				null);

		// player asks about quest but time didn't pass yet
<span class="fc" id="L117">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES,
				new AndCondition(new NotCondition(new TimePassedCondition(QUEST_SLOT, 1,REQUIRED_MINUTES))),
				ConversationStates.ATTENDING,
				null,
				new SayTimeRemainingAction(QUEST_SLOT, 1, REQUIRED_MINUTES, &quot;I don't want to disturb my mum at the moment, it seems like she needs some time on herself, so you don't have to look out for her currently. You can ask me again in&quot;));


		// Player agrees to find mum
<span class="fc" id="L126">		npc.add(ConversationStates.QUEST_OFFERED,</span>
			ConversationPhrases.YES_MESSAGES, null,
			ConversationStates.ATTENDING,
			&quot;Thank you so much! I hope that my #mum is ok and will return soon! Please tell her my name, #Jef, to prove that I sent you to her. If you have found her, return to me please and I'll give you something for your efforts.&quot;,
			new MultipleActions(new SetQuestAction(QUEST_SLOT, 0, &quot;start&quot;)));

		// Player says no, they've lost karma.
<span class="fc" id="L133">		npc.add(ConversationStates.QUEST_OFFERED,</span>
			ConversationPhrases.NO_MESSAGES, null, ConversationStates.IDLE,
			&quot;Oh. Ok. I can understand you... You look like a busy hero so I'll not try to convince you of helping me out.&quot;,
			new MultipleActions(new SetQuestAction(QUEST_SLOT, 0, &quot;rejected&quot;),
					new DecreaseKarmaAction(10.0)));

		// Player asks for quest but is already on it

<span class="fc" id="L141">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES,
				new QuestActiveCondition(QUEST_SLOT),
				ConversationStates.ATTENDING,
				&quot;I hope that you will find my mum soon and tell me, if she is #fine after.&quot;,
				null);

<span class="fc" id="L148">		npc.add(</span>
				ConversationStates.ATTENDING,
				Arrays.asList(&quot;mum&quot;, &quot;mother&quot;, &quot;mom&quot;),
				null,
				ConversationStates.ATTENDING,
				&quot;My mother Amber left me for buying some food on the market, but she didn't return #yet.&quot;,
				null);

<span class="fc" id="L156">		npc.add(</span>
				ConversationStates.ATTENDING,
				&quot;yet&quot;,
				null,
				ConversationStates.ATTENDING,
				&quot;The only thing I know is, that she had a little argument with her boyfriend, #Roger #Frampton earlier...&quot;,
				null);

<span class="fc" id="L164">		npc.add(</span>
				ConversationStates.ATTENDING,
				&quot;Jef&quot;,
				null,
				ConversationStates.ATTENDING,
				&quot;Yes, that is me :)&quot;,
				null);

<span class="fc" id="L172">		npc.add(</span>
				ConversationStates.ATTENDING,
				Arrays.asList(&quot;Roger Frampton&quot;, &quot;Roger&quot;, &quot;Frampton&quot;),
				null,
				ConversationStates.ATTENDING,
				&quot;Maybe Roger has some guess about where she went to. I'm not sure where he is either, I just know he sells houses somewhere here in Kirdneh.&quot;,
				null);

<span class="fc" id="L180">	}</span>

	private void findMomStep() {
<span class="fc" id="L183">		final SpeakerNPC amber = npcs.get(&quot;Amber&quot;);</span>

        // give the flower if it's at least 5 days since the player activated the quest the last time, and set the time slot again
<span class="fc" id="L186">		amber.add(ConversationStates.ATTENDING, &quot;Jef&quot;,</span>
			new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0,&quot;start&quot;),
							 new PlayerCanEquipItemCondition(&quot;zantedeschia&quot;)),

			ConversationStates.IDLE,
			&quot;Oh I see :) My son Jef asked you to take a look after me. He is such a nice and gentle boy! Please give him this zantedeschia here. I love these flowers! Please give it to him and tell him that I'm #fine.&quot;,
			new MultipleActions(new EquipItemAction(&quot;zantedeschia&quot;, 1, true),
                                new SetQuestAction(QUEST_SLOT, 0, &quot;found_mom&quot;)));
		

		// don't put the flower on the ground - if player has no space, tell them
<span class="fc" id="L197">		amber.add(ConversationStates.ATTENDING, &quot;Jef&quot;,</span>
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;start&quot;),
								 new NotCondition(new PlayerCanEquipItemCondition(&quot;zantedeschia&quot;))),
				ConversationStates.IDLE,
				&quot;Oh, I wanted to give you a flower for my son to show him that I'm fine, but as I see now, you don't have enough space for equipping it. Please return to me when you will have made some space in your bags!&quot;,
				null);

        // don't give the flower if the quest state isn't start
<span class="fc" id="L205">	    amber.add(ConversationStates.ATTENDING, &quot;Jef&quot;,</span>
		     	new AndCondition(new NotCondition(new QuestActiveCondition(QUEST_SLOT))),
		    	ConversationStates.IDLE,
		    	&quot;I don't trust you. Your voice shivered while you told me my sons name. I bet he is fine and happy and safe.&quot;,
		    	null);
	    
<span class="fc" id="L211">	    amber.add(ConversationStates.ATTENDING, &quot;Jef&quot;,</span>
	    		new AndCondition(
	    				new QuestInStateCondition(QUEST_SLOT, &quot;found_mom&quot;),
	    				new PlayerHasItemWithHimCondition(&quot;zantedeschia&quot;)),
	    		ConversationStates.IDLE,
	    		&quot;Please give that flower to my son and let him know that I am #fine.&quot;,
	    		null);
	    
	    // replace flower if lost
<span class="fc" id="L220">	    amber.add(ConversationStates.ATTENDING, Arrays.asList(&quot;Jef&quot;, &quot;flower&quot;, &quot;zantedeschia&quot;),</span>
	    		new AndCondition(
	    				new QuestInStateCondition(QUEST_SLOT, 0, &quot;found_mom&quot;),
	    				new NotCondition(new PlayerHasItemWithHimCondition(&quot;zantedeschia&quot;))),
	    		ConversationStates.IDLE,
	    		&quot;Oh you lost the flower? I'm afraid I don't have anymore. Speak with Jenny, by the windmill. She may be able to help you.&quot;,
	    		null); 

<span class="fc" id="L228">	}</span>

	private void bringFlowerToJefStep() {
<span class="fc" id="L231">		final SpeakerNPC npc = npcs.get(&quot;Jef&quot;);</span>

<span class="fc" id="L233">		ChatAction addRandomNumberOfItemsAction = new ChatAction() {</span>
			@Override
			public void fire(final Player player, final Sentence sentence, final EventRaiser npc) {
				//add random number of red lionfish
<span class="fc" id="L237">				final StackableItem red_lionfish = (StackableItem) SingletonRepository.getEntityManager()</span>
						.getItem(&quot;red lionfish&quot;);
				int redlionfishamount;
<span class="fc" id="L240">				redlionfishamount = Rand.roll1D6();</span>
<span class="fc" id="L241">				red_lionfish.setQuantity(redlionfishamount);</span>
<span class="fc" id="L242">				player.equipOrPutOnGround(red_lionfish);</span>
<span class="fc" id="L243">				npc.say(&quot;Thank you! Take &quot; + Grammar.thisthese(redlionfishamount) + &quot; &quot; +  Grammar.quantityplnoun(redlionfishamount,&quot;red lionfish&quot;,&quot;&quot;) + &quot;! I got some from a guy who visited Amazon island some time ago, maybe you need &quot; + Grammar.itthem(redlionfishamount) + &quot; for something.&quot;);</span>

<span class="fc" id="L245">			}</span>
		};
<span class="fc" id="L247">		npc.add(ConversationStates.ATTENDING,</span>
				Arrays.asList(&quot;flower&quot;, &quot;zantedeschia&quot;, &quot;fine&quot;, &quot;amber&quot;, &quot;done&quot;),
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;found_mom&quot;), new PlayerHasItemWithHimCondition(&quot;zantedeschia&quot;)),
				ConversationStates.ATTENDING, null,
				new MultipleActions(new DropItemAction(&quot;zantedeschia&quot;),
                                    new IncreaseXPAction(800),
                                    new IncreaseKarmaAction(15),
									addRandomNumberOfItemsAction,                       
									new IncrementQuestAction(QUEST_SLOT, 2, 1),
									new SetQuestToTimeStampAction(QUEST_SLOT,1),
									new SetQuestAction(QUEST_SLOT, 0, &quot;done&quot;)));

		
<span class="fc" id="L260">	}</span>

	@Override
	public void addToWorld() {
<span class="fc" id="L264">		fillQuestInfo(</span>
				&quot;Find Jefs mother&quot;,
				&quot;Jef, a young boy in Kirdneh city, waits for his mum Amber who didn't return yet from the market.&quot;,
				false);
<span class="fc" id="L268">		offerQuestStep();</span>
<span class="fc" id="L269">		findMomStep();</span>
<span class="fc" id="L270">		bringFlowerToJefStep();</span>
<span class="fc" id="L271">	}</span>

	@Override
	public List&lt;String&gt; getHistory(final Player player) {
<span class="fc" id="L275">		final List&lt;String&gt; res = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L276" title="All 2 branches covered.">		if (!player.hasQuest(QUEST_SLOT)) {</span>
<span class="fc" id="L277">			return res;</span>
		}
<span class="fc" id="L279">		res.add(&quot;I found Jef in Kirdneh city. He waits there for his mum.&quot;);</span>
<span class="fc" id="L280">        final String questStateFull = player.getQuest(QUEST_SLOT);</span>
<span class="fc" id="L281">        final String[] parts = questStateFull.split(&quot;;&quot;);</span>
<span class="fc" id="L282">        final String questState = parts[0];</span>

<span class="fc bfc" id="L284" title="All 2 branches covered.">        if (&quot;rejected&quot;.equals(questState)) {</span>
<span class="fc" id="L285">			res.add(&quot;Finding his mum somewhere costs me too much time at the moment, that is why I rejected his request to find her.&quot;);</span>
		}
<span class="fc bfc" id="L287" title="All 2 branches covered.">		if (&quot;start&quot;.equals(questState)) {</span>
<span class="fc" id="L288">			res.add(&quot;Jef asked me to take a look at his mother Amber who didn't return from the market yet. I hope she will listen to me after I told her the name of her son, Jef.&quot;);</span>
		}
<span class="fc bfc" id="L290" title="All 2 branches covered.">		if (&quot;found_mom&quot;.equals(questState)) {</span>
<span class="fc" id="L291">			res.add(&quot;I found Amber, Jef's mother, while she walked around somewhere in Fado forest. She gave me a flower for her son and told me, that I have to tell him that she is fine.&quot;);</span>
		}
<span class="fc bfc" id="L293" title="All 2 branches covered.">        if (isCompleted(player)) {</span>
<span class="fc bfc" id="L294" title="All 2 branches covered.">            if (isRepeatable(player)) {</span>
<span class="fc" id="L295">                res.add(&quot;Its been a while since I checked on Jef's mother and should ask Jef, if he wants me to take a look after her again.&quot;);</span>
            } else {
<span class="fc" id="L297">                res.add(&quot;I told Jef that his mother is fine. He wants to leave his mother alone for some time now.&quot;);</span>
            }
		}

<span class="fc" id="L301">		return res;</span>

	}

	@Override
	public String getName() {
<span class="nc" id="L307">		return &quot;FindJefsMom&quot;;</span>
	}


	@Override
	public boolean isRepeatable(final Player player) {
<span class="fc" id="L313">		return new AndCondition(new QuestStateStartsWithCondition(QUEST_SLOT,&quot;done&quot;),</span>
				 new TimePassedCondition(QUEST_SLOT, 1, REQUIRED_MINUTES)).fire(player,null, null);
	}
	
	@Override
	public String getRegion() {
<span class="nc" id="L319">		return Region.KIRDNEH;</span>
	}
	@Override
	public String getNPCName() {
<span class="nc" id="L323">		return &quot;Jef&quot;;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>