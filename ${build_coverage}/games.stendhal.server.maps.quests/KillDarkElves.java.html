<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>KillDarkElves.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.quests</a> &gt; <span class="el_source">KillDarkElves.java</span></div><h1>KillDarkElves.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2011 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.maps.quests;

import games.stendhal.server.entity.npc.ChatAction;
import games.stendhal.server.entity.npc.ConversationPhrases;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.SpeakerNPC;
import games.stendhal.server.entity.npc.action.DropItemAction;
import games.stendhal.server.entity.npc.action.EquipItemAction;
import games.stendhal.server.entity.npc.action.ExamineChatAction;
import games.stendhal.server.entity.npc.action.IncreaseKarmaAction;
import games.stendhal.server.entity.npc.action.IncreaseXPAction;
import games.stendhal.server.entity.npc.action.MultipleActions;
import games.stendhal.server.entity.npc.action.SetQuestAction;
import games.stendhal.server.entity.npc.action.SetQuestAndModifyKarmaAction;
import games.stendhal.server.entity.npc.condition.AndCondition;
import games.stendhal.server.entity.npc.condition.GreetingMatchesNameCondition;
import games.stendhal.server.entity.npc.condition.KilledCondition;
import games.stendhal.server.entity.npc.condition.NotCondition;
import games.stendhal.server.entity.npc.condition.PlayerHasItemWithHimCondition;
import games.stendhal.server.entity.npc.condition.QuestActiveCondition;
import games.stendhal.server.entity.npc.condition.QuestCompletedCondition;
import games.stendhal.server.entity.npc.condition.QuestInStateCondition;
import games.stendhal.server.entity.npc.condition.QuestNotStartedCondition;
import games.stendhal.server.entity.player.Player;
import games.stendhal.server.maps.Region;

import java.util.Arrays;
import java.util.LinkedList;
import java.util.List;

/**
 * QUEST: Kill Dark Elves
 * &lt;p&gt;
 * 
 * PARTICIPANTS:
 * &lt;ul&gt;
 * &lt;li&gt; Maerion
 * &lt;/ul&gt;
 * 
 * STEPS:
 * &lt;ul&gt;
 * &lt;li&gt; Maerion asks you fix his dark elf problem
 * &lt;li&gt; You go kill at least a dark elf archer, captain, and thing
 * &lt;li&gt; The thing drops an amulet
 * &lt;li&gt; Maerion checks your kills, takes the amulet and gives you a ring of life
 * as reward
 * &lt;/ul&gt;
 * REWARD: &lt;ul&gt;&lt;li&gt; emerald ring &lt;li&gt; 10000 XP
 * &lt;li&gt;10 karma in total&lt;/ul&gt;
 * 
 * REPETITIONS: - None.
 */
<span class="fc" id="L65">public class KillDarkElves extends AbstractQuest {</span>
	private static final String QUEST_SLOT = &quot;kill_dark_elves&quot;;
<span class="fc" id="L67">	protected final List&lt;String&gt; creatures = </span>
		Arrays.asList(&quot;dark elf captain&quot;,
				      &quot;dark elf general&quot;,
				      &quot;dark elf knight&quot;,
				      &quot;dark elf wizard&quot;,
				      &quot;dark elf sacerdotist&quot;,
				      &quot;dark elf viceroy&quot;,
				      &quot;dark elf matronmother&quot;,
					  &quot;dark elf elite archer&quot;,
				      &quot;dark elf archer&quot;);
	
	@Override
	public String getSlotName() {
<span class="fc" id="L80">		return QUEST_SLOT;</span>
	}

	private void step_1() {
<span class="fc" id="L84">		final SpeakerNPC npc = npcs.get(&quot;Maerion&quot;);</span>

<span class="fc" id="L86">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES, 
				new QuestActiveCondition(QUEST_SLOT),
				ConversationStates.ATTENDING, 
				&quot;I already asked you to kill every dark elf in the tunnel below the secret room. And bring me the amulet from the thing.&quot;,
				null);

		
<span class="fc" id="L94">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES, 
				new QuestCompletedCondition(QUEST_SLOT),
				ConversationStates.ATTENDING, 
				&quot;Thanks for your help. I am relieved to have the amulet back.&quot;,
				null);
		
<span class="fc" id="L101">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES, 
				new QuestNotStartedCondition(QUEST_SLOT),
				ConversationStates.QUEST_OFFERED, 
				&quot;I have a problem with some dark elves. I used to be in league with them... now they are too strong. There is access to their lair from a #secret #room in this hall.&quot;,
				null);

<span class="fc" id="L108">		final List&lt;ChatAction&gt; actions = new LinkedList&lt;ChatAction&gt;();</span>
		//actions.add(new StartRecordingKillsAction(&quot;dark elf archer&quot;, &quot;dark elf captain&quot;, &quot;thing&quot;));
<span class="fc" id="L110">		actions.add(new SetQuestAction(QUEST_SLOT, &quot;started&quot;));</span>
<span class="fc" id="L111">		actions.add(new ExamineChatAction(&quot;dark-elves-wanted.png&quot;, &quot;Wanted!&quot;, &quot;&quot;));</span>

<span class="fc" id="L113">		npc.add(</span>
			ConversationStates.QUEST_OFFERED,
			ConversationPhrases.YES_MESSAGES,
			null,
			ConversationStates.ATTENDING,
			&quot;Good. Please kill every dark elf down there and get the amulet from the mutant thing.&quot;,
			new MultipleActions(actions));

<span class="fc" id="L121">		npc.add(ConversationStates.QUEST_OFFERED, </span>
			ConversationPhrases.NO_MESSAGES, 
			null,
			ConversationStates.ATTENDING,
			&quot;Then I fear for the safety of the Nalwor elves...&quot;,
			new SetQuestAndModifyKarmaAction(QUEST_SLOT, &quot;rejected&quot;, -5.0));

<span class="fc" id="L128">		npc.add(</span>
			ConversationStates.QUEST_OFFERED,
			Arrays.asList(&quot;secret&quot;, &quot;room&quot;, &quot;secret room&quot;),
			null,
			ConversationStates.QUEST_OFFERED,
			&quot;It's that room downstairs with a grey roof and the evil face on the door. Inside you'll find what the dark elves were making, a mutant thing. Will you help?&quot;,
			null);
<span class="fc" id="L135">	}</span>

	private void step_2() {
		// Go kill the dark elves and get the amulet from the thing
<span class="fc" id="L139">	}</span>

	private void step_3() {

<span class="fc" id="L143">		final SpeakerNPC npc = npcs.get(&quot;Maerion&quot;);</span>

		// support for old-style quest
		
		// the player returns to Maerion after having started the quest.
		// Maerion checks if the player has killed one of enough dark elf types
<span class="fc" id="L149">		npc.add(ConversationStates.IDLE, ConversationPhrases.GREETING_MESSAGES,</span>
				new AndCondition(new GreetingMatchesNameCondition(npc.getName()),
						new QuestInStateCondition(QUEST_SLOT, &quot;start&quot;),
						new NotCondition(new KilledCondition(&quot;dark elf archer&quot;, &quot;dark elf captain&quot;, &quot;thing&quot;))),
				ConversationStates.QUEST_STARTED, 
				&quot;Don't you remember promising to sort out my dark elf problem? Kill every dark elf in the #secret room below - especially the snivelling dark elf captain and any evil dark elf archers you find! And bring me the amulet from the mutant thing.&quot;,
				null);
		
<span class="fc" id="L157">		npc.add(ConversationStates.IDLE, </span>
				ConversationPhrases.GREETING_MESSAGES,
				new AndCondition(new GreetingMatchesNameCondition(npc.getName()),
						new QuestInStateCondition(QUEST_SLOT, &quot;start&quot;),
						new KilledCondition(&quot;dark elf archer&quot;, &quot;dark elf captain&quot;, &quot;thing&quot;),
						new NotCondition(new PlayerHasItemWithHimCondition(&quot;amulet&quot;)))
				, ConversationStates.QUEST_STARTED
				, &quot;What happened to the amulet? Remember I need it back!&quot;
				, null);
	
<span class="fc" id="L167">		npc.add(ConversationStates.IDLE, </span>
				ConversationPhrases.GREETING_MESSAGES,
				new AndCondition(new GreetingMatchesNameCondition(npc.getName()),
						new QuestInStateCondition(QUEST_SLOT, &quot;start&quot;),
						new KilledCondition(&quot;dark elf archer&quot;, &quot;dark elf captain&quot;, &quot;thing&quot;),
						new PlayerHasItemWithHimCondition(&quot;amulet&quot;))
				, ConversationStates.ATTENDING
				, &quot;Many, many thanks. I am relieved to have that back. Here, take this ring. It can revive the powers of the dead.&quot;,
				new MultipleActions(new DropItemAction(&quot;amulet&quot;),
						new EquipItemAction(&quot;emerald ring&quot;, 1, true),
						new IncreaseXPAction(10000),
						new IncreaseKarmaAction(5.0),
						new SetQuestAction(QUEST_SLOT, &quot;done&quot;)));
		
		
		// support for new-style quest
		
		// building string for completed quest state
<span class="fc" id="L185">		StringBuilder sb = new StringBuilder(&quot;started&quot;);</span>
<span class="fc bfc" id="L186" title="All 2 branches covered.">		for(int i=0;i&lt;creatures.size();i++) {</span>
<span class="fc" id="L187">			sb.append(&quot;;&quot;);</span>
<span class="fc" id="L188">			sb.append(creatures.get(i));</span>
		}
<span class="fc" id="L190">		final String completedQuestState = sb.toString();</span>
		
		// the player returns to Maerion after having started the quest.
		// Maerion checks if the player has killed one of enough dark elf types
<span class="fc" id="L194">		npc.add(ConversationStates.IDLE, ConversationPhrases.GREETING_MESSAGES,</span>
				new AndCondition(
						new QuestInStateCondition(QUEST_SLOT,0,&quot;started&quot;),
						new NotCondition(
								new QuestInStateCondition(QUEST_SLOT, completedQuestState))),
				ConversationStates.QUEST_STARTED, 
				&quot;Don't you remember promising to sort out my dark elf problem?&quot;+
				&quot; Kill every dark elf in the #secret room below - especially&quot;+
				&quot; the ones who command, do magic or are archers.&quot; +
				&quot;  Don't forget the evil matronmother too.&quot;+
				&quot; And bring me the amulet from the mutant thing.&quot;,
				new ExamineChatAction(&quot;dark-elves-wanted.png&quot;, &quot;Wanted!&quot;, &quot;&quot;));
		
<span class="fc" id="L207">		npc.add(ConversationStates.IDLE, </span>
				ConversationPhrases.GREETING_MESSAGES,
				new AndCondition(new GreetingMatchesNameCondition(npc.getName()),
						new QuestInStateCondition(QUEST_SLOT, completedQuestState),
						new NotCondition(
								new PlayerHasItemWithHimCondition(&quot;amulet&quot;)))
				, ConversationStates.QUEST_STARTED
				, &quot;What happened to the amulet? Remember I need it back!&quot;
				, null);
	
<span class="fc" id="L217">		npc.add(ConversationStates.IDLE, </span>
				ConversationPhrases.GREETING_MESSAGES,
				new AndCondition(new GreetingMatchesNameCondition(npc.getName()),
						new QuestInStateCondition(QUEST_SLOT, completedQuestState),								   
						new PlayerHasItemWithHimCondition(&quot;amulet&quot;))
				, ConversationStates.ATTENDING
				, &quot;Many, many thanks. I am relieved to have that back. Here, take this ring. It can revive the powers of the dead.&quot;,
				new MultipleActions(new DropItemAction(&quot;amulet&quot;),
						new EquipItemAction(&quot;emerald ring&quot;, 1, true),
						new IncreaseXPAction(10000),
						new IncreaseKarmaAction(5.0),
						new SetQuestAction(QUEST_SLOT, &quot;done&quot;)));
		
<span class="fc" id="L230">		npc.add(</span>
			ConversationStates.QUEST_STARTED,
			Arrays.asList(&quot;secret&quot;, &quot;room&quot;, &quot;secret room&quot;),
			null,
			ConversationStates.ATTENDING,
			&quot;The room is below us. It has a grey roof and a evil face for a door. I need you to kill all the dark elves and bring me the amulet from the mutant thing.&quot;,
			null);
<span class="fc" id="L237">	}</span>

	@Override
	public void addToWorld() {
<span class="fc" id="L241">		fillQuestInfo(</span>
				&quot;Kill Dark Elves&quot;,
				&quot;Maerion, leader of Elves, wants to kill dark elves in the secret room to hide his plots and get back his amulet.&quot;,
				false);
<span class="fc" id="L245">		step_1();</span>
<span class="fc" id="L246">		step_2();</span>
<span class="fc" id="L247">		step_3();</span>
<span class="fc" id="L248">	}</span>

	@Override
	public String getName() {
<span class="nc" id="L252">		return &quot;KillDarkElves&quot;;</span>
	}
	
	/**
	 * function return list of drow creatures to kill
	 * @return - list of dark elves to kill
	 */
	public List&lt;String&gt; getDrowCreaturesList() {
<span class="nc" id="L260">		return creatures;</span>
	}
	
	// Killing the thing probably requires a level even higher than this - but they can get help
	@Override
	public int getMinLevel() {
<span class="fc" id="L266">		return 100;</span>
	}
	
	@Override
	public List&lt;String&gt; getHistory(final Player player) {
<span class="fc" id="L271"> 		LinkedList&lt;String&gt; history = new LinkedList&lt;String&gt;();</span>
<span class="fc bfc" id="L272" title="All 2 branches covered.">		if (!player.hasQuest(QUEST_SLOT)) {</span>
<span class="fc" id="L273">			return history;</span>
		}
<span class="fc" id="L275">		final String questState = player.getQuest(QUEST_SLOT, 0);</span>

<span class="fc bfc" id="L277" title="All 2 branches covered.">		if (&quot;rejected&quot;.equals(questState)) {</span>
<span class="fc" id="L278">			history.add(&quot;I do not want to help Maerion.&quot;);</span>
<span class="fc" id="L279">			return history;</span>
		}
<span class="fc bfc" id="L281" title="All 2 branches covered.">		if (&quot;done&quot;.equals(questState)) {</span>
<span class="fc" id="L282">			history.add(&quot;I completed Maerion's quest and got an emerald ring of life!&quot;);</span>
<span class="fc" id="L283">			return history;</span>
		}

		// we can be here only if player accepted this quest.
<span class="fc" id="L287">		history.add(&quot;I agreed to help Maerion.&quot;);</span>
		
<span class="fc" id="L289">		boolean ak=true;	</span>
		
<span class="fc bfc" id="L291" title="All 2 branches covered.">		if(&quot;started&quot;.equals(player.getQuest(QUEST_SLOT, 0))) {</span>
			// checking which creatures player killed.		
<span class="fc bfc" id="L293" title="All 2 branches covered.">			for(int i = 0; i&lt;creatures.size();i++) {</span>
<span class="fc" id="L294">				final boolean sp = creatures.get(i).equals(player.getQuest(QUEST_SLOT, i+1));</span>
<span class="fc" id="L295">				ak = ak &amp; sp;</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">				if(!sp) {</span>
<span class="fc" id="L297">					history.add(&quot;I have not yet killed the &quot;+creatures.get(i)+&quot; in the secret room.&quot;);</span>
				}
			}		
<span class="fc bfc" id="L300" title="All 2 branches covered.">			for(int i = 0; i&lt;creatures.size();i++) {</span>
<span class="fc" id="L301">				final boolean sp = creatures.get(i).equals(player.getQuest(QUEST_SLOT, i+1));</span>
<span class="fc bfc" id="L302" title="All 2 branches covered.">				if(sp) {</span>
<span class="fc" id="L303">					history.add(&quot;I have killed the &quot;+creatures.get(i)+&quot; in the secret room.&quot;);</span>
				}		
			}

			// all killed
<span class="fc bfc" id="L308" title="All 2 branches covered.">			if (ak) {</span>
<span class="fc" id="L309">				history.add(&quot;I have killed all required creatures.&quot;);</span>
			}
		}
		
		// here is support for old-style quest
<span class="fc bfc" id="L314" title="All 2 branches covered.">		if (&quot;start&quot;.equals(player.getQuest(QUEST_SLOT, 0))) {</span>
<span class="fc" id="L315">			final boolean osp1 = player.hasKilled(&quot;dark elf captain&quot;);</span>
<span class="fc" id="L316">			final boolean osp2 = player.hasKilled(&quot;dark elf archer&quot;);</span>
<span class="fc" id="L317">			final boolean osp3 = player.hasKilled(&quot;thing&quot;);</span>
			// first add killed creatures
<span class="fc bfc" id="L319" title="All 2 branches covered.">			if (osp1) {</span>
<span class="fc" id="L320">				history.add(&quot;I have killed the dark elf captain in the secret room.&quot;);				</span>
			}		
<span class="fc bfc" id="L322" title="All 2 branches covered.">			if (osp2) {</span>
<span class="fc" id="L323">				history.add(&quot;I have killed the dark elf archer in the secret room.&quot;);				</span>
			}
<span class="fc bfc" id="L325" title="All 2 branches covered.">			if (osp3) {</span>
<span class="fc" id="L326">				history.add(&quot;I have killed the thing.&quot;);				</span>
			}
			
			// now add non-killed
<span class="fc bfc" id="L330" title="All 2 branches covered.">			if (!osp1) {</span>
<span class="fc" id="L331">				history.add(&quot;I have not yet killed the dark elf captain in the secret room.&quot;);				</span>
			}	
<span class="fc bfc" id="L333" title="All 2 branches covered.">			if (!osp2) {</span>
<span class="fc" id="L334">				history.add(&quot;I have not yet killed the dark elf archer in the secret room.&quot;);				</span>
			}		
<span class="fc bfc" id="L336" title="All 2 branches covered.">			if (!osp3) {</span>
<span class="fc" id="L337">				history.add(&quot;I have not yet killed the thing.&quot;);				</span>
			}
			
			// all killed
<span class="pc bpc" id="L341" title="2 of 6 branches missed.">			if (osp1 &amp;&amp; osp2 &amp;&amp; osp3) {</span>
<span class="fc" id="L342">				history.add(&quot;I have killed all required creatures.&quot;);</span>
<span class="fc" id="L343">				ak=true;</span>
			}	
		}
		
		// for both old- and new-style quests
<span class="fc" id="L348">		final boolean am = player.isEquipped(&quot;amulet&quot;);</span>
<span class="fc bfc" id="L349" title="All 2 branches covered.">		if (am) {</span>
<span class="fc" id="L350">			history.add(&quot;I have the amulet with me.&quot;);</span>
		} else {
<span class="fc" id="L352">			history.add(&quot;I have no amulet with me.&quot;);</span>
		}
		
<span class="pc bpc" id="L355" title="1 of 4 branches missed.">		if (am &amp;&amp; ak) {</span>
<span class="fc" id="L356">			history.add(&quot;It's time to go back to Maerion for a reward.&quot;);</span>
		}
		
<span class="fc" id="L359">		return history;		</span>
	}
	
	@Override
	public String getRegion() {
<span class="nc" id="L364">		return Region.NALWOR_CITY;</span>
	}

	@Override
	public String getNPCName() {
<span class="nc" id="L369">		return &quot;Maerion&quot;;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>