<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>VampireSword.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.quests</a> &gt; <span class="el_source">VampireSword.java</span></div><h1>VampireSword.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.maps.quests;

import games.stendhal.server.entity.npc.ChatAction;
import games.stendhal.server.entity.npc.ConversationPhrases;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.SpeakerNPC;
import games.stendhal.server.entity.npc.action.DropItemAction;
import games.stendhal.server.entity.npc.action.EquipItemAction;
import games.stendhal.server.entity.npc.action.IncreaseKarmaAction;
import games.stendhal.server.entity.npc.action.IncreaseXPAction;
import games.stendhal.server.entity.npc.action.MultipleActions;
import games.stendhal.server.entity.npc.action.SayTimeRemainingAction;
import games.stendhal.server.entity.npc.action.SetQuestAction;
import games.stendhal.server.entity.npc.action.SetQuestAndModifyKarmaAction;
import games.stendhal.server.entity.npc.action.SetQuestToTimeStampAction;
import games.stendhal.server.entity.npc.behaviour.adder.ProducerAdder;
import games.stendhal.server.entity.npc.behaviour.impl.ProducerBehaviour;
import games.stendhal.server.entity.npc.condition.AndCondition;
import games.stendhal.server.entity.npc.condition.GreetingMatchesNameCondition;
import games.stendhal.server.entity.npc.condition.KilledCondition;
import games.stendhal.server.entity.npc.condition.NotCondition;
import games.stendhal.server.entity.npc.condition.PlayerHasItemWithHimCondition;
import games.stendhal.server.entity.npc.condition.QuestActiveCondition;
import games.stendhal.server.entity.npc.condition.QuestCompletedCondition;
import games.stendhal.server.entity.npc.condition.QuestInStateCondition;
import games.stendhal.server.entity.npc.condition.QuestNotStartedCondition;
import games.stendhal.server.entity.npc.condition.QuestStateStartsWithCondition;
import games.stendhal.server.entity.npc.condition.TimePassedCondition;
import games.stendhal.server.entity.player.Player;
import games.stendhal.server.maps.Region;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.TreeMap;

/**
 * QUEST: The Vampire Sword
 * &lt;p&gt;
 * PARTICIPANTS:
 * &lt;ul&gt;
 * &lt;li&gt;Hogart, a retired master dwarf smith, forgotten below the dwarf mines in
 * Orril.&lt;/li&gt;
 * &lt;li&gt;Markovich, a sick vampire who will fill the goblet.&lt;/li&gt;
 * &lt;/ul&gt;
 * &lt;p&gt;
 * STEPS:
 * &lt;ul&gt;
 * &lt;li&gt;Hogart tells you the story of the Vampire Lord.&lt;/li&gt;
 * &lt;li&gt;He offers to forge a Vampire Sword for you if you bring him what it
 * needs.&lt;/li&gt;
 * &lt;li&gt;Go to the catacombs, kill 7 vampirettes to get to the 3rd level, kill 7
 * killer bats and the vampire lord to get the required items to fill the
 * goblet.&lt;/li&gt;
 * &lt;li&gt;Fill the goblet and come back.&lt;/li&gt;
 * &lt;li&gt;You get some items from the Catacombs and kill the Vampire Lord.&lt;/li&gt;
 * &lt;li&gt;You get the iron needed in the usual way by collecting iron ore and
 * casting in Semos.&lt;/li&gt;
 * &lt;li&gt;Hogart forges the Vampire Sword for you.&lt;/li&gt;
 * &lt;/ul&gt;
 * &lt;p&gt;
 * REWARD:
 * &lt;ul&gt;
 * &lt;li&gt;Vampire Sword&lt;/li&gt;
 * &lt;li&gt;5,000 XP&lt;/li&gt;
 * &lt;li&gt;some karma&lt;/li&gt;
 * &lt;/ul&gt;
 * &lt;p&gt;
 * REPETITIONS:
 * &lt;ul&gt;
 * &lt;li&gt;None&lt;/li&gt;
 * &lt;/ul&gt;
 */
<span class="fc" id="L88">public class VampireSword extends AbstractQuest {</span>

	private static final int REQUIRED_IRON = 10;

	private static final int REQUIRED_MINUTES = 10;

	private static final String QUEST_SLOT = &quot;vs_quest&quot;;

	@Override
	public String getSlotName() {
<span class="fc" id="L98">		return QUEST_SLOT;</span>
	}

	private void prepareQuestOfferingStep() {
		
<span class="fc" id="L103">		final SpeakerNPC npc = npcs.get(&quot;Hogart&quot;);</span>
		
		// Player asks about quests, and had previously rejected or never asked: offer it
<span class="fc" id="L106">		npc.add(ConversationStates.ATTENDING,</span>
			ConversationPhrases.QUEST_MESSAGES, 
			new QuestNotStartedCondition(QUEST_SLOT),
			ConversationStates.QUEST_OFFERED, 
			&quot;I can forge a powerful life stealing sword for you. You will need to go to the Catacombs below Semos Graveyard and fight the Vampire Lord. Are you interested?&quot;,
			null);
		
		// Player asks about quests, but has finished this quest
<span class="fc" id="L114">		npc.add(ConversationStates.ATTENDING,</span>
			ConversationPhrases.QUEST_MESSAGES, 
			new QuestCompletedCondition(QUEST_SLOT),
			ConversationStates.ATTENDING, 
			&quot;What are you bothering me for now? You've got your sword, go and use it!&quot;,
			null);
		
		// Player asks about quests, but has not finished this quest
<span class="fc" id="L122">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES, 
				new QuestActiveCondition(QUEST_SLOT),
				ConversationStates.ATTENDING, 
				&quot;Why are you bothering me when you haven't completed your quest yet?&quot;,
				null);

<span class="fc" id="L129">		final List&lt;ChatAction&gt; gobletactions = new LinkedList&lt;ChatAction&gt;();</span>
<span class="fc" id="L130">		gobletactions.add(new EquipItemAction(&quot;empty goblet&quot;));</span>
<span class="fc" id="L131">		gobletactions.add(new SetQuestAction(QUEST_SLOT, &quot;start&quot;));</span>
		// Player wants to do the quest
<span class="fc" id="L133">		npc.add(ConversationStates.QUEST_OFFERED,</span>
			ConversationPhrases.YES_MESSAGES, null,
			ConversationStates.ATTENDING, &quot;Then you need this #goblet. Take it to the Semos #Catacombs.&quot;,
			new MultipleActions(gobletactions));
		
		// Player doesn't want to do the quest; remember this, but they can ask again to start it.
<span class="fc" id="L139">		npc.add(</span>
			ConversationStates.QUEST_OFFERED,
			ConversationPhrases.NO_MESSAGES,
			null,
			ConversationStates.IDLE,
			&quot;Oh, well forget it then. You must have a better sword than I can forge, huh? Bye.&quot;,
			new SetQuestAndModifyKarmaAction(QUEST_SLOT, &quot;rejected&quot;, -5.0));

<span class="fc" id="L147">		npc.addReply(&quot;catacombs&quot;, &quot;The Catacombs of north Semos of the ancient #stories.&quot;);</span>

<span class="fc" id="L149">		npc.addReply(&quot;goblet&quot;, &quot;Go fill it with the blood of the enemies you meet in the #Catacombs.&quot;);</span>
<span class="fc" id="L150">	}</span>

	private void prepareGobletFillingStep() {

<span class="fc" id="L154">		final SpeakerNPC npc = npcs.get(&quot;Markovich&quot;);</span>

<span class="fc" id="L156">		npc.addGoodbye(&quot;*cough* ... farewell ... *cough*&quot;);</span>
<span class="fc" id="L157">		npc.addReply(</span>
			Arrays.asList(&quot;blood&quot;, &quot;vampirette entrails&quot;, &quot;bat entrails&quot;),
			&quot;I need blood. I can take it from the entrails of the alive and undead. I will mix the bloods together for you and #fill your #goblet, if you let me drink some too. But I'm afraid of the powerful #lord.&quot;);

<span class="fc" id="L161">		npc.addReply(Arrays.asList(&quot;lord&quot;, &quot;vampire&quot;, &quot;skull ring&quot;),</span>
			&quot;The Vampire Lord rules these Catacombs! And I'm afraid of him. I can only help you if you kill him and bring me his skull ring with the #goblet.&quot;);

<span class="fc" id="L164">		npc.addReply(</span>
			Arrays.asList(&quot;empty goblet&quot;, &quot;goblet&quot;),
			&quot;Only a powerful talisman like this cauldron or a special goblet should contain blood.&quot;);

		// The sick vampire is only a producer. He doesn't care if your quest slot is active, or anything.
		// So to ensure that the vampire lord must have been killed, we made the skull ring a required item
		// Which the vampire lord drops if the quest is active as in games.stendhal.server.maps.semos.catacombs.VampireLordCreature
		// But, it could have been done other ways using quests slot checks and killed conditions
<span class="fc" id="L172">		final Map&lt;String, Integer&gt; requiredResources = new TreeMap&lt;String, Integer&gt;();	</span>
<span class="fc" id="L173">		requiredResources.put(&quot;vampirette entrails&quot;, 7);</span>
<span class="fc" id="L174">		requiredResources.put(&quot;bat entrails&quot;, 7);</span>
<span class="fc" id="L175">		requiredResources.put(&quot;skull ring&quot;, 1);</span>
<span class="fc" id="L176">		requiredResources.put(&quot;empty goblet&quot;, 1);</span>
<span class="fc" id="L177">		final ProducerBehaviour behaviour = new ProducerBehaviour(</span>
				&quot;sicky_fill_goblet&quot;, &quot;fill&quot;, &quot;goblet&quot;, requiredResources,
				5 * 60, true);
<span class="fc" id="L180">		new ProducerAdder().addProducer(npc, behaviour,</span>
			&quot;Please don't try to kill me...I'm just a sick old #vampire. Do you have any #blood I could drink? If you have an #empty goblet I will #fill it with blood for you in my cauldron.&quot;);

<span class="fc" id="L183">	}</span>

	private void prepareForgingStep() {

<span class="fc" id="L187">		final SpeakerNPC npc = npcs.get(&quot;Hogart&quot;);</span>

<span class="fc" id="L189">		final List&lt;ChatAction&gt; startforging = new LinkedList&lt;ChatAction&gt;();</span>
<span class="fc" id="L190">		startforging.add(new DropItemAction(&quot;goblet&quot;));</span>
<span class="fc" id="L191">		startforging.add(new DropItemAction(&quot;iron&quot;, 10));</span>
<span class="fc" id="L192">		startforging.add(new IncreaseKarmaAction(5.0));</span>
<span class="fc" id="L193">		startforging.add(new SetQuestAction(QUEST_SLOT, &quot;forging;&quot;));</span>
<span class="fc" id="L194">		startforging.add(new SetQuestToTimeStampAction(QUEST_SLOT, 1));</span>
		
		// Player returned with goblet and had killed the vampire lord, and has iron, so offer to forge the sword.
<span class="fc" id="L197">		npc.add(ConversationStates.IDLE, ConversationPhrases.GREETING_MESSAGES,</span>
				new AndCondition(new GreetingMatchesNameCondition(npc.getName()),
					new QuestInStateCondition(QUEST_SLOT,&quot;start&quot;),
					new PlayerHasItemWithHimCondition(&quot;goblet&quot;),
					new KilledCondition(&quot;vampire lord&quot;),
					new PlayerHasItemWithHimCondition(&quot;iron&quot;, REQUIRED_IRON)), 
			ConversationStates.IDLE, 
			&quot;You've brought everything I need to make the vampire sword. Come back in &quot;
			+ REQUIRED_MINUTES
			+ &quot; minutes and it will be ready&quot;, 
			new MultipleActions(startforging));

		// Player returned with goblet and had killed the vampire lord, so offer to forge the sword if iron is brought
<span class="fc" id="L210">		npc.add(ConversationStates.IDLE, ConversationPhrases.GREETING_MESSAGES,</span>
				new AndCondition(new GreetingMatchesNameCondition(npc.getName()),
						new QuestInStateCondition(QUEST_SLOT,&quot;start&quot;),
						new PlayerHasItemWithHimCondition(&quot;goblet&quot;),
						new KilledCondition(&quot;vampire lord&quot;),
						new NotCondition(new PlayerHasItemWithHimCondition(&quot;iron&quot;, REQUIRED_IRON))), 
		ConversationStates.QUEST_ITEM_BROUGHT, 
		&quot;You have battled hard to bring that goblet. I will use it to #forge the vampire sword&quot;,
		null);
		
		// Player has only an empty goblet currently, remind to go to Catacombs
<span class="fc" id="L221">		npc.add(ConversationStates.IDLE, ConversationPhrases.GREETING_MESSAGES,</span>
				new AndCondition(new GreetingMatchesNameCondition(npc.getName()),
					new QuestInStateCondition(QUEST_SLOT,&quot;start&quot;),
					new PlayerHasItemWithHimCondition(&quot;empty goblet&quot;),
					new NotCondition(new PlayerHasItemWithHimCondition(&quot;goblet&quot;))), 
			ConversationStates.IDLE, 
			&quot;Did you lose your way? The Catacombs are in North Semos. Don't come back without a &quot; +
			&quot;full goblet! Bye!&quot;,
			null);
		
		// Player has a goblet (somehow) but did not kill a vampire lord
<span class="fc" id="L232">		npc.add(ConversationStates.IDLE, ConversationPhrases.GREETING_MESSAGES,</span>
				new AndCondition(new GreetingMatchesNameCondition(npc.getName()), 
						new QuestInStateCondition(QUEST_SLOT,&quot;start&quot;),
						new PlayerHasItemWithHimCondition(&quot;goblet&quot;),
						new NotCondition(new KilledCondition(&quot;vampire lord&quot;))), 
		ConversationStates.IDLE, 
		&quot;Hm, that goblet is not filled with vampire blood; it can't be, you have not killed the vampire lord. You must slay him.&quot;,
		null);
		
		// Player lost the empty goblet?
<span class="fc" id="L242">		npc.add(ConversationStates.IDLE, ConversationPhrases.GREETING_MESSAGES,</span>
				new AndCondition(new GreetingMatchesNameCondition(npc.getName()),
						new QuestInStateCondition(QUEST_SLOT,&quot;start&quot;),
						new NotCondition(new PlayerHasItemWithHimCondition(&quot;empty goblet&quot;)),
						new NotCondition(new PlayerHasItemWithHimCondition(&quot;goblet&quot;))), 
			ConversationStates.QUESTION_1, 
			&quot;I hope you didn't lose your goblet! Do you need another?&quot;, 
			null);

		// Player lost the empty goblet, wants another
<span class="fc" id="L252">		npc.add(ConversationStates.QUESTION_1,</span>
			ConversationPhrases.YES_MESSAGES, null,
			ConversationStates.IDLE, &quot;You stupid ..... Be more careful next time. Bye!&quot;, 
			new EquipItemAction(&quot;empty goblet&quot;));
		
		// Player doesn't have the empty goblet but claims they don't need another.
<span class="fc" id="L258">		npc.add(</span>
			ConversationStates.QUESTION_1,
			ConversationPhrases.NO_MESSAGES,
			null,
			ConversationStates.IDLE,
			&quot;Then why are you back here? Go slay some vampires! Bye!&quot;,
			null);
		
		// Returned too early; still forging
<span class="fc" id="L267">		npc.add(ConversationStates.IDLE, ConversationPhrases.GREETING_MESSAGES,</span>
				new AndCondition(new GreetingMatchesNameCondition(npc.getName()),
						new QuestStateStartsWithCondition(QUEST_SLOT, &quot;forging;&quot;),
						new NotCondition(new TimePassedCondition(QUEST_SLOT, 1, REQUIRED_MINUTES))),
				ConversationStates.IDLE, null,
				new SayTimeRemainingAction(QUEST_SLOT, 1, REQUIRED_MINUTES, &quot;I haven't finished forging the sword. Please check back in&quot; +
								&quot;&quot;));
		
<span class="fc" id="L275">		final List&lt;ChatAction&gt; reward = new LinkedList&lt;ChatAction&gt;();</span>
<span class="fc" id="L276">		reward.add(new IncreaseXPAction(5000));</span>
<span class="fc" id="L277">		reward.add(new IncreaseKarmaAction(15.0));</span>
		// here true means: yes, bound to player, in which case we also have to speciy the amount: 1
<span class="fc" id="L279">		reward.add(new EquipItemAction(&quot;vampire sword&quot;, 1, true));</span>
<span class="fc" id="L280">		reward.add(new SetQuestAction(QUEST_SLOT, &quot;done&quot;));</span>

<span class="fc" id="L282">		npc.add(ConversationStates.IDLE, ConversationPhrases.GREETING_MESSAGES,</span>
				new AndCondition(new GreetingMatchesNameCondition(npc.getName()),
						new QuestStateStartsWithCondition(QUEST_SLOT, &quot;forging;&quot;),
						new TimePassedCondition(QUEST_SLOT, 1, REQUIRED_MINUTES)),
			ConversationStates.IDLE, 
			&quot;I have finished forging the mighty Vampire Sword. You deserve this. Now i'm going back to work, goodbye!&quot;, 
			new MultipleActions(reward));

<span class="fc" id="L290">		npc.add(</span>
			ConversationStates.QUEST_ITEM_BROUGHT,
			&quot;forge&quot;,
			null,
			ConversationStates.QUEST_ITEM_BROUGHT,
			&quot;Bring me &quot;
				+ REQUIRED_IRON
				+ &quot; #iron bars to forge the sword with. Don't forget to bring the goblet too.&quot;,
			null);

<span class="fc" id="L300">		npc.add(</span>
			ConversationStates.QUEST_ITEM_BROUGHT,
			&quot;iron&quot;,
			null,
			ConversationStates.IDLE,
			&quot;You know, collect the iron ore lying around and get it cast! Bye!&quot;,
			null);
<span class="fc" id="L307">	}</span>

	@Override
	public void addToWorld() {
<span class="fc" id="L311">		fillQuestInfo(</span>
				&quot;Vampire Sword&quot;,
				&quot;Hogart tells a thrilling story of vampires and betrayal. This inspires the idea of a life stealing sword he can forge.&quot;,
				false);
<span class="fc" id="L315">		prepareQuestOfferingStep();</span>
<span class="fc" id="L316">		prepareGobletFillingStep();</span>
<span class="fc" id="L317">		prepareForgingStep();</span>
<span class="fc" id="L318">	}</span>

	@Override
	public List&lt;String&gt; getHistory(final Player player) {
<span class="nc" id="L322">		final List&lt;String&gt; res = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">		if (!player.hasQuest(QUEST_SLOT)) {</span>
<span class="nc" id="L324">			return res;</span>
		}
<span class="nc" id="L326">		res.add(&quot;I have met Hogart at the dwarf blacksmith.&quot;);</span>
<span class="nc" id="L327">		final String questState = player.getQuest(QUEST_SLOT);</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">		if (questState.equals(&quot;rejected&quot;)) {</span>
<span class="nc" id="L329">			res.add(&quot;I do not want to earn the vampire sword&quot;);</span>
		}
<span class="nc bnc" id="L331" title="All 2 branches missed.">		if (player.isQuestInState(QUEST_SLOT, &quot;start&quot;, &quot;done&quot;)) {</span>
<span class="nc" id="L332">			res.add(&quot;I want the life stealing sword. I need to return to Hogart with a goblet of blood&quot;);</span>
		}
<span class="nc bnc" id="L334" title="All 6 branches missed.">		if (questState.equals(&quot;start&quot;) &amp;&amp; player.isEquipped(&quot;goblet&quot;)</span>
				|| questState.equals(&quot;done&quot;)) {
<span class="nc" id="L336">			res.add(&quot;I have filled the goblet and now I need to bring Hogart the materials he needs.&quot;);</span>
		}
<span class="nc bnc" id="L338" title="All 2 branches missed.">		if (player.getQuest(QUEST_SLOT).startsWith(&quot;forging;&quot;)) {</span>
<span class="nc" id="L339">			res.add(&quot;I took 10 iron and the goblet to Hogart. Now he's forging my sword.&quot;);</span>
		}
<span class="nc bnc" id="L341" title="All 2 branches missed.">		if (questState.equals(&quot;done&quot;)) {</span>
<span class="nc" id="L342">			res.add(&quot;Finally I earned the vampire sword.&quot;);</span>
		}
<span class="nc" id="L344">		return res;</span>
	}

	@Override
	public String getName() {
<span class="nc" id="L349">		return &quot;VampireSword&quot;;</span>
	}
	
	@Override
	public int getMinLevel() {
<span class="fc" id="L354">		return 50;</span>
	}

	@Override
	public String getNPCName() {
<span class="nc" id="L359">		return &quot;Hogart&quot;;</span>
	}
	
	@Override
	public String getRegion() {
<span class="nc" id="L364">		return Region.ORRIL_MINES;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>