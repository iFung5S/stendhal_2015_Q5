<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TilesetGroupAnimationMap.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.client.sprite</a> &gt; <span class="el_source">TilesetGroupAnimationMap.java</span></div><h1>TilesetGroupAnimationMap.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.client.sprite;


import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.util.HashMap;
import java.util.Map;
import java.util.StringTokenizer;

import org.apache.log4j.Logger;

/**
 * A group of tileset animation maps. This might normally be called
 * &lt;code&gt;TilesetsAnimationMap&lt;/code&gt;, but is less likely to mix-up with
 * &lt;code&gt;TilesetAnimationMap&lt;/code&gt;.
 */
public class TilesetGroupAnimationMap {
	/**
	 * The logger.
	 */
<span class="nc" id="L35">	private static final Logger LOGGER = Logger.getLogger(TilesetGroupAnimationMap.class);</span>

	/**
	 * The map of tileset animation maps.
	 */
	private Map&lt;String, TilesetAnimationMap&gt; tilesets;

	/**
	 * Create a map of tileset animation maps.
	 */
<span class="nc" id="L45">	public TilesetGroupAnimationMap() {</span>
<span class="nc" id="L46">		tilesets = new HashMap&lt;String, TilesetAnimationMap&gt;();</span>
<span class="nc" id="L47">	}</span>

	//
	// TilesetGroupAnimationMap
	//

	/**
	 * Acquire a named tileset map. If it does not exists, it will be created.
	 * 
	 * @param name
	 *            The name of the tileset.
	 * 
	 * @return An tileset animation map.
	 */
	private TilesetAnimationMap acquire(final String name) {
<span class="nc" id="L62">		TilesetAnimationMap map = tilesets.get(name);</span>

<span class="nc bnc" id="L64" title="All 2 branches missed.">		if (map == null) {</span>
<span class="nc" id="L65">			map = new TilesetAnimationMap();</span>
<span class="nc" id="L66">			tilesets.put(name, map);</span>
		}

<span class="nc" id="L69">		return map;</span>
	}

	/**
	 * Add a mapping of a tile index to animation frame indexes.
	 * 
	 * &lt;strong&gt;NOTE: The array of frame indexes/delays passed is not copied, and
	 * should not be altered after this is called.&lt;/strong&gt;
	 * 
	 * @param name
	 *            The name of the tileset.
	 * @param index
	 *            The tile index to map.
	 * @param frameIndexes
	 *            The indexes of frame tiles.
	 * @param frameDelays
	 *            The delays of frame tiles.
	 */
	private void add(final String name, final int index,
			final int[] frameIndexes, final int[] frameDelays) {
<span class="nc" id="L89">		acquire(name).add(index, frameIndexes, frameDelays);</span>
<span class="nc" id="L90">	}</span>

	/**
	 * Add mappings of tile indexes to animation frame indexes. For each frame,
	 * a mapping will be created with the remaining indexes as it's frames (in
	 * order, starting with it's index).
	 * 
	 * &lt;strong&gt;NOTE: The array of frame indexes/delays passed is not copied, and
	 * should not be altered after this is called.&lt;/strong&gt;
	 * 
	 * @param name
	 *            The name of the tileset.
	 * @param frameIndexes
	 *            The indexes of frame tiles.
	 * @param frameDelays
	 *            The delays of frame tiles.
	 */
	private void add(final String name, final int[] frameIndexes,
			final int[] frameDelays) {
<span class="nc" id="L109">		acquire(name).add(frameIndexes, frameDelays);</span>
<span class="nc" id="L110">	}</span>

	/**
	 * Parse and add a configuration line.
	 * 
	 * @param line
	 *            The configuration line.
	 * 
	 * @see #load(InputStream)
	 */
	private void addConfig(final String line) {

		int defaultDelay;

<span class="nc" id="L124">		StringTokenizer st = new StringTokenizer(line, &quot; \t&quot;);</span>

		/*
		 * Tileset name
		 */
<span class="nc bnc" id="L129" title="All 2 branches missed.">		if (!st.hasMoreTokens()) {</span>
<span class="nc" id="L130">			LOGGER.warn(&quot;Invalid map entry: &quot; + line);</span>
<span class="nc" id="L131">			return;</span>
		}

<span class="nc" id="L134">		final String name = st.nextToken();</span>

		/*
		 * Tile index
		 */
<span class="nc bnc" id="L139" title="All 2 branches missed.">		if (!st.hasMoreTokens()) {</span>
<span class="nc" id="L140">			LOGGER.error(&quot;Invalid map entry: &quot; + line);</span>
<span class="nc" id="L141">			return;</span>
		}

<span class="nc" id="L144">		String index = st.nextToken();</span>
<span class="nc" id="L145">		int pos = index.indexOf('@');</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">		if (pos != -1) {</span>
<span class="nc" id="L147">			final String val = index.substring(pos + 1);</span>
<span class="nc" id="L148">			index = index.substring(0, pos);</span>

			try {
<span class="nc" id="L151">				defaultDelay = Integer.parseInt(val);</span>
<span class="nc" id="L152">			} catch (final NumberFormatException ex) {</span>
<span class="nc" id="L153">				LOGGER.error(&quot;Invalid default delay: &quot; + val);</span>
<span class="nc" id="L154">				return;</span>
<span class="nc" id="L155">			}</span>
<span class="nc" id="L156">		} else {</span>
<span class="nc" id="L157">			defaultDelay = TilesetAnimationMap.DEFAULT_DELAY;</span>
		}

		/*
		 * Frame indexes
		 */
<span class="nc bnc" id="L163" title="All 2 branches missed.">		if (!st.hasMoreTokens()) {</span>
<span class="nc" id="L164">			LOGGER.error(&quot;Invalid map entry: &quot; + line);</span>
<span class="nc" id="L165">			return;</span>
		}

<span class="nc" id="L168">		final String frames = st.nextToken();</span>

		/*
		 * Split up frames indexes
		 */
<span class="nc" id="L173">		st = new StringTokenizer(frames, &quot;:&quot;);</span>

<span class="nc" id="L175">		final int[] frameIndexes = new int[st.countTokens()];</span>
<span class="nc" id="L176">		final int[] frameDelays = new int[frameIndexes.length];</span>

<span class="nc bnc" id="L178" title="All 2 branches missed.">		for (int i = 0; i &lt; frameIndexes.length; i++) {</span>
<span class="nc" id="L179">			String frameIndex = st.nextToken();</span>

			/*
			 * Custom frame duration?
			 */
<span class="nc" id="L184">			pos = frameIndex.indexOf('@');</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">			if (pos != -1) {</span>
<span class="nc" id="L186">				final String val = frameIndex.substring(pos + 1);</span>
<span class="nc" id="L187">				frameIndex = frameIndex.substring(0, pos);</span>

				try {
<span class="nc" id="L190">					frameDelays[i] = Integer.parseInt(val);</span>
<span class="nc" id="L191">				} catch (final NumberFormatException ex) {</span>
<span class="nc" id="L192">					LOGGER.error(&quot;Invalid delay #&quot; + (i + 1) + &quot; &lt;&quot; + val</span>
							+ &quot;&gt;: &quot; + line);
<span class="nc" id="L194">					return;</span>
<span class="nc" id="L195">				}</span>
<span class="nc" id="L196">			} else {</span>
<span class="nc" id="L197">				frameDelays[i] = defaultDelay;</span>
			}

			/*
			 * Frame index
			 */
			try {
<span class="nc" id="L204">				frameIndexes[i] = Integer.parseInt(frameIndex);</span>
<span class="nc" id="L205">			} catch (final NumberFormatException ex) {</span>
<span class="nc" id="L206">				LOGGER.error(&quot;Invalid frame #&quot; + (i + 1) + &quot; &lt;&quot; + frameIndex</span>
						+ &quot;&gt;: &quot; + line);
<span class="nc" id="L208">				return;</span>
<span class="nc" id="L209">			}</span>
		}

		/*
		 * Special '*' case for rotated frames?
		 */
<span class="nc bnc" id="L215" title="All 2 branches missed.">		if (index.equals(&quot;*&quot;)) {</span>
<span class="nc" id="L216">			add(name, frameIndexes, frameDelays);</span>
		} else {
			try {
<span class="nc" id="L219">				add(name, Integer.parseInt(index), frameIndexes, frameDelays);</span>
<span class="nc" id="L220">			} catch (final NumberFormatException ex) {</span>
<span class="nc" id="L221">				LOGGER.error(&quot;Invalid tile index: &quot; + line);</span>
<span class="nc" id="L222">				return;</span>
<span class="nc" id="L223">			}</span>
		}
<span class="nc" id="L225">	}</span>

	/**
	 * Get a named tileset map.
	 * 
	 * @param name
	 *            The name of the tileset.
	 * 
	 * @return An tileset animation map, or &lt;code&gt;null&lt;/code&gt; if one does not
	 *         exists.
	 */
	public TilesetAnimationMap get(final String name) {
<span class="nc" id="L237">		return tilesets.get(name);</span>
	}

	/**
	 * &lt;p&gt;
	 * Load tileset mappings from a file. This doesn't not first clear any
	 * existing entries.
	 * &lt;/p&gt;
	 * 
	 * &lt;p&gt;
	 * The file format consists of one line per entry. Blank lines and those
	 * starting with '#' (a comment) are ignored. The line format is as follows:&lt;br&gt;
	 * &lt;em&gt;tileset&lt;/em&gt; &lt;em&gt;index&lt;/em&gt; &lt;em&gt;frame:frame[:frame]...&lt;/em&gt;
	 * &lt;/p&gt;
	 * 
	 * &lt;p&gt;
	 * Spaces may be any whitespace. The &lt;em&gt;index&lt;/em&gt; may also be
	 * &lt;code&gt;*&lt;/code&gt;, which indicates that an entry should be added using
	 * each frame as a mapped index. The mapped index or frame index(s) maybe be
	 * appended by &lt;code&gt;@&lt;/code&gt;&lt;em&gt;delay&lt;/em&gt;, where &lt;em&gt;delay&lt;/em&gt; is
	 * a value in milliseconds of for the duration of the frame (or the default
	 * for all frames, if specified for mapped index).
	 * 
	 * @param in
	 *            The input stream.
	 * 
	 * @throws IOException
	 *             If an I/O error occurred.
	 */
	public void load(final InputStream in) throws IOException {
<span class="nc" id="L267">		final BufferedReader r = new BufferedReader(new InputStreamReader(in, &quot;UTF-8&quot;));</span>
		String line;

<span class="nc bnc" id="L270" title="All 2 branches missed.">		while ((line = r.readLine()) != null) {</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">			if (line.length() == 0) {</span>
<span class="nc" id="L272">				continue;</span>
			}

			/*
			 * Comment? (Only works if in first column)
			 */
<span class="nc bnc" id="L278" title="All 2 branches missed.">			if (line.charAt(0) == '#') {</span>
<span class="nc" id="L279">				continue;</span>
			}

<span class="nc" id="L282">			addConfig(line);</span>
		}
<span class="nc" id="L284">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>