<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TextSprite.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.client.sprite</a> &gt; <span class="el_source">TextSprite.java</span></div><h1>TextSprite.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.client.sprite;

import games.stendhal.client.gui.TransparencyMode;

import java.awt.Color;
import java.awt.FontMetrics;
import java.awt.Graphics;
import java.awt.GraphicsConfiguration;
import java.awt.Image;
import java.awt.font.LineMetrics;
import java.awt.image.BufferedImage;

/**
 * Outlined text representation of a string.
 */
public class TextSprite extends ImageSprite {
	// needed only because there's no other reliable way to calculate 
	// string widths other than having a Graphics object
<span class="nc" id="L31">	private static final Graphics graphics = (new BufferedImage(1, 1, BufferedImage.TYPE_INT_RGB)).getGraphics(); </span>
	
	private TextSprite(Image image) {
<span class="nc" id="L34">		super(image);</span>
<span class="nc" id="L35">	}</span>
	
	/**
	 * Create a new &lt;code&gt;TextSprite&lt;/code&gt;
	 * 
	 * @param text The text to be rendered 
	 * @param textColor Color of the text
	 * @return TextSprite with the wanted text
	 */
	public static TextSprite createTextSprite(String text, final Color textColor) {
<span class="nc" id="L45">		final GraphicsConfiguration gc = getGC();</span>
<span class="nc" id="L46">		FontMetrics metrics = graphics.getFontMetrics();</span>
<span class="nc" id="L47">		LineMetrics lm = metrics.getLineMetrics(text, graphics);</span>
<span class="nc" id="L48">		final Image image = gc.createCompatibleImage(metrics.stringWidth(text)</span>
				+ 2, Math.round(lm.getHeight()) + 2, TransparencyMode.TRANSPARENCY);

<span class="nc" id="L51">		drawOutlineString(image, textColor, text, 1, Math.round(lm.getAscent()));</span>

<span class="nc" id="L53">		return new TextSprite(image);</span>
	}
	
	/**
	 * Draw a text string (like &lt;em&gt;Graphics&lt;/em&gt;&lt;code&gt;.drawString()&lt;/code&gt;)
	 * only with an outline border. The area drawn extends 1 pixel out on all
	 * side from what would normal be drawn by drawString().
	 * 
	 * @param image image to draw to
	 * @param textColor The text color.
	 * @param text The text to draw.
	 * @param x X position.
	 * @param y Y position.
	 */
	private static void drawOutlineString(final Image image, final Color textColor,
			final String text, final int x, final int y) {
		/*
		 * Use light gray as outline for colors &lt; 25% bright. Luminance = 0.299R +
		 * 0.587G + 0.114B
		 */
<span class="nc" id="L73">		final int lum = ((textColor.getRed() * 299) + (textColor.getGreen() * 587) + (textColor.getBlue() * 114)) / 1000;</span>

		Color outlineColor;
<span class="nc bnc" id="L76" title="All 2 branches missed.">		if (lum &gt;= 64) {</span>
<span class="nc" id="L77">			outlineColor = Color.black;</span>
		} else {
<span class="nc" id="L79">			outlineColor = Color.lightGray;</span>
		}
<span class="nc" id="L81">		drawOutlineString(image, textColor, outlineColor, text, x, y);</span>
<span class="nc" id="L82">	}</span>
	
	/**
	 * Draw a text string (like &lt;em&gt;Graphics&lt;/em&gt;&lt;code&gt;.drawString()&lt;/code&gt;)
	 * only with an outline border. The area drawn extends 1 pixel out on all
	 * side from what would normal be drawn by drawString().
	 *
	 * @param image
	 *            Image to draw to.
	 * @param textColor
	 *            The text color.
	 * @param outlineColor
	 *            The outline color.
	 * @param text
	 *            The text to draw.
	 * @param x
	 *            The X position.
	 * @param y
	 *            The Y position.
	 */
	private static void drawOutlineString(final Image image, final Color textColor,
			final Color outlineColor, final String text, final int x,
			final int y) {
<span class="nc" id="L105">		Graphics g = image.getGraphics();</span>
<span class="nc" id="L106">		g.setColor(outlineColor);</span>
		
		// The same text will be drawn eight times to create a border
		// note that this is not a good solution, but re-using the image
		// to draw it again doesn't work on Mac OSX
<span class="nc" id="L111">		g.drawString(text, x - 1, y - 1);</span>
<span class="nc" id="L112">		g.drawString(text, x + 1, y + 1);</span>
<span class="nc" id="L113">		g.drawString(text, x - 1, y + 1);</span>
<span class="nc" id="L114">		g.drawString(text, x, y - 1);</span>
<span class="nc" id="L115">		g.drawString(text, x + 1, y);</span>
<span class="nc" id="L116">		g.drawString(text, x - 1, y);</span>
<span class="nc" id="L117">		g.drawString(text, x, y + 1);</span>
<span class="nc" id="L118">		g.drawString(text, x + 1, y - 1);</span>
		
<span class="nc" id="L120">		g.setColor(textColor);</span>
<span class="nc" id="L121">		g.drawString(text, x, y);</span>
<span class="nc" id="L122">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>