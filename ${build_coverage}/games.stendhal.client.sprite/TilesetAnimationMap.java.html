<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TilesetAnimationMap.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.client.sprite</a> &gt; <span class="el_source">TilesetAnimationMap.java</span></div><h1>TilesetAnimationMap.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.client.sprite;

import java.util.HashMap;
import java.util.Map;

/**
 * A tileset animation map.
 */
public class TilesetAnimationMap {
	/**
	 * The default frame delay (in ms).
	 */
	static final int DEFAULT_DELAY = 500;

	/**
	 * The map of tileset animations.
	 */
	private Map&lt;Integer, Mapping&gt; animations;

	/**
	 * Create a tileset animation map.
	 */
<span class="nc" id="L35">	public TilesetAnimationMap() {</span>
<span class="nc" id="L36">		animations = new HashMap&lt;Integer, Mapping&gt;();</span>
<span class="nc" id="L37">	}</span>

	//
	// TilesetAnimationMap
	//

	/**
	 * Add a mapping of a tile index to animation frame indexes.
	 * 
	 * &lt;strong&gt;NOTE: The array of frame indexes/delays passed is not copied, and
	 * should not be altered after this is called.&lt;/strong&gt;
	 * 
	 * @param index
	 *            The tile index to map.
	 * @param frameIndexes
	 *            The indexes of frame tiles.
	 * @param frameDelays
	 *            The frame delays (in ms).
	 */
	void add(final int index, final int[] frameIndexes,
			final int[] frameDelays) {
<span class="nc" id="L58">		animations.put(Integer.valueOf(index), new Mapping(frameIndexes,</span>
				frameDelays));
<span class="nc" id="L60">	}</span>

	/**
	 * Add mappings of a tile indexes to animation frame indexes. For each
	 * frame, a mapping will be created with the remaining indexes as it's
	 * frames (in order, starting with it's index).
	 * 
	 * @param frameIndexes
	 *            The indexes of frame tiles.
	 * @param frameDelays
	 *            The frame delays (in ms).
	 * 
	 * @throws IllegalArgumentException
	 *             If the number of indexes and delays don't match.
	 */
	void add(final int[] frameIndexes, final int[] frameDelays) {
<span class="nc bnc" id="L76" title="All 2 branches missed.">		if (frameIndexes.length != frameDelays.length) {</span>
<span class="nc" id="L77">			throw new IllegalArgumentException(</span>
					&quot;Mismatched number of frame indexes and delays&quot;);
		}

<span class="nc bnc" id="L81" title="All 2 branches missed.">		for (int i = 0; i &lt; frameIndexes.length; i++) {</span>
<span class="nc" id="L82">			final int[] frames = new int[frameIndexes.length];</span>
<span class="nc" id="L83">			final int[] delays = new int[frameIndexes.length];</span>
<span class="nc" id="L84">			int tidx = i;</span>

<span class="nc bnc" id="L86" title="All 2 branches missed.">			for (int fidx = 0; fidx &lt; frameIndexes.length; fidx++) {</span>
<span class="nc" id="L87">				frames[fidx] = frameIndexes[tidx];</span>
<span class="nc" id="L88">				delays[fidx] = frameDelays[tidx];</span>

<span class="nc bnc" id="L90" title="All 2 branches missed.">				if (++tidx &gt;= frameIndexes.length) {</span>
<span class="nc" id="L91">					tidx = 0;</span>
				}
			}

<span class="nc" id="L95">			add(frameIndexes[i], frames, delays);</span>
		}
<span class="nc" id="L97">	}</span>

	/**
	 * Get the animated sprite for an indexed tile of a tileset.
	 * 
	 * @param tileset
	 *            The tileset to load from.
	 * @param index
	 *            The index with-in the tileset.
	 * 
	 * @return A sprite, or &lt;code&gt;null&lt;/code&gt; if no mapped sprite.
	 */
	public Sprite getSprite(final Tileset tileset, final int index) {
<span class="nc" id="L110">		final Mapping mapping = animations.get(Integer.valueOf(index));</span>

<span class="nc bnc" id="L112" title="All 2 branches missed.">		if (mapping == null) {</span>
<span class="nc" id="L113">			return null;</span>
		}

<span class="nc" id="L116">		final int[] frameIndexes = mapping.getIndices();</span>
<span class="nc" id="L117">		final int[] frameDelays = mapping.getDelays();</span>

<span class="nc" id="L119">		final Sprite[] frames = new Sprite[frameIndexes.length];</span>

<span class="nc bnc" id="L121" title="All 2 branches missed.">		for (int i = 0; i &lt; frameIndexes.length; i++) {</span>
<span class="nc" id="L122">			frames[i] = tileset.getSprite(frameIndexes[i]);</span>
		}

		// Use the reference of the first frame as the reference for the whole
		// group
<span class="nc" id="L127">		Object ref = null;</span>
<span class="nc" id="L128">		Sprite first = frames[0];</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">		if (first != null) {</span>
<span class="nc" id="L130">			ref = first.getReference();</span>
		}
<span class="nc" id="L132">		return new AnimatedSprite(frames, frameDelays, true, ref);</span>
	}

	//
	//

	/**
	 * A frame indexes/delays mapping entry for an animated tile.
	 */
	private static class Mapping {
		/**
		 * The frame indexes.
		 */
		private int[] indices;

		/**
		 * The frame delays.
		 */
		private int[] delays;

		/**
		 * Create a new Mapping
		 * 
		 * @param indices frame indices
		 * @param delays frame delays
		 */
<span class="nc" id="L158">		private Mapping(final int[] indices, final int[] delays) {</span>
<span class="nc" id="L159">			this.indices = indices;</span>
<span class="nc" id="L160">			this.delays = delays;</span>
<span class="nc" id="L161">		}</span>

		//
		// Mapping
		//

		/**
		 * Get the delays.
		 * 
		 * @return delays
		 */
		private int[] getDelays() {
<span class="nc" id="L173">			return delays;</span>
		}

		/**
		 * Get the indices
		 * 
		 * @return delays
		 */
		private int[] getIndices() {
<span class="nc" id="L182">			return indices;</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>