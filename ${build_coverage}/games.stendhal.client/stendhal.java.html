<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>stendhal.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.client</a> &gt; <span class="el_source">stendhal.java</span></div><h1>stendhal.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                      (C) Copyright 2003 - Marauroa                      *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.client;

import static java.io.File.separator;
import games.stendhal.client.gui.StendhalFirstScreen;
import games.stendhal.client.gui.j2DClient;
import games.stendhal.client.gui.login.LoginDialog;
import games.stendhal.client.gui.login.Profile;
import games.stendhal.client.gui.styled.StyledLookAndFeel;
import games.stendhal.client.gui.styled.styles.StyleFactory;
import games.stendhal.client.gui.wt.core.WtWindowManager;
import games.stendhal.client.update.ClientGameConfiguration;
import games.stendhal.common.Debug;
import games.stendhal.common.MathHelper;
import games.stendhal.common.Version;

import java.awt.Dimension;
import java.io.File;
import java.security.AccessControlException;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;
import java.util.concurrent.CountDownLatch;

import javax.swing.SwingUtilities;
import javax.swing.UIManager;
import javax.swing.UnsupportedLookAndFeelException;

import marauroa.common.Log4J;
import marauroa.common.MarauroaUncaughtExceptionHandler;

import org.apache.log4j.Logger;

/**
 * Main game class.
 */
public final class stendhal {

	private static final String LOG_FOLDER = &quot;log/&quot;;
<span class="fc" id="L51">	private static final Logger logger = Logger.getLogger(stendhal.class);</span>

	// Use getGameFolder() where you need the real game data location
	private static final String STENDHAL_FOLDER;
	public static final String GAME_NAME;
	/**
	 * Directory for storing the persistent game data.
	 */
	private static String gameFolder;
	/**
	 * Just a try to get Webstart working without additional rights.
	 */
<span class="fc" id="L63">	static boolean WEB_START_SANDBOX = false;</span>

	// detect web start sandbox and init STENDHAL_FOLDER otherwise
	static {
		try {
<span class="fc" id="L68">			System.getProperty(&quot;user.home&quot;);</span>
<span class="nc" id="L69">		} catch (final AccessControlException e) {</span>
<span class="nc" id="L70">			WEB_START_SANDBOX = true;</span>
<span class="fc" id="L71">		}</span>

		/** We set the main game folder to the game name */
<span class="fc" id="L74">		GAME_NAME = ClientGameConfiguration.get(&quot;GAME_NAME&quot;);</span>
<span class="fc" id="L75">		STENDHAL_FOLDER = separator + GAME_NAME.toLowerCase(Locale.ENGLISH) + separator;</span>
<span class="fc" id="L76">		initGameFolder();</span>
	}

<span class="fc" id="L79">	public static final String VERSION = Version.getVersion();</span>
	
	/** Display sizes optimized for different screen resolutions */
<span class="fc" id="L82">	private static final List&lt;Dimension&gt; displaySizes = new ArrayList&lt;Dimension&gt;(3);</span>
<span class="fc" id="L83">	public static final Integer SIZE_INDEX = 0;</span>
<span class="fc" id="L84">	public static final Integer SIZE_INDEX_LARGE = 1;</span>
<span class="fc" id="L85">	public static final Integer SIZE_INDEX_WIDE = 2;</span>
<span class="fc" id="L86">	public static final Integer DISPLAY_SIZE_INDEX = SIZE_INDEX;</span>
	
	public static final boolean SHOW_COLLISION_DETECTION = false;

	public static final boolean SHOW_EVERYONE_ATTACK_INFO = false;

	public static final boolean FILTER_ATTACK_MESSAGES = true;

	static final int FPS_LIMIT = 25;
	/** For keeping the login status. Blocks until logged in. */
<span class="fc" id="L96">	private static final CountDownLatch latch = new CountDownLatch(1);</span>
	
	/**
	 * Make the class non-instantiable.
	 */
<span class="nc" id="L101">	private stendhal() {</span>
<span class="nc" id="L102">	}</span>

	/**
	 * Initialize the client game directory.
	 * &lt;p&gt;
	 * NOTE: IF YOU CHANGE THIS, CHANGE ALSO CORRESPONDING CODE IN
	 * Bootstrap.java
	 */
	private static void initGameFolder() {
<span class="fc" id="L111">		String defaultFolder = System.getProperty(&quot;user.home&quot;) + STENDHAL_FOLDER;</span>
		/*
		 * Add any previously unrecognized unix like systems here. These will
		 * try to use ~/.config/stendhal if the user does not have saved data
		 * in ~/stendhal.
		 *
		 * OS X is counted in here too, but should it?
		 *
		 * List taken from:
		 * 	http://mindprod.com/jgloss/properties.html#OSNAME
		 */
<span class="fc" id="L122">		String unixLikes = &quot;AIX|Digital Unix|FreeBSD|HP UX|Irix|Linux|Mac OS X|Solaris&quot;;</span>
<span class="fc" id="L123">		String system = System.getProperty(&quot;os.name&quot;);</span>
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">		if (system.matches(unixLikes)) {</span>
			// Check first if the user has important data in the default folder.
<span class="fc" id="L126">			File f = new File(defaultFolder + &quot;user.dat&quot;);</span>
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">			if (!f.exists()) {</span>
<span class="fc" id="L128">				gameFolder = System.getProperty(&quot;user.home&quot;) + separator</span>
				+ &quot;.config&quot; + separator + STENDHAL_FOLDER;
<span class="fc" id="L130">				return;</span>
			}
		}
		// Everyone else should use the default top level directory in $HOME
<span class="nc" id="L134">		gameFolder = defaultFolder;</span>
<span class="nc" id="L135">	}</span>

	/**
	 * Notify that the login has been performed and the client should proceed
	 * to show the game window.
	 */
	public static void setDoLogin()	{
<span class="nc" id="L142">		latch.countDown();</span>
<span class="nc" id="L143">	}</span>

	/**
	 * Get the maximum size of the visible game area.
	 * 
	 * @return screen dimensions
	 */
	public static Dimension getDisplaySize() {
<span class="nc" id="L151">		String spec = System.getProperty(&quot;display.index&quot;);</span>
<span class="nc" id="L152">		int sizeIndex = MathHelper.parseIntDefault(spec, DISPLAY_SIZE_INDEX);</span>
		
		try {
<span class="nc" id="L155">			return displaySizes.get(sizeIndex);</span>
<span class="nc" id="L156">		} catch (IndexOutOfBoundsException e) {</span>
<span class="nc" id="L157">			logger.error(&quot;Invalid client size index: &quot; + spec + &quot; (&quot; + sizeIndex + &quot;)&quot;, e);</span>
		}
		
<span class="nc" id="L160">		return displaySizes.get(DISPLAY_SIZE_INDEX);</span>
	}
	
	/**
	 * Initialize list of dimensions that can be used for the clients
	 * display area.
	 */
	private static void initUsableDisplaySizes() {
		// Optimized display dimensions for display resolutions
<span class="nc" id="L169">		displaySizes.add(new Dimension(640, 480)); // Smaller 4:3 (1024x768 and smaller)</span>
<span class="nc" id="L170">		displaySizes.add(new Dimension(800, 600)); // Larger 4:3 (1280x1024)</span>
<span class="nc" id="L171">		displaySizes.add(new Dimension(864, 486)); // Larger 16:9 (1366x768 and larger)</span>
<span class="nc" id="L172">	}</span>

	/**
	 * Starts the LogSystem.
	 */
	private static void startLogSystem() {
<span class="nc" id="L178">		prepareLoggingSystemEnviroment();</span>

<span class="nc" id="L180">		logger.debug(&quot;XXXXXXX&quot;);</span>

<span class="nc" id="L182">		logger.info(&quot;-Setting base at :&quot; + STENDHAL_FOLDER);</span>

<span class="nc" id="L184">		Log4J.init(&quot;data/conf/log4j.properties&quot;);</span>
<span class="nc" id="L185">		logger.debug(&quot;XXXXXXX&quot;);</span>

<span class="nc" id="L187">		logger.info(&quot;Setting base at :&quot; + STENDHAL_FOLDER);</span>
<span class="nc" id="L188">		logger.info(&quot;Stendhal &quot; + VERSION);</span>
<span class="nc" id="L189">		logger.info(Debug.PRE_RELEASE_VERSION);</span>
<span class="nc" id="L190">		logger.info(&quot;Logging to directory: &quot; + getLogFolder());</span>

<span class="nc" id="L192">		String patchLevel = System.getProperty(&quot;sun.os.patch.level&quot;);</span>
<span class="nc bnc" id="L193" title="All 4 branches missed.">		if ((patchLevel == null) || (patchLevel.equals(&quot;unknown&quot;))) {</span>
<span class="nc" id="L194">			patchLevel = &quot;&quot;;</span>
		}

<span class="nc" id="L197">		logger.info(&quot;OS: &quot; + System.getProperty(&quot;os.name&quot;) + &quot; &quot; + patchLevel</span>
				+ &quot; &quot; + System.getProperty(&quot;os.version&quot;) + &quot; &quot;
				+ System.getProperty(&quot;os.arch&quot;));
<span class="nc" id="L200">		logger.info(&quot;Java-Runtime: &quot; + System.getProperty(&quot;java.runtime.name&quot;)</span>
				+ &quot; &quot; + System.getProperty(&quot;java.runtime.version&quot;) + &quot; from &quot;
				+ System.getProperty(&quot;java.home&quot;));
<span class="nc" id="L203">		logger.info(&quot;Java-VM: &quot; + System.getProperty(&quot;java.vm.vendor&quot;) + &quot; &quot;</span>
				+ System.getProperty(&quot;java.vm.name&quot;) + &quot; &quot;
				+ System.getProperty(&quot;java.vm.version&quot;));
<span class="nc" id="L206">		LogUncaughtExceptionHandler.setup();</span>
<span class="nc" id="L207">	}</span>

	/**
	 * Initialize the logging system.
	 */
	private static void prepareLoggingSystemEnviroment() {
		// property configuration relies on this parameter
<span class="nc" id="L214">		System.setProperty(&quot;log.directory&quot;, getLogFolder());</span>
		//create the log directory if not yet existing:
		//removed code as log4j is now capable of doing that automatically
<span class="nc" id="L217">	}</span>

	/**
	 * @return the name of the log folder
	 */
	private static String getLogFolder() {
<span class="nc" id="L223">		return getGameFolder() + LOG_FOLDER;</span>
	}

	/**
	 * A loop which simply waits for the login to be completed.
	 */
	private static void waitForLogin() {
		try {
<span class="nc" id="L231">			latch.await();</span>
<span class="nc" id="L232">		} catch (final InterruptedException e) {</span>
<span class="nc" id="L233">			logger.error(&quot;Unexpected interrupt&quot;, e);</span>
<span class="nc" id="L234">			Thread.currentThread().interrupt();</span>
<span class="nc" id="L235">		}</span>
<span class="nc" id="L236">	}</span>

	/**
	 * Get the location of persistent game client data.
	 *
	 * @return game's home directory
	 */
	public static String getGameFolder() {
<span class="fc" id="L244">		return gameFolder;</span>
	}
	
	/**
	 * Main Entry point.
	 *
	 * @param args
	 *            command line arguments
	 */
	public static void main(final String[] args) {
<span class="nc" id="L254">		startLogSystem();</span>
<span class="nc" id="L255">		MarauroaUncaughtExceptionHandler.setup(false);</span>
<span class="nc" id="L256">		initUsableDisplaySizes();</span>
<span class="nc" id="L257">		new Startup(args);</span>
<span class="nc" id="L258">	}</span>
	
	private static class Startup {
		StendhalFirstScreen splash;

<span class="nc" id="L263">		Startup(String[] args) {</span>
<span class="nc" id="L264">			final UserContext userContext = new UserContext();</span>
<span class="nc" id="L265">			final PerceptionDispatcher perceptionDispatch = new PerceptionDispatcher();</span>
<span class="nc" id="L266">			final StendhalClient client = new StendhalClient(userContext, perceptionDispatch);</span>

			try {
<span class="nc" id="L269">				WtWindowManager wm = WtWindowManager.getInstance();</span>
<span class="nc" id="L270">				String style = wm.getProperty(&quot;ui.style&quot;, &quot;Wood (default)&quot;);</span>
<span class="nc" id="L271">				StyledLookAndFeel look = new StyledLookAndFeel(StyleFactory.createStyle(style));</span>
<span class="nc" id="L272">				UIManager.setLookAndFeel(look);</span>
				/*
				 * Prevents the click event at closing a popup menu by clicking
				 * outside it being passed to the component underneath. 
				 */
<span class="nc" id="L277">				UIManager.put(&quot;PopupMenu.consumeEventOnClose&quot;, Boolean.TRUE);</span>
<span class="nc" id="L278">				int fontSize = wm.getPropertyInt(&quot;ui.font_size&quot;, 12);</span>
<span class="nc" id="L279">				look.setDefaultFontSize(fontSize);</span>
<span class="nc" id="L280">			} catch (UnsupportedLookAndFeelException e) {</span>
				/*
				 * Should not happen as StyledLookAndFeel always returns true for
				 * isSupportedLookAndFeel()
				 */
<span class="nc" id="L285">				logger.error(&quot;Failed to set Look and Feel&quot;, e);</span>
<span class="nc" id="L286">			}</span>

<span class="nc" id="L288">			UIManager.getLookAndFeelDefaults().put(&quot;ClassLoader&quot;, stendhal.class.getClassLoader());</span>

<span class="nc" id="L290">			final Profile profile = Profile.createFromCommandline(args);</span>
			
<span class="nc" id="L292">			SwingUtilities.invokeLater(new Runnable() {</span>
				@Override
				public void run() {
<span class="nc bnc" id="L295" title="All 2 branches missed.">					if (profile.isValid()) {</span>
<span class="nc" id="L296">						new LoginDialog(null, client).connect(profile);</span>
					} else {
<span class="nc" id="L298">						splash = new StendhalFirstScreen(client);</span>
					}
<span class="nc" id="L300">				}</span>
			});

<span class="nc" id="L303">			waitForLogin();</span>
<span class="nc" id="L304">			CStatusSender.send();</span>

<span class="nc" id="L306">			SwingUtilities.invokeLater(new Runnable() {</span>
				@Override
				public void run() {
<span class="nc" id="L309">					j2DClient locclient = new j2DClient(client, userContext, splash);</span>
<span class="nc" id="L310">					perceptionDispatch.register(locclient.getPerceptionListener());</span>
<span class="nc" id="L311">					locclient.startGameLoop();</span>
<span class="nc" id="L312">				}</span>
			});
<span class="nc" id="L314">		}</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>