<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>OutfitStore.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.client</a> &gt; <span class="el_source">OutfitStore.java</span></div><h1>OutfitStore.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.client;


import games.stendhal.client.gui.OutfitColor;
import games.stendhal.client.sprite.ImageSprite;
import games.stendhal.client.sprite.Sprite;
import games.stendhal.client.sprite.SpriteCache;
import games.stendhal.client.sprite.SpriteStore;

import java.awt.Color;
import java.awt.Composite;
import java.awt.Graphics;

import org.apache.log4j.Logger;

/**
 * An outfit store.
 */
public class OutfitStore {
<span class="nc" id="L32">	private Logger logger = Logger.getLogger(OutfitStore.class);</span>
	
	/** outfit directory */
<span class="nc" id="L35">	final String outfits = &quot;data/sprites/outfit&quot;;</span>
	
	/** body directory */
	final String bodies;// = outfits + &quot;/body&quot;;
	
	/** dress directory */
<span class="nc" id="L41">	final String dresses = outfits + &quot;/dress&quot;;</span>
	
	/** head directory */
	final String heads;// = outfits + &quot;/head&quot;;
	
	/** mouth directory */
<span class="nc" id="L47">	final String mouths = outfits + &quot;/mouth&quot;;</span>
	
	/** eyes directory */
<span class="nc" id="L50">	final String eyes = outfits + &quot;/eyes&quot;;</span>
	
	/** hair directory */
<span class="nc" id="L53">	final String hairs = outfits + &quot;/hair&quot;;</span>
	
	/** detail directory */
<span class="nc" id="L56">	final String details = outfits + &quot;/detail&quot;;</span>

	/**
	 * The singleton.
	 */
<span class="nc" id="L61">	private static final OutfitStore sharedInstance = new OutfitStore(</span>
			SpriteStore.get());

	/**
	 * The sprite store.
	 */
	private SpriteStore store;

	/**
	 * Create an outfit store.
	 * 
	 * @param store
	 *            The sprite store to use.
	 */
<span class="nc" id="L75">	private OutfitStore(final SpriteStore store) {</span>
<span class="nc" id="L76">		this.store = store;</span>
		
<span class="nc" id="L78">		bodies = outfits + &quot;/body&quot;;</span>
<span class="nc" id="L79">		heads = outfits + &quot;/head&quot;;</span>
<span class="nc" id="L80">	}</span>

	//
	// OutfitStore
	//
	
	/**
	 * Build an outfit sprite.
	 * 
	 * The outfit is described by an &quot;outfit code&quot;. It is an 8-digit integer of
	 * the form TTRRHHDDBB where TT is the number of the detail graphics (optional)
	 * RR is the number of the hair graphics (optional), HH for the
	 * head, DD for the dress, and BB for the body.
	 * 
	 * @param code
	 *            The outfit code.
	 * @param color coloring data
	 * 
	 * @return A walking state tileset.
	 */
	private Sprite buildOutfit(int code, final OutfitColor color) {
<span class="nc" id="L101">		final int bodycode = (code % 100);</span>
<span class="nc" id="L102">		code /= 100;</span>
		
<span class="nc" id="L104">		final int dresscode = (code % 100);</span>
<span class="nc" id="L105">		code /= 100;</span>
		
<span class="nc" id="L107">		final int headcode = (code % 100);</span>
<span class="nc" id="L108">		code /= 100;</span>
		
<span class="nc" id="L110">		final int haircode = (code % 100);</span>
<span class="nc" id="L111">		code /= 100;</span>
		
<span class="nc" id="L113">		final int detailcode = (code % 100);</span>
		
		// Body layer
<span class="nc" id="L116">		Sprite layer = getBodySprite(bodycode, color);</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">		if (layer == null) {</span>
<span class="nc" id="L118">			throw new IllegalArgumentException(</span>
					&quot;No body image found for outfit: &quot; + bodycode);
		}

<span class="nc" id="L122">		final ImageSprite sprite = new ImageSprite(layer);</span>
<span class="nc" id="L123">		final Graphics g = sprite.getGraphics();</span>

		// Dress layer
<span class="nc" id="L126">		layer = getDressSprite(dresscode, color);</span>
<span class="nc" id="L127">		layer.draw(g, 0, 0);</span>

		// Head layer
<span class="nc" id="L130">		layer = getHeadSprite(headcode, color);</span>
<span class="nc" id="L131">		layer.draw(g, 0, 0);</span>
		
		// Hair layer
<span class="nc" id="L134">		layer = getHairSprite(haircode, color);</span>
<span class="nc" id="L135">		layer.draw(g, 0, 0);</span>
		
		// Item layer
<span class="nc" id="L138">		layer = getDetailSprite(detailcode, color);</span>
<span class="nc" id="L139">		layer.draw(g, 0, 0);</span>

<span class="nc" id="L141">		return sprite;</span>
	}
	
	/**
	 * Build an outfit sprite.
	 * 
	 * Calls buildOutfit(primaryCode, color) to build primary features then
	 * adds extended features: mouth and eyes.
	 * 
	 * @param code
	 * 		The extended code used for mouth and eyes
	 * @param color
	 * 		Coloring data
	 * @return
	 * 		A walking state sprite
	 */
	private Sprite buildOutfit(long code, final OutfitColor color) {
<span class="nc" id="L158">		int oldcode = (int) (code / (10000));</span>
<span class="nc" id="L159">		Sprite layer = this.buildOutfit(oldcode, color);</span>
		
<span class="nc" id="L161">		final int mouthcode = (int) (code % 100);</span>
<span class="nc" id="L162">		code /= 100;</span>
		
<span class="nc" id="L164">		final int eyescode = (int) (code % 100);</span>
		
<span class="nc" id="L166">		final ImageSprite sprite = new ImageSprite(layer);</span>
<span class="nc" id="L167">		final Graphics g = sprite.getGraphics();</span>
		
		// Mouth layer
<span class="nc" id="L170">		layer = getMouthSprite(mouthcode);</span>
<span class="nc" id="L171">		layer.draw(g, 0, 0);</span>

		// Eyes layer
<span class="nc" id="L174">		layer = getEyesSprite(eyescode, color);</span>
<span class="nc" id="L175">		layer.draw(g, 0, 0);</span>
		
<span class="nc" id="L177">		return sprite;</span>
	}
	
	/**
	 * Get the shared instance.
	 * 
	 * @return The shared [singleton] instance.
	 */
	public static OutfitStore get() {
<span class="nc" id="L186">		return sharedInstance;</span>
	}
	
	/**
	 * Get a string value of convention xxx from &quot;index&quot;
	 * 
	 * @param index
	 * 		The sprite index number
	 * @return
	 * 		A string value of the format xxx
	 * 
	 * FIXME:	Probably not necessary since there are no more than 100
	 * 			sprites for each group.
	 */
	public String getSpriteSuffix(final int index) {
		String suffix;
		
		/** Get the value of the index using xxx naming convention */
<span class="nc bnc" id="L204" title="All 2 branches missed.">		if (index &lt; 10) {</span>
<span class="nc" id="L205">			suffix = &quot;00&quot; + Integer.toString(index);</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">		} else if (index &lt; 100) {</span>
<span class="nc" id="L207">			suffix = &quot;0&quot; + Integer.toString(index);</span>
		} else {
<span class="nc" id="L209">			suffix = Integer.toString(index);</span>
		}
		
<span class="nc" id="L212">		return suffix;</span>
	}

	/**
	 * Get the body sprite tileset.
	 * 
	 * @param index
	 *            The resource index.
	 * @param color Skin color
	 * 
	 * @return The sprite, or &lt;code&gt;null&lt;/code&gt;.
	 */
	public Sprite getBodySprite(final int index, OutfitColor color) {
<span class="nc" id="L225">		final String suffix = getSpriteSuffix(index);</span>
		
<span class="nc" id="L227">		final String ref = bodies + &quot;/body_&quot; + suffix + &quot;.png&quot;;</span>

<span class="nc bnc" id="L229" title="All 2 branches missed.">		if (!store.existsSprite(ref)) {</span>
<span class="nc" id="L230">			return null;</span>
		}
		
<span class="nc" id="L233">		return store.getColoredSprite(ref, color.getColor(OutfitColor.SKIN));</span>
	}

	/**
	 * Get the dress sprite tileset.
	 * 
	 * @param index
	 *            The resource index.
	 * @param color coloring data
	 * 
	 * @return The sprite, or &lt;code&gt;null&lt;/code&gt;.
	 */
	public Sprite getDressSprite(final int index, OutfitColor color) {
<span class="nc bnc" id="L246" title="All 2 branches missed.">		if (index == 0) {</span>
<span class="nc" id="L247">			return getEmptySprite();</span>
		}
		
<span class="nc" id="L250">		final String suffix = getSpriteSuffix(index);</span>

<span class="nc" id="L252">		final String ref = dresses + &quot;/dress_&quot; + suffix + &quot;.png&quot;;</span>
		
<span class="nc" id="L254">		return store.getColoredSprite(ref, color.getColor(OutfitColor.DRESS));</span>
	}

	/**
	 * Get the empty sprite tileset.
	 * 
	 * @return The sprite.
	 */
	private Sprite getEmptySprite() {
<span class="nc" id="L263">		return store.getEmptySprite();</span>
	}
	
	/**
	 * Get the failsafe outfit.
	 * 
	 * @return The failsafe outfit tileset.
	 */
	public Sprite getFailsafeOutfit() {
		try {
<span class="nc" id="L273">			return getOutfit(0, OutfitColor.PLAIN);</span>
<span class="nc" id="L274">		} catch (RuntimeException e) {</span>
<span class="nc" id="L275">			logger.warn(&quot;Cannot build failsafe outfit. Trying to use standard failsafe sprite.&quot;, e);</span>
<span class="nc" id="L276">			return store.getFailsafe();</span>
		}
	}
	
	/**
	 * Get the hair sprite tileset.
	 * 
	 * @param index
	 *            The resource index.
	 * @param color coloring data
	 * 
	 * @return The sprite, or &lt;code&gt;null&lt;/code&gt;.
	 */
	public Sprite getHairSprite(final int index, OutfitColor color) {
<span class="nc bnc" id="L290" title="All 2 branches missed.">		if (index == 0) {</span>
<span class="nc" id="L291">			return getEmptySprite();</span>
		}

<span class="nc" id="L294">		final String suffix = getSpriteSuffix(index);</span>
		
<span class="nc" id="L296">		final String ref = hairs + &quot;/hair_&quot; + suffix + &quot;.png&quot;;</span>

<span class="nc" id="L298">		return store.getColoredSprite(ref, color.getColor(OutfitColor.HAIR));</span>
	}
	
	/**
	 * Get the eyes sprite tileset.
	 * 
	 * @param index
	 *            The resource index.
	 * @param color Eye color
	 * @return The sprite, or &lt;code&gt;null&lt;/code&gt;
	 */
	public Sprite getEyesSprite(final int index, OutfitColor color) {
<span class="nc" id="L310">		final String suffix = getSpriteSuffix(index);</span>
		
<span class="nc" id="L312">		final String ref = eyes + &quot;/eyes_&quot; + suffix + &quot;.png&quot;;</span>
		
<span class="nc bnc" id="L314" title="All 2 branches missed.">		if (!store.existsSprite(ref)) {</span>
<span class="nc" id="L315">			return null;</span>
		}
		
<span class="nc" id="L318">		return store.getColoredSprite(ref, color.getColor(OutfitColor.EYES));</span>
	}

	/**
	 * Get the mouth sprite tileset.
	 * 
	 * @param index
	 *            The resource index.
	 * @return The sprite, or &lt;code&gt;null&lt;/code&gt;
	 */
	public Sprite getMouthSprite(final int index) {
<span class="nc" id="L329">		final String suffix = getSpriteSuffix(index);</span>
		
<span class="nc" id="L331">		final String ref = mouths + &quot;/mouth_&quot; + suffix + &quot;.png&quot;;</span>
		
<span class="nc bnc" id="L333" title="All 2 branches missed.">		if (!store.existsSprite(ref)) {</span>
<span class="nc" id="L334">			return null;</span>
		}
		
<span class="nc" id="L337">		return store.getSprite(ref);</span>
	}

	/**
	 * Get the head sprite tileset.
	 * 
	 * @param index
	 *            The resource index.
	 * @param color Skin color
	 * 
	 * @return The sprite, or &lt;code&gt;null&lt;/code&gt;.
	 */
	public Sprite getHeadSprite(final int index, OutfitColor color) {
<span class="nc" id="L350">		final String suffix = getSpriteSuffix(index);</span>
		
<span class="nc" id="L352">		final String ref = heads + &quot;/head_&quot; + suffix + &quot;.png&quot;;</span>
		
<span class="nc bnc" id="L354" title="All 2 branches missed.">		if (!store.existsSprite(ref)) {</span>
<span class="nc" id="L355">			return null;</span>
		}

<span class="nc" id="L358">		return store.getColoredSprite(ref, color.getColor(OutfitColor.SKIN));</span>
	}

	/**
	 * Get the item sprite tileset.
	 * 
	 * @param index
	 *            The resource index.
	 * @param color coloring data
	 * 
	 * @return The sprite, or &lt;code&gt;null&lt;/code&gt;.
	 */
	private Sprite getDetailSprite(final int index, OutfitColor color) {
<span class="nc bnc" id="L371" title="All 2 branches missed.">		if (index == 0) {</span>
<span class="nc" id="L372">			return getEmptySprite();</span>
		}
		
<span class="nc" id="L375">		final String suffix = getSpriteSuffix(index);</span>

<span class="nc" id="L377">		final String ref = details + &quot;/detail_&quot; + suffix + &quot;.png&quot;;</span>

<span class="nc" id="L379">		return store.getColoredSprite(ref, color.getColor(OutfitColor.DETAIL));</span>
	}
	
	/**
	 * Get an outfit sprite.
	 * 
	 * The outfit is described by an &quot;outfit code&quot;. It is an 10-digit integer of
	 * the form TTRRHHDDBB where where TT is the number of the detail graphics (optional)
	 * RR is the number of the hair graphics, HH for the
	 * head, DD for the dress, and BB for the body.
	 * 
	 * @param code
	 *            The outfit code.
	 * @param color Colors for coloring some outfit parts
	 * 
	 * @return An walking state tileset.
	 */
	private Sprite getOutfit(final int code, final OutfitColor color) {
		// Use the normalized string for the reference
<span class="nc" id="L398">		final String reference = buildReference(code, color.toString());</span>
<span class="nc" id="L399">		return getOutfit(code, color, reference);</span>
	}
	
	/**
	 * Get an outfit sprite with extended features.
	 * 
	 * @param code
	 * 		14-digit integer representing extended outfit features: mouth and
	 * 		eyes
	 * @param color
	 * 		Color information for outfit parts
	 * @return
	 * 		A walking state sprite
	 */
	private Sprite getOutfit(final long code, final OutfitColor color) {
<span class="nc" id="L414">		final String reference = buildReference(code,</span>
				color.toString());
<span class="nc" id="L416">		return getOutfit(code, color, reference);</span>
	}
	
	/**
	 * Get outfit for a known outfit reference.
	 * 
	 * @param code outfit code
	 * @param color Color information for outfit parts
	 * @param reference outfit reference
	 * @return outfit
	 */
	private Sprite getOutfit(final int code, final OutfitColor color,
			final String reference) {
<span class="nc" id="L429">		final SpriteCache cache = SpriteCache.get();</span>
<span class="nc" id="L430">		Sprite sprite = cache.get(reference);</span>

<span class="nc bnc" id="L432" title="All 2 branches missed.">		if (sprite == null) {</span>
<span class="nc" id="L433">			sprite = buildOutfit(code, color);</span>
<span class="nc" id="L434">			cache.add(reference, sprite);</span>
		}

<span class="nc" id="L437">		return sprite;</span>
	}
	
	/**
	 * Get outfit for a knows outfit reference with extended outfit parts:
	 * mouth and eyes.
	 * 
	 * @param code
	 * 		The extended outfit system code (mouth and eyes)
	 * @param color
	 * 		Color information for outfit parts
	 * @param reference
	 * 		Outfit reference
	 * @return
	 * 		Outfit
	 */
	private Sprite getOutfit(final long code,
			final OutfitColor color, final String reference) {
<span class="nc" id="L455">		final SpriteCache cache = SpriteCache.get();</span>
<span class="nc" id="L456">		Sprite sprite = cache.get(reference);</span>
		
<span class="nc bnc" id="L458" title="All 2 branches missed.">		if (sprite == null) {</span>
<span class="nc" id="L459">			sprite = buildOutfit(code, color);</span>
<span class="nc" id="L460">			cache.add(reference, sprite);</span>
		}
		
<span class="nc" id="L463">		return sprite;</span>
	}
	
	/**
	 * Get an outfit with color adjustment, such as a player in colored light.
	 * 
	 * @param code outfit code
	 * @param color Color information for outfit parts
	 * @param adjColor adjustment color for the entire outfit
	 * @param blend blend mode for applying the adjustment color
	 * @return color adjusted outfit
	 */
	public Sprite getAdjustedOutfit(final int code, OutfitColor color, 
			Color adjColor, Composite blend) {
<span class="nc bnc" id="L477" title="All 4 branches missed.">		if ((adjColor == null) || (blend == null)) {</span>
<span class="nc" id="L478">			return getOutfit(code, color);</span>
		} else {
<span class="nc" id="L480">			final SpriteCache cache = SpriteCache.get();</span>
			// Use the normalized string for the reference
<span class="nc" id="L482">			final String reference = buildReference(code, color.toString());</span>
<span class="nc" id="L483">			String fullRef = reference + &quot;:&quot; + adjColor.getRGB() + blend.toString();</span>
<span class="nc" id="L484">			Sprite sprite = cache.get(fullRef);</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">			if (sprite == null) {</span>
<span class="nc" id="L486">				Sprite plain = getOutfit(code, color);</span>
<span class="nc" id="L487">				SpriteStore store = SpriteStore.get();</span>
<span class="nc" id="L488">				sprite = store.modifySprite(plain, adjColor, blend, fullRef);</span>
				
			}
<span class="nc" id="L491">			return sprite;</span>
		}
	}
	
	/**
	 * Get an extended feature outfit with color adjustment, such as a player
	 * in colored light.
	 * 
	 * @param code
	 * 		14-digit integer representing the outfit
	 * @param color
	 * 		Color information for outfit parts
	 * @param adjColor
	 * 		Adjustment color for the entire outfit
	 * @param blend
	 * 		Blend mode for applying the adjustment color
	 * @return
	 * 		Color adjusted outfit
	 */
	public Sprite getAdjustedOutfit(final long code, final OutfitColor color,
			final Color adjColor, final Composite blend) {
<span class="nc bnc" id="L512" title="All 4 branches missed.">		if ((adjColor == null) || (blend == null)) {</span>
<span class="nc" id="L513">			return getOutfit(code, color);</span>
		} else {
<span class="nc" id="L515">			final SpriteCache cache = SpriteCache.get();</span>
			// Use the normalized string for the reference
<span class="nc" id="L517">			final String reference = buildReference(code,</span>
					color.toString());
<span class="nc" id="L519">			String fullRef = reference + &quot;:&quot; + adjColor.getRGB() + blend.toString();</span>
<span class="nc" id="L520">			Sprite sprite = cache.get(fullRef);</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">			if (sprite == null) {</span>
<span class="nc" id="L522">				Sprite plain = getOutfit(code, color);</span>
<span class="nc" id="L523">				SpriteStore store = SpriteStore.get();</span>
<span class="nc" id="L524">				sprite = store.modifySprite(plain, adjColor, blend, fullRef);</span>
				
			}
<span class="nc" id="L527">			return sprite;</span>
		}
	}

	/**
	 * Create an unique reference for an outfit.
	 * 
	 * @param code outfit code
	 * @param colorCode color information for outfit parts
	 * @return outfit reference
	 */
	private String buildReference(final int code, final String colorCode) {
<span class="nc" id="L539">		return &quot;OUTFIT:&quot; + code + &quot;@&quot; + colorCode;</span>
	}
	
	/**
	 * Create a unique reference for an outfit that uses extended features:
	 * Currently mouth and eyes.
	 * 
	 * @param code
	 * 		14-digit integer representing outfit
	 * @param colorCode
	 * 		Coloring information for outfit parts
	 * @return
	 * 		Outfit reference
	 */
	private String buildReference(final long code, final String colorCode) {
<span class="nc" id="L554">		return &quot;OUTFIT:&quot; + Long.toString(code) + &quot;@&quot; + colorCode;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>