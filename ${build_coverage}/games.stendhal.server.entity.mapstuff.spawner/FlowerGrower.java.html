<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FlowerGrower.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.entity.mapstuff.spawner</a> &gt; <span class="el_source">FlowerGrower.java</span></div><h1>FlowerGrower.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.entity.mapstuff.spawner;

import games.stendhal.common.Rand;
import games.stendhal.common.grammar.Grammar;
import games.stendhal.server.core.engine.StendhalRPObjectFactory;
import games.stendhal.server.core.engine.StendhalRPZone;
import games.stendhal.server.entity.Entity;
import games.stendhal.server.entity.item.Item;
import games.stendhal.server.entity.mapstuff.area.FertileGround;

import marauroa.common.game.RPObject;

/**
 * Is an item producer that destroys itself when item is removed.
 * &lt;p&gt;
 * The standard vegetable grower would restart production cycle after removal of
 * fruit.
 * 
 * Fruit is only grown when FlowerGrower is in the same place as an entity in
 * zone that implements FertileGround
 * 
 */
public class FlowerGrower extends VegetableGrower {
	/** 5 hours for one growing step */
	private static final int GROW_TIME_TURNS = 60000;
	/** Maximum ripeness of flowers */
	private static final int MAX_RIPENESS = 4;
	private static final String GROWER_NAME = &quot;lilia&quot;;
    /** The description depends upon the ripeness of the flower grower */
<span class="pc" id="L42">	private final String[] description = {</span>
			&quot;You see something which has just been planted.&quot;,
			&quot;Something is sprouting from the ground.&quot;,
			&quot;A plant is growing here, and you can already see foliage.&quot;,
			&quot;You see a plant growing a &quot; + Grammar.fullForm(getVegetableName())
					+ &quot;, it is nearly at full maturity.&quot;,
			&quot;You see a fully grown &quot; + Grammar.fullForm(getVegetableName())
					+ &quot;, ready to pull from the ground.&quot; };

	/**
	 * Constructor for loading FlowerGrower from the stored zone used by
	 * StendhalRPObjectFactory.
	 * 
	 * @see StendhalRPObjectFactory
	 * 
	 * @param object
	 *            the restored object from db
	 * @param itemname
	 *            the item to grow
	 */
	public FlowerGrower(final RPObject object, final String itemname) {
<span class="nc" id="L63">		super(object, itemname, MAX_RIPENESS, GROW_TIME_TURNS);</span>
<span class="nc" id="L64">		store();</span>
<span class="nc" id="L65">	}</span>

	/**
	 * Constructor.
	 * 
	 * Default FlowerGrower produces lilia.
	 */
	public FlowerGrower() {
<span class="fc" id="L73">		this(GROWER_NAME);</span>
<span class="fc" id="L74">		store();</span>
<span class="fc" id="L75">	}</span>

	/**
	 * Constructor of a FlowerGrower growing an item with the name specified in
	 * infostring.
	 * 
	 * @param infoString
	 *            the name of the item to produce
	 * 
	 */
	public FlowerGrower(final String infoString) {
<span class="fc" id="L86">		super(infoString);</span>
<span class="fc" id="L87">		setMaxRipeness(MAX_RIPENESS);</span>
<span class="fc" id="L88">		meanTurnsForRegrow = GROW_TIME_TURNS;</span>
<span class="fc" id="L89">		store();</span>
<span class="fc" id="L90">	}</span>

	/**
	 * Removes this from world. This method is called when the fruit of this
	 * grower is picked.
	 */
	@Override
	public void onFruitPicked(final Item picked) {
<span class="fc" id="L98">		getZone().remove(this);</span>
<span class="fc" id="L99">		notifyWorldAboutChanges();</span>
<span class="fc" id="L100">	}</span>

	@Override
	protected int getRandomTurnsForRegrow() {
<span class="fc" id="L104">		return Rand.randGaussian(meanTurnsForRegrow, (int) (0.1 * meanTurnsForRegrow));</span>
	}

    /** The description depends upon the ripeness of the flower grower */
	@Override
	public String describe() {
<span class="pc bpc" id="L110" title="1 of 4 branches missed.">		if ((getRipeness() &lt; 0) || (getRipeness() &gt; getMaxRipeness())) {</span>
<span class="fc" id="L111">			return super.describe();</span>
		} else {
<span class="fc" id="L113">			return description[getRipeness()];</span>
		}
	}

	/**
	 * Checks if this entity is on a free fertile spot.
	 * 
     * If yes, the flower can grow. Otherwise it withers and dies.
     *
	 * @return true if there is an item implementing FertileGround in the zone,
	 *         and the position of this is in its area.
	 */
	public boolean isOnFreeFertileGround() {
<span class="fc bfc" id="L126" title="All 2 branches covered.">		if (this.getZone() == null) {</span>
<span class="fc" id="L127">			return false;</span>
		} else {
<span class="fc" id="L129">			final StendhalRPZone zone = this.getZone();</span>
<span class="fc" id="L130">			boolean passes = false; </span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">			for (Entity entity : zone.getEntitiesAt(getX(), getY())) {</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">				if (entity instanceof FlowerGrower) {</span>
<span class="fc bfc" id="L133" title="All 2 branches covered.">					if (!equals(entity)) {</span>
						// There's already something else growing here
<span class="fc" id="L135">						return false;</span>
					}
				} else {
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">					if (entity instanceof FertileGround) {</span>
<span class="fc" id="L139">						passes = true;</span>
					}
				}
<span class="fc" id="L142">			}</span>
<span class="fc" id="L143">			return passes;</span>
		}
	}

	@Override
	protected void growNewFruit() {
<span class="fc bfc" id="L149" title="All 2 branches covered.">		if (isOnFreeFertileGround()) {</span>
<span class="fc" id="L150">			super.growNewFruit();</span>
		} else {
<span class="fc bfc" id="L152" title="All 2 branches covered.">			if (getZone() != null) {</span>
<span class="fc" id="L153">				getZone().remove(this);</span>
			}
		}
<span class="fc" id="L156">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>