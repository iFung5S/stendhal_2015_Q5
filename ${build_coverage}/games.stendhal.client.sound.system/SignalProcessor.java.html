<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SignalProcessor.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.client.sound.system</a> &gt; <span class="el_source">SignalProcessor.java</span></div><h1>SignalProcessor.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.client.sound.system;


/**
 * Every class that either wants to modify or generate a stream of
 * PCM audio data should derive from this class
 * &lt;p&gt;
 * Each SignalProcessor is a chain link in a doubly linked list, a processing chain.
 * The first SignalProcessor in such a chain should always generate audio data
 * otherwise no data will arrive at the quit of the chain
 *
 * @author silvio
 */
<span class="pc bpc" id="L26" title="1 of 2 branches missed.">public abstract class SignalProcessor</span>
{
<span class="fc" id="L28">    private SignalProcessor mNext = null;</span>
<span class="fc" id="L29">    private SignalProcessor mPrev = null;</span>

    /**
     * Connects this SignalProcessor to the next one
     * (it is inserted in the processing chain before nextProcessor)
     *
     * @param processor nextProcessor
     * @param before flag to insert processor before this object
     */
    public final synchronized void insert(SignalProcessor processor, boolean before)
    {
<span class="pc bpc" id="L40" title="3 of 4 branches missed.">        assert processor != this;</span>

<span class="pc bpc" id="L42" title="1 of 2 branches missed.">        if(mNext != null) { mNext.mPrev = mPrev; }</span>
<span class="pc bpc" id="L43" title="1 of 2 branches missed.">        if(mPrev != null) { mPrev.mNext = mNext; }</span>

<span class="pc bpc" id="L45" title="1 of 2 branches missed.">        if(processor != null)</span>
        {
<span class="pc bpc" id="L47" title="1 of 2 branches missed.">            if(before)</span>
            {
<span class="nc" id="L49">                mNext = processor;</span>
<span class="nc" id="L50">                mPrev = processor.mPrev;</span>

<span class="nc bnc" id="L52" title="All 2 branches missed.">                if(processor.mPrev != null)</span>
<span class="nc" id="L53">                    processor.mPrev.mNext = this;</span>

<span class="nc" id="L55">                processor.mPrev = this;</span>
            }
            else
            {
<span class="fc" id="L59">                mNext = processor.mNext;</span>
<span class="fc" id="L60">                mPrev = processor;</span>

<span class="pc bpc" id="L62" title="1 of 2 branches missed.">                if(processor.mNext != null)</span>
<span class="nc" id="L63">                    processor.mNext.mPrev = this;</span>

<span class="fc" id="L65">                processor.mNext = this;</span>
            }
        }
        else
        {
<span class="nc" id="L70">            mNext = null;</span>
<span class="nc" id="L71">            mPrev = null;</span>
        }
<span class="fc" id="L73">    }</span>

    public final synchronized void connectTo(SignalProcessor processor, boolean before)
    {
<span class="fc bfc" id="L77" title="All 2 branches covered.">        if(before)</span>
        {
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">            if(mNext == processor)</span>
<span class="nc" id="L80">                return;</span>

<span class="pc bpc" id="L82" title="1 of 2 branches missed.">            if(mNext           != null) { mNext.mPrev           = null; }</span>
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">            if(processor.mPrev != null) { processor.mPrev.mNext = null; }</span>

<span class="fc" id="L85">            mNext           = processor;</span>
<span class="fc" id="L86">            processor.mPrev = this;</span>
        }
        else
        {
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">            if(mPrev == processor)</span>
<span class="nc" id="L91">                return;</span>

<span class="pc bpc" id="L93" title="1 of 2 branches missed.">            if(mPrev           != null) { mPrev.mNext           = null; }</span>
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">            if(processor.mNext != null) { processor.mNext.mPrev = null; }</span>

<span class="fc" id="L96">            mPrev           = processor;</span>
<span class="fc" id="L97">            processor.mNext = this;</span>
        }
<span class="fc" id="L99">    }</span>

    public final synchronized void split(boolean before)
    {
<span class="nc bnc" id="L103" title="All 2 branches missed.">        if(before)</span>
        {
<span class="nc bnc" id="L105" title="All 2 branches missed.">            if(mPrev != null)</span>
			{
<span class="nc" id="L107">                mPrev.mNext = null;</span>
<span class="nc" id="L108">				mPrev       = null;</span>
			}
        }
        else
        {
<span class="nc bnc" id="L113" title="All 2 branches missed.">            if(mNext != null)</span>
			{
<span class="nc" id="L115">                mNext.mPrev = null;</span>
<span class="nc" id="L116">				mNext       = null;</span>
			}
        }
<span class="nc" id="L119">    }</span>

    /**
     * Replaces this SignalProcessor with &quot;processor&quot; in the processing chain
     * 
     * @param processor
     */
    public final synchronized void replace(SignalProcessor processor)
    {
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if(processor == this)</span>
<span class="nc" id="L129">            return;</span>

<span class="nc bnc" id="L131" title="All 2 branches missed.">        if(processor != null)</span>
        {
<span class="nc" id="L133">            processor.disconnect();</span>

<span class="nc bnc" id="L135" title="All 2 branches missed.">			if(mNext != null) { mNext.mPrev = processor; }</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">			if(mPrev != null) { mPrev.mNext = processor; }</span>
			
<span class="nc" id="L138">            processor.mNext = mNext;</span>
<span class="nc" id="L139">            processor.mPrev = mPrev;</span>
        }
        else
        {
<span class="nc" id="L143">            disconnect();</span>
        }
<span class="nc" id="L145">    }</span>

    /**
     * Removes this SignalProcessor from the processing chain
	 * leaving adjacent SignalProcessors disconnected
     */
    public final void disconnect()
    {
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">		if(mNext != null)</span>
		{
<span class="nc" id="L155">			mNext.mPrev = null;</span>
<span class="nc" id="L156">			mNext       = null;</span>
		}

<span class="pc bpc" id="L159" title="1 of 2 branches missed.">		if(mPrev != null)</span>
		{
<span class="fc" id="L161">			mPrev.mNext = null;</span>
<span class="fc" id="L162">			mPrev       = null;</span>
		}
<span class="fc" id="L164">    }</span>
    
    /**
     * This function should be called from a derived class
     * to propagate the modified audio data to the next SignalProcessor in the chain
     *
     * @param data
     * @param samples
     * @param channels
     * @param rate
     */
    protected final synchronized void propagate(float[] data, int samples, int channels, int rate)
    {
<span class="fc bfc" id="L177" title="All 2 branches covered.">        if(mNext != null)</span>
<span class="fc" id="L178">            mNext.modify(data, samples, channels, rate);</span>
<span class="fc" id="L179">    }</span>

    public final synchronized void quit()
    {
<span class="fc bfc" id="L183" title="All 2 branches covered.">        if(mNext != null)</span>
<span class="fc" id="L184">            mNext.finished();</span>
<span class="fc" id="L185">    }</span>

    /**
     * This will call the generate() method of the first
     * SignalProcessor in the processing chain
     * 
     * @return &lt;code&gt;true&lt;/code&gt;, until the stream is finished
     */
    public synchronized boolean request()
    {
<span class="fc bfc" id="L195" title="All 2 branches covered.">        if(mPrev != null)</span>
<span class="fc" id="L196">            return mPrev.request();</span>

<span class="fc" id="L198">        return generate();</span>
    }
    
    /**
     * This function should be overwritten by all classes that want to
     * modify an PCM audio stream. The audio data is uniform and interleaved.
     * uniform:     Each sample has a value between -1.0 and 1.0
     * interleaved: The channels are not separated. They are bundled in frames
     *              e.g. if there is stereo PCM data:
     *              data[0] and data[1] are the left and right channels of sample 0
     *              data[2] and data[3] are the left and right channels of sample 1
     *              data[4] and data[5] are the left and right channels of sample 2
     *              and so on ...
     *
	 * The number of samples can be calculated by: frames * channels
	 * 
     * @param data     the audio data
     * @param frames   the number of sample frames contained in &quot;data&quot;
     * @param channels number of channels
     * @param rate     the sample rate
     */
    protected void modify(float[] data, int frames, int channels, int rate)
    {
<span class="nc" id="L221">        propagate(data, frames, channels, rate);</span>
<span class="nc" id="L222">    }</span>

    /**
     * This function should be overwritten by all classes that want to
     * generate an PCM audio stream e.g. a mp3 decoder, a frequency generator, ...
     * 
     * @return &lt;code&gt;true&lt;/code&gt;, until the stream is finished 
     */
<span class="nc" id="L230">    protected boolean generate() { return false; }</span>

<span class="nc" id="L232">    protected void finished() { quit(); }</span>

    /**
     * This function will create a processing chain by connecting any number
     * of SignalProcessors together
     * 
     * @param processors any number of SignalProcessors to insert together
     */
    public static void createChain(SignalProcessor ...processors)
    {
<span class="nc" id="L242">        int l = processors.length;</span>

<span class="nc bnc" id="L244" title="All 2 branches missed.">        if(l &gt;= 2)</span>
        {
<span class="nc bnc" id="L246" title="All 2 branches missed.">            for(int i=1; i&lt;(l - 1); ++i)</span>
<span class="nc" id="L247">                processors[i].insert(processors[i-1], false);</span>

<span class="nc" id="L249">            processors[0  ].connectTo(processors[1  ], true);</span>
<span class="nc" id="L250">            processors[l-1].connectTo(processors[l-2], false);</span>
        }
<span class="nc" id="L252">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>