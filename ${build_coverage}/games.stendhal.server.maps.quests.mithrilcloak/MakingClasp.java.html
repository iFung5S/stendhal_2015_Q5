<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>MakingClasp.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.quests.mithrilcloak</a> &gt; <span class="el_source">MakingClasp.java</span></div><h1>MakingClasp.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.maps.quests.mithrilcloak;

import games.stendhal.common.MathHelper;
import games.stendhal.common.parser.Sentence;
import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.entity.item.Item;
import games.stendhal.server.entity.npc.ChatAction;
import games.stendhal.server.entity.npc.ConversationPhrases;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.EventRaiser;
import games.stendhal.server.entity.npc.NPCList;
import games.stendhal.server.entity.npc.SpeakerNPC;
import games.stendhal.server.entity.npc.action.DropItemAction;
import games.stendhal.server.entity.npc.action.EquipItemAction;
import games.stendhal.server.entity.npc.action.IncreaseXPAction;
import games.stendhal.server.entity.npc.action.MultipleActions;
import games.stendhal.server.entity.npc.action.SetQuestAndModifyKarmaAction;
import games.stendhal.server.entity.npc.condition.AndCondition;
import games.stendhal.server.entity.npc.condition.NotCondition;
import games.stendhal.server.entity.npc.condition.OrCondition;
import games.stendhal.server.entity.npc.condition.PlayerHasItemWithHimCondition;
import games.stendhal.server.entity.npc.condition.QuestInStateCondition;
import games.stendhal.server.entity.npc.condition.QuestStateStartsWithCondition;
import games.stendhal.server.entity.player.Player;
import games.stendhal.server.util.TimeUtil;

import java.util.Arrays;


/**
 * @author kymara
*/

class MakingClasp {


	private static final int REQUIRED_MINUTES_CLASP = 60;

	private MithrilCloakQuestInfo mithrilcloak;
	
<span class="fc" id="L53">	private final NPCList npcs = SingletonRepository.getNPCList();</span>

<span class="fc" id="L55">	public MakingClasp(final MithrilCloakQuestInfo mithrilcloak) {</span>
<span class="fc" id="L56">		this.mithrilcloak = mithrilcloak;</span>
<span class="fc" id="L57">	}</span>
	
	private void getClaspStep() {

		// don't overlap with any states from producer adder since he is a mithril bar producer
		
<span class="fc" id="L63">		final SpeakerNPC npc = npcs.get(&quot;Pedinghaus&quot;);</span>

		// offer the clasp when prompted
<span class="fc" id="L66">		npc.add(ConversationStates.ATTENDING,</span>
			Arrays.asList(&quot;clasp&quot;, &quot;mithril clasp&quot;, &quot;ida&quot;, &quot;cloak&quot;, &quot;mithril cloak&quot;),
			new QuestInStateCondition(mithrilcloak.getQuestSlot(), &quot;need_clasp&quot;),
			ConversationStates.SERVICE_OFFERED,
			&quot;A clasp? Whatever you say! I am still so happy from that letter you brought me, it would be my pleasure to make something for you. I only need one mithril bar. Do you have it?&quot;,
			null);

		// player says yes they want a clasp made and claim they have the mithril
<span class="fc" id="L74">		npc.add(</span>
			ConversationStates.SERVICE_OFFERED,
			ConversationPhrases.YES_MESSAGES, 
			new QuestInStateCondition(mithrilcloak.getQuestSlot(), &quot;need_clasp&quot;),
			ConversationStates.ATTENDING,
			null,
<span class="fc" id="L80">			new ChatAction() {</span>
				@Override
				public void fire(final Player player, final Sentence sentence, final EventRaiser npc) {
<span class="fc bfc" id="L83" title="All 2 branches covered.">					if (player.isEquipped(&quot;mithril bar&quot;)) {</span>
<span class="fc" id="L84">						player.drop(&quot;mithril bar&quot;);</span>
<span class="fc" id="L85">							npc.say(&quot;What a lovely piece of mithril that is, even if I do say so myself ... Good, please come back in &quot; </span>
									   + REQUIRED_MINUTES_CLASP + &quot; minutes and hopefully your clasp will be ready!&quot;);
<span class="fc" id="L87">							player.setQuest(mithrilcloak.getQuestSlot(), &quot;forgingclasp;&quot; + System.currentTimeMillis());</span>
<span class="fc" id="L88">							player.notifyWorldAboutChanges();</span>
						} else {
<span class="fc" id="L90">							npc.say(&quot;You can't fool an old wizard, and I'd know mithril when I see it. Come back when you have at least one bar.&quot;);</span>
						}
<span class="fc" id="L92">				}</span>
			});

		// player says they don't have any mithril yet
<span class="fc" id="L96">		npc.add(</span>
			ConversationStates.SERVICE_OFFERED,
			ConversationPhrases.NO_MESSAGES, 
			null,
			ConversationStates.ATTENDING,
			&quot;Well, if you should like me to cast any mithril bars just say.&quot;,
			null);

<span class="fc" id="L104">		npc.add(ConversationStates.ATTENDING, </span>
			Arrays.asList(&quot;clasp&quot;, &quot;mithril clasp&quot;, &quot;ida&quot;, &quot;cloak&quot;, &quot;mithril cloak&quot;),
			new QuestStateStartsWithCondition(mithrilcloak.getQuestSlot(), &quot;forgingclasp;&quot;),
<span class="fc" id="L107">			ConversationStates.ATTENDING, null, new ChatAction() {</span>
				@Override
				public void fire(final Player player, final Sentence sentence, final EventRaiser npc) {
<span class="fc" id="L110">					final String[] tokens = player.getQuest(mithrilcloak.getQuestSlot()).split(&quot;;&quot;);</span>
					// minutes -&gt; milliseconds
					final long delay = REQUIRED_MINUTES_CLASP * MathHelper.MILLISECONDS_IN_ONE_MINUTE;
<span class="fc" id="L113">					final long timeRemaining = (Long.parseLong(tokens[1]) + delay)</span>
							- System.currentTimeMillis();
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">					if (timeRemaining &gt; 0L) {</span>
<span class="nc" id="L116">						npc.say(&quot;I haven't finished yet, please return in &quot;</span>
							+ TimeUtil.approxTimeUntil((int) (timeRemaining / 1000L)) + &quot;.&quot;);
<span class="nc" id="L118">						return;</span>
					}
<span class="fc" id="L120">					npc.say(&quot;Here, your clasp is ready!&quot;);</span>
<span class="fc" id="L121">					player.addXP(100);</span>
<span class="fc" id="L122">					player.addKarma(15);</span>
<span class="fc" id="L123">					final Item clasp = SingletonRepository.getEntityManager().getItem(</span>
									&quot;mithril clasp&quot;);
<span class="fc" id="L125">					clasp.setBoundTo(player.getName());</span>
<span class="fc" id="L126">					player.equipOrPutOnGround(clasp);</span>
<span class="fc" id="L127">					player.setQuest(mithrilcloak.getQuestSlot(), &quot;got_clasp&quot;);</span>
<span class="fc" id="L128">					player.notifyWorldAboutChanges();</span>
<span class="fc" id="L129">				}</span>
			});

<span class="fc" id="L132">	}</span>


	private void giveClaspStep() {

<span class="fc" id="L137">		final SpeakerNPC npc = npcs.get(&quot;Ida&quot;);</span>
		
		// Player brought the clasp, don't make them wait any longer for the cloak
<span class="fc" id="L140">		npc.add(ConversationStates.ATTENDING,</span>
				Arrays.asList(&quot;clasp&quot;, &quot;mithril clasp&quot;, &quot;cloak&quot;, &quot;mithril cloak&quot;, &quot;task&quot;, &quot;quest&quot;),
				new AndCondition(new QuestInStateCondition(mithrilcloak.getQuestSlot(), &quot;got_clasp&quot;), new PlayerHasItemWithHimCondition(&quot;mithril clasp&quot;)),
				ConversationStates.ATTENDING,
				&quot;Wow, Pedinghaus really outdid himself this time. It looks wonderful on your new cloak! Wear it with pride.&quot;,
				new MultipleActions(
									 new DropItemAction(&quot;mithril clasp&quot;), 
									 new SetQuestAndModifyKarmaAction(mithrilcloak.getQuestSlot(), &quot;done&quot;, 10.0),
									 new EquipItemAction(&quot;mithril cloak&quot;, 1, true), 
									 new IncreaseXPAction(1000)
									 )
				);

		// remind about getting clasp
<span class="fc" id="L154">		npc.add(ConversationStates.ATTENDING,</span>
				Arrays.asList(&quot;clasp&quot;, &quot;mithril clasp&quot;, &quot;cloak&quot;, &quot;mithril cloak&quot;, &quot;task&quot;, &quot;quest&quot;),
				new OrCondition(
								new QuestInStateCondition(mithrilcloak.getQuestSlot(), &quot;need_clasp&quot;),
								new QuestStateStartsWithCondition(mithrilcloak.getQuestSlot(), &quot;forgingclasp;&quot;),
								new AndCondition(new QuestInStateCondition(mithrilcloak.getQuestSlot(), &quot;got_clasp&quot;),
												 new NotCondition(new PlayerHasItemWithHimCondition(&quot;mithril clasp&quot;)))
								),
				ConversationStates.ATTENDING,
				&quot;You haven't got the clasp from #Pedinghaus yet. As soon as I have that your cloak will be finished!&quot;,				
				null);
<span class="fc" id="L165">	}</span>

	public void addToWorld() {
<span class="fc" id="L168">		getClaspStep();</span>
<span class="fc" id="L169">		giveClaspStep();</span>
		
<span class="fc" id="L171">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>