<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>InitialSteps.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.quests.mithrilcloak</a> &gt; <span class="el_source">InitialSteps.java</span></div><h1>InitialSteps.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.maps.quests.mithrilcloak;

import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.entity.npc.ConversationPhrases;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.NPCList;
import games.stendhal.server.entity.npc.SpeakerNPC;
import games.stendhal.server.entity.npc.action.DropRecordedItemAction;
import games.stendhal.server.entity.npc.action.IncreaseXPAction;
import games.stendhal.server.entity.npc.action.MultipleActions;
import games.stendhal.server.entity.npc.action.SayRequiredItemAction;
import games.stendhal.server.entity.npc.action.SetQuestAction;
import games.stendhal.server.entity.npc.action.SetQuestAndModifyKarmaAction;
import games.stendhal.server.entity.npc.action.StartRecordingRandomItemCollectionAction;
import games.stendhal.server.entity.npc.condition.AndCondition;
import games.stendhal.server.entity.npc.condition.NotCondition;
import games.stendhal.server.entity.npc.condition.OrCondition;
import games.stendhal.server.entity.npc.condition.PlayerHasRecordedItemWithHimCondition;
import games.stendhal.server.entity.npc.condition.QuestCompletedCondition;
import games.stendhal.server.entity.npc.condition.QuestInStateCondition;
import games.stendhal.server.entity.npc.condition.QuestNotStartedCondition;
import games.stendhal.server.entity.npc.condition.QuestStartedCondition;
import games.stendhal.server.entity.npc.condition.QuestStateStartsWithCondition;

import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;

/*
 * @author kymara
 */

class InitialSteps {

	private MithrilCloakQuestInfo mithrilcloak;
	
<span class="fc" id="L49">	private final NPCList npcs = SingletonRepository.getNPCList();</span>

<span class="fc" id="L51">	public InitialSteps(final MithrilCloakQuestInfo mithrilcloak) {</span>
<span class="fc" id="L52">		this.mithrilcloak = mithrilcloak;</span>
<span class="fc" id="L53">	}</span>

	private void offerQuestStep() {
<span class="fc" id="L56">		final SpeakerNPC npc = npcs.get(&quot;Ida&quot;);</span>
		

		// player asks about quest, they haven't started it yet
<span class="fc" id="L60">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES, 
				new OrCondition(new QuestNotStartedCondition(mithrilcloak.getQuestSlot()), new QuestInStateCondition(mithrilcloak.getQuestSlot(), &quot;rejected&quot;)),				
				ConversationStates.QUEST_OFFERED, 
				&quot;My sewing machine is broken, will you help me fix it?&quot;,
				null);
		
<span class="fc" id="L67">		final Map&lt;String,Integer&gt; items = new HashMap&lt;String, Integer&gt;();</span>
<span class="fc" id="L68">		items.put(&quot;leather armor&quot;,1);</span>
<span class="fc" id="L69">		items.put(&quot;oil&quot;,1);</span>
<span class="fc" id="L70">		items.put(&quot;bobbin&quot;,1);</span>

		// Player says yes they want to help 
<span class="fc" id="L73">		npc.add(ConversationStates.QUEST_OFFERED,</span>
			ConversationPhrases.YES_MESSAGES, null,
			ConversationStates.ATTENDING,
			null,			
			new MultipleActions(new SetQuestAction(mithrilcloak.getQuestSlot(), &quot;machine;&quot;),
								new StartRecordingRandomItemCollectionAction(mithrilcloak.getQuestSlot(), 1, items, &quot;Thank you! To fix it, it needs [#item]. I'm ever so grateful for your help.&quot;)));
		
		// player said no they didn't want to help
<span class="fc" id="L81">		npc.add(</span>
			ConversationStates.QUEST_OFFERED,
			ConversationPhrases.NO_MESSAGES,
			null,
			ConversationStates.IDLE,
			&quot;Oh dear, I don't know what I can do without a decent sewing machine. But don't worry I won't bother you any longer!&quot;,
			new SetQuestAndModifyKarmaAction(mithrilcloak.getQuestSlot(), &quot;rejected&quot;, -5.0));


		// player asks for quest but they already did it	
<span class="fc" id="L91">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES, 
				new QuestCompletedCondition(mithrilcloak.getQuestSlot()),
				ConversationStates.ATTENDING, 
				&quot;You've already completed the only quest that I have for you.&quot;,
				null);
		
		//player fixed the machine but hadn't got mithril shield. 
		// they return and ask for quest but they still haven't got mithril shield
<span class="fc" id="L100">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES, 
				new AndCondition(new NotCondition(new QuestCompletedCondition(mithrilcloak.getShieldQuestSlot())),
								 new OrCondition(new QuestInStateCondition(mithrilcloak.getQuestSlot(), &quot;need_mithril_shield&quot;),
												 new QuestInStateCondition(mithrilcloak.getQuestSlot(), &quot;fixed_machine&quot;))
								 ),
				ConversationStates.ATTENDING, 
								 &quot;I don't have anything for you until you have proved yourself worthy of carrying mithril items, by getting the mithril shield.&quot;,
				null);


		// player fixed the machine but hadn't got mithril shield at time or didn't ask to hear more about the cloak. 
		// when they have got it and return to ask for quest she offers the cloak
<span class="fc" id="L113">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES, 
				new AndCondition(
								 new QuestCompletedCondition(mithrilcloak.getShieldQuestSlot()),
								 new OrCondition(new QuestInStateCondition(mithrilcloak.getQuestSlot(), &quot;need_mithril_shield&quot;),
												 new QuestInStateCondition(mithrilcloak.getQuestSlot(), &quot;fixed_machine&quot;))
								 ),
				ConversationStates.QUEST_2_OFFERED, 
				&quot;Congratulations, you completed the quest for the mithril shield! Now, I have another quest for you, do you want to hear it?&quot;,
				null);

<span class="fc" id="L124">		npc.addReply(Arrays.asList(&quot;oil&quot;, &quot;can of oil&quot;, &quot;can&quot;), &quot;The only oil I have ever had is very fishy smelling. I expect a fisherman made it.&quot;);</span>
<span class="fc" id="L125">		npc.addReply(&quot;bobbin&quot;, &quot;Only dwarf smiths make bobbins, no-one else has nimble enough fingers. Try #Alrak.&quot;);</span>
<span class="fc" id="L126">		npc.addReply(&quot;Alrak&quot;, &quot;I thought you kids all knew Alrak, the only dwarf that kobolds have ever liked. Or maybe he's the only dwarf to ever like kobolds, I've never been sure which ...&quot;);</span>
<span class="fc" id="L127">		npc.addReply(Arrays.asList(&quot;leather armor&quot;, &quot;suit of leather armor&quot;, &quot;suit&quot;), &quot;Yes, well, it needs a piece of leather for the mechanism, so I can cut a piece from that.&quot;);</span>
<span class="fc" id="L128">	}</span>

	
	private void fixMachineStep() {

<span class="fc" id="L133">		final SpeakerNPC npc = npcs.get(&quot;Ida&quot;);</span>

		// player returns who has agreed to help fix machine and prompts ida
<span class="fc" id="L136">		npc.add(ConversationStates.ATTENDING,</span>
				Arrays.asList(&quot;sewing&quot;, &quot;machine&quot;, &quot;sewing machine&quot;, &quot;task&quot;, &quot;quest&quot;),
				new QuestStateStartsWithCondition(mithrilcloak.getQuestSlot(), &quot;machine&quot;),
				ConversationStates.QUEST_ITEM_QUESTION,
				&quot;My sewing machine is still broken, did you bring anything to fix it?&quot;,
				null);

			// we stored the needed part name as part of the quest slot
<span class="fc" id="L144">			npc.add(ConversationStates.QUEST_ITEM_QUESTION,</span>
					ConversationPhrases.YES_MESSAGES,
					new PlayerHasRecordedItemWithHimCondition(mithrilcloak.getQuestSlot(),1),
					ConversationStates.QUEST_2_OFFERED,
					&quot;Thank you so much! Listen, I must repay the favour, and I have a wonderful idea. Do you want to hear more?&quot;,
					new MultipleActions(new DropRecordedItemAction(mithrilcloak.getQuestSlot(),1), 
							new SetQuestAction(mithrilcloak.getQuestSlot(), &quot;fixed_machine&quot;),
							new IncreaseXPAction(100)));
			
			// we stored the needed part name as part of the quest slot
<span class="fc" id="L154">			npc.add(ConversationStates.QUEST_ITEM_QUESTION,</span>
					ConversationPhrases.YES_MESSAGES,
					new NotCondition(new PlayerHasRecordedItemWithHimCondition(mithrilcloak.getQuestSlot(),1)),
					ConversationStates.ATTENDING,
					null,
					new SayRequiredItemAction(mithrilcloak.getQuestSlot(),1,&quot;No, you don't have [the item] I need. What a shame.&quot;));
									

			// player doesn't have the item to fix machine yet				
<span class="fc" id="L163">		   npc.add(ConversationStates.QUEST_ITEM_QUESTION,</span>
				   ConversationPhrases.NO_MESSAGES,
				   null,
				   ConversationStates.ATTENDING,
				   null,
				   new SayRequiredItemAction(mithrilcloak.getQuestSlot(),1,&quot;Ok, well if there's anything else I can help you with just say. Don't forget to bring [the item] next time though!&quot;));

		   //offer cloak
<span class="fc" id="L171">		   npc.add(ConversationStates.QUEST_2_OFFERED,</span>
				   ConversationPhrases.YES_MESSAGES,
				   new QuestCompletedCondition(mithrilcloak.getShieldQuestSlot()),
				   ConversationStates.ATTENDING,		   
				   &quot;I will make you the most amazing cloak of mithril. You just need to get me the fabric and any tools I need! First please bring me a couple yards of &quot; + mithrilcloak.getFabricName() + &quot;. The expert on fabrics is the wizard #Kampusch.&quot;,
				   new SetQuestAction(mithrilcloak.getQuestSlot(), &quot;need_fabric&quot;));
					

			// player asks for quest but they haven't completed mithril shield quest
<span class="fc" id="L180">			npc.add(ConversationStates.QUEST_2_OFFERED,</span>
				ConversationPhrases.YES_MESSAGES, 
				new AndCondition(
								 new NotCondition(new QuestCompletedCondition(mithrilcloak.getShieldQuestSlot())),
								 new QuestStartedCondition(mithrilcloak.getShieldQuestSlot())
								 ),
				ConversationStates.ATTENDING, 
				&quot;Oh, I see you are already on a quest to obtain a mithril shield. You see, I was going to offer you a mithril cloak. But you should finish that first. Come back when you've finished the mithril shield quest and we will speak again.&quot;,
				new SetQuestAction(mithrilcloak.getQuestSlot(), &quot;need_mithril_shield&quot;));
			
			// player asks for quest but they haven't completed mithril shield quest
<span class="fc" id="L191">			npc.add(ConversationStates.QUEST_2_OFFERED,</span>
					ConversationPhrases.YES_MESSAGES,
					new QuestNotStartedCondition(mithrilcloak.getShieldQuestSlot()),
					ConversationStates.ATTENDING, 
					&quot;There are legends of a wizard called Baldemar, in the famous underground magic city, who will forge a mithril shield for those who bring him what it needs. You should meet him and do what he asks. Once you have completed that quest, come back here and speak with me again. I will have another quest for you.&quot;,
					new SetQuestAction(mithrilcloak.getQuestSlot(), &quot;need_mithril_shield&quot;));

			// player refused to hear more about another quest after fixing machine
<span class="fc" id="L199">			npc.add(ConversationStates.QUEST_2_OFFERED,</span>
					ConversationPhrases.NO_MESSAGES,
					null,
					ConversationStates.ATTENDING,
					&quot;Ok then obviously you don't need any mithril items! Forgive me for offering to help...!&quot;,
					null);

			// where to find wizard
<span class="fc" id="L207">			npc.addReply(&quot;Kampusch&quot;, &quot;He is obsessed with antiques so look for him in an antiques shop or a museum.&quot;);</span>
	
<span class="fc" id="L209">	}</span>

	public void addToWorld() {
<span class="fc" id="L212">		offerQuestStep();</span>
<span class="fc" id="L213">		fixMachineStep();</span>
<span class="fc" id="L214">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>