<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AccessCheckingPortal.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.entity.mapstuff.portal</a> &gt; <span class="el_source">AccessCheckingPortal.java</span></div><h1>AccessCheckingPortal.java</h1><pre class="source lang-java linenums">/*
 * @(#) src/games/stendhal/server/entity/portal/AccessCheckingPortal.java
 *
 * $Id$
 */

package games.stendhal.server.entity.mapstuff.portal;

import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.core.events.TurnListener;
import games.stendhal.server.entity.RPEntity;
import games.stendhal.server.entity.player.Player;

import java.util.LinkedList;
import java.util.List;

import marauroa.common.game.RPObject;

import org.apache.log4j.Logger;

/**
 * An access checking portal is a special kind of portal which requires some
 * condition to use.
 */
abstract class AccessCheckingPortal extends Portal {
    
    /** the logger instance. */
<span class="fc" id="L28">    private static final Logger logger = Logger.getLogger(AccessCheckingPortal.class);</span>
    
    /** Immediate execution of action when player says password. */
<span class="pc" id="L31">    protected boolean instantAction = false;</span>
    
    /** Radius at which portal will &quot;listen&quot; for speaking players. */
    protected int listeningRadius;
    
    /** Optional message to give when correct password used. */
    protected String passwordAcceptedMessage;
    
    /** Optional message to give when incorrect password used. */
    protected String passwordRejectedMessage;
    
    /** ID for the portal */
    protected int portalID;
<span class="fc" id="L44">    protected static int portalIDCounter = 100;</span>
    
    /** The message to give when rejected. */
    protected String rejectedMessage;
    
    /** Optional password to use portal. */
    protected String requiredPassword;
    
    /**
     * Creates an access checking portal with default values.
     */
<span class="nc" id="L55">    public AccessCheckingPortal() {</span>
<span class="nc" id="L56">        this.rejectedMessage = &quot;Why should i go down there?. It looks very dangerous.&quot;;</span>
        
<span class="nc" id="L58">        portalID = portalIDCounter;</span>
<span class="nc" id="L59">        portalIDCounter += 1;</span>
<span class="nc" id="L60">    }</span>

	/**
	 * Creates an access checking portal.
	 * 
	 * @param rejectMessage
	 *            The message to given when rejected.
	 */
<span class="fc" id="L68">	public AccessCheckingPortal(final String rejectMessage) {</span>
<span class="fc" id="L69">		this.rejectedMessage = rejectMessage;</span>
        
<span class="fc" id="L71">        portalID = portalIDCounter;</span>
<span class="fc" id="L72">        portalIDCounter += 1;</span>
<span class="fc" id="L73">	}</span>
	
	/**
	 * 
	 * @param object
	 */
	public AccessCheckingPortal(final RPObject object) {
<span class="nc" id="L80">		super(object);</span>
        
<span class="nc" id="L82">        portalID = portalIDCounter;</span>
<span class="nc" id="L83">        portalIDCounter += 1;</span>
<span class="nc" id="L84">	}</span>

	/**
	 * 
	 * @return
	 *      Message when password is accepted.
	 */
    public String getPasswordAcceptedMessage() {
<span class="nc" id="L92">        return passwordAcceptedMessage;</span>
    }
    
    /**
     * 
     * @return
     *      Messager when password is rejected.
     */
    public String getPasswordRejectedMessage() {
<span class="nc" id="L101">        return passwordRejectedMessage;</span>
    }
    
    /**
     * 
     * @return
     *      Radius at which portal detects player speech.
     */
    public int getListeningRadius() {
<span class="nc" id="L110">        return listeningRadius;</span>
    }
    
    /**
     * Finds players nearby that have spoken.
     * 
     * @return
     *      List of players
     */
    private List&lt;Player&gt; getNearbyPlayersThatHaveSpoken() {
<span class="nc" id="L120">        final int x = getX();</span>
<span class="nc" id="L121">        final int y = getY();</span>

<span class="nc" id="L123">        final List&lt;Player&gt; players = new LinkedList&lt;Player&gt;();</span>

<span class="nc bnc" id="L125" title="All 2 branches missed.">        for (final Player player : getZone().getPlayers()) {</span>
<span class="nc" id="L126">            final int px = player.getX();</span>
<span class="nc" id="L127">            final int py = player.getY();</span>

<span class="nc bnc" id="L129" title="All 2 branches missed.">            if (player.has(&quot;text&quot;)) {</span>
<span class="nc" id="L130">                int dx = px - x;</span>
<span class="nc" id="L131">                int dy = py - y;</span>

<span class="nc bnc" id="L133" title="All 4 branches missed.">                if (Math.abs(dx)&lt;listeningRadius &amp;&amp; Math.abs(dy)&lt;listeningRadius) { // check rectangular area</span>
//              if (dx*dx + dy*dy &lt; range*range) { // optionally we could check a circular area
<span class="nc" id="L135">                    players.add(player);</span>
                }
            }
<span class="nc" id="L138">        }</span>

<span class="nc" id="L140">        return players;</span>
    }
    
    /**
     * Gets the message to send when player is denied access to portal.
     * 
     * @return
     *      Rejected message
     */
    public String getRejectedMessage() {
<span class="nc" id="L150">        return rejectedMessage;</span>
    }
    
    /**
     * Gets the password required to use the portal.
     * 
     * @return
     *      Required password
     */
    public String getRequiredPassword() {
<span class="nc" id="L160">        return requiredPassword;</span>
    }
    
    /**
     * Checks if the portal executes an action immediately after password is said.
     * 
     * @return
     *      instantAction
     */
    public boolean hasInstanceAction() {
<span class="nc" id="L170">        return instantAction;</span>
    }

	/**
	 * Determine if this portal can be used.
	 * 
	 * @param user
	 *            The user to be checked.
	 * 
	 * @return &lt;code&gt;true&lt;/code&gt; if the user can use the portal.
	 */
	protected abstract boolean isAllowed(RPEntity user);
	
	public boolean playerIsPortalUnlocked(final Player player, final Portal portal) {
<span class="nc bnc" id="L184" title="All 2 branches missed.">	    if (player.getUnlockedPortals().contains(portalID)) {</span>
<span class="nc" id="L185">	        return true;</span>
	    }
<span class="nc" id="L187">	    return false;</span>
	}

    @Override
	public void logic() {
        // Execute action for password portal if required password is set.
<span class="nc bnc" id="L193" title="All 2 branches missed.">        if (requiredPassword != null) {</span>
<span class="nc" id="L194">            List&lt;Player&gt; players = getNearbyPlayersThatHaveSpoken();</span>
            
            String text;
            
<span class="nc bnc" id="L198" title="All 2 branches missed.">            for (Player player : players) {</span>
<span class="nc" id="L199">                text = player.get(&quot;text&quot;);</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">                if (text.equals(requiredPassword)) {</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">                    if (passwordAcceptedMessage != null) {</span>
<span class="nc" id="L202">                        sendMessage(player, passwordAcceptedMessage);</span>
                    }
                    // Temporarily unlock this portal for player.
<span class="nc" id="L205">                    player.unlockPortal(portalID);</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">                } else if (passwordRejectedMessage != null) {</span>
<span class="nc" id="L207">                    sendMessage(player, passwordRejectedMessage);</span>
                }
<span class="nc" id="L209">            }</span>
        }
<span class="nc" id="L211">    }</span>
    
    /**
     * Use the portal, if allowed.
     * 
     * @param user
     *            that wants to pass.
     * @return true if passed , false otherwise.
     */
    @Override
    public boolean onUsed(final RPEntity user) {
<span class="fc bfc" id="L222" title="All 2 branches covered.">        if (isAllowed(user)) {</span>
            // Check if this is a password portal and player has access.
<span class="pc bpc" id="L224" title="3 of 4 branches missed.">            if ((requiredPassword != null) &amp;&amp; !playerIsPortalUnlocked((Player) user, this)) {</span>
<span class="nc" id="L225">                logger.debug(&quot;Player &quot; + user.getName() + &quot; does not have access to portal ID &quot;</span>
                        + Integer.toString(getID().getObjectID()) + &quot; at &quot; + this.getZone().getName()
                        + &quot; (&quot; + Integer.toString(getX()) + &quot;,&quot; + Integer.toString(getY())
                        + &quot;). Required password: &quot; + requiredPassword);
<span class="nc" id="L229">                return false;</span>
            }
<span class="fc" id="L231">            return super.onUsed(user);</span>
        }
        // Supresses sprite bounce-back in the case of non-resistant portals
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">        if (getResistance() != 0) {</span>
<span class="fc" id="L235">            user.stop();</span>
        }
<span class="fc" id="L237">        rejected(user);</span>
<span class="fc" id="L238">        return false;</span>
    }

	/**
	 * Called when the user is rejected. This sends a rejection message to the
	 * user if set.
	 * 
	 * @param user
	 *            The rejected user.
	 */
	protected void rejected(final RPEntity user) {
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">		if (rejectedMessage != null) {</span>
<span class="fc" id="L250">			sendMessage(user, rejectedMessage);</span>
			/*
			 * Supesses sprite bounce-back in the case of non-resistant portals
			 */
<span class="pc bpc" id="L254" title="1 of 2 branches missed.">			if (getResistance() != 0) {</span>
<span class="fc" id="L255">				user.stop();</span>
<span class="fc" id="L256">				user.clearPath();</span>
			}
		}
<span class="fc" id="L259">	}</span>

	/**
	 * Wrapper to send a message to a user, without getting lost.
	 * 
	 * @param user
	 *            The user to send to.
	 * @param text
	 *            The message to send.
	 */
	protected void sendMessage(final RPEntity user, final String text) {
<span class="fc" id="L270">		SingletonRepository.getTurnNotifier().notifyInTurns(0, new SendMessage(user, text));</span>
<span class="fc" id="L271">	}</span>
	
    /**
     * 
     * @param instant
     *         Use portal automatically.
     */
    public void setInstantAction(final boolean instant) {
<span class="nc" id="L279">        instantAction = instant;</span>
//      logger.info(&quot;\nSetting instant action to \&quot;&quot; + Boolean.toString(instant) + &quot;\&quot; for portal at &quot;
//              + getZone().getName() + &quot; (&quot; + Integer.toString(getX()) + &quot;,&quot; + Integer.toString(getY()) + &quot;\n&quot;);
<span class="nc" id="L282">    }</span>
    
	/**
	 * Set the password accepted message.
	 * 
	 * @param message
	 *            Optional message to be given when correct password used.
	 */
	public void setPasswordAcceptedMessage(final String message) {
<span class="nc" id="L291">	    passwordAcceptedMessage = message;</span>
<span class="nc" id="L292">	}</span>
	
    /**
     * Set the password rejected message.
     * 
     * @param message
     *            Optional message to be given when incorrect password used.
     */
    public void setPasswordRejectedMessage(final String message) {
<span class="nc" id="L301">        passwordRejectedMessage = message;</span>
<span class="nc" id="L302">    }</span>
    
	
	/**
	 * Sets the radius at which the portal will &quot;hear&quot; speaking players.
	 * 
	 * @param radius
	 *         Distance at wich portal listens for players speaking.
	 */
	public void setListeningRadius(int radius) {
<span class="nc bnc" id="L312" title="All 2 branches missed.">	    if (radius &lt;= 0) {</span>
<span class="nc" id="L313">	        radius = 1;</span>
	    }
<span class="nc" id="L315">	    listeningRadius = radius;</span>
<span class="nc" id="L316">	}</span>
	
	/**
	 * Set the rejection message.
	 * 
	 * @param message The message to give when rejected.
	 */
	public void setRejectedMessage(final String message) {
<span class="fc" id="L324">		rejectedMessage = message;</span>
<span class="fc" id="L325">	}</span>
	
	/**
	 * 
	 * @param password
	 */
	public void setRequiredPassword(final String password) {
<span class="nc" id="L332">	    requiredPassword = password;</span>
<span class="nc" id="L333">	}</span>
	
	/**
	 * A turn listener that sends a user message. Once sendPrivateText() is
	 * fixed (via a queue or something) to always work, this can go away.
	 */
	protected static class SendMessage implements TurnListener {
		/**
		 * The user to send to.
		 */
		private final RPEntity user;
		private final String text;

		/**
		 * Create a message sending turn listener.
		 * 
		 * @param user
		 *            The user to send to.
		 * @param text
		 *            Message to send
		 */
<span class="fc" id="L354">		public SendMessage(final RPEntity user, final String text) {</span>
<span class="fc" id="L355">			this.user = user;</span>
<span class="fc" id="L356">			this.text = text;</span>
<span class="fc" id="L357">		}</span>

		/**
		 * This method is called when the turn number is reached.
		 * 
		 * @param currentTurn
		 *            Current turn number.
		 */
		@Override
		public void onTurnReached(final int currentTurn) {
<span class="fc" id="L367">			user.sendPrivateText(this.text);</span>
<span class="fc" id="L368">			user.notifyWorldAboutChanges();</span>
<span class="fc" id="L369">		}</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>