<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>OutfitChangerAdder.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.entity.npc.behaviour.adder</a> &gt; <span class="el_source">OutfitChangerAdder.java</span></div><h1>OutfitChangerAdder.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2011 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.entity.npc.behaviour.adder;

import games.stendhal.common.grammar.Grammar;
import games.stendhal.common.grammar.ItemParserResult;
import games.stendhal.common.parser.Sentence;
import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.entity.npc.ChatAction;
import games.stendhal.server.entity.npc.ConversationPhrases;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.EventRaiser;
import games.stendhal.server.entity.npc.SpeakerNPC;
import games.stendhal.server.entity.npc.action.BehaviourAction;
import games.stendhal.server.entity.npc.behaviour.impl.OutfitChangerBehaviour;
import games.stendhal.server.entity.npc.behaviour.journal.ServicersRegister;
import games.stendhal.server.entity.npc.fsm.Engine;
import games.stendhal.server.entity.player.Player;
import games.stendhal.server.util.TimeUtil;

import org.apache.log4j.Logger;

<span class="fc" id="L33">public class OutfitChangerAdder {</span>
<span class="fc" id="L34">	private static Logger logger = Logger.getLogger(OutfitChangerAdder.class);</span>
	
<span class="fc" id="L36">    private final ServicersRegister servicersRegister = SingletonRepository.getServicersRegister();</span>
    
	/**
	 * Behaviour parse result in the current conversation.
	 * Remark: There is only one conversation between a player and the NPC at any time.
	 */
	private ItemParserResult currentBehavRes;

	/**
	 * Makes this NPC an outfit changer, i.e. someone who can give players
	 * special outfits.
	 * 
	 * @param npc
	 *            SpeakerNPC
	 * @param behaviour
	 *            The behaviour (which includes a pricelist).
	 * @param command
	 *            The action needed to get the outfit, e.g. &quot;buy&quot;, &quot;lend&quot;.
	 */
	public void addOutfitChanger(final SpeakerNPC npc,
			final OutfitChangerBehaviour behaviour, final String command) {
<span class="fc" id="L57">		addOutfitChanger(npc, behaviour, command, true, true);</span>
<span class="fc" id="L58">	}</span>

	/**
	 * Makes this NPC an outfit changer, i.e. someone who can give players
	 * special outfits.
	 * 
	 * @param npc
	 *            SpeakerNPC
	 * @param outfitBehaviour
	 *            The behaviour (which includes a pricelist).
	 * @param action
	 *            The action needed to get the outfit, e.g. &quot;buy&quot;, &quot;lend&quot;.
	 * @param offer
	 *            Defines if the NPC should react to the word &quot;offer&quot;.
	 * @param canReturn
	 *            If true, a player can say &quot;return&quot; to get his original outfit
	 *            back.
	 */
	public void addOutfitChanger(final SpeakerNPC npc,
			final OutfitChangerBehaviour outfitBehaviour, final String action,
			final boolean offer, final boolean canReturn) {
		
<span class="fc" id="L80">		servicersRegister.add(npc.getName(), outfitBehaviour);</span>

<span class="fc" id="L82">		final Engine engine = npc.getEngine();</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">		if (offer) {</span>
<span class="fc" id="L84">			engine.add(</span>
					ConversationStates.ATTENDING,
					ConversationPhrases.OFFER_MESSAGES,
					null,
					false,
					ConversationStates.ATTENDING,
					&quot;You can #&quot;
							+ action
							+ &quot; &quot;
							+ Grammar.enumerateCollection(outfitBehaviour.dealtItems())
							+ &quot;.&quot;, null);
		}

<span class="fc" id="L97">		engine.add(ConversationStates.ATTENDING, action, null, false,</span>
				ConversationStates.ATTENDING, null,
<span class="fc" id="L99">				new BehaviourAction(outfitBehaviour, action, &quot;offer&quot;) {</span>
					@Override
					public void fireRequestOK(final ItemParserResult res, Player player, Sentence sentence, EventRaiser raiser) {
						// find out what the player wants to wear

						// We ignore any amounts.
<span class="fc" id="L105">						res.setAmount(1);</span>

<span class="fc" id="L107">						final int price = outfitBehaviour.getUnitPrice(res.getChosenItemName()) * res.getAmount();</span>

<span class="fc" id="L109">						raiser.say(&quot;To &quot; + action + &quot; a &quot; + res.getChosenItemName() + &quot; will cost &quot; + price</span>
								+ &quot;. Do you want to &quot; + action + &quot; it?&quot;);

<span class="fc" id="L112">						currentBehavRes = res;</span>
<span class="fc" id="L113">						raiser.setCurrentState(ConversationStates.BUY_PRICE_OFFERED); // success</span>
<span class="fc" id="L114">					}</span>
				});

<span class="fc" id="L117">		engine.add(ConversationStates.BUY_PRICE_OFFERED,</span>
				ConversationPhrases.YES_MESSAGES, null,
				false, ConversationStates.ATTENDING,
<span class="fc" id="L120">				null, new ChatAction() {</span>
					@Override
					public void fire(final Player player, final Sentence sentence,
							final EventRaiser npc) {
<span class="fc" id="L124">						final String itemName = currentBehavRes.getChosenItemName();</span>
<span class="fc" id="L125">						logger.debug(&quot;Selling a &quot; + itemName + &quot; to player &quot; + player.getName());</span>

<span class="pc bpc" id="L127" title="1 of 2 branches missed.">						if (outfitBehaviour.transactAgreedDeal(currentBehavRes, npc, player)) {</span>
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">							if (canReturn) {</span>
<span class="fc" id="L129">								npc.say(&quot;Thanks, and please don't forget to #return it when you don't need it anymore!&quot;);</span>
								// -1 is also the public static final int NEVER_WEARS_OFF = -1; 
								// but it doesn't recognise it here ...
<span class="nc bnc" id="L132" title="All 2 branches missed.">							} else if (outfitBehaviour.getEndurance() != -1) {</span>
								// timeUntil takes a parameter in seconds so we multiply the endurance in minutes by 60
<span class="nc" id="L134">								npc.say(&quot;Thanks! You can wear this for &quot; +  TimeUtil.timeUntil(60 * outfitBehaviour.getEndurance()) + &quot;.&quot;);</span>
							} else {
<span class="nc" id="L136">								npc.say(&quot;Thanks!&quot;);</span>
							}
						}

<span class="fc" id="L140">						currentBehavRes = null;</span>
<span class="fc" id="L141">					}</span>
				});

<span class="fc" id="L144">		engine.add(ConversationStates.BUY_PRICE_OFFERED,</span>
				ConversationPhrases.NO_MESSAGES, null,
				false, ConversationStates.ATTENDING,
				&quot;Ok, how else may I help you?&quot;, null);

<span class="fc bfc" id="L149" title="All 2 branches covered.">		if (canReturn) {</span>
<span class="fc" id="L150">			engine.add(ConversationStates.ATTENDING, &quot;return&quot;, null,</span>
					false, ConversationStates.ATTENDING,
<span class="fc" id="L152">					null, new ChatAction() {</span>
						@Override
						public void fire(final Player player, final Sentence sentence,
								final EventRaiser npc) {
<span class="nc bnc" id="L156" title="All 2 branches missed.">							if (outfitBehaviour.returnToOriginalOutfit(player)) {</span>
<span class="nc" id="L157">								npc.say(&quot;Thank you!&quot;);</span>
							} else {
<span class="nc" id="L159">								npc.say(&quot;I can't remember that I gave you anything.&quot;);</span>
							}

<span class="nc" id="L162">							currentBehavRes = null;</span>
<span class="nc" id="L163">						}</span>
					});
		}
<span class="fc" id="L166">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>