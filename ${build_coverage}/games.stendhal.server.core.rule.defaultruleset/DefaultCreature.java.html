<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DefaultCreature.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.core.rule.defaultruleset</a> &gt; <span class="el_source">DefaultCreature.java</span></div><h1>DefaultCreature.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                      (C) Copyright 2003 - Marauroa                      *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.core.rule.defaultruleset;

import games.stendhal.common.constants.Nature;
import games.stendhal.server.core.rule.EntityManager;
import games.stendhal.server.entity.creature.Creature;
import games.stendhal.server.entity.creature.impl.DropItem;
import games.stendhal.server.entity.creature.impl.EquipItem;
import games.stendhal.server.entity.status.Status;
import games.stendhal.server.entity.status.StatusAttacker;
import groovy.lang.Binding;
import groovy.lang.GroovyShell;

import java.util.Collections;
import java.util.Comparator;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;

import org.apache.log4j.Logger;
import org.codehaus.groovy.control.CompilationFailedException;

public class DefaultCreature {

	/** the logger instance. */
<span class="fc" id="L40">	private static final Logger logger = Logger.getLogger(DefaultCreature.class);</span>

	/** Creature class. */
	private String clazz;

	/** Creature subclass. */
	private String subclass;

	/** Creature name. */
	private String name;

	/** optional creature description. * */
	private String description;

	/** Map Tile Id in the way tileset.png:pos. */
	private String tileid;

	/** hitpoints. */
	private int hp;

	/** Attack points. */
	private int atk;

	/** defense points. */
	private int def;

	/** experience points for killing this creature. */
	private int xp;

	private int level;

	private int respawn;

	/** size of the creature. */
	private int width;

	private int height;

	private String bloodClass;

	private String corpseName;
	private String harmlessCorpseName;
	private int corpseWidth;
	private int corpseHeight;

	/** The list of items this creature may drop. */
	private List&lt;DropItem&gt; dropsItems;

	private List&lt;EquipItem&gt; equipsItems;
	
	/** List of possible sound events. */
	private List&lt;String&gt; sounds;
	
	/** Sound played on creature death */
	private String deathSound;
	
	/** Looped sound effect for moving creature */
	private String movementSound;

	private LinkedHashMap&lt;String, LinkedList&lt;String&gt;&gt; creatureSays;
	
	private Map&lt;String, String&gt; aiProfiles;
	
	/** Susceptibilities of the creature */
	private Map&lt;Nature, Double&gt; susceptibilities;
	
	/** Status attack types */
	private String statusAttack;
	private double statusAttackProbability;
	
	/** Type of damage caused by the creature */
	private Nature damageType;
	/** Type of damage caused by the creature when using ranged attacks. if
	 * &lt;code&gt;null&lt;code&gt;, then the melee type is used for all attacks. */
	private Nature rangedDamageType;

	/** speed relative to player [0.0 ... 1.0] */
	private double speed;

	public DefaultCreature(final String clazz, final String subclass, final String name,
<span class="fc" id="L120">			final String tileid) {</span>
<span class="fc" id="L121">		this.clazz = clazz;</span>
<span class="fc" id="L122">		this.subclass = subclass;</span>
<span class="fc" id="L123">		this.name = name;</span>

<span class="fc" id="L125">		this.tileid = tileid;</span>
<span class="fc" id="L126">		dropsItems = new LinkedList&lt;DropItem&gt;();</span>
<span class="fc" id="L127">		equipsItems = new LinkedList&lt;EquipItem&gt;();</span>
<span class="fc" id="L128">		creatureSays = new LinkedHashMap&lt;String, LinkedList&lt;String&gt;&gt;();</span>
		
<span class="fc" id="L130">		aiProfiles = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="fc" id="L131">	}</span>

	public void setDescription(final String text) {
<span class="fc" id="L134">		this.description = text;</span>
<span class="fc" id="L135">	}</span>

	public String getDescription() {
<span class="nc" id="L138">		return description;</span>
	}

	public void setRPStats(final int hp, final int atk, final int def, final double speed) {
<span class="fc" id="L142">		this.hp = hp;</span>
<span class="fc" id="L143">		this.atk = atk;</span>
<span class="fc" id="L144">		this.def = def;</span>
<span class="fc" id="L145">		this.speed = speed;</span>
<span class="fc" id="L146">	}</span>

	public int getHP() {
<span class="nc" id="L149">		return hp;</span>
	}

	public int getAtk() {
<span class="nc" id="L153">		return atk;</span>
	}

	public int getDef() {
<span class="nc" id="L157">		return def;</span>
	}

	public double getSpeed() {
<span class="nc" id="L161">		return speed;</span>
	}

	public void setLevel(final int level, final int xp) {
<span class="fc" id="L165">		this.level = level;</span>
<span class="fc" id="L166">		this.xp = xp;</span>
<span class="fc" id="L167">	}</span>

	public void setRespawnTime(final int respawn) {
<span class="fc" id="L170">		this.respawn = respawn;</span>
<span class="fc" id="L171">	}</span>

	public int getRespawnTime() {
<span class="fc" id="L174">		return respawn;</span>
	}

	public int getLevel() {
<span class="fc" id="L178">		return level;</span>
	}

	public int getXP() {
<span class="nc" id="L182">		return xp;</span>
	}

	public void setSize(final int width, final int height) {
<span class="fc" id="L186">		this.width = width;</span>
<span class="fc" id="L187">		this.height = height;</span>
<span class="fc" id="L188">	}</span>

	public double getWidth() {
<span class="nc" id="L191">		return width;</span>
	}

	public double getHeight() {
<span class="nc" id="L195">		return height;</span>
	}

	public void setNoiseLines(final LinkedHashMap&lt;String, LinkedList&lt;String&gt;&gt; creatureSays) {
<span class="fc" id="L199">		this.creatureSays = creatureSays;</span>
<span class="fc" id="L200">	}</span>
	
	public HashMap&lt;String, LinkedList&lt;String&gt;&gt; getNoiseLines() {
<span class="nc" id="L203">		return creatureSays;</span>
	}

	public void setEquipedItems(final List&lt;EquipItem&gt; equipsItems) {
<span class="fc" id="L207">		this.equipsItems = equipsItems;</span>
<span class="fc" id="L208">	}</span>

	public List&lt;EquipItem&gt; getEquipedItems() {
<span class="nc" id="L211">		return equipsItems;</span>
	}

	public void setBlood(final String name) {
<span class="fc" id="L215">		this.bloodClass = name;</span>
<span class="fc" id="L216">	}</span>
	
	public void setCorpse(final String name, final String harmless, final int width, final int height) {
<span class="fc" id="L219">		corpseName = name;</span>
<span class="fc" id="L220">		harmlessCorpseName = harmless;</span>
<span class="fc" id="L221">		corpseWidth = width;</span>
<span class="fc" id="L222">		corpseHeight = height;</span>
<span class="fc" id="L223">	}</span>

	public void setDropItems(final List&lt;DropItem&gt; dropsItems) {
<span class="fc" id="L226">		this.dropsItems = dropsItems;</span>
<span class="fc" id="L227">	}</span>

	public List&lt;DropItem&gt; getDropItems() {
<span class="fc" id="L230">		return dropsItems;</span>
	}

	public void setAIProfiles(final Map&lt;String, String&gt; aiProfiles) {
<span class="fc" id="L234">		this.aiProfiles = aiProfiles;</span>
<span class="fc" id="L235">	}</span>
	
	/**
	 * Set the susceptibility mapping.
	 * 
	 * @param susceptibilities creature susceptibilities
	 */
	public void setSusceptibilities(final Map&lt;Nature, Double&gt; susceptibilities) {
<span class="fc" id="L243">		this.susceptibilities = susceptibilities;</span>
<span class="fc" id="L244">	}</span>
	
	/**
	 * Set the damage types.
	 * 
	 * @param type
	 * @param rangedType if &lt;code&gt;null&lt;/code&gt;, then melee type is used for both
	 * 	attack modes
	 */
	public void setDamageTypes(Nature type, Nature rangedType) {
<span class="fc" id="L254">		damageType = type;</span>
<span class="fc" id="L255">		rangedDamageType = rangedType;</span>
<span class="fc" id="L256">	}</span>

	/** @return a creature-instance. 
	 */
	public Creature getCreature() {
<span class="fc" id="L261">		Collections.sort(dropsItems, new Comparator&lt;DropItem&gt;() {</span>
			@Override
			public int compare(final DropItem o1, final DropItem o2) {
<span class="fc bfc" id="L264" title="All 2 branches covered.">				if (o1.probability &lt; o2.probability) {</span>
<span class="fc" id="L265">					return -1;</span>
<span class="fc bfc" id="L266" title="All 2 branches covered.">				} else if (o1.probability &gt; o2.probability) {</span>
<span class="fc" id="L267">					return 1;</span>
				} else {
<span class="fc" id="L269">					return 0;</span>
				}
			}
		});

<span class="fc" id="L274">		final Creature creature = new Creature(clazz, subclass, name, hp, atk, def,</span>
				level, xp, width, height, speed, dropsItems, aiProfiles,
				creatureSays, respawn, description);
<span class="fc" id="L277">		creature.equip(equipsItems);</span>
		
<span class="fc" id="L279">		creature.setCorpse(corpseName, harmlessCorpseName, corpseWidth, corpseHeight);</span>
<span class="fc" id="L280">		creature.setBlood(bloodClass);</span>
<span class="fc" id="L281">		creature.setSusceptibilities(susceptibilities);</span>
<span class="fc" id="L282">		creature.setDamageTypes(damageType, rangedDamageType);</span>
<span class="fc" id="L283">		creature.setSounds(Collections.unmodifiableList(sounds));</span>
<span class="fc" id="L284">		creature.setDeathSound(deathSound);</span>
<span class="fc" id="L285">		creature.setMovementSound(movementSound);</span>
		
		// Status attack types
<span class="pc bpc" id="L288" title="1 of 2 branches missed.">		if (statusAttack != null) {</span>
<span class="nc" id="L289">			Binding groovyBinding = new Binding();</span>
<span class="nc" id="L290">			final GroovyShell interp = new GroovyShell(groovyBinding);</span>
			try {
<span class="nc" id="L292">				String code = &quot;import games.stendhal.server.entity.status.*;\r\n&quot; + statusAttack;</span>
<span class="nc" id="L293">				StatusAttacker attacker = new StatusAttacker((Status) interp.evaluate(code), statusAttackProbability);</span>
<span class="nc" id="L294">				creature.addStatusAttacker(attacker);</span>
<span class="nc" id="L295">			} catch (CompilationFailedException e) {</span>
<span class="nc" id="L296">				throw new IllegalArgumentException(e);</span>
<span class="nc" id="L297">			}</span>
		}
		
<span class="fc" id="L300">		return creature;</span>
	}

	/** @return the tileid. */
	public String getTileId() {
<span class="fc" id="L305">		return tileid;</span>
	}

	public void setTileId(final String val) {
<span class="nc" id="L309">		tileid = val;</span>
<span class="nc" id="L310">	}</span>

	/** @return the class. */
	public String getCreatureClass() {
<span class="nc" id="L314">		return clazz;</span>
	}

	public String getCreatureSubclass() {
<span class="nc" id="L318">		return subclass;</span>
	}

	public String getCreatureName() {
<span class="fc" id="L322">		return name;</span>
	}

	public void setCreatureClass(final String val) {
<span class="nc" id="L326">		clazz = val;</span>
<span class="nc" id="L327">	}</span>

	public void setCreatureSubclass(final String val) {
<span class="nc" id="L330">		subclass = val;</span>
<span class="nc" id="L331">	}</span>

	public void setCreatureName(final String val) {
<span class="nc" id="L334">		name = val;</span>
<span class="nc" id="L335">	}</span>
	
	/**
	 * Set the possible sound names.
	 * 
	 * @param sounds list of sounds
	 */
	public void setCreatureSounds(List&lt;String&gt; sounds) {
<span class="fc" id="L343">		this.sounds = sounds;</span>
<span class="fc" id="L344">	}</span>
	
	/**
	 * Set the sound played when a creature dies
	 * 
	 * @param sound Name of sound
	 */
	public void setCreatureDeathSound(String sound) {
<span class="fc" id="L352">	    this.deathSound = sound;</span>
<span class="fc" id="L353">	}</span>
	
	/**
	 * Set a looped sound effect for creature when moving
	 * 
	 * @param sound
	 * 				desired sound effect
	 */
	public void setCreatureMovementSound(String sound) {
<span class="fc" id="L362">		this.movementSound = sound;</span>
<span class="fc" id="L363">	}</span>
	
	/**
	 * 
	 * @param name
	 * @param probability
	 */
	public void setStatusAttack(final String name, final double probability) {
<span class="nc" id="L371">	    statusAttack = name;</span>
<span class="nc" id="L372">	    statusAttackProbability = probability;</span>
<span class="nc" id="L373">	}</span>
	
	public boolean verifyItems(final EntityManager defaultEntityManager) {
<span class="fc bfc" id="L376" title="All 2 branches covered.">		for (final DropItem item : dropsItems) {</span>
<span class="pc bpc" id="L377" title="1 of 2 branches missed.">			if (!defaultEntityManager.isItem(item.name)) {</span>
<span class="nc" id="L378">				logger.warn(&quot;Item &quot; + item.name + &quot; doesnt exists&quot;);</span>
<span class="nc" id="L379">				return false;</span>
			}
<span class="fc" id="L381">		}</span>

<span class="fc bfc" id="L383" title="All 2 branches covered.">		for (final EquipItem item : equipsItems) {</span>
<span class="pc bpc" id="L384" title="1 of 2 branches missed.">			if (!defaultEntityManager.isItem(item.name)) {</span>
<span class="nc" id="L385">				logger.warn(&quot;Item &quot; + item.name + &quot; doesnt exists&quot;);</span>
<span class="nc" id="L386">				return false;</span>
			}
<span class="fc" id="L388">		}</span>

<span class="fc" id="L390">		return true;</span>
	}

	public String toXML() {
<span class="nc" id="L394">		final StringBuilder os = new StringBuilder();</span>
<span class="nc" id="L395">		os.append(&quot;  &lt;creature name=\&quot;&quot; + name + &quot;\&quot;&gt;\n&quot;);</span>
<span class="nc" id="L396">		os.append(&quot;    &lt;type class=\&quot;&quot; + clazz + &quot;\&quot; subclass=\&quot;&quot; + subclass</span>
				+ &quot;\&quot; tileid=\&quot;&quot;
				+ tileid.replace(&quot;../../tileset/logic/creature/&quot;, &quot;&quot;)
				+ &quot;\&quot;/&gt;\n&quot;);
<span class="nc bnc" id="L400" title="All 2 branches missed.">		if (description != null) {</span>
<span class="nc" id="L401">			os.append(&quot;    &lt;description&gt;&quot; + description + &quot;&lt;/description&gt;\n&quot;);</span>
		}
<span class="nc" id="L403">		os.append(&quot;    &lt;attributes&gt;\n&quot;);</span>
<span class="nc" id="L404">		os.append(&quot;      &lt;atk value=\&quot;&quot; + atk + &quot;\&quot;/&gt;\n&quot;);</span>
<span class="nc" id="L405">		os.append(&quot;      &lt;def value=\&quot;&quot; + def + &quot;\&quot;/&gt;\n&quot;);</span>
<span class="nc" id="L406">		os.append(&quot;      &lt;hp value=\&quot;&quot; + hp + &quot;\&quot;/&gt;\n&quot;);</span>
<span class="nc" id="L407">		os.append(&quot;      &lt;speed value=\&quot;&quot; + speed + &quot;\&quot;/&gt;\n&quot;);</span>
<span class="nc" id="L408">		os.append(&quot;      &lt;size value=\&quot;&quot; + width + &quot;,&quot; + height + &quot;\&quot;/&gt;\n&quot;);</span>
<span class="nc" id="L409">		os.append(&quot;    &lt;/attributes&gt;\n&quot;);</span>
<span class="nc" id="L410">		os.append(&quot;    &lt;level value=\&quot;&quot; + level + &quot;\&quot;/&gt;\n&quot;);</span>
<span class="nc" id="L411">		os.append(&quot;    &lt;experience value=\&quot;&quot; + (xp / 20) + &quot;\&quot;/&gt;\n&quot;);</span>
<span class="nc" id="L412">		os.append(&quot;    &lt;respawn value=\&quot;&quot; + respawn + &quot;\&quot;/&gt;\n&quot;);</span>
<span class="nc" id="L413">		os.append(&quot;    &lt;drops&gt;\n&quot;);</span>
<span class="nc bnc" id="L414" title="All 2 branches missed.">		for (final DropItem item : dropsItems) {</span>
<span class="nc" id="L415">			os.append(&quot;      &lt;item value=\&quot;&quot; + item.name + &quot;\&quot; quantity=\&quot;[&quot;</span>
					+ item.min + &quot;,&quot; + item.max + &quot;]\&quot; probability=\&quot;&quot;
					+ item.probability + &quot;\&quot;/&gt;\n&quot;);
<span class="nc" id="L418">		}</span>
<span class="nc" id="L419">		os.append(&quot;    &lt;/drops&gt;\n&quot;);</span>
<span class="nc" id="L420">		os.append(&quot;    &lt;equips&gt;\n&quot;);</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">		for (final EquipItem item : equipsItems) {</span>
<span class="nc" id="L422">			os.append(&quot;      &lt;slot name=\&quot;&quot; + item.slot + &quot;\&quot; item=\&quot;&quot;</span>
					+ item.name + &quot;\&quot; quantity=\&quot;&quot; + item.quantity + &quot;\&quot;/&gt;\n&quot;);
<span class="nc" id="L424">		}</span>
<span class="nc" id="L425">		os.append(&quot;    &lt;/equips&gt;\n&quot;);</span>
<span class="nc" id="L426">		os.append(&quot;    &lt;ai&gt;\n&quot;);</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">		if (!creatureSays.isEmpty()) {</span>
<span class="nc" id="L428">			os.append(&quot;      &lt;says&gt;\n&quot;);</span>
			
<span class="nc bnc" id="L430" title="All 2 branches missed.">			while(creatureSays.entrySet().iterator().hasNext()) {</span>
<span class="nc" id="L431">				final Entry&lt;String, LinkedList&lt;String&gt;&gt; entry =</span>
					creatureSays.entrySet().iterator().next();
<span class="nc bnc" id="L433" title="All 2 branches missed.">				for (int i=0; i&lt;entry.getValue().size(); i++) {</span>
<span class="nc" id="L434">					os.append(&quot;        &lt;noise state=\&quot;&quot;+entry.getKey()+</span>
							&quot;\&quot; value=\&quot;&quot; + entry.getValue().get(i) + &quot;\&quot;/&gt;\n&quot;);					
				}
<span class="nc" id="L437">			}</span>

<span class="nc" id="L439">		os.append(&quot;      &lt;/says&gt;\n&quot;);</span>
		}
<span class="nc bnc" id="L441" title="All 2 branches missed.">		for (final Map.Entry&lt;String, String&gt; entry : aiProfiles.entrySet()) {</span>
<span class="nc" id="L442">			os.append(&quot;      &lt;profile name=\&quot;&quot; + entry.getKey() + &quot;\&quot;&quot;);</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">			if (entry.getValue() != null) {</span>
<span class="nc" id="L444">				os.append(&quot; params=\&quot;&quot; + entry.getValue() + &quot;\&quot;&quot;);</span>
			}
<span class="nc" id="L446">			os.append(&quot;/&gt;\n&quot;);</span>
<span class="nc" id="L447">		}</span>
<span class="nc" id="L448">		os.append(&quot;    &lt;/ai&gt;\n&quot;);</span>
<span class="nc" id="L449">		os.append(&quot;  &lt;/creature&gt;\n&quot;);</span>
<span class="nc" id="L450">		return os.toString();</span>
	}

	public Map&lt;String, String&gt; getAIProfiles() {
<span class="nc" id="L454">		return aiProfiles;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>