<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Group.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.core.rp.group</a> &gt; <span class="el_source">Group.java</span></div><h1>Group.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2011 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.core.rp.group;

import games.stendhal.common.NotificationType;
import games.stendhal.server.core.engine.GameEvent;
import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.core.engine.StendhalRPRuleProcessor;
import games.stendhal.server.entity.player.Player;
import games.stendhal.server.events.GroupChangeEvent;
import games.stendhal.server.events.GroupInviteEvent;

import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedHashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Set;

import marauroa.common.game.RPEvent;

/**
 * A group of players
 *
 * @author hendrik
 */
<span class="nc" id="L39">public class Group {</span>
<span class="nc" id="L40">	private static long TIMEOUT = 5*60*1000;</span>
<span class="nc" id="L41">	private static int MAX_MEMBERS = 5;</span>

<span class="nc" id="L43">	private final HashMap&lt;String, Long&gt; membersAndLastSeen = new LinkedHashMap&lt;String, Long&gt;();</span>
<span class="nc" id="L44">	private final HashMap&lt;String, Long&gt; openInvites = new HashMap&lt;String, Long&gt;();</span>
<span class="nc" id="L45">	private String leader = null;</span>
<span class="nc" id="L46">	private String lootmode = &quot;shared&quot;;</span>

	/**
	 * adds a member to the group
	 *
	 * @param playerName name of player
	 */
	public void addMember(String playerName) {
<span class="nc" id="L54">		openInvites.remove(playerName);</span>
<span class="nc" id="L55">		membersAndLastSeen.put(playerName, Long.valueOf(System.currentTimeMillis()));</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">		if (leader == null) {</span>
<span class="nc" id="L57">			leader = playerName;</span>
		}
<span class="nc" id="L59">		sendGroupChangeEvent();</span>
<span class="nc" id="L60">	}</span>

	/**
	 * removes a member from the group
	 *
	 * @param playerName name of player
	 * @return true if the player was a member of this group
	 */
	public boolean removeMember(String playerName) {
<span class="nc bnc" id="L69" title="All 2 branches missed.">		boolean res = membersAndLastSeen.remove(playerName) != null;</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">		if (res) {</span>
<span class="nc" id="L71">			Set&lt;String&gt; toRemove = new HashSet&lt;String&gt;();</span>
<span class="nc" id="L72">			toRemove.add(playerName);</span>

			// destroy the group if there is only one person and no open invites left
<span class="nc bnc" id="L75" title="All 4 branches missed.">			if ((membersAndLastSeen.size() == 1) &amp;&amp; openInvites.isEmpty()) {</span>
<span class="nc" id="L76">				toRemove.add(membersAndLastSeen.keySet().iterator().next());</span>
<span class="nc" id="L77">				membersAndLastSeen.clear();</span>
			}
<span class="nc" id="L79">			fixLeader();</span>

<span class="nc" id="L81">			sendLeftGroupEvent(toRemove);</span>
<span class="nc" id="L82">			sendGroupChangeEvent();</span>
		}
<span class="nc" id="L84">		return res;</span>
	}


	/**
	 * removes players that are offline longer than the timeout,
	 * destroys the group if there is only one player left
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	public void clean() {
<span class="nc" id="L94">		Set&lt;String&gt; toRemove = new HashSet&lt;String&gt;();</span>
<span class="nc" id="L95">		StendhalRPRuleProcessor ruleProcessor = SingletonRepository.getRuleProcessor();</span>
<span class="nc" id="L96">		Long currentTime = Long.valueOf(System.currentTimeMillis());</span>
<span class="nc" id="L97">		Long timeoutTime = Long.valueOf(System.currentTimeMillis() - TIMEOUT);</span>

		// remove offline members and set keep alive timestamp
<span class="nc bnc" id="L100" title="All 2 branches missed.">		for (Map.Entry&lt;String, Long&gt; entry : ((Map&lt;String, Long&gt;)membersAndLastSeen.clone()).entrySet()) {</span>
<span class="nc" id="L101">			String playerName = entry.getKey();</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">			if (ruleProcessor.getPlayer(playerName) != null) {</span>
<span class="nc" id="L103">				membersAndLastSeen.put(playerName, currentTime);</span>
			} else {
<span class="nc bnc" id="L105" title="All 2 branches missed.">				if (entry.getValue().compareTo(timeoutTime) &lt; 0) {</span>
<span class="nc" id="L106">					toRemove.add(playerName);</span>
<span class="nc" id="L107">					new GameEvent(playerName, &quot;group&quot;, playerName, &quot;timeout&quot;).raise();</span>
				}
			}
<span class="nc" id="L110">		}</span>
<span class="nc" id="L111">		membersAndLastSeen.keySet().removeAll(toRemove);</span>

		// expire open invites
<span class="nc" id="L114">		Iterator&lt;Map.Entry&lt;String, Long&gt;&gt; itr = openInvites.entrySet().iterator();</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">		while (itr.hasNext()) {</span>
<span class="nc" id="L116">			Map.Entry&lt;String, Long&gt; entry = itr.next();</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">			if (entry.getValue().compareTo(timeoutTime) &lt; 0) {</span>
				// TODO: &quot;leader&quot; needs to be the leader at invite time
				// TODO: alternatively: cancel the old invite and create a new one on leader change
				//       but the new leader may not agree with the invite, so it may not be a good idea
				//       to fake it his name.
<span class="nc" id="L122">				Player invitedPlayer = ruleProcessor.getPlayer(entry.getKey());</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">				if (invitedPlayer != null) {</span>
<span class="nc" id="L124">					invitedPlayer.addEvent(new GroupInviteEvent(leader, true));</span>
<span class="nc" id="L125">					invitedPlayer.notifyWorldAboutChanges();</span>
				}

<span class="nc" id="L128">				itr.remove();</span>
			}
<span class="nc" id="L130">		}</span>

<span class="nc" id="L132">		fixLeader();</span>

		// destroy the group if there is only one person and no open invites left
<span class="nc bnc" id="L135" title="All 4 branches missed.">		if ((membersAndLastSeen.size() == 1) &amp;&amp; openInvites.isEmpty()) {</span>
<span class="nc" id="L136">			toRemove.add(membersAndLastSeen.keySet().iterator().next());</span>
<span class="nc" id="L137">			membersAndLastSeen.clear();</span>
		}

		// tell the clients about the changes
<span class="nc bnc" id="L141" title="All 2 branches missed.">		if (!toRemove.isEmpty()) {</span>
<span class="nc" id="L142">			sendGroupChangeEvent();</span>
<span class="nc" id="L143">			sendLeftGroupEvent(toRemove);</span>
		}
<span class="nc" id="L145">	}</span>

	/**
	 * destroys the groups
	 */
	public void destory() {
<span class="nc" id="L151">		sendLeftGroupEvent(membersAndLastSeen.keySet());</span>
<span class="nc" id="L152">		membersAndLastSeen.clear();</span>
<span class="nc" id="L153">	}</span>

	/**
	 * checks if this group does not have any members
	 *
	 * @return true, if it is empty; false if there are members in it
	 */
	public boolean isEmpty() {
<span class="nc" id="L161">		return membersAndLastSeen.isEmpty();</span>
	}

	/**
	 * checks if the group is full.
	 *
	 * @return true if the group is full; false otherwise
	 */
	public boolean isFull() {
<span class="nc bnc" id="L170" title="All 2 branches missed.">		return membersAndLastSeen.size() &gt;= MAX_MEMBERS;</span>
	}

	/**
	 * check if the player was invited
	 * @param playerName player to check if it was invited
	 * @return true, if the player was invited; false otherwise
	 */
	public boolean hasBeenInvited(String playerName) {
<span class="nc bnc" id="L179" title="All 2 branches missed.">		return openInvites.get(playerName) != null;</span>
	}

	/**
	 * is the specified player the leader of this group?
	 *
	 * @param playerName name of player
	 * @return true if its the leader; false otherwise
	 */
	public boolean hasLeader(String playerName) {
<span class="nc bnc" id="L189" title="All 4 branches missed.">		return (leader != null) &amp;&amp; leader.equals(playerName);</span>
	}

	/**
	 * is the player a member of this group?
	 *
	 * @param playerName name of player
	 * @return true if the player is a member of this group
	 */
	public boolean hasMember(String playerName) {
<span class="nc bnc" id="L199" title="All 2 branches missed.">		return membersAndLastSeen.get(playerName) != null;</span>
	}

	/**
	 * is the specified player the leader of this group?
	 *
	 * @param playerName name of player
	 * @return true if its the leader; false otherwise
	 */
	public boolean setLeader(String playerName) {
<span class="nc bnc" id="L209" title="All 2 branches missed.">		if (!membersAndLastSeen.containsKey(playerName)) {</span>
<span class="nc" id="L210">			return false;</span>
		}
<span class="nc" id="L212">		leader = playerName;</span>
<span class="nc" id="L213">		sendGroupChangeEvent();</span>
<span class="nc" id="L214">		return true;</span>
	}

	/**
	 * gets the loot mode
	 *
	 * @return loot mode
	 */
	public String getLootmode() {
<span class="nc" id="L223">		return lootmode;</span>
	}

	/**
	 * sets the loot mode
	 *
	 * @param mode &quot;single&quot; or &quot;shared&quot;
	 */
	public void setLootmode(String mode) {
<span class="nc" id="L232">		this.lootmode = mode;</span>
<span class="nc" id="L233">		sendGroupChangeEvent();</span>
<span class="nc" id="L234">	}</span>

	/**
	 * invites a player to join this group.
	 *
	 * @param player  player sending the invited
	 * @param targetPlayer invited player
	 */
	public void invite(Player player, Player targetPlayer) {
<span class="nc" id="L243">		openInvites.put(targetPlayer.getName(), Long.valueOf(System.currentTimeMillis()));</span>
<span class="nc" id="L244">		targetPlayer.addEvent(new GroupInviteEvent(player.getName(), false));</span>
<span class="nc" id="L245">		targetPlayer.notifyWorldAboutChanges();</span>
<span class="nc" id="L246">	}</span>

	/**
	 * defines a new leader, if the leader is not part of the group anymore.
	 */
	private void fixLeader() {
<span class="nc bnc" id="L252" title="All 2 branches missed.">		if (membersAndLastSeen.isEmpty()) {</span>
<span class="nc" id="L253">			return;</span>
		}
<span class="nc bnc" id="L255" title="All 4 branches missed.">		if ((leader == null) || !membersAndLastSeen.containsKey(leader)) {</span>
<span class="nc" id="L256">			leader = membersAndLastSeen.keySet().iterator().next();</span>
<span class="nc" id="L257">			new GameEvent(leader, &quot;group&quot;, leader, &quot;leader fixed&quot;).raise();</span>
		}
<span class="nc" id="L259">	}</span>


	/**
	 * sends a group chat message to all members
	 *
	 * @param name   name of sender
	 * @param text message to send
	 */
	public void sendGroupMessage(String name, String text) {
<span class="nc" id="L269">		StendhalRPRuleProcessor ruleProcessor = SingletonRepository.getRuleProcessor();</span>
<span class="nc bnc" id="L270" title="All 2 branches missed.">		for (String playerName : membersAndLastSeen.keySet()) {</span>
<span class="nc" id="L271">			Player player = ruleProcessor.getPlayer(playerName);</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">			if (player != null) {</span>
<span class="nc" id="L273">				player.sendPrivateText(NotificationType.GROUP, name + &quot;: &quot; + text);</span>
			}
<span class="nc" id="L275">		}</span>
<span class="nc" id="L276">	}</span>


	/**
	 * tell the clients about changes in the group
	 */
	private void sendGroupChangeEvent() {
<span class="nc" id="L283">		StendhalRPRuleProcessor ruleProcessor = SingletonRepository.getRuleProcessor();</span>
<span class="nc" id="L284">		List&lt;String&gt; members = new LinkedList&lt;String&gt;(membersAndLastSeen.keySet());</span>
<span class="nc" id="L285">		RPEvent event = new GroupChangeEvent(leader, members, lootmode);</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">		for (String playerName : membersAndLastSeen.keySet()) {</span>
<span class="nc" id="L287">			Player player = ruleProcessor.getPlayer(playerName);</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">			if (player != null) {</span>
<span class="nc" id="L289">				player.addEvent(event);</span>
<span class="nc" id="L290">				player.notifyWorldAboutChanges();</span>
			}
<span class="nc" id="L292">		}</span>
<span class="nc" id="L293">	}</span>

	/**
	 * tells the player the current status of the group
	 *
	 * @param player Player
	 */
	public void sendGroupChangeEvent(Player player) {
<span class="nc" id="L301">		List&lt;String&gt; members = new LinkedList&lt;String&gt;(membersAndLastSeen.keySet());</span>
<span class="nc" id="L302">		RPEvent event = new GroupChangeEvent(leader, members, lootmode);</span>
<span class="nc" id="L303">		player.addEvent(event);</span>
<span class="nc" id="L304">		player.notifyWorldAboutChanges();</span>
<span class="nc" id="L305">	}</span>

	/**
	 * tell players about them being removed from the group
	 *
	 * @param toRemove players to remove.
	 */
	private void sendLeftGroupEvent(Set&lt;String&gt; toRemove) {
<span class="nc" id="L313">		StendhalRPRuleProcessor ruleProcessor = SingletonRepository.getRuleProcessor();</span>
<span class="nc" id="L314">		RPEvent event = new GroupChangeEvent();</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">		for (String playerName : toRemove) {</span>
<span class="nc" id="L316">			Player player = ruleProcessor.getPlayer(playerName);</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">			if (player != null) {</span>
<span class="nc" id="L318">				player.addEvent(event);</span>
<span class="nc" id="L319">				player.notifyWorldAboutChanges();</span>
			}
<span class="nc" id="L321">		}</span>
<span class="nc" id="L322">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>