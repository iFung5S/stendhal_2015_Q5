<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>BuyHouseChatAction.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.quests.houses</a> &gt; <span class="el_source">BuyHouseChatAction.java</span></div><h1>BuyHouseChatAction.java</h1><pre class="source lang-java linenums">
package games.stendhal.server.maps.quests.houses;

import marauroa.common.game.SlotIsFullException;

import org.apache.log4j.Logger;

import games.stendhal.common.parser.Sentence;
import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.entity.item.HouseKey;
import games.stendhal.server.entity.item.Item;
import games.stendhal.server.entity.item.StackableItem;
import games.stendhal.server.entity.mapstuff.chest.StoredChest;
import games.stendhal.server.entity.mapstuff.portal.HousePortal;
import games.stendhal.server.entity.npc.ChatAction;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.EventRaiser;
import games.stendhal.server.entity.player.Player;

final class BuyHouseChatAction extends HouseChatAction implements ChatAction {


	private int cost;

	/**
	 * Creates a new BuyHouseChatAction.
	 * 
	 * @param cost how much does the house cost
	 * @param questSlot name of quest slot
	 */
	BuyHouseChatAction(final int cost, final String questSlot) {
<span class="fc" id="L32">		super(questSlot);</span>
<span class="fc" id="L33">		this.cost = cost;</span>
<span class="fc" id="L34">	}</span>

	@Override
	public void fire(final Player player, final Sentence sentence, final EventRaiser raiser) {

<span class="fc" id="L39">		final int number = sentence.getNumeral().getAmount();</span>
		// now check if the house they said is free
<span class="fc" id="L41">		final String itemName = Integer.toString(number);</span>

<span class="fc" id="L43">		final HousePortal houseportal = HouseUtilities.getHousePortal(number);</span>

<span class="fc bfc" id="L45" title="All 2 branches covered.">		if (houseportal == null) {</span>
			// something bad happened
<span class="fc" id="L47">			raiser.say(&quot;Sorry I did not understand you, could you try saying the house number you want again please?&quot;);</span>
<span class="fc" id="L48">			raiser.setCurrentState(ConversationStates.QUEST_OFFERED);</span>
<span class="fc" id="L49">			return;</span>
		}

<span class="fc" id="L52">		final String owner = houseportal.getOwner();</span>
<span class="fc bfc" id="L53" title="All 2 branches covered.">		if (owner.length() == 0) {</span>
			
			// it's available, so take money
<span class="fc bfc" id="L56" title="All 2 branches covered.">			if (player.isEquipped(&quot;money&quot;, cost)) {</span>
<span class="fc" id="L57">				final Item key = SingletonRepository.getEntityManager().getItem(</span>
																				&quot;house key&quot;);

<span class="fc" id="L60">				final String doorId = houseportal.getDoorId();</span>

<span class="fc" id="L62">				final int locknumber = houseportal.getLockNumber();</span>
<span class="fc" id="L63">				((HouseKey) key).setup(doorId, locknumber, player.getName());</span>
			
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">				if (player.equipToInventoryOnly(key)) {</span>
<span class="fc" id="L66">					raiser.say(&quot;Congratulations, here is your key to &quot; + doorId</span>
							   + &quot;! Make sure you change the locks if you ever lose it. Do you want to buy a spare key, at a price of &quot;
							   + HouseChatAction.COST_OF_SPARE_KEY + &quot; money?&quot;);
					
<span class="fc" id="L70">					player.drop(&quot;money&quot;, cost);</span>
					// remember what house they own
<span class="fc" id="L72">					player.setQuest(questslot, itemName);</span>

					// put nice things and a helpful note in the chest
<span class="fc" id="L75">					BuyHouseChatAction.fillChest(HouseUtilities.findChest(houseportal), houseportal.getDoorId());</span>

					// set the time so that the taxman can start harassing the player
<span class="fc" id="L78">					final long time = System.currentTimeMillis();</span>
<span class="fc" id="L79">					houseportal.setExpireTime(time);</span>

<span class="fc" id="L81">					houseportal.setOwner(player.getName());</span>
<span class="fc" id="L82">					raiser.setCurrentState(ConversationStates.QUESTION_1);</span>
<span class="fc" id="L83">				} else {</span>
<span class="nc" id="L84">					raiser.say(&quot;Sorry, you can't carry more keys!&quot;);</span>
				}
			
<span class="fc" id="L87">			} else {</span>
<span class="fc" id="L88">				raiser.say(&quot;You do not have enough money to buy a house!&quot;);</span>
			}
		
		} else {
<span class="fc" id="L92">			raiser.say(&quot;Sorry, house &quot; + itemName</span>
					   + &quot; is sold, please ask for a list of #unsold houses, or give me the number of another house.&quot;);
<span class="fc" id="L94">			raiser.setCurrentState(ConversationStates.QUEST_OFFERED);</span>
		}
<span class="fc" id="L96">	}</span>

	private static void fillChest(final StoredChest chest, String id) {
<span class="fc" id="L99">		Item item = SingletonRepository.getEntityManager().getItem(&quot;note&quot;);</span>
<span class="fc" id="L100">		item.setDescription(&quot;WELCOME TO THE HOUSE OWNER\n&quot;</span>
				+ &quot;1. If you do not pay your house taxes, the house and all the items in the chest will be confiscated.\n&quot;
				+ &quot;2. All people who can get in the house can use the chest.\n&quot;
				+ &quot;3. Remember to change your locks as soon as the security of your house is compromised.\n&quot;
				+ &quot;4. You can resell your house to the state if wished (please don't leave me)\n&quot;);
		try {
<span class="fc" id="L106">			chest.add(item);</span>

<span class="fc" id="L108">			item = SingletonRepository.getEntityManager().getItem(&quot;wine&quot;);</span>
<span class="fc" id="L109">			((StackableItem) item).setQuantity(2);</span>
<span class="fc" id="L110">			chest.add(item);</span>

<span class="fc" id="L112">			item = SingletonRepository.getEntityManager().getItem(&quot;chocolate bar&quot;);</span>
<span class="fc" id="L113">			((StackableItem) item).setQuantity(2);</span>
<span class="fc" id="L114">			chest.add(item);</span>
<span class="nc" id="L115">		} catch (SlotIsFullException e) {</span>
<span class="nc" id="L116">			Logger.getLogger(BuyHouseChatAction.class).info(&quot;Could not add &quot; + item.getName() + &quot; to chest in &quot; + id, e);</span>
<span class="fc" id="L117">		}</span>
<span class="fc" id="L118">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>