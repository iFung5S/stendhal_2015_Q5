<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>HouseSellerNPCBase.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.quests.houses</a> &gt; <span class="el_source">HouseSellerNPCBase.java</span></div><h1>HouseSellerNPCBase.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.maps.quests.houses;

import games.stendhal.common.parser.Sentence;
import games.stendhal.server.entity.Entity;
import games.stendhal.server.entity.npc.ChatCondition;
import games.stendhal.server.entity.npc.ConversationPhrases;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.SpeakerNPC;
import games.stendhal.server.entity.npc.condition.NotCondition;
import games.stendhal.server.entity.player.Player;

import java.util.Arrays;

/**
 * Base class for dialogue shared by all houseseller NPCs.
 * 
 */
abstract class HouseSellerNPCBase extends SpeakerNPC {

	static final String QUEST_SLOT = &quot;house&quot;;
	/**
	 * age required to buy a house. Note, age is in minutes, not seconds! So
	 * this is 300 hours.
	 */
	static final int REQUIRED_AGE = 300 * 60;
	/** percentage of initial cost refunded when you resell a house.*/
	private static final int DEPRECIATION_PERCENTAGE = 40;

	private final String location;
	
	private final HouseTax houseTax;
	/**	
	 *	Creates NPC dialog for house sellers.
	 * @param name
	 *            the name of the NPC
	 * @param location
	 *            where are the houses?
	 * @param houseTax 
	 * 		      class which controls house tax, and confiscation of houses
	*/
	HouseSellerNPCBase(final String name, final String location, final HouseTax houseTax) {
<span class="fc" id="L54">		super(name);			</span>
<span class="fc" id="L55">		this.location = location;</span>
<span class="fc" id="L56">		this.houseTax =  houseTax;</span>
<span class="fc" id="L57">		createDialogNowWeKnowLocation();</span>
<span class="fc" id="L58">	}</span>
	
	@Override
	protected abstract void createPath();
	
	private void createDialogNowWeKnowLocation() {
<span class="fc" id="L64">		addGreeting(null, new HouseSellerGreetingAction(QUEST_SLOT));</span>
		
			// quest slot 'house' is started so player owns a house
<span class="fc" id="L67">		add(ConversationStates.ATTENDING, </span>
			Arrays.asList(&quot;cost&quot;, &quot;house&quot;, &quot;buy&quot;, &quot;purchase&quot;),
			new PlayerOwnsHouseCondition(),
			ConversationStates.ATTENDING, 
			&quot;As you already know, the cost of a new house is &quot;
				+ getCost()
			+ &quot; money. But you cannot own more than one house, the market is too demanding for that! You cannot own another house until you #resell the one you already own.&quot;,
			null);
		
		// we need to warn people who buy spare keys about the house
		// being accessible to other players with a key
<span class="fc" id="L78">		add(ConversationStates.QUESTION_1,</span>
			ConversationPhrases.YES_MESSAGES,
			null,
			ConversationStates.QUESTION_2,
			&quot;Before we go on, I must warn you that anyone with a key to your house can enter it, and access the items in the chest in your house. Do you still wish to buy a spare key?&quot;,
			null);

		// player wants spare keys and is OK with house being accessible
		// to other person.
<span class="fc" id="L87">		add(ConversationStates.QUESTION_2,</span>
			ConversationPhrases.YES_MESSAGES, 
			null,
			ConversationStates.ATTENDING, 
			null,
			new BuySpareKeyChatAction(QUEST_SLOT));
			
		// refused offer to buy spare key for security reasons
<span class="fc" id="L95">		add(ConversationStates.QUESTION_2,</span>
			ConversationPhrases.NO_MESSAGES,
			null,
				ConversationStates.ATTENDING,
			&quot;That is wise of you. It is certainly better to restrict use of your house to those you can really trust.&quot;,
			null);
		
		// refused offer to buy spare key 
<span class="fc" id="L103">		add(ConversationStates.QUESTION_1,</span>
				ConversationPhrases.NO_MESSAGES,
			null,
			ConversationStates.ATTENDING,
			&quot;No problem! Just so you know, if you need to #change your locks, I can do that, and you can also #resell your house to me if you want to.&quot;,
			null);

		// player is eligible to resell a house
<span class="fc" id="L111">		add(ConversationStates.ATTENDING, </span>
			Arrays.asList(&quot;resell&quot;, &quot;sell&quot;),
			new PlayerOwnsHouseCondition(),
				ConversationStates.QUESTION_3, 
			&quot;The state will pay you &quot;
			+ Integer.toString(DEPRECIATION_PERCENTAGE)
			+ &quot; percent of the price you paid for your house, minus any taxes you owe. You should remember to collect any belongings from your house before you sell it. Do you really want to sell your house to the state?&quot;,
			null);
		
		// player is not eligible to resell a house
<span class="fc" id="L121">		add(ConversationStates.ATTENDING, </span>
			Arrays.asList(&quot;resell&quot;, &quot;sell&quot;),
			new NotCondition(new PlayerOwnsHouseCondition()),
			ConversationStates.ATTENDING, 
			&quot;You don't own any house at the moment. If you want to buy one please ask about the #cost.&quot;,
			null);
		
<span class="fc" id="L128">		add(ConversationStates.QUESTION_3,</span>
			ConversationPhrases.YES_MESSAGES,
			null,
				ConversationStates.ATTENDING,
			null,
			new ResellHouseAction(getCost(), QUEST_SLOT, DEPRECIATION_PERCENTAGE, houseTax));
		
		// refused offer to resell a house
<span class="fc" id="L136">		add(ConversationStates.QUESTION_3,</span>
			ConversationPhrases.NO_MESSAGES,
			null,
			ConversationStates.ATTENDING,
			&quot;Well, I'm glad you changed your mind.&quot;,
			null);
		
		// player is eligible to change locks
<span class="fc" id="L144">		add(ConversationStates.ATTENDING, </span>
			&quot;change&quot;,
			new PlayerOwnsHouseCondition(),
			ConversationStates.SERVICE_OFFERED, 
			&quot;If you are at all worried about the security of your house or, don't trust anyone you gave a spare key to, &quot;
			+ &quot;it is wise to change your locks. Do you want me to change your house lock and give you a new key now?&quot;,
			null);

		// player is not eligible to change locks
<span class="fc" id="L153">		add(ConversationStates.ATTENDING, </span>
			&quot;change&quot;,
			new NotCondition(new PlayerOwnsHouseCondition()),
			ConversationStates.ATTENDING, 
			&quot;You don't own any house at the moment. If you want to buy one please ask about the #cost.&quot;,
			null);

		// accepted offer to change locks
<span class="fc" id="L161">		add(ConversationStates.SERVICE_OFFERED,</span>
			ConversationPhrases.YES_MESSAGES,
			null,
			ConversationStates.ATTENDING,
			null,
			new ChangeLockAction(QUEST_SLOT));

		// refused offer to change locks 
<span class="fc" id="L169">		add(ConversationStates.SERVICE_OFFERED,</span>
			ConversationPhrases.NO_MESSAGES,
			null,
			ConversationStates.ATTENDING,
			&quot;OK, if you're really sure. Please let me know if I can help with anything else.&quot;,
			null);

<span class="fc" id="L176">		add(ConversationStates.ANY,</span>
			Arrays.asList(&quot;available&quot;, &quot;unbought&quot;, &quot;unsold&quot;), 
			null, 
			ConversationStates.ATTENDING,
			null,
			new ListUnboughtHousesAction(location));

<span class="fc" id="L183">		addReply(</span>
				 &quot;buy&quot;,
				 &quot;You should really enquire the #cost before you ask to buy. And check our brochure, #http://stendhalgame.org/wiki/StendhalHouses.&quot;);
<span class="fc" id="L186">		addReply(&quot;really&quot;,</span>
				 &quot;That's right, really, really, really. Really.&quot;);
<span class="fc" id="L188">		addOffer(&quot;I sell houses, please look at #http://stendhalgame.org/wiki/StendhalHouses for examples of how they look inside. Then ask about the #cost when you are ready.&quot;);</span>
<span class="fc" id="L189">		addHelp(&quot;You may be eligible to buy a house if there are any #available. If you can pay the #cost, I'll give you a key. As a house owner you can buy spare keys to give your friends. See #http://stendhalgame.org/wiki/StendhalHouses for pictures inside the houses and more details.&quot;);</span>
<span class="fc" id="L190">		addQuest(&quot;You may buy houses from me, please ask the #cost if you are interested. Perhaps you would first like to view our brochure, #http://stendhalgame.org/wiki/StendhalHouses.&quot;);</span>
<span class="fc" id="L191">		addGoodbye(&quot;Goodbye.&quot;);</span>
<span class="fc" id="L192">	}</span>

	protected abstract int getCost();

	protected abstract int getLowestHouseNumber();
	protected abstract int getHighestHouseNumber();
}
<span class="fc" id="L199">final class PlayerOwnsHouseCondition implements ChatCondition {</span>
	@Override
	public boolean fire(final Player player, final Sentence sentence, final Entity npc) {
<span class="fc" id="L202">		return HouseUtilities.playerOwnsHouse(player);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>