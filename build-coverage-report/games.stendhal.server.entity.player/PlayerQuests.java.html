<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PlayerQuests.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.entity.player</a> &gt; <span class="el_source">PlayerQuests.java</span></div><h1>PlayerQuests.java</h1><pre class="source lang-java linenums">/***************************************************************************
 *                   (C) Copyright 2003-2015 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.entity.player;

import java.util.Calendar;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;

import org.apache.log4j.Logger;

import games.stendhal.common.MathHelper;
import games.stendhal.server.core.engine.GameEvent;
import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.util.StringUtils;
import marauroa.common.game.RPObject;
import marauroa.common.game.RPSlot;

/**
 * Accesses the player quest states.
 *
 * @author hendrik
 */
class PlayerQuests {
	private final Player player;
	
<span class="fc" id="L37">	private static Logger logger = Logger.getLogger(PlayerQuests.class);</span>

	
<span class="fc" id="L40">	public PlayerQuests(final Player player) {</span>
<span class="fc" id="L41">		this.player = player;</span>
<span class="fc" id="L42">	}</span>

	/**
	 * Checks whether the player has completed the given quest or not.
	 * 
	 * @param name
	 *            The quest's name
	 * @return true if the quest has been completed by the player
	 */
	public boolean isQuestCompleted(final String name) {
<span class="fc" id="L52">		final String info = getQuest(name, 0);</span>

<span class="fc bfc" id="L54" title="All 2 branches covered.">		if (info == null) {</span>
<span class="fc" id="L55">			return false;</span>
		}

<span class="fc" id="L58">		return info.equals(&quot;done&quot;);</span>
	}

	/**
	 * Checks whether the player has made any progress in the given quest or
	 * not. For many quests, this is true right after the quest has been
	 * started.
	 * 
	 * @param name
	 *            The quest's name
	 * @return true iff the player has made any progress in the quest
	 */
	public boolean hasQuest(final String name) {
<span class="fc bfc" id="L71" title="All 2 branches covered.">		return (player.getKeyedSlot(&quot;!quests&quot;, evaluateSlotName(name)) != null);</span>
	}

	/**
	 * Gets the player's current status in the given quest.
	 * 
	 * @param name
	 *            The quest's name
	 * @return the player's status in the quest
	 */
	public String getQuest(final String name) {
<span class="fc" id="L82">		return player.getKeyedSlot(&quot;!quests&quot;, evaluateSlotName(name));</span>
	}

	/**
	 * Allows to store the player's current status in a quest in a string. This
	 * string may, for instance, be &quot;started&quot;, &quot;done&quot;, a semicolon- separated
	 * list of items that need to be brought/NPCs that need to be met, or the
	 * number of items that still need to be brought. Note that the string
	 * &quot;done&quot; has a special meaning: see isQuestComplete().
	 * 
	 * @param name
	 *            The quest's name
	 * @param status
	 *            the player's status in the quest. Set it to null to completely
	 *            reset the player's status for the quest.
	 */
	public void setQuest(final String name, final String status) {
<span class="fc" id="L99">		final String oldStatus = player.getKeyedSlot(&quot;!quests&quot;, evaluateSlotName(name));</span>
<span class="fc" id="L100">		player.setKeyedSlot(&quot;!quests&quot;, evaluateSlotName(name), status);</span>
<span class="fc bfc" id="L101" title="All 4 branches covered.">		if ((status == null) || !status.equals(oldStatus)) {</span>
<span class="fc" id="L102">			new GameEvent(player.getName(), &quot;quest&quot;, evaluateSlotName(name), status).raise();</span>
		}
		// check for reached achievements
<span class="fc" id="L105">		SingletonRepository.getAchievementNotifier().onFinishQuest(player);</span>
<span class="fc" id="L106">	}</span>

	
	/**
	 * Gets the player's current status in the given quest.
	 * 
	 * @param name
	 *            The quest's name
	 * @param index
	 *            the index of the sub state to get (separated by &quot;;&quot;)
	 * @return the player's status in the quest
	 */
	public String getQuest(final String name, final int index) {
<span class="fc" id="L119">		String state = getQuest(name);</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">		if (state == null) {</span>
<span class="fc" id="L121">			return null;</span>
		}
		
<span class="fc bfc" id="L124" title="All 2 branches covered.">		if(index == -1) {</span>
<span class="fc" id="L125">			return state;</span>
		}
		
<span class="fc" id="L128">		String[] elements = state.split(&quot;;&quot;);</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">		if (index &lt; elements.length) {</span>
<span class="fc" id="L130">			return elements[index];</span>
		}
<span class="fc" id="L132">		return &quot;&quot;;</span>
	}

	/**
	 * Allows to store the player's current status in a quest in a string. This
	 * string may, for instance, be &quot;started&quot;, &quot;done&quot;, a semicolon- separated
	 * list of items that need to be brought/NPCs that need to be met, or the
	 * number of items that still need to be brought. Note that the string
	 * &quot;done&quot; has a special meaning: see isQuestComplete().
	 * 
	 * @param name
	 *            The quest's name
	 * @param index
	 *            the index of the sub state to change (separated by &quot;;&quot;)
	 * @param subStatus
	 *            the player's status in the quest. Set it to null to completely
	 *            reset the player's status for the quest.
	 */
	public void setQuest(final String name, final int index, final String subStatus) {
<span class="fc" id="L151">		String state = getQuest(name);</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">		if (state == null) {</span>
<span class="fc" id="L153">			state = &quot;&quot;;</span>
		}
<span class="fc" id="L155">		String[] elements = state.split(&quot;;&quot;);</span>
<span class="fc bfc" id="L156" title="All 2 branches covered.">		if (elements.length &lt;= index) {</span>
<span class="fc" id="L157">			String[] temp = new String[index + 1];</span>
<span class="fc" id="L158">			System.arraycopy(elements, 0, temp, 0, elements.length);</span>
<span class="fc" id="L159">			elements = temp;</span>
		}
		
<span class="fc" id="L162">		elements[index] = subStatus;</span>
<span class="fc" id="L163">		StringBuilder res = new StringBuilder();</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">		for (int i = 0; i &lt; elements.length; i++) {</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">			if (i &gt; 0) {</span>
<span class="fc" id="L166">				res.append(&quot;;&quot;);</span>
			}
<span class="fc bfc" id="L168" title="All 2 branches covered.">			if (elements[i] != null) {</span>
<span class="fc" id="L169">				res.append(elements[i]);</span>
			}
		}
<span class="fc" id="L172">		setQuest(name, res.toString());</span>
<span class="fc" id="L173">	}</span>
	
	public List&lt;String&gt; getQuests() {
<span class="fc" id="L176">		final RPSlot slot = player.getSlot(&quot;!quests&quot;);</span>
<span class="fc" id="L177">		final RPObject quests = slot.iterator().next();</span>

<span class="fc" id="L179">		final List&lt;String&gt; questsList = new LinkedList&lt;String&gt;();</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">		for (final String quest : quests) {</span>
<span class="pc bpc" id="L181" title="1 of 4 branches missed.">			if (!quest.equals(&quot;id&quot;) &amp;&amp; !quest.equals(&quot;zoneid&quot;)) {</span>
<span class="fc" id="L182">				questsList.add(quest);</span>
			}
<span class="fc" id="L184">		}</span>
<span class="fc" id="L185">		return questsList;</span>
	}

	public void removeQuest(final String name) {
<span class="fc" id="L189">		player.setKeyedSlot(&quot;!quests&quot;, evaluateSlotName(name), null);</span>
<span class="fc" id="L190">	}</span>

	/**
	 * Is the named quest in one of the listed states?
	 * 
	 * @param name
	 *            quest
	 * @param states
	 *            valid states
	 * @return true, if the quest is in one of theses states, false otherwise
	 */
	public boolean isQuestInState(final String name, final String... states) {
<span class="fc" id="L202">		final String questState = getQuest(name);</span>

<span class="pc bpc" id="L204" title="1 of 2 branches missed.">		if (questState != null) {</span>
<span class="fc bfc" id="L205" title="All 2 branches covered.">			for (final String state : states) {</span>
<span class="fc bfc" id="L206" title="All 2 branches covered.">				if (questState.equals(state)) {</span>
<span class="fc" id="L207">					return true;</span>
				}
			}
		}

<span class="fc" id="L212">		return false;</span>
	}
	
	/**
	 * Is the named quest in one of the listed states?
	 * 
	 * @param name
	 *            quest
	 * @param index         
	 *            quest index
	 * @param states
	 *            valid states
	 * @return true, if the quest is in one of theses states, false otherwise
	 */
	public boolean isQuestInState(final String name, final int index, final String... states) {
<span class="fc" id="L227">		final String questState = getQuest(name, index);</span>

<span class="fc bfc" id="L229" title="All 2 branches covered.">		if (questState != null) {</span>
<span class="fc bfc" id="L230" title="All 2 branches covered.">			for (final String state : states) {</span>
<span class="fc bfc" id="L231" title="All 2 branches covered.">				if (questState.equals(state)) {</span>
<span class="fc" id="L232">					return true;</span>
				}
			}
		}

<span class="fc" id="L237">		return false;</span>
	}
	
	/**
	 * Gets the recorded item stored in a substate of quest slot 
	 * 
	 * @param name
	 *            The quest's name
	 * @param index
	 *            the index of the sub state to get (separated by &quot;;&quot;)
	 * @return the name of the required item (no formatting)
	 */
	public String getRequiredItemName(final String name, final int index) {
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">		if (!player.hasQuest(name)) {</span>
<span class="nc" id="L251">			logger.error(player.getName() + &quot; does not have quest &quot; + name);</span>
<span class="nc" id="L252">			return &quot;&quot;;</span>
		}
<span class="fc" id="L254">		String questSubString = getQuest(name, index);</span>
<span class="fc" id="L255">		final String[] elements = questSubString.split(&quot;=&quot;);</span>
<span class="fc" id="L256">		String questItem = elements[0];</span>
<span class="fc" id="L257">		return questItem;		</span>
	}
	
	/**
	 * Gets the recorded item quantity stored in a substate of quest slot 
	 * 
	 * @param name
	 *            The quest's name
	 * @param index
	 *            the index of the sub state to get (separated by &quot;;&quot;)
	 * @return required item quantity
	 */
	public int getRequiredItemQuantity(final String name, final int index) {
<span class="fc" id="L270">		int amount = 1;</span>
<span class="pc bpc" id="L271" title="1 of 2 branches missed.">		if (!player.hasQuest(name)) {</span>
<span class="nc" id="L272">			logger.error(player.getName() + &quot; does not have quest &quot; + name);</span>
<span class="nc" id="L273">			return amount;</span>
		}
<span class="fc" id="L275">		String questSubString = getQuest(name, index);</span>
<span class="fc" id="L276">		final String[] elements = questSubString.split(&quot;=&quot;);</span>
<span class="fc bfc" id="L277" title="All 2 branches covered.">		if(elements.length &gt; 1) {</span>
<span class="fc" id="L278">			amount=MathHelper.parseIntDefault(elements[1], 1);</span>
		}
<span class="fc" id="L280">		return amount;</span>
		
	}
	
	/**
	 * Gets the number of repetitions in a substate of quest slot 
	 * 
	 * @param name
	 *            The quest's name
	 * @param index
	 *            the index of the sub state to get (separated by &quot;;&quot;)
	 * @return the integer value in the index of the quest slot, used to represent a number of repetitions
	 */
	public int getNumberOfRepetitions(final String name, final int index) {
<span class="pc bpc" id="L294" title="1 of 2 branches missed.">		if (!player.hasQuest(name)) {</span>
<span class="nc" id="L295">			logger.error(player.getName() + &quot; does not have quest &quot; + name);</span>
<span class="nc" id="L296">			return 0;</span>
		}
<span class="fc" id="L298">		String questState = player.getQuest(name, index);</span>
<span class="fc" id="L299">		return MathHelper.parseIntDefault(questState, 0);</span>
	}

	/**
	 * evaluates slot names by replacing variables
	 *
	 * @param name name of slot
	 * @return evaluated slot
	 */
	String evaluateSlotName(String name) {
<span class="fc" id="L309">		Map&lt;String, String&gt; params = new HashMap&lt;String, String&gt;();</span>
<span class="fc" id="L310">		Calendar calendar = Calendar.getInstance();</span>
<span class="fc" id="L311">		int year = calendar.get(Calendar.YEAR);</span>
<span class="fc" id="L312">		params.put(&quot;year&quot;, Integer.toString(year).substring(2));</span>
<span class="fc" id="L313">		calendar.add(Calendar.MONTH, -2);</span>
<span class="fc" id="L314">		year = calendar.get(Calendar.YEAR);</span>
<span class="fc" id="L315">		params.put(&quot;seasonyear&quot;, Integer.toString(year).substring(2));</span>
<span class="fc" id="L316">		return StringUtils.substitute(name, params);</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>