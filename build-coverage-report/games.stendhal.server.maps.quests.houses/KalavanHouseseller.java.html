<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>KalavanHouseseller.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.quests.houses</a> &gt; <span class="el_source">KalavanHouseseller.java</span></div><h1>KalavanHouseseller.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.maps.quests.houses;

import games.stendhal.common.parser.ExpressionType;
import games.stendhal.common.parser.JokerExprMatcher;
import games.stendhal.server.core.pathfinder.FixedPath;
import games.stendhal.server.core.pathfinder.Node;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.condition.AgeGreaterThanCondition;
import games.stendhal.server.entity.npc.condition.AndCondition;
import games.stendhal.server.entity.npc.condition.NotCondition;
import games.stendhal.server.entity.npc.condition.QuestCompletedCondition;
import games.stendhal.server.entity.npc.condition.QuestNotCompletedCondition;
import games.stendhal.server.entity.npc.condition.QuestNotStartedCondition;
import games.stendhal.server.entity.npc.condition.TextHasNumberCondition;

import java.util.Arrays;
import java.util.LinkedList;
import java.util.List;

final class KalavanHouseseller extends HouseSellerNPCBase {
	/** Cost to buy house in kalavan. */
	private static final int COST_KALAVAN = 100000;
	private static final String PRINCESS_QUEST_SLOT = &quot;imperial_princess&quot;;

	KalavanHouseseller(final String name, final String location, final HouseTax houseTax) {
<span class="fc" id="L38">		super(name, location, houseTax);</span>
<span class="fc" id="L39">		init();</span>
<span class="fc" id="L40">	}</span>

	private void init() {
		// Other than the condition that you must not already own a house, there are a number of conditions a player must satisfy. 
		// For definiteness we will check these conditions in a set order. 
		// So then the NPC doesn't have to choose which reason to reject the player for (appears as a WARN from engine if he has to choose)

		// player has not done required quest, hasn't got a house at all
<span class="fc" id="L48">add(ConversationStates.ATTENDING, </span>
		Arrays.asList(&quot;cost&quot;, &quot;house&quot;, &quot;buy&quot;, &quot;purchase&quot;),
		new AndCondition(new QuestNotStartedCondition(HouseSellerNPCBase.QUEST_SLOT), new QuestNotCompletedCondition(KalavanHouseseller.PRINCESS_QUEST_SLOT)),
		ConversationStates.ATTENDING, 
			&quot;The cost of a new house is &quot;
		+ getCost()
		+ &quot; money. But I am afraid I cannot sell you a house until your citizenship has been approved by the King, who you will find &quot;
		+ &quot; north of here in Kalavan Castle. Try speaking to his daughter first, she is ... friendlier.&quot;,
			null);

// player is not old enough but they have doen princess quest 
// (don't need to check if they have a house, they can't as they're not old enough)
<span class="fc" id="L60">add(ConversationStates.ATTENDING, </span>
		Arrays.asList(&quot;cost&quot;, &quot;house&quot;, &quot;buy&quot;, &quot;purchase&quot;),
		new AndCondition(
							 new QuestCompletedCondition(KalavanHouseseller.PRINCESS_QUEST_SLOT),
							 new NotCondition(new AgeGreaterThanCondition(HouseSellerNPCBase.REQUIRED_AGE))),
		ConversationStates.ATTENDING, 
		&quot;The cost of a new house is &quot;
		+ getCost()
		+ &quot; money. But I am afraid I cannot trust you with house ownership just yet, come back when you have spent at least &quot; 
		+ Integer.toString((HouseSellerNPCBase.REQUIRED_AGE / 60)) + &quot; hours on Faiumoni.&quot;,
		null);

// player is eligible to buy a house
<span class="fc" id="L73">		add(ConversationStates.ATTENDING, </span>
		Arrays.asList(&quot;cost&quot;, &quot;house&quot;, &quot;buy&quot;, &quot;purchase&quot;),
		new AndCondition(new QuestNotStartedCondition(HouseSellerNPCBase.QUEST_SLOT), 
						 new AgeGreaterThanCondition(HouseSellerNPCBase.REQUIRED_AGE), 
							 new QuestCompletedCondition(KalavanHouseseller.PRINCESS_QUEST_SLOT)),
		ConversationStates.QUEST_OFFERED, 
		&quot;The cost of a new house is &quot;
		+ getCost()
		+ &quot; money. Also, you must pay a house tax of &quot; + HouseTax.BASE_TAX
		+ &quot; money, every month. You can ask me which houses are #available. Or, if you have a specific house in mind, please tell me the number now.&quot;,
		null);

// handle house numbers 1 to 25
<span class="fc" id="L86">addMatching(ConversationStates.QUEST_OFFERED,</span>
		// match for all numbers as trigger expression
		ExpressionType.NUMERAL, new JokerExprMatcher(),
		new TextHasNumberCondition(getLowestHouseNumber(), getHighestHouseNumber()),
		ConversationStates.ATTENDING,
		null,
		new BuyHouseChatAction(getCost(), QUEST_SLOT));

<span class="fc" id="L94">addJob(&quot;I'm an estate agent. In simple terms, I sell houses to those who have been granted #citizenship. They #cost a lot, of course. Our brochure is at #http://stendhalgame.org/wiki/StendhalHouses.&quot;);</span>
<span class="fc" id="L95">addReply(&quot;citizenship&quot;,</span>
			 &quot;The royalty in Kalavan Castle decide that.&quot;);


<span class="fc" id="L99">setDescription(&quot;You see a smart looking man.&quot;);</span>
<span class="fc" id="L100">setEntityClass(&quot;estateagentnpc&quot;);</span>
<span class="fc" id="L101">setPosition(55, 94);</span>
<span class="fc" id="L102">initHP(100);</span>
		
<span class="fc" id="L104">	}</span>

	@Override
	protected int getCost() {
<span class="fc" id="L108">		return KalavanHouseseller.COST_KALAVAN;</span>
	}

	@Override
	protected int getHighestHouseNumber() {
<span class="fc" id="L113">		return 25;</span>
	}

	@Override
	protected int getLowestHouseNumber() {
<span class="fc" id="L118">		return 1;</span>
	}

	@Override
	protected void createPath() {
<span class="fc" id="L123">		final List&lt;Node&gt; nodes = new LinkedList&lt;Node&gt;();</span>
<span class="fc" id="L124">		nodes.add(new Node(55, 94));</span>
<span class="fc" id="L125">		nodes.add(new Node(93, 94));</span>
<span class="fc" id="L126">		nodes.add(new Node(93, 73));</span>
<span class="fc" id="L127">		nodes.add(new Node(107, 73));</span>
<span class="fc" id="L128">		nodes.add(new Node(107, 35));</span>
<span class="fc" id="L129">		nodes.add(new Node(84, 35));</span>
<span class="fc" id="L130">		nodes.add(new Node(84, 20));</span>
<span class="fc" id="L131">		nodes.add(new Node(17, 20));</span>
<span class="fc" id="L132">		nodes.add(new Node(17, 82));</span>
<span class="fc" id="L133">		nodes.add(new Node(43, 82));</span>
<span class="fc" id="L134">		nodes.add(new Node(43, 94));</span>
<span class="fc" id="L135">		setPath(new FixedPath(nodes, true));</span>
<span class="fc" id="L136">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>