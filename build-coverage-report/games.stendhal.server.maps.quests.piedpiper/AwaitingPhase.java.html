<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AwaitingPhase.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.quests.piedpiper</a> &gt; <span class="el_source">AwaitingPhase.java</span></div><h1>AwaitingPhase.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.maps.quests.piedpiper;

import games.stendhal.server.core.engine.StendhalRPZone;
import games.stendhal.server.core.pathfinder.GoToPosition;
import games.stendhal.server.core.pathfinder.RPZonePath;
import games.stendhal.server.core.pathfinder.MultiZonesFixedPath;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.SpeakerNPC;
import games.stendhal.server.entity.npc.interaction.NPCChatting;
import games.stendhal.server.entity.npc.interaction.NPCFollowing;

import java.util.Arrays;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Observer;

/**
 * Implementation of Pied Piper's initial actions (coming, chatting, going to work place)
 * @author yoriy
 */
public class AwaitingPhase extends TPPQuest {
	
	private SpeakerNPC piedpiper;	
<span class="fc" id="L37">	private final SpeakerNPC mainNPC = TPPQuestHelperFunctions.getMainNPC();</span>
	private final int minPhaseChangeTime;
	private int maxPhaseChangeTime;
<span class="fc" id="L40">	private List&lt;RPZonePath&gt; fullpathin = </span>
		new LinkedList&lt;RPZonePath&gt;();
<span class="fc" id="L42">	private List&lt;RPZonePath&gt; fullpathout = </span>
			new LinkedList&lt;RPZonePath&gt;();
<span class="fc" id="L44">	private final List&lt;String&gt; conversations = new LinkedList&lt;String&gt;();</span>
<span class="fc" id="L45">	private final String explainations = </span>
			&quot;I see that our city's savoiur is here. I have to speak with him quickly. &quot;+
			&quot;Please speak with me again after we finish talking.&quot;;
	
	
	/**
	 * adds quest's related conversations to mayor
	 */
	private void addConversations() {
<span class="fc" id="L54">		TPP_Phase myphase = AWAITING;</span>
		
		// Player asking about rats.
<span class="fc" id="L57">		mainNPC.add(</span>
				ConversationStates.ATTENDING, 
				Arrays.asList(&quot;rats&quot;, &quot;rats!&quot;), 
				new TPPQuestInPhaseCondition(myphase),
				ConversationStates.ATTENDING, 
				&quot;Well, we tried to clean up the city. &quot;+
	    		&quot;You can get a #reward for your help now, ask about #details &quot;+
				  &quot;if you want to know more.&quot;, 
				null);
		
		// Player asking about details.
<span class="fc" id="L68">		mainNPC.add(</span>
				ConversationStates.ATTENDING, 
				&quot;details&quot;, 
				new TPPQuestInPhaseCondition(myphase),
				ConversationStates.ATTENDING, 
				null, 
				new DetailsKillingsAction());
		
		// Player asked about reward
<span class="fc" id="L77">		mainNPC.add(</span>
				ConversationStates.ATTENDING, 
				&quot;reward&quot;, 
				new TPPQuestInPhaseCondition(myphase),
				ConversationStates.ATTENDING, 
				null, 
				new RewardPlayerAction());
<span class="fc" id="L84">	}</span>
	
	
	/**
	 * fills conversations list between mayor and piper
	 */
	private void fillConversations() {
		//piper
<span class="fc" id="L92">		conversations.add(&quot;Good day, Mayor Chalmers. What did you call me here for?&quot;);</span>
		//mayor
<span class="fc" id="L94">		conversations.add(&quot;Hello, very glad to see our respectable hero here. Who hasn't heard about you, there is almost...&quot;);</span>
		//piper
<span class="fc" id="L96">		conversations.add(&quot;Please talk about your business to me, my time is precious.&quot;);</span>
		//mayor
<span class="fc" id="L98">		conversations.add(&quot;... ok, what was I saying? Ah yes, our city has a little problem with #rats.&quot;);</span>
		//piper
<span class="fc" id="L100">		conversations.add(&quot;Again?&quot;);</span>
		//mayor
<span class="fc" id="L102">		conversations.add(&quot;Yes, these animals are too stupid to remember a lesson they learnt only recently.&quot;);</span>
		//piper
<span class="fc" id="L104">		conversations.add(&quot;I can help, if you are ready to pay.&quot;);</span>
		//mayor
<span class="fc" id="L106">		conversations.add(&quot;Ados City has no other way to eliminate this nuisance. We will pay you.&quot;);</span>
		//piper
<span class="fc" id="L108">		conversations.add(&quot;Do you know my usual price?&quot;);</span>
		//mayor
<span class="fc" id="L110">		conversations.add(&quot;Yes, I have it written somewhere in my papers.&quot;);</span>
		//piper
<span class="fc" id="L112">		conversations.add(&quot;Good. I will return for my reward soon, please prepare it.&quot;);</span>
		//mayor
<span class="fc" id="L114">		conversations.add(&quot;Don't worry, how can I break your trust in me and my city?&quot;);</span>
<span class="fc" id="L115">	}</span>
	
	
	/**
	 * constructor
	 * @param timings - a pair of time parameters for phase timeouts
	 */
	public AwaitingPhase(final Map&lt;String, Integer&gt; timings) {
<span class="fc" id="L123">		super(timings);</span>
<span class="fc" id="L124">		minPhaseChangeTime = timings.get(AWAITING_TIME_MIN);</span>
<span class="fc" id="L125">		maxPhaseChangeTime = timings.get(AWAITING_TIME_MAX);</span>
<span class="fc" id="L126">		addConversations();</span>
<span class="fc" id="L127">		fillConversations();</span>
<span class="fc" id="L128">	}</span>

	
	/**
	 * prepare actions
	 */
	@Override
	public void prepare() {
<span class="fc" id="L136">		createPiedPiper();</span>
<span class="fc" id="L137">	}</span>
	
	
	/**
	 * function for creating pied piper npc
	 */
	private void createPiedPiper() {
<span class="fc" id="L144">		piedpiper = new SpeakerNPC(&quot;Pied Piper&quot;);</span>
<span class="fc" id="L145">		TPPQuestHelperFunctions.setupPiper(piedpiper);</span>
<span class="fc" id="L146">		fullpathin = PathsBuildHelper.getAdosIncomingPath();</span>
<span class="fc" id="L147">		fullpathout = PathsBuildHelper.getAdosTownHallBackwardPath();</span>
<span class="fc" id="L148">		leadNPC();</span>
<span class="fc" id="L149">	}</span>
	
	
	/**
	 * function will remove piped piper npc object
	 */
	private void destroyPiedPiper() {
<span class="fc" id="L156">		piedpiper.getZone().remove(piedpiper);</span>
<span class="fc" id="L157">		piedpiper = null;</span>
<span class="fc" id="L158">	}</span>

	/**
	 * prepare NPC to walk through his multizone pathes and do some actions during that.
	 */
	private void leadNPC() {
<span class="fc" id="L164">		final StendhalRPZone zone = fullpathin.get(0).get().first();</span>
<span class="fc" id="L165">		final int x=fullpathin.get(0).get().second().get(0).getX();</span>
<span class="fc" id="L166">		final int y=fullpathin.get(0).get().second().get(0).getY();</span>
<span class="fc" id="L167">		piedpiper.setPosition(x, y);</span>
<span class="fc" id="L168">		zone.add(piedpiper);</span>
<span class="fc" id="L169">		Observer o = new MultiZonesFixedPath(piedpiper, fullpathin, </span>
						new NPCFollowing(mainNPC, piedpiper,
							new NPCChatting(piedpiper, mainNPC, conversations, explainations,
								new GoToPosition(piedpiper, PathsBuildHelper.getAdosTownHallMiddlePoint(),
									new MultiZonesFixedPath(piedpiper, fullpathout,
										new PhaseSwitcher(this))))));
<span class="fc" id="L175">		o.update(null, null);</span>
<span class="fc" id="L176">	}</span>
	
	
	/**
	 * @return - min quest phase timeout
	 */
	@Override
	public int getMinTimeOut() {
<span class="fc" id="L184">		return minPhaseChangeTime;</span>
	}
	

	/**
	 * @return - max quest phase timeout
	 */
	@Override
	public int getMaxTimeOut() {
<span class="fc" id="L193">		return maxPhaseChangeTime;</span>
	}


	/**
	 * @param comments - comments for switching event
	 */
	@Override
	public void phaseToDefaultPhase(List&lt;String&gt; comments) {
<span class="fc" id="L202">		destroyPiedPiper();</span>
<span class="fc" id="L203">		super.phaseToDefaultPhase(comments);		</span>
<span class="fc" id="L204">	}</span>


	/**
	 * @param nextPhase - next phase
	 * @param comments - comments for switching event
	 */
	@Override
	public void phaseToNextPhase(ITPPQuest nextPhase, List&lt;String&gt; comments) {
<span class="fc" id="L213">		destroyPiedPiper();</span>
<span class="fc" id="L214">		super.phaseToNextPhase(nextPhase, comments);</span>
<span class="fc" id="L215">	}</span>
	
	
	/**
	 *  Pied Piper will now start to collect rats :-)
	 *  @return - npc shouts at switching quest phase.
	 */
	@Override
	public String getSwitchingToNextPhaseMessage() {
		final String text = 
			/*
			&quot;Pied Piper shouts: Ados citizens, now i will clean up your city from rats. I will play &quot; +
			&quot;magical melody, and rats will attracts to me. Please do not try to block or kill them, &quot; +
			&quot;because melody will also protect MY rats. &quot; +
			&quot;Just enjoy the show.&quot;;
			 */
			&quot;Mayor Chalmers shouts: Thankfully, all the #rats are gone now, &quot; +
			&quot;the Pied Piper hypnotized them and led them away to the dungeons. &quot;+
			&quot;Those of you who helped Ados City with the rats problem &quot;+
			&quot;can get your #reward now.&quot;;

<span class="fc" id="L236">		return text;</span>
	}

	
	/**
	 * @return - current phase
	 */
	@Override
	public TPP_Phase getPhase() {
<span class="fc" id="L245">		return TPP_Phase.TPP_AWAITING;</span>
	}		
	
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>