<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>UpdateProgressBar.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.client.update</a> &gt; <span class="el_source">UpdateProgressBar.java</span></div><h1>UpdateProgressBar.java</h1><pre class="source lang-java linenums">/***************************************************************************
 *                   (C) Copyright 2003-2011 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.client.update;

import java.awt.Dimension;
import java.awt.MouseInfo;
import java.io.IOException;
import java.net.URL;

import javax.swing.BorderFactory;
import javax.swing.Box;
import javax.swing.BoxLayout;
import javax.swing.ImageIcon;
import javax.swing.JEditorPane;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JProgressBar;
import javax.swing.JScrollPane;
import javax.swing.SwingUtilities;

/**
 * A progress bar for the download progress.
 */
class UpdateProgressBar extends JFrame implements
		HttpClient.ProgressListener {
	private static final long serialVersionUID = -1607102841664745919L;

	/** highest value of progress bar */
<span class="nc" id="L39">	private int max = 100;</span>

	/** base url for the browser */
<span class="nc" id="L42">	private String urlBase = null;</span>

	/** the version the update is based on, &lt;code&gt;null&lt;/code&gt; for a initial download */
<span class="nc" id="L45">	private String fromVersion = null;</span>

	/** the version the download is leading to */
<span class="nc" id="L48">	private String toVersion = null;</span>

	/** the size of the downloaded files */
	private int sizeOfLastFiles;

	/** content pane which manages the components */
	private JPanel contentPane;

	/** bar showing the download progress */
	private JProgressBar progressBar;

	/** browser window */
	private JEditorPane browser;


	/**
	 * Creates update progress bar.
	 * 
	 * @param max max file size
	 * @param urlBase base url for the browser
	 * @param fromVersion the version the update is based on, may be &lt;code&gt;null&lt;/code&gt;
	 * @param toVersion the version the download leads to
	 */
	UpdateProgressBar(final int max, final String urlBase, final String fromVersion, final String toVersion) {
<span class="nc" id="L72">		super(&quot;Downloading...&quot;, MouseInfo.getPointerInfo().getDevice().getDefaultConfiguration());</span>
<span class="nc" id="L73">		setLocationByPlatform(true);</span>
<span class="nc" id="L74">		setDefaultCloseOperation(DO_NOTHING_ON_CLOSE);</span>
<span class="nc" id="L75">		addWindowListener(new UpdateProgressBarWindowListener());</span>

<span class="nc" id="L77">		this.max = max;</span>
<span class="nc" id="L78">		this.urlBase = urlBase;</span>
<span class="nc" id="L79">		this.fromVersion = fromVersion;</span>
<span class="nc" id="L80">		this.toVersion = toVersion;</span>

		try {
<span class="nc" id="L83">			final URL url = this.getClass().getClassLoader().getResource(</span>
					ClientGameConfiguration.get(&quot;GAME_ICON&quot;));
<span class="nc" id="L85">			setIconImage(new ImageIcon(url).getImage());</span>
<span class="nc" id="L86">		} catch (final RuntimeException e) {</span>
			// in case that resource is not available
<span class="nc" id="L88">		}</span>

<span class="nc" id="L90">		initializeComponents();</span>

<span class="nc" id="L92">		this.pack();</span>
<span class="nc" id="L93">	}</span>

	private void initializeComponents() {
<span class="nc" id="L96">		contentPane = (JPanel) this.getContentPane();</span>

<span class="nc" id="L98">		contentPane.setLayout(new BoxLayout(contentPane, BoxLayout.PAGE_AXIS));</span>
<span class="nc" id="L99">		contentPane.setBorder(BorderFactory.createEmptyBorder(5, 5, 5, 5));</span>

<span class="nc bnc" id="L101" title="All 2 branches missed.">		if (fromVersion == null) {</span>
<span class="nc" id="L102">			contentPane.add(new JLabel(&quot;Please wait while &quot; + ClientGameConfiguration.get(&quot;GAME_NAME&quot;) + &quot; is downloaded...&quot;));</span>
		} else {
<span class="nc" id="L104">			contentPane.add(new JLabel(&quot;Downloading updates...&quot;));</span>
		}
<span class="nc" id="L106">		contentPane.add(Box.createVerticalStrut(5));</span>

<span class="nc" id="L108">		progressBar = new JProgressBar(0, max);</span>
<span class="nc" id="L109">		progressBar.setStringPainted(false);</span>
<span class="nc" id="L110">		progressBar.setValue(0);</span>
<span class="nc" id="L111">		contentPane.add(progressBar);</span>
<span class="nc" id="L112">		contentPane.add(Box.createVerticalStrut(5));</span>

<span class="nc bnc" id="L114" title="All 2 branches missed.">		if (urlBase != null) {</span>
			// Set up page display.
<span class="nc" id="L116">			browser = new JEditorPane();</span>
<span class="nc" id="L117">			browser.setContentType(&quot;text/html&quot;);</span>
<span class="nc" id="L118">			browser.setEditable(false);</span>
<span class="nc" id="L119">			Dimension dim = new Dimension(600, 440);</span>
<span class="nc" id="L120">			browser.setPreferredSize(dim);</span>
<span class="nc" id="L121">			browser.addPropertyChangeListener(&quot;page&quot;, new UpdateProgressBarMetaRefreshSupport());</span>
<span class="nc" id="L122">			browser.addHyperlinkListener(new UpdateProgressBarHyperLinkListener());</span>
			
<span class="nc" id="L124">			Dimension windowSize = new Dimension(640, 480);</span>
<span class="nc" id="L125">			setPreferredSize(windowSize);</span>
			// TODO: load page async?
			try {
<span class="nc" id="L128">				browser.setPage(urlBase + fromVersion + &quot;/&quot; + toVersion + &quot;.html&quot;);</span>
<span class="nc" id="L129">			} catch (IOException e) {</span>
<span class="nc" id="L130">				System.out.println(e);</span>
<span class="nc" id="L131">			}</span>

			// Gige the page scroll bars if it needs them
<span class="nc" id="L134">			final JScrollPane scrollPane = new JScrollPane(browser);</span>
<span class="nc" id="L135">			contentPane.add(scrollPane);</span>
		}
<span class="nc" id="L137">	}</span>

	@Override
	public void onDownloading(final int downloadedBytes) {
		// The updater will not be running in EDT
<span class="nc" id="L142">		SwingUtilities.invokeLater(new Runnable() {</span>
			@Override
			public void run() {
<span class="nc" id="L145">				progressBar.setValue(sizeOfLastFiles + downloadedBytes);</span>
<span class="nc" id="L146">			}</span>
		});
<span class="nc" id="L148">	}</span>

	@Override
	public void onDownloadCompleted(final int byteCounter) {
<span class="nc" id="L152">		sizeOfLastFiles = sizeOfLastFiles + byteCounter;</span>
		// The updater will not be running in EDT
<span class="nc" id="L154">		SwingUtilities.invokeLater(new Runnable() {</span>
			@Override
			public void run() {
<span class="nc" id="L157">				progressBar.setValue(sizeOfLastFiles);</span>
<span class="nc" id="L158">			}</span>
		});
<span class="nc" id="L160">	}</span>

	/**
	 * main entrance point for testing
	 *
	 * @param args ignored
	 */
	public static void main(String[] args) {
<span class="nc" id="L168">		UpdateProgressBar updateProgressBar = new UpdateProgressBar(100, &quot;http://arianne.sourceforge.net/stendhal/greeting/&quot;, null, &quot;0.88&quot;);</span>
<span class="nc" id="L169">		updateProgressBar.onDownloading(50);</span>
<span class="nc" id="L170">		updateProgressBar.setVisible(true);</span>
<span class="nc" id="L171">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>