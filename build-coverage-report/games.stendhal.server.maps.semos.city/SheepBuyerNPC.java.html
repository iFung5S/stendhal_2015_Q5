<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SheepBuyerNPC.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.semos.city</a> &gt; <span class="el_source">SheepBuyerNPC.java</span></div><h1>SheepBuyerNPC.java</h1><pre class="source lang-java linenums">package games.stendhal.server.maps.semos.city;

import games.stendhal.common.Rand;
import games.stendhal.common.grammar.ItemParserResult;
import games.stendhal.server.core.config.ZoneConfigurator;
import games.stendhal.server.core.engine.StendhalRPZone;
import games.stendhal.server.core.pathfinder.FixedPath;
import games.stendhal.server.core.pathfinder.Node;
import games.stendhal.server.core.rp.StendhalRPAction;
import games.stendhal.server.entity.RPEntity;
import games.stendhal.server.entity.creature.Creature;
import games.stendhal.server.entity.creature.Sheep;
import games.stendhal.server.entity.npc.EventRaiser;
import games.stendhal.server.entity.npc.SpeakerNPC;
import games.stendhal.server.entity.npc.behaviour.adder.BuyerAdder;
import games.stendhal.server.entity.npc.behaviour.impl.BuyerBehaviour;
import games.stendhal.server.entity.player.Player;
import games.stendhal.server.maps.semos.village.SheepSellerNPC;
import games.stendhal.server.util.Area;

import java.awt.geom.Rectangle2D;
import java.util.Arrays;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;

import marauroa.common.game.RPObject;

/**
 * A merchant (original name: Sato) who buys sheep from players.
 */
<span class="fc" id="L33">public class SheepBuyerNPC implements ZoneConfigurator {</span>
	
	// The sheep pen where Sato moves what he buys
	/** Left X coordinate of the sheep pen */ 
	private static final int SHEEP_PEN_X = 39;
	/** Top Y coordinate of the sheep pen */
	private static final int SHEEP_PEN_Y = 24;
	/** Width of the sheep pen */
	private static final int SHEEP_PEN_WIDTH = 16;
	/** Height of the sheep pen */
	private static final int SHEEP_PEN_HEIGHT = 6;
	/** 
	 * The maximum number of sheep Sato keeps in his sheep pen.
	 */ 
	private static final int MAX_SHEEP_IN_PEN = 8;
	/** The area covering the sheep pen in Semos */
	private Area pen;

	public class SheepBuyerSpeakerNPC extends SpeakerNPC {

<span class="fc" id="L53">		public SheepBuyerSpeakerNPC(String name) {</span>
<span class="fc" id="L54">			super(name);</span>
			// HP needs to be &gt; 0 for Sato to appear in the killer list for
			// the big bad wolf
<span class="fc" id="L57">			setBaseHP(100);</span>
<span class="fc" id="L58">			setHP(100);</span>
<span class="fc" id="L59">		}</span>
		
		/**
		 * Get the area of the sheep pen where bought sheep 
		 * should be moved.
		 * 
		 * @param zone the zone of the sheep pen
		 * @return area of the sheep pen
		 */
		private Area getPen(StendhalRPZone zone) {
<span class="nc bnc" id="L69" title="All 2 branches missed.">			if (pen == null) {</span>
<span class="nc" id="L70">				Rectangle2D rect = new Rectangle2D.Double();</span>
<span class="nc" id="L71">				rect.setRect(SHEEP_PEN_X, SHEEP_PEN_Y, SHEEP_PEN_WIDTH, SHEEP_PEN_HEIGHT);</span>
<span class="nc" id="L72">				pen = new Area(zone, rect);</span>
			}
			
<span class="nc" id="L75">			return pen;</span>
		}
		
		/**
		 * Try to get rid of the big bad wolf that could have spawned in the pen,
		 * but miss it sometimes.
		 *  
		 * @param zone the zone to check
		 */
		private void killWolves(StendhalRPZone zone) {
<span class="nc bnc" id="L85" title="All 2 branches missed.">			if (Rand.throwCoin() == 1) { </span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">				for (RPObject obj : zone) {</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">					if (obj instanceof Creature) {</span>
<span class="nc" id="L88">						Creature wolf = (Creature) obj;</span>
						
<span class="nc bnc" id="L90" title="All 4 branches missed.">						if (&quot;wolf&quot;.equals(wolf.get(&quot;subclass&quot;)) &amp;&amp; getPen(zone).contains(wolf)) {</span>
<span class="nc" id="L91">							wolf.onDamaged(this, wolf.getHP());</span>
<span class="nc" id="L92">							return;</span>
						}
					}
<span class="nc" id="L95">				}</span>
			}
<span class="nc" id="L97">		}</span>
		
		/**
		 * Get a list of the sheep in the pen.
		 * 
		 * @param zone the zone to check
		 * @return list of sheep in the pen
		 */
		private List&lt;Sheep&gt; sheepInPen(StendhalRPZone zone) {
<span class="nc" id="L106">			List&lt;Sheep&gt; sheep = new LinkedList&lt;Sheep&gt;();</span>
<span class="nc" id="L107">			Area pen = getPen(zone);</span>
			
<span class="nc bnc" id="L109" title="All 2 branches missed.">			for (RPEntity entity : zone.getPlayerAndFriends()) {</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">				if (entity instanceof Sheep) {</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">					if (pen.contains(entity)) {</span>
<span class="nc" id="L112">						sheep.add((Sheep) entity);</span>
					}
				}
<span class="nc" id="L115">			}</span>
			
<span class="nc" id="L117">			return sheep;</span>
		}
		
		/**
		 * Move a bought sheep to the den if there's space, or remove it 
		 * from the zone otherwise. Remove old sheep if there'd be more
		 * than &lt;code&gt;MAX_SHEEP_IN_PEN&lt;/code&gt; after the addition.
		 * 
		 * @param sheep the sheep to be moved
		 */
		public void moveSheep(Sheep sheep) {
			// The area of the sheed den.
<span class="nc" id="L129">			int x = Rand.randUniform(SHEEP_PEN_X, SHEEP_PEN_X + SHEEP_PEN_WIDTH - 1);</span>
<span class="nc" id="L130">			int y = Rand.randUniform(SHEEP_PEN_Y, SHEEP_PEN_Y + SHEEP_PEN_HEIGHT - 1);</span>
<span class="nc" id="L131">			StendhalRPZone zone = sheep.getZone();</span>
<span class="nc" id="L132">			List&lt;Sheep&gt; oldSheep = sheepInPen(zone);</span>
			
<span class="nc" id="L134">			killWolves(zone);</span>
			/*
			 * Keep the amount of sheep reasonable. Sato's
			 * a business man and letting the sheep starve 
			 * would be bad for busines.
			 */
<span class="nc bnc" id="L140" title="All 2 branches missed.">			if (oldSheep.size() &gt;= MAX_SHEEP_IN_PEN) {</span>
				// Sato sells the oldest sheep
<span class="nc" id="L142">				zone.remove(oldSheep.get(0));</span>
			}
			
<span class="nc bnc" id="L145" title="All 2 branches missed.">			if (!StendhalRPAction.placeat(zone, sheep, x, y)) {</span>
				// there was no room for the sheep. Simply eat it
<span class="nc" id="L147">				sheep.getZone().remove(sheep);  </span>
			}
<span class="nc" id="L149">		}</span>
	}
	
	@Override
	public void configureZone(StendhalRPZone zone,
			Map&lt;String, String&gt; attributes) {
<span class="fc" id="L155">		final SpeakerNPC npc = new SheepBuyerSpeakerNPC(&quot;Sato&quot;) {</span>
			@Override
			public void createDialog() {
<span class="fc" id="L158">				addGreeting();</span>
<span class="fc" id="L159">				addJob(&quot;I buy sheep here in Semos, then I send them up to Ados where they are exported.&quot;);</span>
<span class="fc" id="L160">				addHelp(&quot;I purchase sheep, at what I think is a fairly reasonable price. Just say if you want to #sell #sheep, and I will set up a deal!&quot;);</span>
<span class="fc" id="L161">				addGoodbye();</span>
<span class="fc" id="L162">				addQuest(&quot;Hmm I need a present for my friend. Maybe you can ask Nishiya for a nice idea...&quot;);</span>
<span class="fc" id="L163">			}</span>

			@Override
			protected void createPath() {
<span class="fc" id="L167">				final List&lt;Node&gt; nodes = new LinkedList&lt;Node&gt;();</span>
<span class="fc" id="L168">				nodes.add(new Node(40, 45));</span>
<span class="fc" id="L169">				nodes.add(new Node(58, 45));</span>
<span class="fc" id="L170">				nodes.add(new Node(58, 22));</span>
<span class="fc" id="L171">				nodes.add(new Node(39, 22));</span>
<span class="fc" id="L172">				nodes.add(new Node(39, 15));</span>
<span class="fc" id="L173">				nodes.add(new Node(23, 15));</span>
<span class="fc" id="L174">				nodes.add(new Node(23, 45));</span>
<span class="fc" id="L175">				setPath(new FixedPath(nodes, true));</span>
<span class="fc" id="L176">			}</span>
		};
<span class="fc" id="L178">		final Map&lt;String, Integer&gt; buyitems = new HashMap&lt;String, Integer&gt;();</span>
<span class="fc" id="L179">		buyitems.put(&quot;sheep&quot;, 150);</span>
<span class="fc" id="L180">		new BuyerAdder().addBuyer(npc, new SheepBuyerBehaviour(buyitems), true);</span>
<span class="fc" id="L181">		npc.setPosition(40, 45);</span>
<span class="fc" id="L182">		npc.setEntityClass(&quot;buyernpc&quot;);</span>
<span class="fc" id="L183">		npc.setDescription(&quot;You see Sato. He loves sheep.&quot;);</span>
<span class="fc" id="L184">		npc.setSounds(Arrays.asList(&quot;hiccup-1&quot;, &quot;sneeze-1&quot;));</span>
<span class="fc" id="L185">		zone.add(npc);</span>
<span class="fc" id="L186">	}</span>

<span class="fc" id="L188">	private static class SheepBuyerBehaviour extends BuyerBehaviour {</span>
		SheepBuyerBehaviour(final Map&lt;String, Integer&gt; items) {
<span class="fc" id="L190">			super(items);</span>
<span class="fc" id="L191">		}</span>

		private int getValue(ItemParserResult res, final Sheep sheep) {
<span class="nc" id="L194">			return Math.round(getUnitPrice(res.getChosenItemName()) * ((float) sheep.getWeight() / (float) Sheep.MAX_WEIGHT));</span>
		}

		@Override
		public int getCharge(ItemParserResult res, final Player player) {
<span class="nc bnc" id="L199" title="All 2 branches missed.">			if (player.hasSheep()) {</span>
<span class="nc" id="L200">				final Sheep sheep = player.getSheep();</span>
<span class="nc" id="L201">				return getValue(res, sheep);</span>
			} else {
				// npc's answer was moved to BuyerAdder. 
<span class="nc" id="L204">				return 0;</span>
			}
		}

		@Override
		public boolean transactAgreedDeal(ItemParserResult res, final EventRaiser seller, final Player player) {
			// res.getAmount() is currently ignored.

<span class="nc" id="L212">			final Sheep sheep = player.getSheep();</span>

<span class="nc bnc" id="L214" title="All 2 branches missed.">			if (sheep != null) {</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">				if (seller.getEntity().squaredDistance(sheep) &gt; 5 * 5) {</span>
<span class="nc" id="L216">					seller.say(&quot;I can't see that sheep from here! Bring it over so I can assess it properly.&quot;);</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">				} else if (getValue(res, sheep) &lt; SheepSellerNPC.BUYING_PRICE) {</span>
					// prevent newbies from selling their sheep too early
<span class="nc" id="L219">					seller.say(&quot;Nah, that sheep looks too skinny. Feed it with red berries, and come back when it has become fatter.&quot;);</span>
				} else {
<span class="nc" id="L221">					seller.say(&quot;Thanks! Here is your money.&quot;);</span>
<span class="nc" id="L222">					payPlayer(res, player);</span>
<span class="nc" id="L223">					player.removeSheep(sheep);</span>

<span class="nc" id="L225">					player.notifyWorldAboutChanges();</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">					if(seller.getEntity() instanceof SheepBuyerSpeakerNPC) {</span>
<span class="nc" id="L227">						((SheepBuyerSpeakerNPC)seller.getEntity()).moveSheep(sheep);</span>
					} else {
						// only to prevent that an error occurs and the sheep does not disappear
<span class="nc" id="L230">						sheep.getZone().remove(sheep);</span>
					}

<span class="nc" id="L233">					return true;</span>
				}
			} else {
<span class="nc" id="L236">				seller.say(&quot;You don't have any sheep, &quot; + player.getTitle() + &quot;! What are you trying to pull?&quot;);</span>
			}

<span class="nc" id="L239">			return false;</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>