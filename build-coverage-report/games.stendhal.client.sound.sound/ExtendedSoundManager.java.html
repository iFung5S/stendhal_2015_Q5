<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ExtendedSoundManager.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.client.sound.sound</a> &gt; <span class="el_source">ExtendedSoundManager.java</span></div><h1>ExtendedSoundManager.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.client.sound.sound;

import games.stendhal.client.MemoryCache;
import games.stendhal.client.gui.wt.core.WtWindowManager;
import games.stendhal.client.sound.facade.AudibleArea;
import games.stendhal.client.sound.facade.SoundFileType;
import games.stendhal.client.sound.facade.SoundGroup;
import games.stendhal.client.sound.facade.Time;
import games.stendhal.client.sound.manager.AudioResource;
import games.stendhal.client.sound.manager.DeviceEvaluator;
import games.stendhal.client.sound.manager.SoundManagerNG;
import games.stendhal.common.math.Numeric;

import java.util.Collection;
import java.util.LinkedHashMap;
import java.util.Map;
import java.util.regex.Pattern;

import javax.sound.sampled.AudioFormat;

import org.apache.log4j.Logger;

/**
 * this class is the main interface between the game logic and the low level
 * sound system. It is a refinement of the manager.SoundManager class.
 *
 * @author hendrik, silvio
 */
public class ExtendedSoundManager extends SoundManagerNG {
<span class="fc" id="L42">	private static Logger logger = Logger.getLogger(ExtendedSoundManager.class);</span>

	private static class Multiplicator {

<span class="nc" id="L46">		public Multiplicator(float v, Group g) {</span>
<span class="nc" id="L47">			value = v;</span>
<span class="nc" id="L48">			group = g;</span>
<span class="nc" id="L49">		}</span>

		float value;
		Group group;
	}

<span class="fc" id="L55">	public class Group implements SoundGroup {</span>

<span class="fc" id="L57">		private final boolean mEnabled = true;</span>
<span class="fc" id="L58">		private float mVolume = 1.0f;</span>
<span class="fc" id="L59">		private final MemoryCache&lt;String, Sound&gt; mGroupSounds = new MemoryCache&lt;String, Sound&gt;();</span>
<span class="fc" id="L60">		private boolean streaming = false;</span>

		@Override
		public boolean loadSound(String name, String filename, SoundFileType fileType, boolean enableStreaming) {
			try {
<span class="fc" id="L65">				Sound sound = ExtendedSoundManager.this.mSounds.get(name);</span>

<span class="pc bpc" id="L67" title="1 of 2 branches missed.">				if (sound == null) {</span>
<span class="fc" id="L68">					sound = openSound(new AudioResource(filename), fileType, 256, enableStreaming);</span>

<span class="pc bpc" id="L70" title="1 of 2 branches missed.">					if (sound != null) {</span>
<span class="fc" id="L71">						ExtendedSoundManager.this.mSounds.put(name, sound);</span>
					}
				}

<span class="pc bpc" id="L75" title="1 of 2 branches missed.">				if (sound != null) {</span>
<span class="fc" id="L76">					mGroupSounds.put(name, sound);</span>
				}

<span class="pc bpc" id="L79" title="1 of 2 branches missed.">				return sound != null;</span>
<span class="nc" id="L80">			} catch (RuntimeException e) {</span>
<span class="nc" id="L81">				logger.error(e, e);</span>
			}
<span class="nc" id="L83">			return false;</span>
		}

		@Override
		public float getVolume() {
<span class="nc" id="L88">			return mVolume;</span>
		}

		@Override
		public void changeVolume(float volume) {
<span class="fc" id="L93">			mVolume = volume;</span>

<span class="pc bpc" id="L95" title="1 of 2 branches missed.">			for (Sound sound : getActiveSounds()) {</span>
<span class="nc" id="L96">				Multiplicator multiplicator = sound.getAttachment(Multiplicator.class);</span>

<span class="nc bnc" id="L98" title="All 4 branches missed.">				if (multiplicator != null &amp;&amp; multiplicator.group == this) {</span>
<span class="nc" id="L99">					ExtendedSoundManager.this.changeVolume(sound, (mMasterVolume * mVolume * multiplicator.value));</span>
				}
<span class="nc" id="L101">			}</span>
<span class="fc" id="L102">		}</span>

		/**
		 * enables streaming of the music data for this group.
		 */
		@Override
		public void enableStreaming() {
<span class="nc" id="L109">			streaming = true;</span>
<span class="nc" id="L110">		}</span>

		@Override
		public Sound play(String soundName, int layerLevel, AudibleArea area, Time fadeInDuration, boolean autoRepeat, boolean clone) {
<span class="fc" id="L114">			return play(soundName, 1.0f, layerLevel, area, fadeInDuration, autoRepeat, clone);</span>
		}

		@Override
		public Sound play(String soundName, float volume, int layerLevel, AudibleArea area, Time fadeInDuration, boolean autoRepeat, boolean clone) {
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">			if (soundName == null) {</span>
<span class="fc" id="L120">				return null;</span>
			}
			try {

				if (mEnabled) {
<span class="nc" id="L125">					Sound sound = mGroupSounds.get(soundName);</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">					if (sound == null) {</span>
<span class="nc" id="L127">						loadSound(soundName, soundName + &quot;.ogg&quot;, SoundFileType.OGG, this.streaming);</span>
<span class="nc" id="L128">						sound = mGroupSounds.get(soundName);</span>
					}

<span class="nc bnc" id="L131" title="All 2 branches missed.">					if (sound != null) {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">						if (clone) {</span>
<span class="nc" id="L133">							sound = sound.clone();</span>
						}

<span class="nc" id="L136">						sound.setAttachment(new Multiplicator(volume, this));</span>
<span class="nc" id="L137">						ExtendedSoundManager.this.play(sound, (mMasterVolume * mVolume * volume), layerLevel, area, autoRepeat, fadeInDuration);</span>
					}

<span class="nc" id="L140">					return sound;</span>
				}
<span class="nc" id="L142">			} catch (RuntimeException e) {</span>
<span class="nc" id="L143">				logger.error(e, e);</span>
			}
<span class="nc" id="L145">			return null;</span>
		}
	}

	private static final AudioFormat mAudioFormat;
	private static final DeviceEvaluator mDeviceEvaluator;

	static
	{
<span class="fc" id="L154">		WtWindowManager wm = WtWindowManager.getInstance();</span>
<span class="fc" id="L155">		mDeviceEvaluator = new DeviceEvaluator();</span>
<span class="fc" id="L156">		String userSelected = wm.getProperty(&quot;sound.device&quot;, &quot;auto&quot;);</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">		if (!userSelected.equals(&quot;auto - recommended&quot;)) {</span>
<span class="fc" id="L158">			logger.info(&quot;User selected sound device: &quot; + userSelected);</span>
<span class="fc" id="L159">			mDeviceEvaluator.setRating(Pattern.compile(Pattern.quote(userSelected)), null, 100);</span>
		}
<span class="fc" id="L161">		mDeviceEvaluator.setRating(Pattern.compile(&quot;.*pulseaudio.*&quot;, Pattern.CASE_INSENSITIVE), null, 2);</span>
<span class="fc" id="L162">		mDeviceEvaluator.setRating(Pattern.compile(&quot;.*plughw.0.0.*&quot;), null, 1);</span>
<span class="fc" id="L163">		mDeviceEvaluator.setRating(Pattern.compile(&quot;.*Java Sound Audio Engine.*&quot;), null, -1);</span>

<span class="fc" id="L165">		mAudioFormat = new AudioFormat(44100, 16, 2, true, false);</span>
<span class="fc" id="L166">	}</span>

<span class="fc" id="L168">	private final MemoryCache&lt;String, Sound&gt; mSounds = new MemoryCache&lt;String, Sound&gt;();</span>
<span class="fc" id="L169">	private final Map&lt;String, Group&gt; mGroups = new LinkedHashMap&lt;String, Group&gt;();</span>
<span class="fc" id="L170">	private float mMasterVolume = 1.0f;</span>

	ExtendedSoundManager() {
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">		super(!Boolean.parseBoolean(WtWindowManager.getInstance().getProperty(&quot;sound.play&quot;, &quot;true&quot;)),</span>
				mDeviceEvaluator.createDeviceList(mAudioFormat), mAudioFormat);
<span class="fc" id="L175">		initVolumes();</span>
<span class="fc" id="L176">	}</span>

	private void initVolumes() {
<span class="fc" id="L179">		WtWindowManager config = WtWindowManager.getInstance();</span>

<span class="fc" id="L181">		int volume = config.getPropertyInt(&quot;sound.volume.master&quot;, 100);</span>
<span class="fc" id="L182">		changeVolume(Numeric.intToFloat(volume, 100.0f));</span>

<span class="fc" id="L184">		this.getGroup(&quot;gui&quot;).changeVolume(Numeric.intToFloat(config.getPropertyInt(&quot;sound.volume.gui&quot;, 100), 100.0f));</span>
<span class="fc" id="L185">		this.getGroup(&quot;sfx&quot;).changeVolume(Numeric.intToFloat(config.getPropertyInt(&quot;sound.volume.sfx&quot;, 100), 100.0f));</span>
<span class="fc" id="L186">		this.getGroup(&quot;creature&quot;).changeVolume(Numeric.intToFloat(config.getPropertyInt(&quot;sound.volume.creature&quot;, 95), 100.0f));</span>
<span class="fc" id="L187">		this.getGroup(&quot;ambient&quot;).changeVolume(Numeric.intToFloat(config.getPropertyInt(&quot;sound.volume.ambient&quot;, 80), 100.0f));</span>
<span class="fc" id="L188">		this.getGroup(&quot;music&quot;).changeVolume(Numeric.intToFloat(config.getPropertyInt(&quot;sound.volume.music&quot;, 60), 100.0f));</span>
<span class="fc" id="L189">	}</span>

	// The initMute() method is not needed anymore, but preserved
	// if something goes wrong with the muting again.
	/*
	private void initMute() {
		WtWindowManager config = WtWindowManager.getInstance();
		boolean play = Boolean.parseBoolean(config.getProperty(&quot;sound.play&quot;, &quot;true&quot;));
		mute(!play, false, new Time(0, Time.Unit.SEC));
	}*/

	public Group getGroup(String groupName) {
<span class="fc" id="L201">		Group group = mGroups.get(groupName);</span>

<span class="fc bfc" id="L203" title="All 2 branches covered.">		if (group == null) {</span>
<span class="fc" id="L204">			group = new Group();</span>
<span class="fc" id="L205">			mGroups.put(groupName, group);</span>
		}

<span class="fc" id="L208">		return group;</span>
	}

	public Collection&lt;String&gt; getGroupNames() {
<span class="nc" id="L212">		return mGroups.keySet();</span>
	}

	public float getVolume() {
<span class="nc" id="L216">		return mMasterVolume;</span>
	}

	public void changeVolume(float volume) {
<span class="fc" id="L220">		mMasterVolume = volume;</span>

<span class="pc bpc" id="L222" title="1 of 2 branches missed.">		for (Sound sound : getActiveSounds()) {</span>
<span class="nc" id="L223">			Multiplicator multiplicator = sound.getAttachment(Multiplicator.class);</span>

<span class="nc bnc" id="L225" title="All 2 branches missed.">			if (multiplicator != null) {</span>
<span class="nc" id="L226">				super.changeVolume(sound, (mMasterVolume * multiplicator.group.mVolume * multiplicator.value));</span>
			}
<span class="nc" id="L228">		}</span>
<span class="fc" id="L229">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>