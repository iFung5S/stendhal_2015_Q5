<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>NPCsXMLLoader.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.core.config</a> &gt; <span class="el_source">NPCsXMLLoader.java</span></div><h1>NPCsXMLLoader.java</h1><pre class="source lang-java linenums">package games.stendhal.server.core.config;

import games.stendhal.server.core.rule.defaultruleset.DefaultNPC;

import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.net.URI;
import java.util.Arrays;
import java.util.LinkedHashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;

import javax.xml.parsers.ParserConfigurationException;
import javax.xml.parsers.SAXParser;
import javax.xml.parsers.SAXParserFactory;

import org.apache.log4j.Logger;
import org.xml.sax.Attributes;
import org.xml.sax.SAXException;
import org.xml.sax.helpers.DefaultHandler;

public final class NPCsXMLLoader extends DefaultHandler {
    
    /** the logger instance. */
<span class="nc" id="L27">    private static final Logger logger = Logger.getLogger(ItemsXMLLoader.class);</span>
    
    private Class&lt; ? &gt; implementation;
    
    private String name;
    
    private String clazz;
    
    private String subclass;
    
    private String description;
    
    private String text;
    
    private String tileid;
    
    private double speed;
    
    private int sizeWidth;
    
    private int sizeHeight;
    
    /** List of possible sound events. */
    private List&lt;String&gt; sounds;
    
    /** Looped sound effect for moving creature */
    private String movementSound;
    
    private LinkedHashMap&lt;String, LinkedList&lt;String&gt;&gt; npcSays;
    
    private Map&lt;String, String&gt; aiProfiles;
    
    private List&lt;DefaultNPC&gt; list;
    
    private boolean ai;
    
    private boolean says;
    
    private boolean attributes;
    
    private String condition;
    
<span class="nc" id="L69">    NPCsXMLLoader() {</span>
        // hide constructor, use NPCGroupsXMLLoader instead
<span class="nc" id="L71">    }</span>
    
    public List&lt;DefaultNPC&gt; load(final URI uri) throws SAXException {
<span class="nc" id="L74">        list = new LinkedList&lt;DefaultNPC&gt;();</span>
        // Use the default (non-validating) parser
<span class="nc" id="L76">        final SAXParserFactory factory = SAXParserFactory.newInstance();</span>
        try {
            // Parse the input
<span class="nc" id="L79">            final SAXParser saxParser = factory.newSAXParser();</span>
            
<span class="nc" id="L81">            final InputStream is = NPCsXMLLoader.class.getResourceAsStream(uri.getPath());</span>
            
<span class="nc bnc" id="L83" title="All 2 branches missed.">            if (is == null) {</span>
<span class="nc" id="L84">                throw new FileNotFoundException(&quot;cannot find resource '&quot; + uri</span>
                        + &quot;' in classpath&quot;);
            }
            
            try {
<span class="nc" id="L89">                saxParser.parse(is, this);</span>
            } finally {
<span class="nc" id="L91">                is.close();</span>
<span class="nc" id="L92">            }</span>
<span class="nc" id="L93">        } catch (final ParserConfigurationException t) {</span>
<span class="nc" id="L94">            logger.error(t);</span>
<span class="nc" id="L95">        } catch (final IOException e) {</span>
<span class="nc" id="L96">            logger.error(e);</span>
<span class="nc" id="L97">            throw new SAXException(e);</span>
<span class="nc" id="L98">        }</span>
        
<span class="nc" id="L100">        return list;</span>
    }
    
    @Override
    public void startDocument() {
        // do nothing
<span class="nc" id="L106">    }</span>
    
    @Override
    public void endDocument() {
        // do nothing
<span class="nc" id="L111">    }</span>
    
    @Override
    public void startElement(final String namespaceURI, final String lName, final String qName,
            final Attributes attrs) {
<span class="nc" id="L116">        text = &quot;&quot;;</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (qName.equals(&quot;npc&quot;)) {</span>
<span class="nc" id="L118">            name = attrs.getValue(&quot;name&quot;);</span>
<span class="nc" id="L119">            condition = attrs.getValue(&quot;condition&quot;);</span>
<span class="nc" id="L120">            ai = false;</span>
<span class="nc" id="L121">            sounds = new LinkedList&lt;String&gt;();</span>
<span class="nc" id="L122">            npcSays = new LinkedHashMap&lt;String, LinkedList&lt;String&gt;&gt;();</span>
<span class="nc" id="L123">            aiProfiles = new LinkedHashMap&lt;String, String&gt;();</span>
<span class="nc" id="L124">            description = null;</span>
<span class="nc" id="L125">            implementation = null;</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">        } else if (qName.equals(&quot;type&quot;)) {</span>
<span class="nc" id="L127">            clazz = attrs.getValue(&quot;class&quot;);</span>
<span class="nc" id="L128">            subclass = attrs.getValue(&quot;subclass&quot;);</span>

<span class="nc" id="L130">            tileid = &quot;../../tileset/logic/npc/&quot; + attrs.getValue(&quot;tileid&quot;);</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">        } else if (qName.equals(&quot;implementation&quot;)) {</span>

<span class="nc" id="L133">            final String className = attrs.getValue(&quot;class-name&quot;);</span>

            try {
<span class="nc" id="L136">                implementation = Class.forName(className);</span>
<span class="nc" id="L137">            } catch (final ClassNotFoundException ex) {</span>
<span class="nc" id="L138">                logger.error(&quot;Unable to load class: &quot; + className);</span>
<span class="nc" id="L139">            }</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">        } else if (qName.equals(&quot;attributes&quot;)) {</span>
<span class="nc" id="L141">            attributes = true;</span>
<span class="nc bnc" id="L142" title="All 4 branches missed.">        } else if (attributes &amp;&amp; qName.equals(&quot;speed&quot;)) {</span>
<span class="nc" id="L143">            speed = Double.parseDouble(attrs.getValue(&quot;value&quot;));</span>
<span class="nc bnc" id="L144" title="All 4 branches missed.">        } else if (attributes &amp;&amp; qName.equals(&quot;size&quot;)) {</span>
<span class="nc" id="L145">            final String[] size = attrs.getValue(&quot;value&quot;).split(&quot;,&quot;);</span>

<span class="nc" id="L147">            sizeWidth = Integer.parseInt(size[0]);</span>
<span class="nc" id="L148">            sizeHeight = Integer.parseInt(size[1]);</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        } else if (qName.equals(&quot;ai&quot;)) {</span>
<span class="nc" id="L150">            ai = true;</span>
<span class="nc bnc" id="L151" title="All 4 branches missed.">        } else if (ai &amp;&amp; qName.equals(&quot;profile&quot;)) {</span>
<span class="nc" id="L152">            aiProfiles.put(attrs.getValue(&quot;name&quot;), attrs.getValue(&quot;params&quot;));</span>
<span class="nc bnc" id="L153" title="All 4 branches missed.">        } else if (ai &amp;&amp; qName.equals(&quot;says&quot;)) {</span>
<span class="nc" id="L154">            says = true;</span>
<span class="nc bnc" id="L155" title="All 2 branches missed.">        } else if (says) {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">            if (qName.equals(&quot;noise&quot;)) {</span>
<span class="nc" id="L157">                final String states = attrs.getValue(&quot;state&quot;);</span>
<span class="nc" id="L158">                final String value = attrs.getValue(&quot;value&quot;);</span>
<span class="nc" id="L159">                final List&lt;String&gt; keys=Arrays.asList(states.split(&quot; &quot;));</span>
                // no such state in noises, will add it
<span class="nc bnc" id="L161" title="All 2 branches missed.">                for (int i=0; i&lt;keys.size(); i++) {</span>
<span class="nc" id="L162">                    final String key=keys.get(i);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                    if(npcSays.get(key)==null) {</span>
<span class="nc" id="L164">                        final LinkedList&lt;String&gt; ll=new LinkedList&lt;String&gt;();</span>
<span class="nc" id="L165">                        ll.add(value);</span>
<span class="nc" id="L166">                        npcSays.put(key, ll);</span>
                        // no such value in existing state, will add it
<span class="nc bnc" id="L168" title="All 2 branches missed.">                    } else if (npcSays.get(key).indexOf(value)==-1) {</span>
<span class="nc" id="L169">                        npcSays.get(key).add(value);</span>
                        // both state and value already exists
                    } else {
<span class="nc" id="L172">                        logger.warn(&quot;NPCsXMLLoader: NPC (&quot; + name +</span>
                                &quot;): double definition for noise \&quot;&quot; +
                                key + &quot;\&quot; (&quot; + value + &quot;)&quot;);
                    }
                }
<span class="nc bnc" id="L177" title="All 2 branches missed.">            } else if (qName.equals(&quot;sound&quot;)) {</span>
<span class="nc" id="L178">                sounds.add(attrs.getValue(&quot;value&quot;));</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">            } else if (qName.equals(&quot;movement&quot;)) {</span>
<span class="nc" id="L180">                movementSound = attrs.getValue(&quot;value&quot;);</span>
            }
        }
<span class="nc" id="L183">    }</span>
    
    @Override
    public void endElement(final String namespaceURI, final String sName, final String qName) {
<span class="nc bnc" id="L187" title="All 2 branches missed.">        if (qName.equals(&quot;npc&quot;)) {</span>
            
<span class="nc bnc" id="L189" title="All 2 branches missed.">            if (!XMLUtil.checkCondition(condition)) {</span>
<span class="nc" id="L190">                return;</span>
            }
            
<span class="nc bnc" id="L193" title="All 2 branches missed.">            if (!tileid.contains(&quot;:&quot;)) {</span>
<span class="nc" id="L194">                logger.error(&quot;Corrupt XML file: Bad tileid for NPC (&quot; + name + &quot;)&quot;);</span>
<span class="nc" id="L195">                return;</span>
            }
            
<span class="nc" id="L198">            final DefaultNPC npc = new DefaultNPC(clazz, subclass, tileid);</span>
            
<span class="nc" id="L200">            npc.setRPStats(speed);</span>
<span class="nc" id="L201">            npc.setSize(sizeWidth, sizeHeight);</span>
            
<span class="nc" id="L203">            npc.setAIProfiles(aiProfiles);</span>
<span class="nc" id="L204">            npc.setNoiseLines(npcSays);</span>
<span class="nc" id="L205">            npc.setDescription(description);</span>
<span class="nc" id="L206">            npc.setNPCSounds(sounds);</span>
<span class="nc" id="L207">            npc.setNPCMovementSound(movementSound);</span>
<span class="nc" id="L208">            list.add(npc);</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">        } else if (qName.equals(&quot;attributes&quot;)) {</span>
<span class="nc" id="L210">            attributes = false;</span>
<span class="nc bnc" id="L211" title="All 4 branches missed.">        } else if (ai &amp;&amp; qName.equals(&quot;says&quot;)) {</span>
<span class="nc" id="L212">            says = false;</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">        } else if (qName.equals(&quot;ai&quot;)) {</span>
<span class="nc" id="L214">            ai = false;</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">        } else if (qName.equals(&quot;description&quot;)) {</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">            if (text != null) {</span>
<span class="nc" id="L217">                description = text.trim();</span>
            }
<span class="nc" id="L219">            text = &quot;&quot;;</span>
        }
<span class="nc" id="L221">    }</span>
    
    @Override
    public void characters(final char[] buf, final int offset, final int len) {
<span class="nc" id="L225">        text = text + (new String(buf, offset, len)).trim() + &quot; &quot;;</span>
<span class="nc" id="L226">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>