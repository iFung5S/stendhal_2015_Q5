<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>StyledSplitPaneUI.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.client.gui.styled</a> &gt; <span class="el_source">StyledSplitPaneUI.java</span></div><h1>StyledSplitPaneUI.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.client.gui.styled;

import java.awt.Component;
import java.awt.Dimension;
import java.awt.Graphics;
import java.awt.Insets;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;

import javax.swing.JComponent;
import javax.swing.JSplitPane;
import javax.swing.SwingUtilities;
import javax.swing.border.Border;
import javax.swing.plaf.ComponentUI;
import javax.swing.plaf.basic.BasicSplitPaneDivider;
import javax.swing.plaf.basic.BasicSplitPaneUI;

/**
 * A SplitPaneUI implementation for drawing pixmap styled JSplitPanes.
 */
public class StyledSplitPaneUI extends BasicSplitPaneUI {
	private final Style style;
	
	// Required by UIManager
	public static ComponentUI createUI(JComponent pane) {
		// BasicScrollPaneUI instances can not be shared
<span class="nc" id="L39">		return new StyledSplitPaneUI(StyleUtil.getStyle());</span>
	}
	
	/**
	 * Create a new StyledSplitPaneUI.
	 * 
	 * @param style pixmap style
	 */
<span class="nc" id="L47">	public StyledSplitPaneUI(Style style) {</span>
<span class="nc" id="L48">		this.style = style;</span>
<span class="nc" id="L49">	}</span>
	
	@Override
	public BasicSplitPaneDivider createDefaultDivider() {
<span class="nc" id="L53">		return new StyledSplitPaneDivider(this, style);</span>
	}
	
	@Override
	public void installUI(JComponent pane) {
<span class="nc" id="L58">		super.installUI(pane);</span>
<span class="nc" id="L59">		pane.setBorder(style.getBorderDown());</span>
<span class="nc" id="L60">	}</span>
	
	/*
	 * BasicSplitPaneUI has a bug that the components' maximum sizes are
	 * ignored. The following overrides are a workaround to it.
	 */
	
	// part of the divider location bug workaround
	@Override
	public int getMaximumDividerLocation(JSplitPane pane) {
<span class="nc" id="L70">		int rightMax = super.getMaximumDividerLocation(pane);</span>
<span class="nc" id="L71">		Component first = pane.getLeftComponent();</span>
<span class="nc bnc" id="L72" title="All 4 branches missed.">		if ((first != null) &amp;&amp; first.isVisible()) {</span>
<span class="nc" id="L73">			Dimension maxSize = first.getMaximumSize();</span>
<span class="nc" id="L74">			Insets insets = pane.getInsets();</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">			if (pane.getOrientation() == JSplitPane.HORIZONTAL_SPLIT) {</span>
<span class="nc" id="L76">				rightMax = Math.min(rightMax, maxSize.width + insets.left);</span>
			} else {
<span class="nc" id="L78">				rightMax = Math.min(rightMax, maxSize.height + insets.top);</span>
			}
			// Sanity check. Must be in this method, not in
			// getMinimumDividerLocation() (see below)
<span class="nc" id="L82">			rightMax = Math.max(rightMax, getMinimumDividerLocation(pane));</span>
		}

<span class="nc" id="L85">		return rightMax;</span>
	}
	
	// Another bug workaround. For whatever reason the left component is given
	// a preferred size that is too high by the amount of the divider width.
	@Override
	public Dimension getPreferredSize(JComponent comp) {
<span class="nc" id="L92">		Dimension rval = super.getPreferredSize(comp);</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">		if (getSplitPane().getOrientation() == JSplitPane.HORIZONTAL_SPLIT) {</span>
<span class="nc" id="L94">			rval.width -= getSplitPane().getDividerSize();</span>
		} else {
<span class="nc" id="L96">			rval.height -= getSplitPane().getDividerSize();</span>
		}
<span class="nc" id="L98">		return rval;</span>
	}

	// part of the divider location bug workaround
	@Override
	public int getMinimumDividerLocation(JSplitPane pane) {
<span class="nc" id="L104">		int leftMin = super.getMinimumDividerLocation(pane);</span>
<span class="nc" id="L105">		Component second = pane.getRightComponent();</span>
<span class="nc bnc" id="L106" title="All 4 branches missed.">		if ((second != null) &amp;&amp; second.isVisible()) {</span>
<span class="nc" id="L107">			Dimension paneSize = splitPane.getSize();</span>
<span class="nc" id="L108">			Dimension maxSize = second.getMaximumSize();</span>
<span class="nc" id="L109">			Insets insets = pane.getInsets();</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">			if (pane.getOrientation() == JSplitPane.HORIZONTAL_SPLIT) {</span>
<span class="nc" id="L111">				leftMin = Math.max(leftMin, paneSize.width - insets.right - maxSize.width);</span>
			} else {
<span class="nc" id="L113">				leftMin = Math.max(leftMin, paneSize.height - insets.bottom - maxSize.height);</span>
			}
			/*
			 * To avoid inconsistency with the maximum location, it would seem
			 * reasonable to do:
			 * 
			 *	leftMin = Math.min(leftMin, getMaximumDividerLocation(pane));
			 *
			 * however, the parent already calls getMinimumDividerLocation()
			 * in getMaximumDividerLocation(), so that would be a good way
			 * to get a stack overflow.
			 */
		}
<span class="nc" id="L126">		return leftMin;</span>
	}
	
	// part of the divider location bug workaround
	@Override
	public void setDividerLocation(JSplitPane pane, int location) {
		// Override the stupidity
<span class="nc" id="L133">		int newLocation = Math.min(location, getMaximumDividerLocation(pane));</span>
<span class="nc" id="L134">		newLocation = Math.max(newLocation, getMinimumDividerLocation(pane));</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">		if (newLocation != location) {</span>
<span class="nc" id="L136">			pane.setDividerLocation(newLocation);</span>
		} else {
<span class="nc" id="L138">			super.setDividerLocation(pane, location);</span>
		}
		
		/*
		 * It seems that JSplitPane fails to set lastDividerLocation properly
		 * at component resizes if the divider location is too high for the new
		 * size. Set it here, so that after resizes getLastDividerLocation()
		 * returns the location before resizing, rather than the one before
		 * that. Needs to be pushed to the end of the event queue, because
		 * JSplitPane sets the last location after calling
		 * ui.setDividerLocation().
		 */
<span class="nc" id="L150">		final int lastLocation = newLocation;</span>
<span class="nc" id="L151">		SwingUtilities.invokeLater(new Runnable() {</span>
			@Override
			public void run() {
<span class="nc" id="L154">				getSplitPane().setLastDividerLocation(lastLocation);</span>
<span class="nc" id="L155">			}</span>
		});
<span class="nc" id="L157">	}</span>
	
	// part of the divider location bug workaround
	@Override
	protected void dragDividerTo(int location) {
		// Override the stupidity
<span class="nc" id="L163">		location = Math.min(location, getMaximumDividerLocation(getSplitPane()));</span>
<span class="nc" id="L164">		location = Math.max(location, getMinimumDividerLocation(getSplitPane()));</span>
<span class="nc" id="L165">		super.dragDividerTo(location);</span>
<span class="nc" id="L166">	}</span>
	
	/**
	 * A split pane divider drawn with style.
	 */
	private static class StyledSplitPaneDivider extends BasicSplitPaneDivider {
		/**
		 * serial version uid
		 */
		private static final long serialVersionUID = 3799692779880585757L;

		private final Style style;
		
		/**
		 * Create a new StyledSplitPaneDivider.
		 * 
		 * @param ui UI delegate of the parent &lt;code&gt;JSplitPane&lt;/code&gt;
		 * @param style drawing style
		 */
		public StyledSplitPaneDivider(StyledSplitPaneUI ui, Style style) {
<span class="nc" id="L186">			super(ui);</span>
<span class="nc" id="L187">			this.style = style;</span>
<span class="nc" id="L188">			addMouseListener(new DividerMouseListener(this));</span>
<span class="nc" id="L189">		}</span>
		
		// There's no paintComponent. This is an awt widget.
		@Override
		public void paint(Graphics g) {
<span class="nc" id="L194">			StyleUtil.fillBackground(style, g, 0, 0, getWidth(), getHeight());</span>
			
			// Ribbing
<span class="nc" id="L197">			Insets insets = style.getBorder().getBorderInsets(this);</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">			if (splitPane.getOrientation() == JSplitPane.VERTICAL_SPLIT) {</span>
<span class="nc" id="L199">				int y = insets.top + 1;</span>
<span class="nc" id="L200">				int maxY = getHeight() - insets.bottom - 1;</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">				while (y &lt; maxY) {</span>
<span class="nc" id="L202">					g.setColor(style.getShadowColor());</span>
<span class="nc" id="L203">					g.drawLine(5, y, getWidth() - 6, y);</span>
<span class="nc" id="L204">					y++;</span>
<span class="nc" id="L205">					g.setColor(style.getHighLightColor());</span>
<span class="nc" id="L206">					g.drawLine(5, y, getWidth() - 6, y);</span>
<span class="nc" id="L207">					y++;</span>
				}
<span class="nc" id="L209">			} else {</span>
<span class="nc" id="L210">				int x = insets.left + 1;</span>
<span class="nc" id="L211">				int maxX = getWidth() - insets.right - 1;</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">				while (x &lt; maxX) {</span>
<span class="nc" id="L213">					g.setColor(style.getShadowColor());</span>
<span class="nc" id="L214">					g.drawLine(x, 5, x, getHeight() - 6);</span>
<span class="nc" id="L215">					x++;</span>
<span class="nc" id="L216">					g.setColor(style.getHighLightColor());</span>
<span class="nc" id="L217">					g.drawLine(x, 5, x, getHeight() - 6);</span>
<span class="nc" id="L218">					x++;</span>
				}
			}
			
			// highlighting
<span class="nc bnc" id="L223" title="All 2 branches missed.">			if (isMouseOver()) {</span>
<span class="nc" id="L224">				highLightBorder(g);</span>
			} else {
<span class="nc" id="L226">				paintBorder(g);</span>
			}
<span class="nc" id="L228">		}</span>
		
		/**
		 * Paint the handle using the normal border. (No highlighting)
		 * 
		 * @param g graphics
		 */
		private void paintBorder(Graphics g) {
<span class="nc" id="L236">			int left = 0;</span>
<span class="nc" id="L237">			int right = 0;</span>
<span class="nc" id="L238">			int top = 0;</span>
<span class="nc" id="L239">			int bottom = 0;</span>
<span class="nc" id="L240">			Border border = style.getBorder();</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">			if (orientation == JSplitPane.HORIZONTAL_SPLIT) {</span>
<span class="nc" id="L242">				top = border.getBorderInsets(this).top;</span>
<span class="nc" id="L243">				bottom = border.getBorderInsets(this).bottom;</span>
			} else {
<span class="nc" id="L245">				left = border.getBorderInsets(this).left;</span>
<span class="nc" id="L246">				right = border.getBorderInsets(this).right;</span>
			}
<span class="nc" id="L248">			border.paintBorder(this, g, 0 - left, 0 - top, </span>
				getWidth() + right + left, getHeight() + top + bottom);
<span class="nc" id="L250">		}</span>
		
		/**
		 * Paint highlighted borders. Meanot to be used at mouseover.
		 * 
		 * @param g graphics
		 */
		private void highLightBorder(Graphics g) {
<span class="nc" id="L258">			g.setColor(style.getHighLightColor());</span>
			
<span class="nc" id="L260">			Border border = style.getBorder();</span>
<span class="nc bnc" id="L261" title="All 2 branches missed.">			if (orientation == JSplitPane.HORIZONTAL_SPLIT) {</span>
<span class="nc" id="L262">				int width = border.getBorderInsets(this).left;</span>
<span class="nc" id="L263">				g.fillRect(0, 0, width, getHeight());</span>
<span class="nc" id="L264">				g.fillRect(getWidth() - width, 0, width, getHeight());</span>
<span class="nc" id="L265">			} else {</span>
<span class="nc" id="L266">				int height = border.getBorderInsets(this).top;</span>
<span class="nc" id="L267">				g.fillRect(0, 0, getWidth(), height);</span>
<span class="nc" id="L268">				g.fillRect(0, getHeight() - height, getWidth(), height);</span>
			}
<span class="nc" id="L270">		}</span>
		
		/**
		 * Listener for mouse entering and leaving messages. Otherwise
		 * the divider does not get repainted at mouseover, unlike
		 * most other components.
		 */
		private static class DividerMouseListener extends MouseAdapter {
			private final StyledSplitPaneDivider divider;
			
<span class="nc" id="L280">			public DividerMouseListener(StyledSplitPaneDivider divider) {</span>
<span class="nc" id="L281">				this.divider = divider;</span>
<span class="nc" id="L282">			}</span>

			@Override
			public void mouseEntered(MouseEvent e) {
<span class="nc" id="L286">				divider.repaint();</span>
<span class="nc" id="L287">			}</span>

			@Override
			public void mouseExited(MouseEvent e) {
<span class="nc" id="L291">				divider.repaint();</span>
<span class="nc" id="L292">			}</span>
		}
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>