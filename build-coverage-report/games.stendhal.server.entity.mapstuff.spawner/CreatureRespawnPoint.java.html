<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CreatureRespawnPoint.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.entity.mapstuff.spawner</a> &gt; <span class="el_source">CreatureRespawnPoint.java</span></div><h1>CreatureRespawnPoint.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                      (C) Copyright 2003 - Marauroa                      *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.entity.mapstuff.spawner;

import java.util.LinkedList;
import java.util.List;
import java.util.Observer;

import org.apache.log4j.Logger;

import games.stendhal.common.MathHelper;
import games.stendhal.common.Rand;
import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.core.engine.StendhalRPZone;
import games.stendhal.server.core.events.TurnListener;
import games.stendhal.server.core.rp.StendhalRPAction;
import games.stendhal.server.entity.creature.Creature;

/**
 * RespawnPoints are points at which creatures can appear. Several creatures can
 * be spawned, until a maximum has been reached (note that this maximum is
 * usually 1); then the RespawnPoint will stop spawning creatures until at least
 * one of the creatures has died. It will then continue to spawn creatures. A
 * certain time must pass between respawning creatures; this respawn time is
 * usually dependent of the type of the creatures that are spawned.
 * 
 * Each respawn point can only spawn one type of creature. The Prototype design
 * pattern is used; the &lt;i&gt;prototypeCreature&lt;/i&gt; will be copied to create new
 * creatures.
 */
public class CreatureRespawnPoint implements TurnListener {
	/** longest possible respawn time in turns. half a year - should be longer than the 
	 * server is up in one phase */
	private static final int MAX_RESPAWN_TIME = 200 * 60 * 24 * 30 * 6;
	/** minimum respawn time in turns. about 10s */
	private static final int MIN_RESPAWN_TIME = 33;

	/** the logger instance. */
<span class="fc" id="L49">	private static final Logger logger = Logger.getLogger(CreatureRespawnPoint.class);</span>

	protected final StendhalRPZone zone;
	
<span class="fc" id="L53">	private LinkedList&lt;Observer&gt; observers = new LinkedList&lt;Observer&gt;();</span>
	
	protected final int x;

	protected final int y;

	/**
	 * The number of creatures spawned here that can exist at the same time.
	 */
	private final int maximum;

	/**
	 * This is the prototype; it will be copied to create new creatures that
	 * will be spawned here.
	 */
	protected Creature prototypeCreature;

	/** All creatures that were spawned here and that are still alive. */
	protected final List&lt;Creature&gt; creatures;

	/**
	 * Stores if this respawn point is currently waiting for a creature to
	 * respawn.
	 */
	protected boolean respawning;

	/**
	 * How long it takes to respawn a creature. This defaults to the creature's
	 * default respawn time. It is in turns.
	 */
	private int respawnTime;

	/**
	 * Creates a new RespawnPoint.
	 * 
	 * @param zone
	 * @param x
	 * @param y
	 * @param creature
	 *            The prototype creature
	 * @param maximum
	 *            The number of creatures spawned here that can exist at the
	 *            same time
	 */
	public CreatureRespawnPoint(final StendhalRPZone zone, final int x, final int y,
<span class="fc" id="L98">			final Creature creature, final int maximum) {</span>
<span class="fc" id="L99">		this.zone = zone;</span>
<span class="fc" id="L100">		this.x = x;</span>
<span class="fc" id="L101">		this.y = y;</span>
<span class="fc" id="L102">		this.prototypeCreature = creature;</span>
<span class="fc" id="L103">		this.maximum = maximum;</span>

<span class="fc" id="L105">		this.respawnTime = creature.getRespawnTime();</span>
<span class="fc" id="L106">		this.creatures = new LinkedList&lt;Creature&gt;();</span>

<span class="fc" id="L108">		respawning = true;</span>
		
		// don't respawn in next turn!
<span class="fc" id="L111">		SingletonRepository.getTurnNotifier().notifyInTurns(calculateNextRespawnTurn(), this); </span>
<span class="fc" id="L112">	}</span>
	
	/**
	 * Creates a new RespawnPoint.
	 * 
	 * @param zone
	 * @param x
	 * @param y
	 * @param creature
	 *            The prototype creature
	 * @param maximum
	 *            The number of creatures spawned here that can exist at the
	 *            same time
	 * @param observer 
	 */
	public CreatureRespawnPoint(StendhalRPZone zone, int x,
			int y, Creature creature, int maximum, final Observer observer) {
<span class="nc" id="L129">		this(zone, x, y, creature, maximum);</span>
<span class="nc" id="L130">		this.observers.add(observer);</span>
<span class="nc" id="L131">	}</span>

	public Creature getPrototypeCreature() {
<span class="fc" id="L134">		return prototypeCreature;</span>
	}

	/**
	 * Sets the time it takes to respawn a creature. Note that this value
	 * defaults to the creature's default respawn time.
	 * @param respawnTime the middled delay between spawns in turns
	 */
	public void setRespawnTime(final int respawnTime) {
<span class="nc" id="L143">		this.respawnTime = respawnTime;</span>
<span class="nc" id="L144">	}</span>

	/**
	 * Notifies this respawn point about the death of a creature that was
	 * spawned here.
	 * 
	 * @param dead
	 *            The creature that has died
	 */
	public void notifyDead(final Creature dead) {

<span class="nc bnc" id="L155" title="All 2 branches missed.">		if (!respawning) {</span>
			// start respawning a new creature
<span class="nc" id="L157">			respawning = true;</span>
<span class="nc" id="L158">			SingletonRepository.getTurnNotifier().notifyInTurns(</span>
					calculateNextRespawnTurn(), this);
		}

<span class="nc" id="L162">		creatures.remove(dead);</span>
<span class="nc" id="L163">	}</span>

	/**
	 * Is called when a new creature is ready to pop up.
	 * 
	 * @see games.stendhal.server.core.events.TurnListener#onTurnReached(int)
	 */
	@Override
	public void onTurnReached(final int currentTurn) {
<span class="fc" id="L172">		respawn();</span>

		// Is this all or should we spawn more creatures?
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">		if (creatures.size() == maximum) {</span>
<span class="fc" id="L176">			respawning = false;</span>
		} else {
<span class="nc" id="L178">			SingletonRepository.getTurnNotifier().notifyInTurns(</span>
					calculateNextRespawnTurn(), this);
		}
<span class="fc" id="L181">	}</span>
	
	/**
	 * Calculates a randomized respawn time.
	 * @return the amount of turns calculated
	 */
	protected int calculateNextRespawnTurn() {
<span class="fc" id="L188">		return MathHelper.clamp(Rand.randExponential(respawnTime), MIN_RESPAWN_TIME, MAX_RESPAWN_TIME);</span>
	}

	/**
	 * Checks how many creatures which were spawned here are currently alive.
	 * 
	 * @return amount of living creatures
	 */
	public int size() {
<span class="nc" id="L197">		return creatures.size();</span>
	}
	
	/**
	 * function returns X coord of this respawn point
	 * @return - x coord
	 */
	public int getX() {
<span class="nc" id="L205">		return this.x;</span>
	}
	
	/**
	 * function returns Y coord of this respawn point
	 * @return - y coord
	 */
	public int getY() {
<span class="nc" id="L213">		return this.y;</span>
	}
	
	/**
	 * Set the prototype creature for the spawner.
	 * 
	 * @param creature prototype creature 
	 */
    public void setPrototypeCreature(final Creature creature) {
<span class="nc" id="L222">    	this.prototypeCreature = creature;</span>
<span class="nc" id="L223">    }</span>
    
	/**
	 * add observer to observers list
	 * @param observer - observer to add
	 */
	public void addObserver(final Observer observer) {
<span class="nc" id="L230">		observers.add(observer);</span>
<span class="nc" id="L231">	}</span>
	
	/**
	 * remove observer from list
	 * @param observer - observer to remove
	 */
	public void removeObserver(final Observer observer) {
<span class="nc" id="L238">		observers.remove(observer);</span>
<span class="nc" id="L239">	}</span>
	
	/**
	 * return zone where respawn point placed
	 * @return - zone where respawn point placed
	 */
	public StendhalRPZone getZone() {
<span class="nc" id="L246">		return this.zone;</span>
	}
    
	/**
	 * Pops up a new creature.
	 */
	protected void respawn() {

		try {
			// clone the prototype creature
<span class="fc" id="L256">			final Creature newentity = prototypeCreature.getNewInstance();</span>

			// A bit of randomization to make Joan and Snaketails a bit happier.
			// :)
<span class="fc" id="L260">			newentity.setAtk(Rand.randGaussian(newentity.getAtk(),</span>
					newentity.getAtk() / 10));
<span class="fc" id="L262">			newentity.setDef(Rand.randGaussian(newentity.getDef(),</span>
					newentity.getDef() / 10));
			
<span class="fc" id="L265">			newentity.registerObjectsForNotification(observers);</span>
			
<span class="pc bpc" id="L267" title="1 of 2 branches missed.">			if (StendhalRPAction.placeat(zone, newentity, x, y)) {</span>
<span class="fc" id="L268">				newentity.init();</span>
<span class="fc" id="L269">				newentity.setRespawnPoint(this);</span>

<span class="fc" id="L271">				creatures.add(newentity);</span>
			} else {
				// Could not place the creature anywhere. 
				// Treat it like it just had died.
<span class="nc" id="L275">				notifyDead(newentity);</span>
<span class="nc" id="L276">				logger.warn(&quot;Could not respawn &quot; + newentity.getName() + &quot; near &quot; </span>
						+ zone.getName() + &quot; &quot; + x + &quot; &quot; + y);
			}
<span class="nc" id="L279">		} catch (final Exception e) {</span>
<span class="nc" id="L280">			logger.error(&quot;error respawning entity &quot; + prototypeCreature, e);</span>
<span class="fc" id="L281">		}</span>
<span class="fc" id="L282">	}</span>
	
	/**
	 * Pops up a new creature.
	 */
	public void spawnNow() {
<span class="nc bnc" id="L288" title="All 2 branches missed.">		if (creatures.size() &lt; maximum) {</span>
<span class="nc" id="L289">			SingletonRepository.getTurnNotifier().dontNotify(this);</span>
			//SingletonRepository.getTurnNotifier().notifyInTurns(1, this);
<span class="nc" id="L291">			onTurnReached(0);</span>
		}
<span class="nc" id="L293">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>