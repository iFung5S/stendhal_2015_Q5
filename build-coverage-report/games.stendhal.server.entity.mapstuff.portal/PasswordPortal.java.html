<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PasswordPortal.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.entity.mapstuff.portal</a> &gt; <span class="el_source">PasswordPortal.java</span></div><h1>PasswordPortal.java</h1><pre class="source lang-java linenums">/***************************************************************************
 *                (C) Copyright 2013-2013 - Faiumoni e. V.                 *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.entity.mapstuff.portal;

import games.stendhal.server.entity.RPEntity;
import games.stendhal.server.entity.player.Player;

import java.util.LinkedList;
import java.util.List;

import org.apache.log4j.Logger;

/**
 * a portal which requires a password to pass through
 */

// PasswordPortal does not extend AccessCheckingPortal because they are not &quot;used&quot;.
public class PasswordPortal extends Portal {
    
    // Logger instance
<span class="nc" id="L30">    private static final Logger logger = Logger.getLogger(PasswordPortal.class);</span>
    
    private String requiredPassword;
    private String acceptedMessage;
    private String rejectedMessage;
    
<span class="nc" id="L36">    private int listeningRadius = 1;</span>

    /**
     * Creates a default PasswordPortal
     */
<span class="nc" id="L41">    public PasswordPortal() {</span>
<span class="nc" id="L42">    }</span>
    /**
     * creates a portal which requires a password to be said by the player
     *
     * @param
     *      password password to say
     */
<span class="nc" id="L49">    public PasswordPortal(final String password) {</span>
<span class="nc" id="L50">        this.requiredPassword = password;</span>
<span class="nc" id="L51">    }</span>
    
    /**
     * gets the password
     *
     * @return
     *      password
     */
    public String getPassword() {
<span class="nc" id="L60">        return this.requiredPassword;</span>
    }

    /**
     * Finds players nearby that have spoken.
     * 
     * @return
     *      List of players
     */
    private List&lt;Player&gt; getNearbyPlayersThatHaveSpoken() {
<span class="nc" id="L70">        final int x = getX();</span>
<span class="nc" id="L71">        final int y = getY();</span>

<span class="nc" id="L73">        final List&lt;Player&gt; players = new LinkedList&lt;Player&gt;();</span>

<span class="nc bnc" id="L75" title="All 2 branches missed.">        for (final Player player : getZone().getPlayers()) {</span>
<span class="nc" id="L76">            final int px = player.getX();</span>
<span class="nc" id="L77">            final int py = player.getY();</span>

<span class="nc bnc" id="L79" title="All 2 branches missed.">            if (player.has(&quot;text&quot;)) {</span>
<span class="nc" id="L80">                int dx = px - x;</span>
<span class="nc" id="L81">                int dy = py - y;</span>

<span class="nc bnc" id="L83" title="All 4 branches missed.">                if (Math.abs(dx)&lt;listeningRadius &amp;&amp; Math.abs(dy)&lt;listeningRadius) { // check rectangular area</span>
//              if (dx*dx + dy*dy &lt; range*range) { // optionally we could check a circular area
<span class="nc" id="L85">                    players.add(player);</span>
                }
            }
<span class="nc" id="L88">        }</span>

<span class="nc" id="L90">        return players;</span>
    }
    
    /**
     * gets the reject message
     *
     * @return
     *      reject message
     */
    public String getRejectedMessage() {
<span class="nc" id="L100">        return this.rejectedMessage;</span>
    }
    
    @Override
	public void logic() {
<span class="nc" id="L105">        List&lt;Player&gt; players = getNearbyPlayersThatHaveSpoken();</span>
        
        String text;
        
<span class="nc bnc" id="L109" title="All 2 branches missed.">        for (Player player : players) {</span>
<span class="nc" id="L110">            text = player.get(&quot;text&quot;);</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">            if (text.equals(requiredPassword)) {</span>
<span class="nc bnc" id="L112" title="All 2 branches missed.">                if (acceptedMessage != null) {</span>
<span class="nc" id="L113">                    player.sendPrivateText(acceptedMessage);</span>
                }
<span class="nc" id="L115">                usePortal(player);</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">            } else if (rejectedMessage != null) {</span>
<span class="nc" id="L117">                player.sendPrivateText(rejectedMessage);</span>
            }
<span class="nc" id="L119">        }</span>
<span class="nc" id="L120">    }</span>
    
    /**
     * Override so portal does not get &quot;used&quot;
     */
    @Override
    public boolean onUsed(final RPEntity user) {
<span class="nc bnc" id="L127" title="All 2 branches missed.">        if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L128">            logger.debug(&quot;Using this portal has been disabled.&quot;);</span>
        }
<span class="nc" id="L130">        return false;</span>
    }

    /**
     * Optional message to be sent to player when portal is successfully used
     * 
     * @param message
     *      Message to be sent
     */
    public void setAcceptedMessage(final String message) {
<span class="nc" id="L140">        this.acceptedMessage = message;</span>
<span class="nc" id="L141">    }</span>

    /**
     * 
     * @param radius
     *      Radius at which portal will listen for player's speech
     */
    public void setListeningRadius(int radius) {
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (radius &lt;= 0) {</span>
<span class="nc" id="L150">            radius = 1; // The portal must have at least 1 listening square</span>
        }
<span class="nc" id="L152">        this.listeningRadius = radius;</span>
<span class="nc" id="L153">    }</span>

    /**
     * sets the required password
     *
     * @param password
     *      new password
     */
    public void setPassword(final String password) {
<span class="nc" id="L162">        this.requiredPassword = password;</span>
<span class="nc" id="L163">    }</span>
    
    /**
     * sets the reject message
     *
     * @param message
     *      message informing the player about the failed condition
     */
    public void setRejectedMessage(final String message) {
<span class="nc" id="L172">        this.rejectedMessage = message;</span>
<span class="nc" id="L173">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>