<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>PoisonAttacker.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.entity.status</a> &gt; <span class="el_source">PoisonAttacker.java</span></div><h1>PoisonAttacker.java</h1><pre class="source lang-java linenums">/***************************************************************************
 *                   (C) Copyright 2003-2013 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.entity.status;

import games.stendhal.common.NotificationType;
import games.stendhal.common.Rand;
import games.stendhal.common.constants.Testing;
import games.stendhal.common.grammar.Grammar;
import games.stendhal.server.core.engine.GameEvent;
import games.stendhal.server.entity.RPEntity;
import games.stendhal.server.entity.item.ConsumableItem;
import games.stendhal.server.entity.player.Player;

import org.apache.log4j.Logger;

/**
 * a status attacker for poison
 */
public class PoisonAttacker extends StatusAttacker {
	/** The logger instance */
<span class="fc" id="L30">	private static final Logger logger = Logger.getLogger(PoisonAttacker.class);</span>

	/**
	 * PoisonAttacker
	 *
	 * @param probability probability
	 * @param poison poison item
	 */
	public PoisonAttacker(final int probability, final ConsumableItem poison) {
<span class="fc" id="L39">		super(new PoisonStatus(poison.getAmount(), poison.getFrecuency(), poison.getRegen()), probability);</span>
<span class="fc" id="L40">	}</span>

	@Override
	public void onAttackAttempt(RPEntity target, RPEntity attacker) {

<span class="fc" id="L45">		double myProbability = getProbability();</span>

		// Create a temporary instance to adjust without affecting entity's
		// built-in probability.
<span class="fc" id="L49">		Double actualProbability = myProbability;</span>
		
<span class="fc" id="L51">		String resistAttribute = &quot;resist_poisoned&quot;;</span>
<span class="pc bpc" id="L52" title="1 of 2 branches missed.">		if (target.has(resistAttribute)) {</span>
<span class="nc" id="L53">			Double probabilityAdjust = 1.0 - target.getDouble(resistAttribute);</span>
			
<span class="nc bnc" id="L55" title="All 2 branches missed.">			if (logger.isDebugEnabled()) {</span>
<span class="nc" id="L56">				logger.info(&quot;Adjusting POISONED status infliction resistance: &quot;</span>
						+ Double.toString(myProbability) + &quot; * &quot;
						+ Double.toString(probabilityAdjust) + &quot; = &quot;
						+ Double.toString(myProbability * probabilityAdjust));
			}
			
<span class="nc" id="L62">			actualProbability = myProbability * probabilityAdjust;</span>
		}
		
		// DEBUG
<span class="pc bpc" id="L66" title="2 of 4 branches missed.">		if (logger.isDebugEnabled() || Testing.DEBUG) {</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">			if (target.has(resistAttribute)) {</span>
<span class="nc" id="L68">				double resistValue = target.getDouble(resistAttribute);</span>
<span class="nc" id="L69">				String debugString1 = attacker.getName() + &quot; &quot;</span>
						+ &quot;poison probability: &quot;
						+ Double.toString(myProbability);
<span class="nc" id="L72">				String debugString2 = target.getName() + &quot;poison resistance: &quot;</span>
						+ Double.toString(resistValue);
<span class="nc" id="L74">				String debugString3 = &quot;New probability: &quot;</span>
						+ Double.toString(actualProbability)
						+ &quot; (&quot; + Double.toString(myProbability) + &quot; * (1.0 - &quot;
						+ Double.toString(resistValue) + &quot;))&quot;;
<span class="nc" id="L78">				logger.info(debugString1);</span>
<span class="nc" id="L79">				logger.info(debugString2);</span>
<span class="nc" id="L80">				logger.info(debugString3);</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">				if (target instanceof Player) {</span>
<span class="nc" id="L82">					Player player = (Player)target;</span>
<span class="nc" id="L83">					player.sendPrivateText(NotificationType.SERVER,</span>
							debugString1 + &quot;\n&quot; + debugString2 + &quot;\n&quot;
							+ debugString3);
				}
			}
		}
		
<span class="fc" id="L90">		final int roll = Rand.roll1D100();</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">		if (roll &lt;= actualProbability) {</span>
<span class="pc bpc" id="L92" title="1 of 2 branches missed.">			if (target.getStatusList().inflictStatus((Status) getStatus().clone(), attacker)) {</span>
<span class="fc" id="L93">				new GameEvent(attacker.getName(), &quot;poison&quot;, target.getName()).raise();</span>
<span class="fc" id="L94">				target.sendPrivateText(&quot;You have been poisoned by &quot; + Grammar.a_noun(attacker.getName()) + &quot;.&quot;);</span>
			}
		}
<span class="fc" id="L97">	}</span>

	@Override
	public void onHit(RPEntity target, RPEntity attacker, int damage) {
		// do nothing, especially do not process the logic of the super class
<span class="nc" id="L102">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>