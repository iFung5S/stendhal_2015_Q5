<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>OccupantArea.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.entity.mapstuff.area</a> &gt; <span class="el_source">OccupantArea.java</span></div><h1>OccupantArea.java</h1><pre class="source lang-java linenums">/*
 * @(#) src/games/stendhal/server/entity/area/OccupantArea.java
 *
 * $Id$
 */

package games.stendhal.server.entity.mapstuff.area;

import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.core.engine.StendhalRPZone;
import games.stendhal.server.core.events.MovementListener;
import games.stendhal.server.core.events.TurnListener;
import games.stendhal.server.entity.ActiveEntity;
import games.stendhal.server.entity.RPEntity;
import games.stendhal.server.entity.player.Player;

import java.awt.geom.Rectangle2D;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.List;

import marauroa.common.game.IRPZone;

/**
 * An base area that performs actions on RPEntity's that are entering, leaving,
 * moving in, or standing in it's space.
 */
public class OccupantArea extends AreaEntity implements MovementListener,
		TurnListener {

	/**
	 * How often an action is done while stationary (in turns).
	 */
	protected int interval;

	/**
	 * Applies only to players.
	 */
	protected boolean playersOnly;

	/**
	 * A list of entities [potentially] occupying this area.
	 */
	protected List&lt;RPEntity.ID&gt; targets;

	/**
	 * Create an occupant area.
	 * 
	 * @param width
	 *            Width of this area
	 * @param height
	 *            Height of this area
	 * @param interval
	 *            Standing action interval.
	 */
	public OccupantArea(final int width, final int height, final int interval) {
<span class="nc" id="L57">		super(width, height);</span>

<span class="nc" id="L59">		this.interval = interval;</span>

<span class="nc" id="L61">		playersOnly = false;</span>
<span class="nc" id="L62">		targets = new LinkedList&lt;RPEntity.ID&gt;();</span>
<span class="nc" id="L63">	}</span>

	//
	// OccupantArea
	//

	/**
	 * Add an entity to the target list.
	 * 
	 * @param entity
	 *            The RPEntity to add.
	 */
	protected void addTarget(final RPEntity entity) {
<span class="nc" id="L76">		targets.add(entity.getID());</span>

<span class="nc bnc" id="L78" title="All 2 branches missed.">		if (targets.size() == 1) {</span>
<span class="nc" id="L79">			SingletonRepository.getTurnNotifier().notifyInTurns(interval, this);</span>
		}
<span class="nc" id="L81">	}</span>

	/**
	 * Check if an entity is an [acknowledged] occupant of this area.
	 * @param entity to be tested
	 * @return true if is occupant
	 * 
	 * 
	 */
	public boolean isOccupant(final RPEntity entity) {
<span class="nc" id="L91">		return targets.contains(entity.getID());</span>
	}

	/**
	 * An entity has entered the area. This should not apply any actions that
	 * &lt;code&gt;handleMovement()&lt;/code&gt; does.
	 * 
	 * @param entity
	 *            The RPEntity that was added.
	 * 
	 * @return &lt;code&gt;false&lt;/code&gt; if this entity should not be processed,
	 *         &lt;code&gt;true&lt;/code&gt; otherwise.
	 */
	protected boolean handleAdded(final RPEntity entity) {
<span class="nc" id="L105">		return true;</span>
	}

	/**
	 * Apply actions done at regular intervals.
	 * 
	 * @param entity
	 *            The RPEntity occupant.
	 * 
	 * @return &lt;code&gt;false&lt;/code&gt; if this entity should be removed from
	 *         further processing, &lt;code&gt;true&lt;/code&gt; otherwise.
	 */
	protected boolean handleInterval(final RPEntity entity) {
<span class="nc" id="L118">		return true;</span>
	}

	/**
	 * Apply actions done while moving.
	 * 
	 * @param entity
	 *            The RPEntity that moved.
	 * 
	 * @return &lt;code&gt;false&lt;/code&gt; if this entity should be removed from
	 *         further processing, &lt;code&gt;true&lt;/code&gt; otherwise.
	 */
	protected boolean handleMovement(final RPEntity entity) {
<span class="nc" id="L131">		return true;</span>
	}

	/**
	 * An entity has left the area. This should not apply any actions that
	 * &lt;code&gt;handleMovement()&lt;/code&gt; does.
	 * 
	 * @param entity
	 *            The RPEntity that was added.
	 */
	protected void handleRemoved(final RPEntity entity) {
		// can be implemented by sub classes.
<span class="nc" id="L143">	}</span>

	/**
	 * Remove an entity from the target list.
	 * 
	 * @param entity
	 *            The RPEntity to remove.
	 */
	protected void removeTarget(final RPEntity entity) {
<span class="nc" id="L152">		targets.remove(entity.getID());</span>

<span class="nc bnc" id="L154" title="All 2 branches missed.">		if (targets.isEmpty()) {</span>
<span class="nc" id="L155">			SingletonRepository.getTurnNotifier().dontNotify(this);</span>
		}
<span class="nc" id="L157">	}</span>

	/**
	 * Set whether only players get affected.
	 * 
	 * @param playersOnly
	 *            Whether to only affect players.
	 */
	public void setPlayersOnly(final boolean playersOnly) {
<span class="nc" id="L166">		this.playersOnly = playersOnly;</span>
<span class="nc" id="L167">	}</span>

	//
	// Entity
	//

	/**
	 * Called when this object is added to a zone.
	 * 
	 * @param zone
	 *            The zone this was added to.
	 */
	@Override
	public void onAdded(final StendhalRPZone zone) {
<span class="nc" id="L181">		super.onAdded(zone);</span>
<span class="nc" id="L182">		zone.addMovementListener(this);</span>
<span class="nc" id="L183">	}</span>

	/**
	 * Called when this object is being removed from a zone.
	 * 
	 * @param zone
	 *            The zone this will be removed from.
	 */
	@Override
	public void onRemoved(final StendhalRPZone zone) {
<span class="nc" id="L193">		zone.removeMovementListener(this);</span>
<span class="nc" id="L194">		super.onRemoved(zone);</span>
<span class="nc" id="L195">	}</span>

	/**
	 * Handle object attribute change(s).
	 */
	@Override
	public void update() {
		StendhalRPZone zone;

		/*
		 * Reregister incase coordinates/size changed (could be smarter)
		 */
<span class="nc" id="L207">		zone = getZone();</span>

<span class="nc bnc" id="L209" title="All 2 branches missed.">		if (zone != null) {</span>
<span class="nc" id="L210">			zone.removeMovementListener(this);</span>
		}

<span class="nc" id="L213">		super.update();</span>

<span class="nc bnc" id="L215" title="All 2 branches missed.">		if (zone != null) {</span>
<span class="nc" id="L216">			zone.addMovementListener(this);</span>
		}
<span class="nc" id="L218">	}</span>

	//
	// MovementListener
	//

	/**
	 * Invoked when an entity enters the object area.
	 * 
	 * @param entity
	 *            The entity that moved.
	 * @param zone
	 *            The new zone.
	 * @param newX
	 *            The new X coordinate.
	 * @param newY
	 *            The new Y coordinate.
	 */
	@Override
	public void onEntered(final ActiveEntity entity, final StendhalRPZone zone, final int newX,
			final int newY) {
		/*
		 * Ignore non-RPEntity's
		 */
<span class="nc bnc" id="L242" title="All 2 branches missed.">		if (!(entity instanceof RPEntity)) {</span>
<span class="nc" id="L243">			return;</span>
		}

<span class="nc" id="L246">		final RPEntity rpentity = (RPEntity) entity;</span>

		/*
		 * Only effect players?
		 */
<span class="nc bnc" id="L251" title="All 4 branches missed.">		if (playersOnly &amp;&amp; !(rpentity instanceof Player)) {</span>
<span class="nc" id="L252">			return;</span>
		}

<span class="nc bnc" id="L255" title="All 2 branches missed.">		if (handleAdded(rpentity)) {</span>
<span class="nc" id="L256">			handleMovement(rpentity);</span>
<span class="nc" id="L257">			addTarget(rpentity);</span>
		}
<span class="nc" id="L259">	}</span>

	/**
	 * Invoked when an entity leaves the object area.
	 * 
	 * @param entity
	 *            The entity that entered.
	 * @param zone
	 *            The old zone.
	 * @param oldX
	 *            The old X coordinate.
	 * @param oldY
	 *            The old Y coordinate.
	 * 
	 */
	@Override
	public void onExited(final ActiveEntity entity, final StendhalRPZone zone, final int oldX,
			final int oldY) {
		/*
		 * Ignore non-RPEntity's
		 */
<span class="nc bnc" id="L280" title="All 2 branches missed.">		if (!(entity instanceof RPEntity)) {</span>
<span class="nc" id="L281">			return;</span>
		}

<span class="nc" id="L284">		final RPEntity rpentity = (RPEntity) entity;</span>

		/*
		 * Only effect players?
		 */
<span class="nc bnc" id="L289" title="All 4 branches missed.">		if (playersOnly &amp;&amp; !(rpentity instanceof Player)) {</span>
<span class="nc" id="L290">			return;</span>
		}

<span class="nc bnc" id="L293" title="All 2 branches missed.">		if (targets.contains(rpentity.getID())) {</span>
<span class="nc" id="L294">			handleMovement(rpentity);</span>
<span class="nc" id="L295">			removeTarget(rpentity);</span>
<span class="nc" id="L296">			handleRemoved(rpentity);</span>
		}
<span class="nc" id="L298">	}</span>

	/**
	 * Invoked when an entity moves while over the object area.
	 * 
	 * @param entity
	 *            The entity that left.
	 * @param zone
	 *            The zone.
	 * @param oldX
	 *            The old X coordinate.
	 * @param oldY
	 *            The old Y coordinate.
	 * @param newX
	 *            The new X coordinate.
	 * @param newY
	 *            The new Y coordinate.
	 */
	@Override
	public void onMoved(final ActiveEntity entity, final StendhalRPZone zone, final int oldX,
			final int oldY, final int newX, final int newY) {
		/*
		 * Ignore non-RPEntity's
		 */
<span class="nc bnc" id="L322" title="All 2 branches missed.">		if (!(entity instanceof RPEntity)) {</span>
<span class="nc" id="L323">			return;</span>
		}

<span class="nc" id="L326">		final RPEntity rpentity = (RPEntity) entity;</span>

<span class="nc bnc" id="L328" title="All 2 branches missed.">		if (targets.contains(rpentity.getID())) {</span>
<span class="nc" id="L329">			handleMovement(rpentity);</span>
		}
<span class="nc" id="L331">	}</span>

	//
	// TurnListener
	//

	/**
	 * This method is called when the turn number is reached.
	 * 
	 * @param currentTurn
	 *            Current turn number.
	 */
	@Override
	public void onTurnReached(final int currentTurn) {
		IRPZone zone;
		Rectangle2D area;

<span class="nc" id="L348">		zone = getZone();</span>
<span class="nc" id="L349">		area = getArea();</span>

		/*
		 * Perform action on entities still in the area. Remove those that have
		 * gone missing.
		 */
<span class="nc" id="L355">		final Iterator&lt;RPEntity.ID&gt; iter = targets.iterator();</span>

<span class="nc bnc" id="L357" title="All 2 branches missed.">		while (iter.hasNext()) {</span>
<span class="nc" id="L358">			final RPEntity.ID id = iter.next();</span>

<span class="nc bnc" id="L360" title="All 2 branches missed.">			if (zone.has(id)) {</span>
<span class="nc" id="L361">				final RPEntity entity = (RPEntity) zone.get(id);</span>

<span class="nc bnc" id="L363" title="All 2 branches missed.">				if (area.intersects(entity.getArea())) {</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">					if (!handleInterval(entity)) {</span>
<span class="nc" id="L365">						handleRemoved(entity);</span>
<span class="nc" id="L366">						iter.remove();</span>
					}
				} else {
<span class="nc" id="L369">					handleRemoved(entity);</span>
<span class="nc" id="L370">					iter.remove();</span>
				}
<span class="nc" id="L372">			} else {</span>
<span class="nc" id="L373">				iter.remove();</span>
			}
<span class="nc" id="L375">		}</span>

<span class="nc bnc" id="L377" title="All 2 branches missed.">		if (!targets.isEmpty()) {</span>
<span class="nc" id="L378">			SingletonRepository.getTurnNotifier().notifyInTurns(interval, this);</span>
		}
<span class="nc" id="L380">	}</span>

	@Override
	public void beforeMove(ActiveEntity entity, StendhalRPZone zone, int oldX,
			int oldY, int newX, int newY) {
		// nothing to do before a move
<span class="nc" id="L386">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>