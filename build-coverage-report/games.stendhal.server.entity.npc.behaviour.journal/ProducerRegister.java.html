<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ProducerRegister.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.entity.npc.behaviour.journal</a> &gt; <span class="el_source">ProducerRegister.java</span></div><h1>ProducerRegister.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.entity.npc.behaviour.journal;

import games.stendhal.common.grammar.Grammar;
import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.entity.item.Item;
import games.stendhal.server.entity.npc.behaviour.impl.MultiProducerBehaviour;
import games.stendhal.server.entity.npc.behaviour.impl.ProducerBehaviour;
import games.stendhal.server.entity.player.Player;

import java.util.HashSet;
import java.util.LinkedList;
import java.util.List;

import marauroa.common.Pair;

public class ProducerRegister {

	private static ProducerRegister instance;

	private final List&lt;Pair&lt;String, ProducerBehaviour&gt;&gt; producers;
	private final List&lt;Pair&lt;String, MultiProducerBehaviour&gt;&gt; multiproducers;

	public static ProducerRegister get() {
<span class="fc bfc" id="L36" title="All 2 branches covered.">		if (instance == null) {</span>
<span class="fc" id="L37">			new ProducerRegister();</span>
		}
<span class="fc" id="L39">		return instance;</span>
	}

<span class="fc" id="L42">	protected ProducerRegister() {</span>
<span class="fc" id="L43">		instance = this;</span>
<span class="fc" id="L44">		producers  = new LinkedList&lt;Pair&lt;String, ProducerBehaviour&gt;&gt;();</span>
<span class="fc" id="L45">		multiproducers  = new LinkedList&lt;Pair&lt;String, MultiProducerBehaviour&gt;&gt;();</span>
<span class="fc" id="L46">	}</span>

	/**
	 * Adds an NPC to the NPCList. Does nothing if an NPC with the same name
	 * already exists. This makes sure that each NPC can be uniquely identified
	 * by his/her name.
	 * 
	 * @param npcName
	 *            The NPC that should be added
	 * @param behaviour   
	 *            The ProducerBehaviour of that NPC
	 */
	public void add(final String npcName, final ProducerBehaviour behaviour) {
		// insert lower case names ?
		// final String name = npcName.toLowerCase();
<span class="fc" id="L61">		Pair&lt;String, ProducerBehaviour&gt; pair = new Pair&lt;String, ProducerBehaviour&gt;(npcName, behaviour);</span>
<span class="fc" id="L62">		producers.add(pair);</span>
<span class="fc" id="L63">	}</span>

	public void add(final String npcName, final MultiProducerBehaviour behaviour) {
		// insert lower case names ?
		// final String name = npcName.toLowerCase();
<span class="nc" id="L68">		Pair&lt;String, MultiProducerBehaviour&gt; pair = new Pair&lt;String, MultiProducerBehaviour&gt;(npcName, behaviour);</span>
<span class="nc" id="L69">		multiproducers.add(pair);</span>
<span class="nc" id="L70">	}</span>

	public List&lt;Pair&lt;String, ProducerBehaviour&gt;&gt; getProducers() {
<span class="fc" id="L73">		return producers;</span>
	}

	public List&lt;Pair&lt;String, MultiProducerBehaviour&gt;&gt; getMultiProducers() {
<span class="nc" id="L77">		return multiproducers;</span>
	}

	public String listWorkingProducers(final Player player) {
<span class="fc" id="L81">		final StringBuilder sb = new StringBuilder(&quot;&quot;);</span>

		// Open orders - do not state if ready to collect or not, yet
<span class="fc bfc" id="L84" title="All 2 branches covered.">		for (final Pair&lt;String, ProducerBehaviour&gt; producer : producers) {</span>
<span class="fc" id="L85">			String npcName = producer.first();</span>
<span class="fc" id="L86">			ProducerBehaviour behaviour = producer.second();</span>
<span class="fc" id="L87">			String questSlot =  behaviour.getQuestSlot();</span>
<span class="fc" id="L88">			String activity =  behaviour.getProductionActivity();</span>
<span class="fc" id="L89">			String product =  behaviour.getProductName();</span>
<span class="fc bfc" id="L90" title="All 4 branches covered.">			if (player.hasQuest(questSlot) &amp;&amp; !player.isQuestCompleted(questSlot)) {</span>
<span class="fc" id="L91">				int amount = behaviour.getNumberOfProductItems(player);</span>
<span class="fc bfc" id="L92" title="All 2 branches covered.">				if (behaviour.isOrderReady(player)) {</span>
					// put all completed orders first - player wants to collect these!
<span class="fc" id="L94">					sb.insert(0,&quot;\n&quot; + npcName + &quot; has finished &quot; + Grammar.gerundForm(activity) </span>
							+ &quot; your &quot; + Grammar.plnoun(amount,product) + &quot;.&quot;);
				} else {
<span class="fc" id="L97">					String timeleft = behaviour.getApproximateRemainingTime(player);</span>
					// put all ongoing orders last
<span class="fc" id="L99">					sb.append(&quot;\n&quot; + npcName + &quot; is &quot; + Grammar.gerundForm(activity) </span>
							+ &quot; &quot; + Grammar.quantityplnoun(amount, product, &quot;a&quot;) + &quot; and will be ready in &quot; + timeleft + &quot;.&quot;);
				}
			}
<span class="fc" id="L103">		}</span>
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">		for (final Pair&lt;String, MultiProducerBehaviour&gt; producer : multiproducers) {</span>
<span class="nc" id="L105">			String npcName = producer.first();</span>
<span class="nc" id="L106">			MultiProducerBehaviour behaviour = producer.second();</span>
<span class="nc" id="L107">			String questSlot =  behaviour.getQuestSlot();</span>
<span class="nc" id="L108">			String activity =  behaviour.getProductionActivity();</span>
            // Retrieve all production details from the questSlot
<span class="nc bnc" id="L110" title="All 4 branches missed.">			if (player.hasQuest(questSlot) &amp;&amp; !player.isQuestCompleted(questSlot)) {</span>
<span class="nc" id="L111">                final String orderString = player.getQuest(questSlot);</span>
<span class="nc" id="L112">                final String[] order = orderString.split(&quot;;&quot;);</span>
                //final long orderTime = Long.parseLong(order[2]);
<span class="nc" id="L114">                final int amount = Integer.parseInt(order[0]);</span>
<span class="nc" id="L115">                final String product = order[1];</span>
<span class="nc bnc" id="L116" title="All 2 branches missed.">				if (behaviour.isOrderReady(player)) {</span>
					// put all completed orders first - player wants to collect these!
<span class="nc" id="L118">					sb.insert(0,&quot;\n&quot; + npcName + &quot; has finished &quot; + Grammar.gerundForm(activity) </span>
							+ &quot; your &quot; + Grammar.plnoun(amount,product) + &quot;.&quot;);
				} else {
<span class="nc" id="L121">					String timeleft = behaviour.getApproximateRemainingTime(player);</span>
					// put all ongoing orders last
<span class="nc" id="L123">					sb.append(&quot;\n&quot; + npcName + &quot; is &quot; + Grammar.gerundForm(activity) </span>
							+ &quot; &quot; + Grammar.quantityplnoun(amount, product, &quot;a&quot;) + &quot; and will be ready in &quot; + timeleft + &quot;.&quot;);
				}
			}
<span class="nc" id="L127">		}</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">		if (!&quot;&quot;.equals(sb.toString())) {</span>
<span class="fc" id="L129">			sb.insert(0,&quot;\r\nOrders: &quot;);</span>
		} else {
<span class="fc" id="L131">			sb.append(&quot;You have no ongoing or uncollected orders.&quot;);</span>
		}
<span class="fc" id="L133">		return sb.toString();</span>
	}

	/**
	 * gets description of the production
	 *
	 * @param player player to get the description for
	 * @param npcName name of quest
	 * @return details
	 */
	public String getProductionDescription(final Player player, final String npcName) {
<span class="nc bnc" id="L144" title="All 2 branches missed.">		for (final Pair&lt;String, ProducerBehaviour&gt; producer : producers) {</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">			if(npcName.equals(producer.first())) {</span>
<span class="nc" id="L146">				ProducerBehaviour behaviour = producer.second();</span>
<span class="nc" id="L147">				String activity =  behaviour.getProductionActivity();</span>
<span class="nc" id="L148">				String product =  behaviour.getProductName();</span>
<span class="nc" id="L149">				return npcName + &quot; &quot; + Grammar.plural(activity) + &quot; &quot; + Grammar.plural(product) + &quot;.&quot;;</span>
			}
<span class="nc" id="L151">		}</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">		for (final Pair&lt;String, MultiProducerBehaviour&gt; producer : multiproducers) {</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">			if(npcName.equals(producer.first())) {</span>
<span class="nc" id="L154">				MultiProducerBehaviour behaviour = producer.second();</span>
<span class="nc" id="L155">				String activity =  behaviour.getProductionActivity();</span>
<span class="nc" id="L156">				HashSet&lt;String&gt; products =  behaviour.getProductsNames();</span>
<span class="nc" id="L157">				return npcName + &quot; &quot; + Grammar.plural(activity) + &quot; &quot; + Grammar.enumerateCollection(products) + &quot;.&quot;;</span>
			}
<span class="nc" id="L159">		}</span>
<span class="nc" id="L160">		return &quot;&quot;;</span>
	}

	/**
	 * gets description of the produced item
	 *
	 * Note: if more than one NPC makes the item, just the details of the first NPC in the list who makes it are returned 
	 * 
	 * @param itemName produced item
	 * @return details about the produced item
	 */
	public String getProducedItemDetails(final String itemName) {
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">		for (final Pair&lt;String, ProducerBehaviour&gt; producer : producers) {</span>
<span class="fc" id="L173">			ProducerBehaviour behaviour = producer.second();</span>
<span class="fc" id="L174">			String product =  behaviour.getProductName();</span>

<span class="fc bfc" id="L176" title="All 2 branches covered.">			if(itemName.equals(product)) {</span>
<span class="fc" id="L177">				String npcName = producer.first();</span>
<span class="fc" id="L178">				String activity =  behaviour.getProductionActivity();</span>
<span class="fc" id="L179">				String resources = behaviour.getRequiredResourceNames(1);</span>
<span class="fc" id="L180">				return  npcName + &quot; &quot; + Grammar.plural(activity) + &quot; &quot; + Grammar.plural(product) + &quot;, which need &quot; + resources + &quot; each.&quot;;</span>
			}
<span class="fc" id="L182">		}</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">		for (final Pair&lt;String, MultiProducerBehaviour&gt; producer : multiproducers) {</span>
<span class="nc" id="L184">			MultiProducerBehaviour behaviour = producer.second();</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">			for (String product : behaviour.getProductsNames()) {</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">				if(itemName.equals(product)) {</span>
<span class="nc" id="L187">                    String npcName = producer.first();</span>
<span class="nc" id="L188">                    String activity =  behaviour.getProductionActivity();</span>
<span class="nc" id="L189">                    String resources = behaviour.getRequiredResourceNames(product, 1);</span>
<span class="nc" id="L190">                    return npcName + &quot; &quot; + Grammar.plural(activity) + &quot; &quot; + Grammar.plural(product) + &quot;, which need &quot; + resources + &quot; each.&quot;;</span>
                }
<span class="nc" id="L192">			}</span>
<span class="nc" id="L193">		}</span>
<span class="nc" id="L194">		return &quot;&quot;;</span>
	}

	/**
	 * gets names of all items produced, which are of the given item class (i.e. food, drink)
	 *
	 * @param clazz Item class to check
	 * @return list of item names
	 */
	public List&lt;String&gt; getProducedItemNames(final String clazz) {
<span class="fc" id="L204">		List&lt;String&gt; res = new LinkedList&lt;String&gt;();</span>
<span class="fc bfc" id="L205" title="All 2 branches covered.">		for (final Pair&lt;String, ProducerBehaviour&gt; producer : producers) {</span>
<span class="fc" id="L206">			final ProducerBehaviour behaviour = producer.second();</span>
<span class="fc" id="L207">			final String product =  behaviour.getProductName();</span>
<span class="fc" id="L208">			final Item item = SingletonRepository.getEntityManager().getItem(product);</span>
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">			if (item.isOfClass(clazz)) {</span>
<span class="fc" id="L210">				res.add(product);</span>
			}
<span class="fc" id="L212">		}</span>
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">		for (final Pair&lt;String, MultiProducerBehaviour&gt; producer : multiproducers) {</span>
<span class="nc" id="L214">			final MultiProducerBehaviour behaviour = producer.second();</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">			for (String product : behaviour.getProductsNames()) {</span>
<span class="nc" id="L216">				final Item item = SingletonRepository.getEntityManager().getItem(product);</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">                if (item.isOfClass(clazz)) {</span>
<span class="nc" id="L218">                    res.add(product);</span>
                }
<span class="nc" id="L220">			}</span>
<span class="nc" id="L221">		}</span>
<span class="fc" id="L222">		return res;</span>
	}

	/**
     * gets the names of all the NPCs to whom the player has asked to produce something
     *
	 * @param player player to get the details for
	 * @return NPC names
     */
	public List&lt;String&gt; getWorkingProducerNames(final Player player) {
<span class="nc" id="L232">		List&lt;String&gt; res = new LinkedList&lt;String&gt;();</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">		for (final Pair&lt;String, ProducerBehaviour&gt; producer : producers) {</span>
<span class="nc" id="L234">			String npcName = producer.first();</span>
<span class="nc" id="L235">			ProducerBehaviour behaviour = producer.second();</span>
<span class="nc" id="L236">			String questSlot =  behaviour.getQuestSlot();</span>
<span class="nc bnc" id="L237" title="All 4 branches missed.">			if (player.hasQuest(questSlot) &amp;&amp; !player.isQuestCompleted(questSlot)) {</span>
<span class="nc bnc" id="L238" title="All 2 branches missed.">				if (behaviour.isOrderReady(player)) {</span>
					// put all completed orders first - player wants to collect these!
<span class="nc" id="L240">					res.add(0, npcName);</span>
				} else {
<span class="nc" id="L242">					res.add(npcName);</span>
				}
			}
<span class="nc" id="L245">		}</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">		for (final Pair&lt;String, MultiProducerBehaviour&gt; producer : multiproducers) {</span>
<span class="nc" id="L247">			String npcName = producer.first();</span>
<span class="nc" id="L248">			MultiProducerBehaviour behaviour = producer.second();</span>
<span class="nc" id="L249">			String questSlot =  behaviour.getQuestSlot();</span>
<span class="nc bnc" id="L250" title="All 4 branches missed.">			if (player.hasQuest(questSlot) &amp;&amp; !player.isQuestCompleted(questSlot)) {</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">				if (behaviour.isOrderReady(player)) {</span>
					// put all completed orders first - player wants to collect these!
<span class="nc" id="L253">					res.add(0, npcName);</span>
				} else {
<span class="nc" id="L255">					res.add(npcName);</span>
				}
			}
<span class="nc" id="L258">		}</span>
<span class="nc" id="L259">		return res;</span>
	}

	/**
	 * gets details on the progress of the production
	 *
	 * @param player player to get the details for
	 * @param npcName name of quest
	 * @return details
	 */
	public List&lt;String&gt; getProductionDetails(final Player player, final String npcName) {
<span class="nc" id="L270">		List&lt;String&gt; res = new LinkedList&lt;String&gt;();</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">		for (final Pair&lt;String, ProducerBehaviour&gt; producer : producers) {</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">			if(npcName.equals(producer.first())) {</span>
<span class="nc" id="L273">				ProducerBehaviour behaviour = producer.second();</span>
<span class="nc" id="L274">				String questSlot =  behaviour.getQuestSlot();</span>
<span class="nc" id="L275">				String activity =  behaviour.getProductionActivity();</span>
<span class="nc" id="L276">				String product =  behaviour.getProductName();</span>
<span class="nc bnc" id="L277" title="All 4 branches missed.">				if (player.hasQuest(questSlot) &amp;&amp; !player.isQuestCompleted(questSlot)) {</span>
<span class="nc" id="L278">					int amount = behaviour.getNumberOfProductItems(player);</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">					if (behaviour.isOrderReady(player)) {</span>
						// put all completed orders first - player wants to collect these!
<span class="nc" id="L281">						res.add(npcName + &quot; has finished &quot; + Grammar.gerundForm(activity) </span>
							+ &quot; your &quot; + Grammar.plnoun(amount,product) + &quot;.&quot;);
					} else {
<span class="nc" id="L284">						String timeleft = behaviour.getApproximateRemainingTime(player);</span>
						// put all ongoing orders last
<span class="nc" id="L286">						res.add(&quot;\n&quot; + npcName + &quot; is &quot; + Grammar.gerundForm(activity) </span>
							+ &quot; &quot; + Grammar.quantityplnoun(amount, product, &quot;a&quot;) + &quot; and will be ready in &quot; + timeleft + &quot;.&quot;);
					}
				}
			}
<span class="nc" id="L291">		}</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">		for (final Pair&lt;String, MultiProducerBehaviour&gt; producer : multiproducers) {</span>
<span class="nc bnc" id="L293" title="All 2 branches missed.">			if(npcName.equals(producer.first())) {</span>
<span class="nc" id="L294">                MultiProducerBehaviour behaviour = producer.second();</span>
<span class="nc" id="L295">                String questSlot =  behaviour.getQuestSlot();</span>
<span class="nc" id="L296">                String activity =  behaviour.getProductionActivity();</span>
                // Retrieve all production details from the questSlot
<span class="nc bnc" id="L298" title="All 4 branches missed.">                if (player.hasQuest(questSlot) &amp;&amp; !player.isQuestCompleted(questSlot)) {</span>
<span class="nc" id="L299">                    final String orderString = player.getQuest(questSlot);</span>
<span class="nc" id="L300">                    final String[] order = orderString.split(&quot;;&quot;);</span>
                    //final long orderTime = Long.parseLong(order[2]);
<span class="nc" id="L302">                    final int amount = Integer.parseInt(order[0]);</span>
<span class="nc" id="L303">                    final String product = order[1];</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">                    if (behaviour.isOrderReady(player)) {</span>
                        // put all completed orders first - player wants to collect these!
<span class="nc" id="L306">                        res.add(npcName + &quot; has finished &quot; + Grammar.gerundForm(activity) </span>
                            + &quot; your &quot; + Grammar.plnoun(amount,product) + &quot;.&quot;);
                    } else {
<span class="nc" id="L309">                        String timeleft = behaviour.getApproximateRemainingTime(player);</span>
                        // put all ongoing orders last
<span class="nc" id="L311">						res.add(&quot;\n&quot; + npcName + &quot; is &quot; + Grammar.gerundForm(activity) </span>
							+ &quot; &quot; + Grammar.quantityplnoun(amount, product, &quot;a&quot;) + &quot; and will be ready in &quot; + timeleft + &quot;.&quot;);
                    }
                }
			}
<span class="nc" id="L316">		}</span>
<span class="nc" id="L317">		return res;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>