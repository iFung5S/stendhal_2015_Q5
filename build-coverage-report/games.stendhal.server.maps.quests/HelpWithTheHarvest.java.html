<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>HelpWithTheHarvest.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.quests</a> &gt; <span class="el_source">HelpWithTheHarvest.java</span></div><h1>HelpWithTheHarvest.java</h1><pre class="source lang-java linenums">/**
 * 
 */
package games.stendhal.server.maps.quests;

import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.core.engine.StendhalRPZone;
import games.stendhal.server.entity.mapstuff.block.Block;
import games.stendhal.server.entity.mapstuff.block.BlockTarget;
import games.stendhal.server.entity.npc.ChatAction;
import games.stendhal.server.entity.npc.ChatCondition;
import games.stendhal.server.entity.npc.ConversationPhrases;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.SpeakerNPC;
import games.stendhal.server.entity.npc.action.EquipRandomAmountOfItemAction;
import games.stendhal.server.entity.npc.action.IncreaseKarmaAction;
import games.stendhal.server.entity.npc.action.IncreaseXPAction;
import games.stendhal.server.entity.npc.action.IncrementQuestAction;
import games.stendhal.server.entity.npc.action.MultipleActions;
import games.stendhal.server.entity.npc.action.ResetBlockChatAction;
import games.stendhal.server.entity.npc.action.SetQuestAction;
import games.stendhal.server.entity.npc.action.SetQuestAndModifyKarmaAction;
import games.stendhal.server.entity.npc.condition.AndCondition;
import games.stendhal.server.entity.npc.condition.QuestActiveCondition;
import games.stendhal.server.entity.npc.condition.QuestCompletedCondition;
import games.stendhal.server.entity.npc.condition.QuestInStateCondition;
import games.stendhal.server.entity.npc.condition.QuestNotStartedCondition;
import games.stendhal.server.entity.npc.condition.QuestStartedCondition;
import games.stendhal.server.entity.npc.condition.QuestStateGreaterThanCondition;
import games.stendhal.server.entity.player.Player;
import games.stendhal.server.maps.Region;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

/**
 * In this quest the player can help Eheneumniranin by bringing
 * two carts with straw up to the barn near Karl.
 * 
 * (proof of concept for pushable blocks)
 * 
 * @author madmetzger
 * 
 * 
 * QUEST: Help with the Harvest
 * 
 * PARTICIPANTS:
 * &lt;ul&gt;
 * &lt;li&gt; Eheneumniranin (the half-elf on Ados farm) &lt;/li&gt;
 * &lt;/ul&gt;
 * 
 * STEPS:
 * &lt;ul&gt;
 * &lt;li&gt; Eheneumniranin asks you to push some carts full of straw to Karl's barn &lt;/li&gt;
 * &lt;li&gt; Push 2 carts to the designated spots in front of the barn &lt;/li&gt; 
 * &lt;/ul&gt;
 * 
 * REWARD:
 * &lt;ul&gt;
 * &lt;li&gt; 50 XP &lt;/li&gt;
 * &lt;li&gt; some karma (5 + (2 | -2)) &lt;/li&gt;
 * &lt;li&gt; between 10 and 20 &lt;item&gt;grain&lt;/item&gt; &lt;/li&gt;
 * &lt;/ul&gt;
 * 
 * REPETITIONS:
 * &lt;ul&gt;
 * &lt;li&gt;None&lt;/li&gt;
 * &lt;/ul&gt;
 */
<span class="nc" id="L71">public class HelpWithTheHarvest extends AbstractQuest {</span>
	
	private static final String QUEST_SLOT = &quot;helpwiththeharvest&quot;;

	@Override
	public String getSlotName() {
<span class="nc" id="L77">		return QUEST_SLOT;</span>
	}

	@Override
	public List&lt;String&gt; getHistory(Player player) {
<span class="nc" id="L82">		List&lt;String&gt; result = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L83" title="All 4 branches missed.">		if(new QuestStartedCondition(QUEST_SLOT).fire(player, null, null) &amp;&amp; !createFinishedCondition().fire(player, null, null)) {</span>
<span class="nc" id="L84">			result.add(&quot;I want to help Eheneumniranin with his harvest.&quot;);</span>
		}
<span class="nc bnc" id="L86" title="All 2 branches missed.">		if (player.isQuestInState(QUEST_SLOT, &quot;rejected&quot;)) {</span>
<span class="nc" id="L87">		    result.add(&quot;Farm work is too hard for me at the moment.&quot;);</span>
		}

<span class="nc bnc" id="L90" title="All 2 branches missed.">		if(constructHayCartsNotYetCompletedCondition().fire(player, null, null)) {</span>
<span class="nc" id="L91">			result.add(&quot;I need to bring two straw carts to the barn just north of Eheneumniranin.&quot;);</span>
		}
<span class="nc bnc" id="L93" title="All 2 branches missed.">		if(createTaskFinishedCondition().fire(player, null, null)) {</span>
<span class="nc" id="L94">			result.add(&quot;I have brought enough straw carts to the barn. I can tell Eheneumniranin now that I am done.&quot;);</span>
		}
<span class="nc bnc" id="L96" title="All 2 branches missed.">		if(createFinishedCondition().fire(player, null, null)) {</span>
<span class="nc" id="L97">			result.add(&quot;I have helped &quot; + getNPCName() + &quot; and got my reward.&quot;);</span>
		}
<span class="nc" id="L99">		return result;</span>
	}

	@Override
	public String getName() {
<span class="nc" id="L104">		return &quot;Help with the Harvest&quot;;</span>
	}
	
	@Override
	public int getMinLevel() {
<span class="nc" id="L109">		return 5;</span>
	}

	@Override
	public void addToWorld() {
<span class="nc" id="L114">		placeCartsAndTargets();</span>
<span class="nc" id="L115">		configureNPC();</span>
<span class="nc" id="L116">		fillQuestInfo(getName(), &quot;Eheneumniranin needs help with the harvest.&quot;, false);</span>
<span class="nc" id="L117">	}</span>

	private void configureNPC() {
<span class="nc" id="L120">		SpeakerNPC npc = npcs.get(&quot;Eheneumniranin&quot;);</span>
		
		/*
		 * Add a reply on the trigger phrase &quot;quest&quot;
		 */
<span class="nc" id="L125">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES,
				new QuestNotStartedCondition(QUEST_SLOT),
				ConversationStates.QUEST_OFFERED,
				&quot;Are you here to help me a bit with my harvest?&quot;,
				null);
		
		/*
		 * Player is interested in helping, so explain the quest.
		 */
<span class="nc" id="L135">		npc.add(ConversationStates.QUEST_OFFERED,</span>
				ConversationPhrases.YES_MESSAGES,
				new QuestNotStartedCondition(QUEST_SLOT),
				ConversationStates.ATTENDING,
                        &quot;That is really nice. I was getting tired of bringing carts to Karl. Please #push two straw carts to Karl's #barn and tell me that you are #done afterwards.&quot;,
				new SetQuestAndModifyKarmaAction(QUEST_SLOT, &quot;start;2&quot;, 2.0));

<span class="nc" id="L142">		npc.addReply(&quot;push&quot;, &quot;You can easily move the carts by pushing them in front of the barn entrance. Take care to not get them stuck anywhere around or you won't be able to move them away.&quot;);</span>
		
<span class="nc" id="L144">		npc.addReply(&quot;barn&quot;, &quot;You can find Karl's barn north of here. It is marked by a huge sign with his name.&quot;);</span>
		
		/*
		 * Player refused to help - end the conversation.
		 */
<span class="nc" id="L149">		npc.add(ConversationStates.QUEST_OFFERED,</span>
				ConversationPhrases.NO_MESSAGES,
				new QuestNotStartedCondition(QUEST_SLOT),
				ConversationStates.ATTENDING,
				&quot;Oh, I was hoping to get a bit of help, but ok...&quot;,
				new SetQuestAndModifyKarmaAction(QUEST_SLOT, &quot;rejected&quot;, -2.0));
				
		
		/*
		 * Player has not yet put the carts to the right spots
		 */
<span class="nc" id="L160">		npc.add(ConversationStates.ATTENDING,</span>
				Arrays.asList(&quot;done&quot;),
				constructHayCartsNotYetCompletedCondition(),
				ConversationStates.ATTENDING,
				&quot;You did not yet bring both straw carts next to the cart near the barn just north of here.&quot;,
				null);
		
		/*
		 * Player asks for a quest although he has it already open
		 */
<span class="nc" id="L170">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES,
				new QuestActiveCondition(QUEST_SLOT),
				ConversationStates.ATTENDING,
				&quot;I already ask you to bring both straw carts next to Karls barn. Tell me if you are already #done with that.&quot;,
				null);
		
		/*
		 * Player has put both carts at the right spots
		 */
<span class="nc" id="L180">		npc.add(ConversationStates.ATTENDING,</span>
				Arrays.asList(&quot;done&quot;),
				createTaskFinishedCondition(),
				ConversationStates.ATTENDING,
				&quot;Thank you for helping me with the harvest. Here is your reward. Maybe you can bring the grain to #Jenny who can mill #flour from it.&quot;,
				createReward());
		/*
		 * Player has finished the quest and can get additional information
		 */
<span class="nc" id="L189">		npc.add(ConversationStates.ATTENDING,</span>
				Arrays.asList(&quot;jenny&quot;),
				createFinishedCondition(),
				ConversationStates.ATTENDING,
				&quot;You can find #Jenny near Semos at the mill. She mills grain into #flour for you if you bring her a few sheaves.&quot;,
				null);
		
<span class="nc" id="L196">		npc.add(ConversationStates.ATTENDING,</span>
				Arrays.asList(&quot;flour&quot;),
				createFinishedCondition(),
				ConversationStates.ATTENDING,
				&quot;#Jenny will mill the grain I gave you as reward to flour which you could maybe use for #bread?&quot;,
				null);
		
<span class="nc" id="L203">		npc.add(ConversationStates.ATTENDING,</span>
				Arrays.asList(&quot;bread&quot;),
				createFinishedCondition(),
				ConversationStates.ATTENDING,
				&quot;#Erna hasn't baked for you yet? It is really worth it, because #Leander can use it to make #sandwiches for you.&quot;,
				null);
		
<span class="nc" id="L210">		npc.add(ConversationStates.ATTENDING,</span>
				Arrays.asList(&quot;sandwich&quot;),
				createFinishedCondition(),
				ConversationStates.ATTENDING,
				&quot;You haven't tried a #sandwich made by #Leander yet? They are so tasty.&quot;,
				null);
		
<span class="nc" id="L217">		npc.add(ConversationStates.ATTENDING,</span>
				Arrays.asList(&quot;leander&quot;),
				createFinishedCondition(),
				ConversationStates.ATTENDING,
				&quot;Leander runs the bakery in Semos City and can make #sandwiches for you if you bring him the ingredients. Why don't you give him a visit?&quot;,
				null);
		
<span class="nc" id="L224">		npc.add(ConversationStates.ATTENDING,</span>
				Arrays.asList(&quot;erna&quot;),
				createFinishedCondition(),
				ConversationStates.ATTENDING,
				&quot;Erna is the assistant to #Leander in the bakery. If you bring her #flour, she will bake #bread for you.&quot;,
				null);

        /*
         * Add a reply on the trigger phrase &quot;quest&quot; after it is finished
         */
<span class="nc" id="L234">        npc.add(ConversationStates.ATTENDING, ConversationPhrases.QUEST_MESSAGES, createFinishedCondition(), ConversationStates.ATTENDING, &quot;We already brought in the complete harvest, thanks again for your help.&quot;, null);</span>
<span class="nc" id="L235">	}</span>


	/**
	 * Place the carts and targets into the zone
	 */
	private void placeCartsAndTargets() {
<span class="nc" id="L242">		StendhalRPZone zone = SingletonRepository.getRPWorld().getZone(&quot;0_ados_forest_w2&quot;);</span>
		
<span class="nc" id="L244">		ChatCondition c = constructHayCartsNotYetCompletedCondition();</span>
		
<span class="nc" id="L246">		String cartDescription = &quot;You see a straw cart. Can you manage to push it to Karl's barn?&quot;;</span>
		
<span class="nc" id="L248">		Block cartOne = new Block(87, 100, true, &quot;hay_cart&quot;);</span>
<span class="nc" id="L249">		cartOne.setDescription(cartDescription);</span>
<span class="nc" id="L250">		Block cartTwo = new Block(79, 106, true, &quot;hay_cart&quot;);</span>
<span class="nc" id="L251">		cartTwo.setDescription(cartDescription);</span>
		
<span class="nc" id="L253">        ChatAction a = new MultipleActions(new IncrementQuestAction(QUEST_SLOT, 1, -1), new ResetBlockChatAction(cartOne), new ResetBlockChatAction(cartTwo));</span>

<span class="nc" id="L255">		zone.add(cartOne);</span>
<span class="nc" id="L256">		zone.add(cartTwo);</span>
<span class="nc" id="L257">		zone.addMovementListener(cartOne);</span>
<span class="nc" id="L258">		zone.addMovementListener(cartTwo);</span>
<span class="nc" id="L259">		zone.addZoneEnterExitListener(cartOne);</span>
<span class="nc" id="L260">		zone.addZoneEnterExitListener(cartTwo);</span>
		
<span class="nc" id="L262">		BlockTarget targetOne = new BlockTarget(64, 75);</span>
<span class="nc" id="L263">		targetOne.setDescription(&quot;You see a plain point on the ground. Something heavy stood here before.&quot;);</span>
<span class="nc" id="L264">		targetOne.setCondition(c);</span>
<span class="nc" id="L265">		targetOne.setAction(a);</span>
		
<span class="nc" id="L267">		BlockTarget targetTwo = new BlockTarget(65, 75);</span>
<span class="nc" id="L268">		targetTwo.setDescription(&quot;You see a plain point on the ground. Something heavy stood here before.&quot;);</span>
<span class="nc" id="L269">		targetTwo.setAction(a);</span>
<span class="nc" id="L270">		targetTwo.setCondition(c);</span>
		
<span class="nc" id="L272">		zone.add(targetOne);</span>
<span class="nc" id="L273">		zone.add(targetTwo);</span>
<span class="nc" id="L274">	}</span>

	/**
	 * Create condition determining if straw carts have not been moved completely to the barn
	 * 
	 * @return the condition
	 */
	private ChatCondition constructHayCartsNotYetCompletedCondition() {
<span class="nc" id="L282">		ChatCondition c = new AndCondition(</span>
								new QuestStartedCondition(QUEST_SLOT), 
								new QuestInStateCondition(QUEST_SLOT, 0, &quot;start&quot;), 
								new QuestStateGreaterThanCondition(QUEST_SLOT, 1, 0));
<span class="nc" id="L286">		return c;</span>
	}
	
	/**
	 * Create condition determining when straw carts were move to the barn
	 * 
	 * @return the condition
	 */
	private ChatCondition createTaskFinishedCondition() {
<span class="nc" id="L295">		ChatCondition c = new AndCondition(</span>
				new QuestStartedCondition(QUEST_SLOT), 
				new QuestInStateCondition(QUEST_SLOT, 0, &quot;start&quot;), 
				new QuestInStateCondition(QUEST_SLOT, 1, &quot;0&quot;));
<span class="nc" id="L299">		return c;</span>
	}
	
	/**
	 * Create the reward action
	 * 
	 * @return the action for rewarding finished quest
	 */
	private ChatAction createReward() {
<span class="nc" id="L308">		return new MultipleActions(</span>
					new IncreaseKarmaAction(5),
					new IncreaseXPAction(50),
					new EquipRandomAmountOfItemAction(&quot;grain&quot;, 10, 20),
					new SetQuestAction(QUEST_SLOT, &quot;done&quot;));	
	}
	
	/**
	 * Create the condition determining if quest is finished
	 * 
	 * @return the condition
	 */
	private ChatCondition createFinishedCondition() {
<span class="nc" id="L321">		return new QuestCompletedCondition(QUEST_SLOT);</span>
	}

	@Override
	public String getRegion() {
<span class="nc" id="L326">		return Region.ADOS_SURROUNDS;</span>
	}

	@Override
	public String getNPCName() {
<span class="nc" id="L331">		return &quot;Eheneumniranin&quot;;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>