<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SuppliesForPhalk.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.quests</a> &gt; <span class="el_source">SuppliesForPhalk.java</span></div><h1>SuppliesForPhalk.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.maps.quests;

import games.stendhal.common.parser.Sentence;
import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.entity.item.Item;
import games.stendhal.server.entity.npc.ChatAction;
import games.stendhal.server.entity.npc.ConversationPhrases;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.EventRaiser;
import games.stendhal.server.entity.npc.SpeakerNPC;
import games.stendhal.server.entity.npc.action.DropInfostringItemAction;
import games.stendhal.server.entity.npc.action.DropItemAction;
import games.stendhal.server.entity.npc.action.EquipItemAction;
import games.stendhal.server.entity.npc.action.IncreaseXPAction;
import games.stendhal.server.entity.npc.action.InflictStatusOnNPCAction;
import games.stendhal.server.entity.npc.action.MultipleActions;
import games.stendhal.server.entity.npc.action.SetQuestAction;
import games.stendhal.server.entity.npc.action.SetQuestAndModifyKarmaAction;
import games.stendhal.server.entity.npc.condition.AndCondition;
import games.stendhal.server.entity.npc.condition.NotCondition;
import games.stendhal.server.entity.npc.condition.PlayerHasInfostringItemWithHimCondition;
import games.stendhal.server.entity.npc.condition.PlayerHasItemWithHimCondition;
import games.stendhal.server.entity.npc.condition.QuestCompletedCondition;
import games.stendhal.server.entity.npc.condition.QuestInStateCondition;
import games.stendhal.server.entity.npc.condition.QuestNotStartedCondition;
import games.stendhal.server.entity.player.Player;
import games.stendhal.server.maps.Region;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.LinkedList;
import java.util.List;

import org.apache.log4j.Logger;

/**
 * QUEST: Supplies For Phalk
 *
 * PARTICIPANTS:
 * &lt;ul&gt;
 * &lt;li&gt;Phalk, the dwarf guarding Semos mines&lt;/li&gt;
 * &lt;li&gt;Wrvil, a kobold weapon trader in Wo'fol&lt;/li&gt;
 * &lt;li&gt;Mrotho, in Ados barracks&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * STEPS:
 * &lt;ul&gt;
 * &lt;li&gt;1. Phalk asks for some food and drink&lt;/li&gt;
 * &lt;li&gt;2. Once you brought him the food and drink, Phalk asks you to collect his clothes from Wrvil and Mrotho&lt;/li&gt;
 * &lt;li&gt;3. Wrvil gives you Phalk's special dwarf cloak but you must pay for it in arrows&lt;/li&gt;
 * &lt;li&gt;4. Mrotho gives you Phalk's special golden armor but you must pay for it in gold bars&lt;/li&gt;
 * &lt;li&gt;5. Phalk accepts only the special items from Wrvil and Mrotho with his name on&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * REWARD:
 * &lt;ul&gt;
 * &lt;li&gt;Dwarvish armor&lt;/li&gt;
 * &lt;li&gt;5000 XP in total&lt;/li&gt;
 * &lt;li&gt;Karma&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * REPETITIONS:
 * &lt;ul&gt;
 * &lt;li&gt;Not repeatable.&lt;/li&gt;
 * &lt;/ul&gt;
 */
 
<span class="fc" id="L80"> public class SuppliesForPhalk extends AbstractQuest {</span>
 
 	private static final String QUEST_SLOT = &quot;supplies_for_phalk&quot;;
 	
<span class="fc" id="L84">	private static Logger logger = Logger.getLogger(SuppliesForPhalk.class);</span>
	
 	@Override
	public String getSlotName() {
<span class="fc" id="L88">		return QUEST_SLOT;</span>
	}
	private void askForFood() {
<span class="fc" id="L91">		final SpeakerNPC npc = npcs.get(&quot;Phalk&quot;);	</span>
		
<span class="fc" id="L93">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES, 
				new QuestNotStartedCondition(QUEST_SLOT),
				ConversationStates.QUEST_OFFERED, 
				&quot;I've been here a long time, and I can not leave this place. Could you bring me some food?&quot;,
				null);
							
<span class="fc" id="L100">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES, 
				new QuestCompletedCondition(QUEST_SLOT),
				ConversationStates.ATTENDING,
				&quot;Thanks for getting me the food and clothes. I think I can stand here warning people for some months longer now.&quot;,
				null);
		

<span class="fc" id="L108">		npc.add(ConversationStates.QUEST_OFFERED,</span>
				ConversationPhrases.YES_MESSAGES, null,
				ConversationStates.ATTENDING,
				&quot;Oh, great! I am really hungry and thirsty. 3 #sandwiches, 3 bottles of #beer and 3 glasses of #wine should be enough. Please bring it to me and say #food!&quot;,
				new SetQuestAction(QUEST_SLOT, &quot;start&quot;));

		// Player says no, they've lost karma.
<span class="fc" id="L115">		npc.add(ConversationStates.QUEST_OFFERED,</span>
				ConversationPhrases.NO_MESSAGES, null, ConversationStates.IDLE,
				&quot;Oh, thats not nice... but ok. Maybe the next visitor can help me.&quot;,
				new SetQuestAndModifyKarmaAction(QUEST_SLOT, &quot;rejected&quot;, -10.0));
		
<span class="fc" id="L120">		npc.addReply(&quot;beer&quot;, &quot;In an INN of course!&quot;);</span>
<span class="fc" id="L121">		npc.addReply(&quot;wine&quot;, &quot;In an INN of course!&quot;);</span>
<span class="fc" id="L122">		npc.addReply(Arrays.asList(&quot;sandwiches&quot;, &quot;sandwich&quot;), &quot;Come on, ask in a bakery!&quot;);</span>
<span class="fc" id="L123">	}</span>
	
	private void receiveFood() {
<span class="fc" id="L126">	final SpeakerNPC npc = npcs.get(&quot;Phalk&quot;);	</span>
	
<span class="fc" id="L128">		npc.add(ConversationStates.ATTENDING, &quot;food&quot;,</span>
				new QuestInStateCondition(QUEST_SLOT, &quot;start&quot;),
				ConversationStates.QUEST_ITEM_QUESTION,
				&quot;Do you have 3 sandwiches, 3 bottles of beer and 3 glasses of wine?&quot;,
				null);
		
<span class="fc" id="L134">		final List&lt;ChatAction&gt; actions = new LinkedList&lt;ChatAction&gt;();</span>
<span class="fc" id="L135">		actions.add(new IncreaseXPAction(600));</span>
<span class="fc" id="L136">		actions.add(new DropItemAction(&quot;sandwich&quot;,3));</span>
<span class="fc" id="L137">		actions.add(new DropItemAction(&quot;beer&quot;,3));</span>
<span class="fc" id="L138">		actions.add(new DropItemAction(&quot;wine&quot;,3));</span>
		// the extra parts in the quest state are for wrvil and mrotho not to give them cloaks and armor twice
<span class="fc" id="L140">		actions.add(new SetQuestAndModifyKarmaAction(QUEST_SLOT, &quot;clothes;none;none&quot;, 2.0));</span>
<span class="fc" id="L141">		actions.add(new InflictStatusOnNPCAction(&quot;sandwich&quot;));</span>

<span class="fc" id="L143">		npc.add(ConversationStates.QUEST_ITEM_QUESTION, ConversationPhrases.YES_MESSAGES,</span>
				new AndCondition(
						new QuestInStateCondition(QUEST_SLOT, &quot;start&quot;),
						new PlayerHasItemWithHimCondition(&quot;sandwich&quot;,3),
						new PlayerHasItemWithHimCondition(&quot;beer&quot;,3),
						new PlayerHasItemWithHimCondition(&quot;wine&quot;,3)),
				ConversationStates.ATTENDING, 
				&quot;Yay, thank you!!! There is another thing you could do for me: my clothes are old and dirty and I need a new #cloak and a new #armor. Please bring them to me and say #clothes.&quot;,
				new MultipleActions(actions)
		);
		
		
<span class="fc" id="L155">		npc.add(ConversationStates.QUEST_ITEM_QUESTION, ConversationPhrases.YES_MESSAGES,</span>
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, &quot;start&quot;),
				new NotCondition(
						new AndCondition(
								new PlayerHasItemWithHimCondition(&quot;sandwich&quot;,3),
								new PlayerHasItemWithHimCondition(&quot;beer&quot;,3),
								new PlayerHasItemWithHimCondition(&quot;wine&quot;,3)))),
				ConversationStates.ATTENDING, 
				&quot;I've been around a long time and what's more I am really hungry. You can't trick me.&quot;,
				null);
		
<span class="fc" id="L166">		npc.add(ConversationStates.QUEST_ITEM_QUESTION, </span>
				ConversationPhrases.NO_MESSAGES,
				new QuestInStateCondition(QUEST_SLOT, &quot;start&quot;), 
				ConversationStates.ATTENDING,
				&quot;Pff! Then go away! But be sure, you will not get a reward if you don't bring me the items!&quot;, 
				null);
		
<span class="fc" id="L173">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES, 
				new QuestInStateCondition(QUEST_SLOT, &quot;start&quot;),
				ConversationStates.ATTENDING,
				&quot;I already asked you to bring me some #food!&quot;,
				null);
		
<span class="fc" id="L180">		npc.add(ConversationStates.ATTENDING, &quot;cloak&quot;,</span>
				new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;) ,
				ConversationStates.ATTENDING, 
				&quot;I know Wrvil (he lives in Wofol) has a new cloak for me. Just tell him my name.&quot;,
				null);
		
<span class="fc" id="L186">		npc.add(ConversationStates.ATTENDING, &quot;armor&quot;,</span>
				new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;) ,
				ConversationStates.ATTENDING, 
				&quot;Mrotho (he lives in Ados) told me he will look for a golden armor for me. Just tell him my name.&quot;,
				null);
		
<span class="fc" id="L192">	}</span>
	
	private void getCloak() {
<span class="fc" id="L195">	final SpeakerNPC npc = npcs.get(&quot;Wrvil&quot;);</span>
	
<span class="fc" id="L197">		npc.add(ConversationStates.ATTENDING, &quot;Phalk&quot;,</span>
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),new QuestInStateCondition(QUEST_SLOT, 1, &quot;none&quot;)) ,
				ConversationStates.ATTENDING, 
				&quot;Aaah, his cloak... yes, it is ready. But I am still waiting for the #payment!&quot;,
				null);
		
<span class="fc" id="L203">		npc.add(ConversationStates.ATTENDING, &quot;payment&quot;,</span>
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),new QuestInStateCondition(QUEST_SLOT, 1, &quot;none&quot;)),
				ConversationStates.QUEST_ITEM_QUESTION, 
				&quot;Oh yes! it costs 20 steel arrows. Our victims don't bring them back ;) Do you have them?&quot;,
				null);	
		
<span class="fc" id="L209">		npc.add(ConversationStates.QUEST_ITEM_QUESTION, </span>
				ConversationPhrases.NO_MESSAGES,
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),new QuestInStateCondition(QUEST_SLOT, 1, &quot;none&quot;)), 
				ConversationStates.ATTENDING,
				&quot;So I can not give you the cloak! First the payment!&quot;, 
				null);
		
<span class="fc" id="L216">		final List&lt;ChatAction&gt; actions = new LinkedList&lt;ChatAction&gt;();</span>
<span class="fc" id="L217">		actions.add(new IncreaseXPAction(200));</span>
<span class="fc" id="L218">		actions.add(new DropItemAction(&quot;steel arrow&quot;,20));</span>
<span class="fc" id="L219">		actions.add(new ChatAction() {</span>
			@Override
			public void fire(final Player player, final Sentence sentence, final EventRaiser npc) {
<span class="fc" id="L222">				final Item cloak = SingletonRepository.getEntityManager().getItem(&quot;dwarf cloak&quot;);</span>
<span class="fc" id="L223">				cloak.setInfoString(&quot;Phalk&quot;);</span>
<span class="fc" id="L224">				cloak.setDescription(&quot;You see a brand new dwarf cloak, with the name 'Phalk' sewn into the label by Wrvil.&quot;);</span>
				// remember the description
<span class="fc" id="L226">				cloak.setPersistent(true);</span>
<span class="fc" id="L227">				cloak.setBoundTo(player.getName());</span>
<span class="fc" id="L228">				player.equipOrPutOnGround(cloak);</span>
<span class="fc" id="L229">			}</span>
		});
		// the extra parts in the quest state are for wrvil and mrotho not to give them cloaks and armor twice
<span class="fc" id="L232">		actions.add(new SetQuestAction(QUEST_SLOT, 1, &quot;cloak&quot;));</span>
		
<span class="fc" id="L234">		npc.add(ConversationStates.QUEST_ITEM_QUESTION, ConversationPhrases.YES_MESSAGES,</span>
				new AndCondition(
						new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),new QuestInStateCondition(QUEST_SLOT, 1, &quot;none&quot;)),
						new PlayerHasItemWithHimCondition(&quot;steel arrow&quot;,20)),
				ConversationStates.ATTENDING, 
				&quot;Ok, here you are.&quot;,
				new MultipleActions(actions)
		);
		
		
<span class="fc" id="L244">		npc.add(ConversationStates.QUEST_ITEM_QUESTION, ConversationPhrases.YES_MESSAGES,</span>
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),new QuestInStateCondition(QUEST_SLOT, 1, &quot;none&quot;),
				new NotCondition(new PlayerHasItemWithHimCondition(&quot;steel arrow&quot;,20))),
				ConversationStates.ATTENDING, 
				&quot;Your type are all liars, aren't they? Come back when you have the payment.&quot;,
				null);
		
		
		// player got the cloak already but lost it?
<span class="fc" id="L253">		npc.add(ConversationStates.ATTENDING, &quot;Phalk&quot;,</span>
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),new QuestInStateCondition(QUEST_SLOT, 1, &quot;cloak&quot;)) ,
				ConversationStates.QUEST_ITEM_QUESTION, 
				&quot;Take the cloak I gave you to Phalk. If you lost it the replacement price is 250 money. Do you want to pay for a replacement for Phalk?&quot;,
				null);
		
<span class="fc" id="L259">		final List&lt;ChatAction&gt; actions2 = new LinkedList&lt;ChatAction&gt;();</span>
<span class="fc" id="L260">		actions2.add(new DropItemAction(&quot;money&quot;,250));</span>
<span class="fc" id="L261">		actions2.add(new ChatAction() {</span>
				@Override
				public void fire(final Player player, final Sentence sentence, final EventRaiser npc) {
<span class="fc" id="L264">					final Item cloak = SingletonRepository.getEntityManager().getItem(&quot;dwarf cloak&quot;);</span>
<span class="fc" id="L265">					cloak.setInfoString(&quot;Phalk&quot;);</span>
<span class="fc" id="L266">					cloak.setDescription(&quot;You see a brand new dwarf cloak, with the name 'Phalk' sewn into the label by Wrvil.&quot;);</span>
					// remember the description
<span class="fc" id="L268">					cloak.setPersistent(true);</span>
<span class="fc" id="L269">					cloak.setBoundTo(player.getName());</span>
<span class="fc" id="L270">					player.equipOrPutOnGround(cloak);</span>
<span class="fc" id="L271">				}</span>
			});		
<span class="fc" id="L273">		npc.add(ConversationStates.QUEST_ITEM_QUESTION, ConversationPhrases.YES_MESSAGES,</span>
				new AndCondition(
						new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),new QuestInStateCondition(QUEST_SLOT, 1, &quot;cloak&quot;)),
						new PlayerHasItemWithHimCondition(&quot;money&quot;,250)),
				ConversationStates.ATTENDING, 
				&quot;Ok, here you are.&quot;,
				new MultipleActions(actions2)
		);
		
<span class="fc" id="L282">		npc.add(ConversationStates.QUEST_ITEM_QUESTION, ConversationPhrases.YES_MESSAGES,</span>
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),new QuestInStateCondition(QUEST_SLOT, 1, &quot;cloak&quot;),
				new NotCondition(new PlayerHasItemWithHimCondition(&quot;money&quot;,250))),
				ConversationStates.ATTENDING, 
				&quot;Sorry, you don't have enough money.&quot;,
				null);
		
<span class="fc" id="L289">		npc.add(ConversationStates.QUEST_ITEM_QUESTION, ConversationPhrases.NO_MESSAGES,</span>
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),new QuestInStateCondition(QUEST_SLOT, 1, &quot;cloak&quot;)),
				ConversationStates.ATTENDING, 
				&quot;Okay, but Phalk will only accept a dwarf cloak from me, with his name sewn in.&quot;,
				null);

<span class="fc" id="L295">	}</span>
	
	private void getArmor() {
<span class="fc" id="L298">		final SpeakerNPC npc = npcs.get(&quot;Mrotho&quot;);</span>
		
<span class="fc" id="L300">		npc.add(ConversationStates.ATTENDING, &quot;Phalk&quot;,</span>
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),new QuestInStateCondition(QUEST_SLOT, 2, &quot;none&quot;)) ,
				ConversationStates.QUEST_ITEM_QUESTION, 
				&quot;Ooops, his armor...wait.. where is it.. aah here it is. Did he give you the #payment for me too?&quot;,
				null);
		
<span class="fc" id="L306">		npc.add(ConversationStates.QUEST_ITEM_QUESTION, &quot;payment&quot;,</span>
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),new QuestInStateCondition(QUEST_SLOT, 2, &quot;none&quot;)),
				ConversationStates.QUEST_ITEM_QUESTION, 
				&quot;Well.. the armor will cost 20 gold bars. Do you have them?&quot;,
				null);	
		
		// incase player goes on to ask something else, accept payment from attending too.
<span class="fc" id="L313">		npc.add(ConversationStates.ATTENDING, &quot;payment&quot;,</span>
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),new QuestInStateCondition(QUEST_SLOT, 2, &quot;none&quot;)),
				ConversationStates.QUEST_ITEM_QUESTION, 
				&quot;The armor will cost 20 gold bars. Do you have them?&quot;,
				null);	
		
<span class="fc" id="L319">		npc.add(ConversationStates.QUEST_ITEM_QUESTION, </span>
				ConversationPhrases.NO_MESSAGES,
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),new QuestInStateCondition(QUEST_SLOT, 2, &quot;none&quot;)), 
				ConversationStates.ATTENDING,
				&quot;Bah! I will not give you the armor without payment!&quot;, 
				null);
		
<span class="fc" id="L326">		final List&lt;ChatAction&gt; actions = new LinkedList&lt;ChatAction&gt;();</span>
<span class="fc" id="L327">		actions.add(new IncreaseXPAction(200));</span>
<span class="fc" id="L328">		actions.add(new DropItemAction(&quot;gold bar&quot;,20));</span>
<span class="fc" id="L329">		actions.add(new ChatAction() {</span>
			@Override
			public void fire(final Player player, final Sentence sentence, final EventRaiser npc) {
<span class="fc" id="L332">				final Item armor = SingletonRepository.getEntityManager().getItem(&quot;golden armor&quot;);</span>
<span class="fc" id="L333">				armor.setInfoString(&quot;Phalk&quot;);</span>
<span class="fc" id="L334">				armor.setDescription(&quot;You see a shining golden armor, with the name 'Phalk' inscribed on it.&quot;);</span>
				// remember the description
<span class="fc" id="L336">				armor.setPersistent(true);</span>
<span class="fc" id="L337">				armor.setBoundTo(player.getName());</span>
<span class="fc" id="L338">				player.equipOrPutOnGround(armor);</span>
<span class="fc" id="L339">			}</span>
		});
		// the extra parts in the quest state are for wrvil and mrotho not to give them cloaks and armor twice
<span class="fc" id="L342">		actions.add(new SetQuestAction(QUEST_SLOT, 2, &quot;armor&quot;));</span>
		
<span class="fc" id="L344">		npc.add(ConversationStates.QUEST_ITEM_QUESTION, ConversationPhrases.YES_MESSAGES,</span>
				new AndCondition(
						new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),new QuestInStateCondition(QUEST_SLOT, 2, &quot;none&quot;)),
						new PlayerHasItemWithHimCondition(&quot;gold bar&quot;,20)),
				ConversationStates.ATTENDING, 
				&quot;Ok, here you are.&quot;,
				new MultipleActions(actions)
		);
		
<span class="fc" id="L353">		npc.add(ConversationStates.QUEST_ITEM_QUESTION, ConversationPhrases.YES_MESSAGES,</span>
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),new QuestInStateCondition(QUEST_SLOT, 2, &quot;none&quot;),
				new NotCondition(new PlayerHasItemWithHimCondition(&quot;gold bar&quot;,20))),
				ConversationStates.ATTENDING, 
				&quot;Army disciplinary actions are pretty serious, so don't lie to me.&quot;,
				null);
		
		// player got the armor already but lost it?
<span class="fc" id="L361">		npc.add(ConversationStates.ATTENDING, &quot;Phalk&quot;,</span>
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),new QuestInStateCondition(QUEST_SLOT, 2, &quot;armor&quot;)) ,
				ConversationStates.QUEST_ITEM_QUESTION, 
				&quot;Take the armor I gave you to Phalk. If you lost it the replacement price is 10000 money. Do you want to pay for a replacement for Phalk?&quot;,
				null);
		
<span class="fc" id="L367">		final List&lt;ChatAction&gt; actions2 = new LinkedList&lt;ChatAction&gt;();</span>
<span class="fc" id="L368">		actions2.add(new DropItemAction(&quot;money&quot;,10000));</span>
<span class="fc" id="L369">		actions2.add(new ChatAction() {</span>
			@Override
			public void fire(final Player player, final Sentence sentence, final EventRaiser npc) {
<span class="fc" id="L372">				final Item armor = SingletonRepository.getEntityManager().getItem(&quot;golden armor&quot;);</span>
<span class="fc" id="L373">				armor.setInfoString(&quot;Phalk&quot;);</span>
<span class="fc" id="L374">				armor.setDescription(&quot;You see a shining golden armor, with the name 'Phalk' inscribed on it.&quot;);</span>
				// remember the description
<span class="fc" id="L376">				armor.setPersistent(true);</span>
<span class="fc" id="L377">				armor.setBoundTo(player.getName());</span>
<span class="fc" id="L378">				player.equipOrPutOnGround(armor);</span>
<span class="fc" id="L379">			}</span>
		});		
<span class="fc" id="L381">		npc.add(ConversationStates.QUEST_ITEM_QUESTION, ConversationPhrases.YES_MESSAGES,</span>
				new AndCondition(
						new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),new QuestInStateCondition(QUEST_SLOT, 2, &quot;armor&quot;)),
						new PlayerHasItemWithHimCondition(&quot;money&quot;,10000)),
				ConversationStates.ATTENDING, 
				&quot;Ok, here you are.&quot;,
				new MultipleActions(actions2)
		);
		
<span class="fc" id="L390">		npc.add(ConversationStates.QUEST_ITEM_QUESTION, ConversationPhrases.YES_MESSAGES,</span>
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),new QuestInStateCondition(QUEST_SLOT, 2, &quot;armor&quot;),
				new NotCondition(new PlayerHasItemWithHimCondition(&quot;money&quot;,10000))),
				ConversationStates.ATTENDING, 
				&quot;Sorry, you don't have enough money.&quot;,
				null);
		
<span class="fc" id="L397">		npc.add(ConversationStates.QUEST_ITEM_QUESTION, ConversationPhrases.NO_MESSAGES,</span>
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),new QuestInStateCondition(QUEST_SLOT, 2, &quot;armor&quot;)),
				ConversationStates.ATTENDING, 
				&quot;Okay, but Phalk will only accept golden armor from me, with his name on it.&quot;,
				null);
		
<span class="fc" id="L403">	}</span>
		
	
	private void receiveClothes() {
<span class="fc" id="L407">	final SpeakerNPC npc = npcs.get(&quot;Phalk&quot;);	</span>
	
<span class="fc" id="L409">		final List&lt;ChatAction&gt; actions = new LinkedList&lt;ChatAction&gt;();</span>
<span class="fc" id="L410">		actions.add(new IncreaseXPAction(4000));</span>
<span class="fc" id="L411">		actions.add(new DropInfostringItemAction(&quot;golden armor&quot;,&quot;Phalk&quot;));</span>
<span class="fc" id="L412">		actions.add(new DropInfostringItemAction(&quot;dwarf cloak&quot;,&quot;Phalk&quot;));</span>
<span class="fc" id="L413">		actions.add(new SetQuestAction(QUEST_SLOT, &quot;done&quot;));	</span>
<span class="fc" id="L414">		actions.add(new EquipItemAction(&quot;dwarvish armor&quot;, 1, true));</span>
		
<span class="fc" id="L416">		npc.add(ConversationStates.ATTENDING, &quot;clothes&quot;,</span>
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),
				new PlayerHasInfostringItemWithHimCondition(&quot;golden armor&quot;,&quot;Phalk&quot;),
				new PlayerHasInfostringItemWithHimCondition(&quot;dwarf cloak&quot;,&quot;Phalk&quot;)),
				ConversationStates.ATTENDING, 
				&quot;Oh yeah! Thank you so much! Payment?? Erm... *cough* I will give you my old armor as a reward.&quot;,
				new MultipleActions(actions));

<span class="fc" id="L424">		npc.add(ConversationStates.ATTENDING, &quot;clothes&quot;,</span>
				new AndCondition(new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),
				new NotCondition(
						new AndCondition(
								new PlayerHasInfostringItemWithHimCondition(&quot;golden armor&quot;,&quot;Phalk&quot;),
								new PlayerHasInfostringItemWithHimCondition(&quot;dwarf cloak&quot;,&quot;Phalk&quot;)))),
				ConversationStates.ATTENDING, 
				&quot;Hm, I want the special golden #armor from Mrotho and the dwarf #cloak from Wrvil. Tell them my name and they will give you what they made me.&quot;,
				null);
		
<span class="fc" id="L434">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES, 
				new QuestInStateCondition(QUEST_SLOT, 0, &quot;clothes&quot;),
				ConversationStates.ATTENDING,
				&quot;I am waiting for you to bring me new #clothes from Wrvil and Mrotho.&quot;,
				null);
<span class="fc" id="L440">	}</span>
	
	@Override
	public void addToWorld() {
<span class="fc" id="L444">		fillQuestInfo(</span>
				&quot;Supplies for Phalk&quot;,
				&quot;Phalk, the dwarvish guard in Semos Mine, is in need of supplies.&quot;,
				false);
<span class="fc" id="L448">		askForFood();</span>
<span class="fc" id="L449">		receiveFood();</span>
<span class="fc" id="L450">		getCloak();</span>
<span class="fc" id="L451">		getArmor();</span>
<span class="fc" id="L452">		receiveClothes();</span>
<span class="fc" id="L453">	}</span>
	
	@Override
	public List&lt;String&gt; getHistory(final Player player) {
<span class="nc" id="L457">			final List&lt;String&gt; res = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">			if (!player.hasQuest(QUEST_SLOT)) {</span>
<span class="nc" id="L459">				return res;</span>
			}
<span class="nc" id="L461">			final String questState = player.getQuest(QUEST_SLOT);</span>
<span class="nc" id="L462">			res.add(&quot;I spoke with Phalk, who guards a passage in Semos Mines.&quot;);</span>
<span class="nc" id="L463">			res.add(&quot;Phalk asked me to bring him 3 sandwiches, 3 bottles of beer and 3 glasses of wine.&quot;);</span>
<span class="nc bnc" id="L464" title="All 2 branches missed.">			if (&quot;rejected&quot;.equals(questState)) {</span>
<span class="nc" id="L465">				res.add(&quot;I don't want to help Phalk.&quot;);</span>
<span class="nc" id="L466">				return res;</span>
			} 
<span class="nc bnc" id="L468" title="All 2 branches missed.">			if (&quot;start&quot;.equals(questState)) {</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">				if(player.isEquipped(&quot;sandwich&quot;,3)) {</span>
<span class="nc" id="L470">					res.add(&quot;I have the sandwiches!&quot;);</span>
				}
<span class="nc bnc" id="L472" title="All 2 branches missed.">				if(player.isEquipped(&quot;beer&quot;,3)) {</span>
<span class="nc" id="L473">					res.add(&quot;I have the beer!&quot;);</span>
				}
<span class="nc bnc" id="L475" title="All 2 branches missed.">				if(player.isEquipped(&quot;wine&quot;,3)) {</span>
<span class="nc" id="L476">					res.add(&quot;I have the wine!&quot;);</span>
				}
<span class="nc" id="L478">				return res;</span>
			} 
<span class="nc" id="L480">			res.add(&quot;Now Phalk needs me to collect a cloak from Wrvil and some armor from Mrotho.&quot;);</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">			if (questState.startsWith(&quot;clothes&quot;)) {</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">				if(new QuestInStateCondition(QUEST_SLOT, 1, &quot;cloak&quot;).fire(player,null, null)){</span>
<span class="nc" id="L483">					res.add(&quot;I have collected the cloak and had to pay for it!&quot;);</span>
				}
<span class="nc bnc" id="L485" title="All 2 branches missed.">				if(new QuestInStateCondition(QUEST_SLOT, 2, &quot;armor&quot;).fire(player,null, null)){</span>
<span class="nc" id="L486">					res.add(&quot;Mrotho gave me Phalk's golden armor but I had to cover his debt.&quot;);</span>
				}
<span class="nc" id="L488">				return res;</span>
			} 
<span class="nc" id="L490">			res.add(&quot;I collected Phalk's equipment and he gave me his dwarvish armor in return!&quot;);</span>
<span class="nc bnc" id="L491" title="All 2 branches missed.">			if (isCompleted(player)) {</span>
<span class="nc" id="L492">				return res;</span>
			}
			// if things have gone wrong and the quest state didn't match any of the above, debug a bit:
<span class="nc" id="L495">			final List&lt;String&gt; debug = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L496">			debug.add(&quot;Quest state is: &quot; + questState);</span>
<span class="nc" id="L497">			logger.error(&quot;History doesn't have a matching quest state for &quot; + questState);</span>
<span class="nc" id="L498">			return debug;</span>
	}
	
	@Override
	public String getName() {
<span class="nc" id="L503">		return &quot;SuppliesForPhalk&quot;;</span>
	}
	
	@Override
	public int getMinLevel() {
<span class="fc" id="L508">		return 30;</span>
	}
	@Override
	public String getNPCName() {
<span class="nc" id="L512">		return &quot;Phalk&quot;;</span>
	}
		
	@Override
	public String getRegion() {
<span class="nc" id="L517">		return Region.SEMOS_MINES;</span>
	}
}
 
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>