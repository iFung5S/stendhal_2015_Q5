<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>WeaponsCollector2.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.quests</a> &gt; <span class="el_source">WeaponsCollector2.java</span></div><h1>WeaponsCollector2.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.maps.quests;

import games.stendhal.common.grammar.Grammar;
import games.stendhal.common.parser.Sentence;
import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.entity.item.Item;
import games.stendhal.server.entity.npc.ChatAction;
import games.stendhal.server.entity.npc.ConversationPhrases;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.EventRaiser;
import games.stendhal.server.entity.npc.SpeakerNPC;
import games.stendhal.server.entity.npc.condition.AndCondition;
import games.stendhal.server.entity.npc.condition.GreetingMatchesNameCondition;
import games.stendhal.server.entity.npc.condition.QuestActiveCondition;
import games.stendhal.server.entity.npc.condition.QuestCompletedCondition;
import games.stendhal.server.entity.npc.condition.QuestNotStartedCondition;
import games.stendhal.server.entity.player.Player;
import games.stendhal.server.maps.Region;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.LinkedList;
import java.util.List;

/**
 * QUEST: The Weapons Collector Part 2
 * &lt;p&gt;
 * PARTICIPANTS:
 * &lt;ul&gt;
 * &lt;li&gt; Balduin, a hermit living on a mountain between Semos and Ados
 * &lt;/ul&gt;
 * &lt;p&gt;
 * STEPS:
 * &lt;ul&gt;
 * &lt;li&gt; Balduin asks you for some new weapons.
 * &lt;li&gt; You get one of the weapons somehow, e.g. by killing a monster.
 * &lt;li&gt; You bring the weapon up the mountain and give it to Balduin.
 * &lt;li&gt; Repeat until Balduin received all weapons. (Of course you can bring up
 * several weapons at the same time.)
 * &lt;li&gt; Balduin gives you a pair of swords in exchange.
 * &lt;/ul&gt;
 * REWARD:
 * &lt;ul&gt;
 * &lt;li&gt; rhand sword and lhand sword
 * &lt;li&gt; 3000 XP
 * &lt;li&gt; 60 karma
 * &lt;/ul&gt;
 * REPETITIONS:
 * &lt;ul&gt;
 * &lt;li&gt; None.
 * &lt;/ul&gt;
 */
<span class="fc" id="L65">public class WeaponsCollector2 extends AbstractQuest {</span>

	private static final String QUEST_SLOT = &quot;weapons_collector2&quot;;

	
<span class="fc" id="L70">	private static final List&lt;String&gt; neededWeapons = Arrays.asList(</span>
			// fairly rare from glow_monster in haunted house
			&quot;morning star&quot;,
			// rare from monk on mountain
			&quot;staff&quot;, 
			// rare from devil_queen on mountain
			&quot;great sword&quot; 
	);

	@Override
	public String getSlotName() {
<span class="fc" id="L81">		return QUEST_SLOT;</span>
	}

	public List&lt;String&gt; getNeededItems() {
<span class="fc" id="L85">		return neededWeapons;</span>
	}

	public SpeakerNPC getNPC() {
<span class="fc" id="L89">		return npcs.get(&quot;Balduin&quot;);</span>
	}

	/**
	 * Returns a list of the names of all weapons that the given player still
	 * has to bring to fulfill the quest.
	 * 
	 * @param player
	 *            The player doing the quest
	 * @param hash
	 *            If true, sets a # character in front of every name
	 * @return A list of weapon names
	 */
	private List&lt;String&gt; missingWeapons(final Player player, final boolean hash) {
<span class="fc" id="L103">		final List&lt;String&gt; result = new LinkedList&lt;String&gt;();</span>

<span class="fc" id="L105">		String doneText = player.getQuest(QUEST_SLOT);</span>
<span class="pc bpc" id="L106" title="1 of 2 branches missed.">		if (doneText == null) {</span>
<span class="nc" id="L107">			doneText = &quot;&quot;;</span>
		}
<span class="fc" id="L109">		final List&lt;String&gt; done = Arrays.asList(doneText.split(&quot;;&quot;));</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">		for (String weapon : neededWeapons) {</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">			if (!done.contains(weapon)) {</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">				if (hash) {</span>
<span class="fc" id="L113">					weapon = &quot;#&quot; + weapon;</span>
				}
<span class="fc" id="L115">				result.add(weapon);</span>
			}
<span class="fc" id="L117">		}</span>
<span class="fc" id="L118">		return result;</span>
	}

	private void step_1() {
<span class="fc" id="L122">		final SpeakerNPC npc = getNPC();</span>

		// player says hi before starting the quest
<span class="fc" id="L125">		npc.add(ConversationStates.IDLE,</span>
				ConversationPhrases.GREETING_MESSAGES,
				new AndCondition(new GreetingMatchesNameCondition(npc.getName()),
						new QuestCompletedCondition(&quot;weapons_collector&quot;),
						new QuestNotStartedCondition(QUEST_SLOT)),
			    ConversationStates.ATTENDING,
			    &quot;Greetings, old friend. If you are willing, I have another #quest for you.&quot;,
			    null);

<span class="fc" id="L134">		npc.add(ConversationStates.ATTENDING,</span>
				ConversationPhrases.QUEST_MESSAGES, 
				new AndCondition(new QuestCompletedCondition(&quot;weapons_collector&quot;), new QuestNotStartedCondition(QUEST_SLOT)),
				ConversationStates.QUEST_2_OFFERED, 
				null, 
<span class="fc" id="L139">				new ChatAction() {</span>
					@Override
					public void fire(final Player player, final Sentence sentence, final EventRaiser raiser) {
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">							if (player.isQuestCompleted(QUEST_SLOT)) {</span>
<span class="nc" id="L143">								raiser.say(&quot;My collection is now complete! Thanks again.&quot;);</span>
<span class="nc" id="L144">								raiser.setCurrentState(ConversationStates.ATTENDING);</span>
							} else {
<span class="fc" id="L146">								raiser.say(&quot;Recent adventurers to these parts describe strange new creatures with weapons I have never seen. &quot;</span>
										+ &quot;Would you fight these creatures and bring their weapons to me?&quot;);
							}
<span class="fc" id="L149">						}</span>
				});

		// player is willing to help
<span class="fc" id="L153">		npc.add(ConversationStates.QUEST_2_OFFERED,</span>
				ConversationPhrases.YES_MESSAGES, 
				null,
				ConversationStates.ATTENDING, 
				null, 
<span class="fc" id="L158">				new ChatAction() {</span>
					@Override
					public void fire(final Player player, final Sentence sentence, final EventRaiser raiser) {
<span class="fc" id="L161">						raiser.say(&quot;Wonderful. Now, the #list is small but the risk may be great. &quot;</span>
								+ &quot;If you return safely, I have another reward for you.&quot;);
<span class="fc" id="L163">						player.setQuest(QUEST_SLOT, &quot;&quot;);</span>
<span class="fc" id="L164">					}</span>
				});

		// player is not willing to help
<span class="fc" id="L168">		npc.add(ConversationStates.QUEST_2_OFFERED,</span>
				ConversationPhrases.NO_MESSAGES, 
				null,
				ConversationStates.ATTENDING,
				&quot;Well, maybe someone else will happen by and help me.&quot;, 
				null);

		// player asks what exactly is missing
<span class="fc" id="L176">		npc.add(ConversationStates.ATTENDING, </span>
				&quot;list&quot;, 
				new QuestActiveCondition(QUEST_SLOT), 
				ConversationStates.QUESTION_2, 
				null,
<span class="fc" id="L181">				new ChatAction() {</span>
					@Override
					public void fire(final Player player, final Sentence sentence, final EventRaiser raiser) {
<span class="fc" id="L184">						final List&lt;String&gt; needed = missingWeapons(player, true);</span>
<span class="fc" id="L185">						raiser.say(&quot;There &quot;</span>
								+ Grammar.isare(needed.size())
								+ &quot; &quot;
								+ Grammar.quantityplnoun(needed.size(), &quot;weapon&quot;, &quot;a&quot;)
								+ &quot; still missing from my newest collection: &quot;
								+ Grammar.enumerateCollection(needed)
								+ &quot;. Do you have anything like that with you?&quot;);
<span class="fc" id="L192">					}</span>
				});

		// player says he doesn't have required weapons with him
<span class="fc" id="L196">		npc.add(ConversationStates.QUESTION_2, </span>
				ConversationPhrases.NO_MESSAGES,
				null, 
				ConversationStates.IDLE, 
				null, 
<span class="fc" id="L201">				new ChatAction() {</span>
					@Override
					public void fire(final Player player, final Sentence sentence, final EventRaiser raiser) {
<span class="fc" id="L204">						final List&lt;String&gt; missing = missingWeapons(player, false);</span>
<span class="fc" id="L205">						raiser.say(&quot;Let me know as soon as you find &quot;</span>
								+ Grammar.itthem(missing.size())
								+ &quot;. Farewell.&quot;);
<span class="fc" id="L208">					}</span>
				});

		// player says he has a required weapon with him
<span class="fc" id="L212">		npc.add(ConversationStates.QUESTION_2,</span>
				ConversationPhrases.YES_MESSAGES, 
				null,
				ConversationStates.QUESTION_2, 
				&quot;What did you find?&quot;, 
				null);

<span class="fc bfc" id="L219" title="All 2 branches covered.">		for(final String itemName : neededWeapons) {</span>
<span class="fc" id="L220">			npc.add(ConversationStates.QUESTION_2, </span>
				itemName, 
				null,
				ConversationStates.QUESTION_2, 
				null, 
<span class="fc" id="L225">				new ChatAction() {</span>
					@Override
					public void fire(final Player player, final Sentence sentence, final EventRaiser raiser) {
<span class="fc" id="L228">						List&lt;String&gt; missing = missingWeapons(player, false);</span>

<span class="fc bfc" id="L230" title="All 2 branches covered.">						if (missing.contains(itemName)) {</span>
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">							if (player.drop(itemName)) {</span>
								// register weapon as done
<span class="fc" id="L233">								final String doneText = player.getQuest(QUEST_SLOT);</span>
<span class="fc" id="L234">								player.setQuest(QUEST_SLOT, doneText + &quot;;&quot; + itemName);</span>

								// check if the player has brought all weapons
<span class="fc" id="L237">								missing = missingWeapons(player, true);</span>

<span class="fc bfc" id="L239" title="All 2 branches covered.">								if (!missing.isEmpty()) {</span>
<span class="fc" id="L240">									raiser.say(&quot;Thank you very much! Do you have anything more for me?&quot;);</span>
								} else {
<span class="fc" id="L242">									final Item lhandsword = SingletonRepository.getEntityManager().getItem(</span>
											&quot;l hand sword&quot;);
<span class="fc" id="L244">									lhandsword.setBoundTo(player.getName());</span>
<span class="fc" id="L245">									player.equipOrPutOnGround(lhandsword);</span>
<span class="fc" id="L246">									final Item rhandsword = SingletonRepository.getEntityManager().getItem(</span>
											&quot;r hand sword&quot;);
<span class="fc" id="L248">									rhandsword.setBoundTo(player.getName());</span>
<span class="fc" id="L249">									player.equipOrPutOnGround(rhandsword);</span>
<span class="fc" id="L250">									player.addXP(3000);</span>
<span class="fc" id="L251">									player.addKarma(60);</span>
<span class="fc" id="L252">									raiser.say(&quot;At last, my collection is complete! Thank you very much; here, take this pair of swords in exchange!&quot;);</span>
<span class="fc" id="L253">									player.setQuest(QUEST_SLOT, &quot;done&quot;);</span>
<span class="fc" id="L254">									player.notifyWorldAboutChanges();</span>
<span class="fc" id="L255">									raiser.setCurrentState(ConversationStates.ATTENDING);</span>
								}
<span class="fc" id="L257">							} else {</span>
<span class="nc" id="L258">								raiser.say(&quot;I may be old, but I'm not senile, and you clearly don't have &quot;</span>
										+ Grammar.a_noun(itemName)
										+ &quot;. What do you really have for me?&quot;);
							}
						} else {
<span class="fc" id="L263">							raiser.say(&quot;I already have that one. Do you have any other weapon for me?&quot;);</span>
						}
<span class="fc" id="L265">					}</span>
				});
<span class="fc" id="L267">		}</span>
<span class="fc" id="L268">	}</span>

	private void step_2() {
		// Just find some of the weapons somewhere and bring them to Balduin.
<span class="fc" id="L272">	}</span>

	private void step_3() {
<span class="fc" id="L275">		final SpeakerNPC npc = getNPC();</span>

		// player returns while quest is still active
<span class="fc" id="L278">		playerReturnsWhileQuestIsActive(npc);</span>

		// player returns after finishing the quest
	//	playerReturnsAfterFinishingQuest(npc);
<span class="fc" id="L282">	}</span>

	private void playerReturnsWhileQuestIsActive(final SpeakerNPC npc) {
<span class="fc" id="L285">		npc.add(ConversationStates.IDLE,</span>
				ConversationPhrases.GREETING_MESSAGES,
				new AndCondition(new GreetingMatchesNameCondition(npc.getName()),
						new QuestActiveCondition(QUEST_SLOT)),
				ConversationStates.ATTENDING,
				&quot;Welcome back. I hope you have come to help me with my latest #list of weapons.&quot;,
				null);
<span class="fc" id="L292">	}</span>

/*	private void playerReturnsAfterFinishingQuest(final SpeakerNPC npc) {
		npc.add(ConversationStates.IDLE, 
				ConversationPhrases.GREETING_MESSAGES,
				new AndCondition(new SubjectOptMatchCondition(getName()),
						new QuestCompletedCondition(QUEST_SLOT)),
				ConversationStates.ATTENDING,
				&quot;Welcome! Thanks again for extending my collection.&quot;,
				null);
	} */

	@Override
	public void addToWorld() {
<span class="fc" id="L306">		fillQuestInfo(</span>
				&quot;Weapon Collector 2&quot;,
				&quot;Balduin, the hermit who is living on Ados rock, has heard of more weapons he can collect.&quot;,
				true);
<span class="fc" id="L310">		step_1();</span>
<span class="fc" id="L311">		step_2();</span>
<span class="fc" id="L312">		step_3();</span>
<span class="fc" id="L313">	}</span>
	
	
	@Override
	public List&lt;String&gt; getHistory(final Player player) {
<span class="nc" id="L318">			final List&lt;String&gt; res = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">			if (!player.hasQuest(QUEST_SLOT)) {</span>
<span class="nc" id="L320">				return res;</span>
			}
<span class="nc bnc" id="L322" title="All 2 branches missed.">			if (!isCompleted(player)) {</span>
<span class="nc" id="L323">				res.add(&quot;I'm collecting weapons for Balduin's collection. I still need &quot; + Grammar.enumerateCollection(missingWeapons(player, false)) + &quot;.&quot;);</span>
			} else {
<span class="nc" id="L325">				res.add(&quot;I found all the weapons Balduin asked for and he rewarded me with a pair of handed swords.&quot;);</span>
			}
<span class="nc" id="L327">			return res;</span>
	}
	
	@Override
	public String getName() {
<span class="nc" id="L332">		return &quot;WeaponsCollector2&quot;;</span>
	}
	
	// it can be a long quest so they can always start it before they can necessarily finish all
	@Override
	public int getMinLevel() {
<span class="fc" id="L338">		return 60;</span>
	}

	@Override
	public String getNPCName() {
<span class="nc" id="L343">		return &quot;Balduin&quot;;</span>
	}
	
	@Override
	public String getRegion() {
<span class="nc" id="L348">		return Region.ADOS_SURROUNDS;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>