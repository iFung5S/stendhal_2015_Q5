<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>FruitsForCoralia.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.quests</a> &gt; <span class="el_source">FruitsForCoralia.java</span></div><h1>FruitsForCoralia.java</h1><pre class="source lang-java linenums">package games.stendhal.server.maps.quests;
 
import games.stendhal.common.grammar.Grammar;
import games.stendhal.server.entity.npc.ChatAction;
import games.stendhal.server.entity.npc.ConversationPhrases;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.SpeakerNPC;
import games.stendhal.server.entity.npc.action.CollectRequestedItemsAction;
import games.stendhal.server.entity.npc.action.EquipRandomAmountOfItemAction;
import games.stendhal.server.entity.npc.action.IncreaseKarmaAction;
import games.stendhal.server.entity.npc.action.IncreaseXPAction;
import games.stendhal.server.entity.npc.action.MultipleActions;
import games.stendhal.server.entity.npc.action.SayRequiredItemsFromCollectionAction;
import games.stendhal.server.entity.npc.action.SayTextAction;
import games.stendhal.server.entity.npc.action.SetQuestAction;
import games.stendhal.server.entity.npc.action.SetQuestAndModifyKarmaAction;
import games.stendhal.server.entity.npc.action.SetQuestToTimeStampAction;
import games.stendhal.server.entity.npc.condition.AndCondition;
import games.stendhal.server.entity.npc.condition.GreetingMatchesNameCondition;
import games.stendhal.server.entity.npc.condition.NotCondition;
import games.stendhal.server.entity.npc.condition.QuestActiveCondition;
import games.stendhal.server.entity.npc.condition.QuestCompletedCondition;
import games.stendhal.server.entity.npc.condition.QuestInStateCondition;
import games.stendhal.server.entity.npc.condition.QuestNotInStateCondition;
import games.stendhal.server.entity.npc.condition.QuestNotStartedCondition;
import games.stendhal.server.entity.npc.condition.QuestStateStartsWithCondition;
import games.stendhal.server.entity.npc.condition.TimePassedCondition;
import games.stendhal.server.entity.player.Player;
import games.stendhal.server.maps.Region;
import games.stendhal.server.util.ItemCollection;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

/**
 * QUEST: Fruits for Coralia
 * 
 * PARTICIPANTS:
 * &lt;ul&gt;
 * &lt;li&gt;Coralia (Bar-maid of Ado tavern)&lt;/li&gt;
 * &lt;/ul&gt;
 * 
 * STEPS:
 * &lt;ul&gt;
 * &lt;li&gt;Coralia introduces herself and asks for a variety of fresh fruits for her hat.&lt;/li&gt;
 * &lt;li&gt;You collect the items.&lt;/li&gt;
 * &lt;li&gt;Coralia sees your items, asks for them then thanks you.&lt;/li&gt;
 * &lt;/ul&gt;
 * 
 * REWARD:
 * &lt;ul&gt;
 * &lt;li&gt;XP: 300&lt;/li&gt;
 * &lt;li&gt;&lt;1-5&gt; Crepes Suzettes&lt;/li&gt;
 * &lt;li&gt;&lt;2-8&gt; Minor Potions&lt;/li&gt;
 * &lt;li&gt;Karma: 5&lt;/li&gt;
 * &lt;/ul&gt;
 * 
 * REPETITIONS:
 * &lt;ul&gt;
 * &lt;li&gt;After 1 week, fit with the withering of the fruits&lt;/li&gt;
 * &lt;/ul&gt;
 * 
 * @author pinchanzee
 */
<span class="fc" id="L66">public class FruitsForCoralia extends AbstractQuest {</span>
 
	
	
	/**
	 * NOTE: Reward has not been set, nor has the XP.
	 * left them default here, but in the JUnit test
	 * called reward item &quot;REWARD&quot; temporarily
	 */
	
    public static final String QUEST_SLOT = &quot;fruits_coralia&quot;;
    
    /** 
     * The delay between repeating quests.
     * 1 week
     */
	private static final int REQUIRED_MINUTES = 1440;
    
    /**
	 * Required items for the quest.
	 */
	protected static final String NEEDED_ITEMS = &quot;apple=4;banana=5;cherry=9;grapes=2;pear=4;watermelon=1;pomegranate=2&quot;;
 
    @Override
    public void addToWorld() {
<span class="fc" id="L91">        fillQuestInfo(&quot;Fruits for Coralia&quot;,</span>
				&quot;The Ados Tavern barmaid, Coralia, searches for fresh fruits for her exotic hat.&quot;,
				true);
<span class="fc" id="L94">        prepareQuestStep();</span>
<span class="fc" id="L95">        prepareBringingStep();</span>
<span class="fc" id="L96">    }</span>
 
    @Override
    public String getSlotName() {
<span class="fc" id="L100">        return QUEST_SLOT;</span>
    }
 
    @Override
    public String getName() {
<span class="nc" id="L105">        return &quot;FruitsForCoralia&quot;;</span>
    }
    
 	@Override
 	public int getMinLevel() {
<span class="fc" id="L110"> 		return 0;</span>
 	}
 	
 	@Override
 	public boolean isRepeatable(final Player player) {
<span class="nc" id="L115"> 		return new AndCondition(</span>
 					new QuestStateStartsWithCondition(QUEST_SLOT, &quot;done;&quot;),
 					new TimePassedCondition(QUEST_SLOT, 1, REQUIRED_MINUTES)).fire(player, null, null);
 	}
 	
 	@Override
 	public String getRegion() {
<span class="nc" id="L122"> 		return Region.ADOS_CITY;</span>
 	}
 
 	@Override
	public List&lt;String&gt; getHistory(final Player player) {
<span class="nc" id="L127">		final List&lt;String&gt; res = new ArrayList&lt;String&gt;();</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">		if (!player.hasQuest(QUEST_SLOT)) {</span>
<span class="nc" id="L129">			return res;</span>
		}
<span class="nc" id="L131">		res.add(&quot;Coralia asked me for some fresh fruits for her hat.&quot;);</span>
<span class="nc" id="L132">		final String questState = player.getQuest(QUEST_SLOT);</span>
		
<span class="nc bnc" id="L134" title="All 2 branches missed.">		if (&quot;rejected&quot;.equals(questState)) {</span>
			// quest rejected
<span class="nc" id="L136">			res.add(&quot;I decided not find Coralia some fruits, I have better things to do.&quot;);</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">		} else if (!player.isQuestCompleted(QUEST_SLOT)) {</span>
			// not yet finished
<span class="nc" id="L139">			final ItemCollection missingItems = new ItemCollection();</span>
<span class="nc" id="L140">			missingItems.addFromQuestStateString(questState);</span>
<span class="nc" id="L141">			res.add(&quot;I still need to bring Coralia &quot; + Grammar.enumerateCollection(missingItems.toStringList()) + &quot;.&quot;);</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">		} else if (isRepeatable(player)) {</span>
			// may be repeated now
<span class="nc" id="L144">			res.add(&quot;It's been a while since I brought Coralia fresh fruits for her hat, I wonder if the fruits have withered?&quot;);</span>
        } else {
        	// not (currently) repeatable
<span class="nc" id="L147">        	res.add(&quot;I brought Coralia the fruits she needed for her hat and she restored it to its old radiance.&quot;);</span>
		}
<span class="nc" id="L149">		return res;</span>
	}
    
    public void prepareQuestStep() {
<span class="fc" id="L153">    	SpeakerNPC npc = npcs.get(&quot;Coralia&quot;);</span>
    	
    	// various quest introductions
    	
    	// offer quest first time
<span class="fc" id="L158">    	npc.add(ConversationStates.ATTENDING,</span>
    		ConversationPhrases.combine(ConversationPhrases.QUEST_MESSAGES, &quot;fruit&quot;),
    		new AndCondition(
    			new QuestNotStartedCondition(QUEST_SLOT),
    			new QuestNotInStateCondition(QUEST_SLOT, &quot;rejected&quot;)),
    		ConversationStates.QUEST_OFFERED,
    		&quot;Would you be kind enough to find me some fresh fruits for my hat? I'd be ever so grateful!&quot;,
    		null);
    	
    	// ask for quest again after rejected
<span class="fc" id="L168">    	npc.add(ConversationStates.ATTENDING, </span>
    		ConversationPhrases.combine(ConversationPhrases.QUEST_MESSAGES, &quot;hat&quot;),
    		new QuestInStateCondition(QUEST_SLOT, &quot;rejected&quot;),
    		ConversationStates.QUEST_OFFERED, 
    		&quot;Are you willing to find me some fresh fruits for my hat yet?&quot;,
    		null);
    	
    	// repeat quest
<span class="fc" id="L176">    	npc.add(ConversationStates.ATTENDING,</span>
            ConversationPhrases.combine(ConversationPhrases.QUEST_MESSAGES, &quot;hat&quot;),
            new AndCondition(
            	new QuestCompletedCondition(QUEST_SLOT),
            	new TimePassedCondition(QUEST_SLOT, 1, REQUIRED_MINUTES)),
            ConversationStates.QUEST_OFFERED,
            &quot;I'm sorry to say that the fruits you brought for my hat aren't very fresh anymore. &quot; +
            &quot;Would you be kind enough to find me some more?&quot;,
            null);
    	    	
    	// quest inactive    	
<span class="fc" id="L187">    	npc.add(ConversationStates.ATTENDING,</span>
        	ConversationPhrases.combine(ConversationPhrases.QUEST_MESSAGES, &quot;hat&quot;),
        	new AndCondition(
        		new QuestCompletedCondition(QUEST_SLOT),
        		new NotCondition(new TimePassedCondition(QUEST_SLOT, 1, REQUIRED_MINUTES))),
        	ConversationStates.ATTENDING,
        	&quot;Doesn't my hat look so fresh? I don't need any new fresh fruits for it yet, but thanks for enquiring!&quot;,
        	null);
    	
    	// end of quest introductions
    	
    	
    	// introduction chat    	
<span class="fc" id="L200">    	npc.add(ConversationStates.ATTENDING,</span>
        	&quot;hat&quot;,
        	new AndCondition(
        		new QuestNotStartedCondition(QUEST_SLOT),
        		new QuestNotInStateCondition(QUEST_SLOT, &quot;rejected&quot;)),
        	ConversationStates.ATTENDING,
        	&quot;It's a shame for you to see it all withered like this, it really needs some fresh #fruits...&quot;,
        	null);
    	
    	// accept quest response
<span class="fc" id="L210">    	npc.add(ConversationStates.QUEST_OFFERED,</span>
    		ConversationPhrases.YES_MESSAGES,
    		null,
    		ConversationStates.QUESTION_1,
    		null,
			new MultipleActions(
				new SetQuestAction(QUEST_SLOT, NEEDED_ITEMS),
				new SayRequiredItemsFromCollectionAction(QUEST_SLOT, &quot;That's wonderful! I'd like these fresh fruits: [items].&quot;)));
    	
    	// reject quest response
<span class="fc" id="L220">    	npc.add(ConversationStates.QUEST_OFFERED,</span>
        	ConversationPhrases.NO_MESSAGES,
        	null,
        	ConversationStates.ATTENDING,
        	&quot;These exotic hats don't keep themselves you know...&quot;,
        	new SetQuestAndModifyKarmaAction(QUEST_SLOT, &quot;rejected&quot;, -5.0));
    	
    	// meet again during quest
<span class="fc" id="L228">    	npc.add(ConversationStates.IDLE, </span>
    		ConversationPhrases.GREETING_MESSAGES,
			new AndCondition(
				new QuestActiveCondition(QUEST_SLOT),
				new GreetingMatchesNameCondition(npc.getName())),
			ConversationStates.ATTENDING,
			&quot;Hello again. If you've brought me some fresh fruits for my #hat, I'll happily take them!&quot;,
			null);

   	
    	
    	// specific fruit info
<span class="fc" id="L240">    	npc.add(ConversationStates.QUESTION_1,</span>
        	&quot;apple&quot;,
        	new QuestActiveCondition(QUEST_SLOT),
        	ConversationStates.QUESTION_1,
        	&quot;Glowing, radiant apples! The ones I have just now came from somewhere east of Semos.&quot;,
        	null);
    	
<span class="fc" id="L247">    	npc.add(ConversationStates.QUESTION_1,</span>
            &quot;banana&quot;,
            new QuestActiveCondition(QUEST_SLOT),
            ConversationStates.QUESTION_1,
            &quot;There's one particularly exotic island with bananas.. Keep west, though - lets just say the bananas aren't meaty or fleshy enough for those in the east.&quot;,
            null);
    	
<span class="fc" id="L254">    	npc.add(ConversationStates.QUESTION_1,</span>
        	&quot;cherry&quot;,
        	new QuestActiveCondition(QUEST_SLOT),
        	ConversationStates.QUESTION_1,
        	&quot;There's an old lady in Fado who sells the most beautifully vibrant cherries.&quot;,
        	null);
    	
<span class="fc" id="L261">    	npc.add(ConversationStates.QUESTION_1,</span>
            &quot;grapes&quot;,
            new QuestActiveCondition(QUEST_SLOT),
            ConversationStates.QUESTION_1,
            &quot;There's a beautiful little temple in the mountains north of Semos that's covered in grape vines!  I've also heard of some by an old house in Or'ril mountains.&quot;,
            null);
    	
<span class="fc" id="L268">    	npc.add(ConversationStates.QUESTION_1,</span>
        	&quot;pear&quot;,
        	new QuestActiveCondition(QUEST_SLOT),
        	ConversationStates.QUESTION_1,
        	&quot;I think I saw some pear trees in the northern mountains near a beautiful waterfall.&quot;,
        	null);
    	
<span class="fc" id="L275">    	npc.add(ConversationStates.QUESTION_1,</span>
            &quot;watermelon&quot;,
            new QuestActiveCondition(QUEST_SLOT),
            ConversationStates.QUESTION_1,
            &quot;One of the huge watermelons from Kalavan gardens would make a nice new centrepiece for my hat.&quot;,
            null);
    	
<span class="fc" id="L282">    	npc.add(ConversationStates.QUESTION_1,</span>
            &quot;pomegranate&quot;,
            new QuestActiveCondition(QUEST_SLOT),
            ConversationStates.QUESTION_1,
            &quot;I've never seen pomegranate trees growing wild, but I heard of a man living south of the great river cultivating them in his garden.&quot;,
            null);
<span class="fc" id="L288">    }</span>
    
    
    private void prepareBringingStep() {
<span class="fc" id="L292">		final SpeakerNPC npc = npcs.get(&quot;Coralia&quot;);</span>
		
		// ask for required items
<span class="fc" id="L295">    	npc.add(ConversationStates.ATTENDING, </span>
    		ConversationPhrases.combine(ConversationPhrases.QUEST_MESSAGES, &quot;hat&quot;),
    		new QuestActiveCondition(QUEST_SLOT),
    		ConversationStates.QUESTION_2, 
    		null,
    		new SayRequiredItemsFromCollectionAction(QUEST_SLOT, &quot;I'd still like [items]. Have you brought any?&quot;));
    	
    	// player says he didn't bring any items
<span class="fc" id="L303">		npc.add(ConversationStates.QUESTION_2, </span>
			ConversationPhrases.NO_MESSAGES,
			new QuestActiveCondition(QUEST_SLOT),
			ConversationStates.QUESTION_1,
			null,
			new SayRequiredItemsFromCollectionAction(QUEST_SLOT, &quot;Oh, that's a shame, do tell me when you find some. I'd still like [items].&quot;));
    	
    	// player says he has a required item with him
<span class="fc" id="L311">		npc.add(ConversationStates.QUESTION_2,</span>
			ConversationPhrases.YES_MESSAGES,
			new QuestActiveCondition(QUEST_SLOT),
			ConversationStates.QUESTION_2, 
			&quot;Wonderful, what fresh delights have you brought?&quot;,
			null);
    	
		// set up next step
<span class="fc" id="L319">    	ChatAction completeAction = new  MultipleActions(</span>
			new SetQuestAction(QUEST_SLOT, &quot;done&quot;),
			new SayTextAction(&quot;My hat has never looked so delightful! Thank you ever so much! Here, take this as a reward.&quot;),
			new IncreaseXPAction(300),
			new IncreaseKarmaAction(5),
			new EquipRandomAmountOfItemAction(&quot;crepes suzette&quot;, 1, 5),
			new EquipRandomAmountOfItemAction(&quot;minor potion&quot;, 2, 8),
			new SetQuestToTimeStampAction(QUEST_SLOT, 1)
		);
    	
    	// add triggers for the item names
<span class="fc" id="L330">    	final ItemCollection items = new ItemCollection();</span>
<span class="fc" id="L331">    	items.addFromQuestStateString(NEEDED_ITEMS);</span>
<span class="fc bfc" id="L332" title="All 2 branches covered.">    	for (final Map.Entry&lt;String, Integer&gt; item : items.entrySet()) {</span>
<span class="fc" id="L333">    		npc.add(ConversationStates.QUESTION_2,</span>
    			item.getKey(),
    			new QuestActiveCondition(QUEST_SLOT),
    			ConversationStates.QUESTION_2,
    			null,
    			new CollectRequestedItemsAction(item.getKey(),
    				QUEST_SLOT,
    				&quot;Wonderful! Did you bring anything else with you?&quot;, &quot;I already have enough of those.&quot;,
    				completeAction,
    				ConversationStates.ATTENDING));
<span class="fc" id="L343">    	}</span>
<span class="fc" id="L344">    }</span>

	@Override
	public String getNPCName() {
<span class="nc" id="L348">		return &quot;Coralia&quot;;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>