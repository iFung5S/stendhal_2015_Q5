<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SheepGrowing.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.quests</a> &gt; <span class="el_source">SheepGrowing.java</span></div><h1>SheepGrowing.java</h1><pre class="source lang-java linenums">/***************************************************************************
 *                   (C) Copyright 2003-2011 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.maps.quests;

import games.stendhal.common.Level;
import games.stendhal.common.parser.Sentence;
import games.stendhal.server.core.rp.StendhalRPAction;
import games.stendhal.server.entity.Entity;
import games.stendhal.server.entity.creature.Sheep;
import games.stendhal.server.entity.npc.ChatAction;
import games.stendhal.server.entity.npc.ChatCondition;
import games.stendhal.server.entity.npc.ConversationPhrases;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.EventRaiser;
import games.stendhal.server.entity.npc.SpeakerNPC;
import games.stendhal.server.entity.npc.action.IncreaseKarmaAction;
import games.stendhal.server.entity.npc.action.MultipleActions;
import games.stendhal.server.entity.npc.action.SetQuestAction;
import games.stendhal.server.entity.npc.condition.AndCondition;
import games.stendhal.server.entity.npc.condition.NotCondition;
import games.stendhal.server.entity.npc.condition.QuestActiveCondition;
import games.stendhal.server.entity.npc.condition.QuestCompletedCondition;
import games.stendhal.server.entity.npc.condition.QuestInStateCondition;
import games.stendhal.server.entity.npc.condition.QuestNotInStateCondition;
import games.stendhal.server.entity.player.Player;
import games.stendhal.server.maps.Region;
import games.stendhal.server.maps.semos.city.SheepBuyerNPC.SheepBuyerSpeakerNPC;

import java.util.ArrayList;
import java.util.LinkedList;
import java.util.List;

/**
 * QUEST: Sheep Growing for Nishiya
 *
 * PARTICIPANTS:
 * &lt;ul&gt;
 * &lt;li&gt;Nishiya (the sheep seller in Semos village)&lt;/li&gt;
 * &lt;li&gt;Sato (the sheep buyer in Semos city)&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * STEPS:
 * &lt;ul&gt;
 * &lt;li&gt;Nishiya asks you to grow a sheep.&lt;/li&gt;
 * &lt;li&gt;Sheep grows to weight 100.&lt;/li&gt;
 * &lt;li&gt;Sheep is handed over to Sato.&lt;/li&gt;
 * &lt;li&gt;Nishiya thanks you.&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * REWARD:
 * &lt;ul&gt;
 * &lt;li&gt;Maximum of (XP to level 2) or (30XP)&lt;/li&gt;
 * &lt;li&gt;Karma: 10&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * REPETITIONS:
 * &lt;ul&gt;
 * &lt;li&gt;None&lt;/li&gt;
 * &lt;/ul&gt;
 */
<span class="nc" id="L70">public class SheepGrowing extends AbstractQuest {</span>

    private static final String QUEST_SLOT = &quot;sheep_growing&quot;;
    private static final String TITLE = &quot;Sheep Growing for Nishiya&quot;;
    private static final int MIN_XP_GAIN = 30;

    @Override
    public void addToWorld() {
<span class="nc" id="L78">        fillQuestInfo(</span>
                TITLE,
                &quot;Nishiya, the sheep seller, promised Sato a sheep. &quot; +
                    &quot;Because he is very busy he needs somebody to take care of &quot; +
                    &quot;one of his sheep and hand it over to Sato.&quot;,
                true);
<span class="nc" id="L84">        generalInformationDialogs();</span>
<span class="nc" id="L85">        preparePlayerGetsSheepStep();</span>
<span class="nc" id="L86">        preparePlayerHandsOverSheepStep();</span>
<span class="nc" id="L87">        preparePlayerReturnsStep();</span>
<span class="nc" id="L88">    }</span>

    @Override
    public String getSlotName() {
<span class="nc" id="L92">        return QUEST_SLOT;</span>
    }

    @Override
    public List&lt;String&gt; getHistory(final Player player) {
<span class="nc" id="L97">        final List&lt;String&gt; res = new LinkedList&lt;String&gt;();</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (!player.hasQuest(QUEST_SLOT)) {</span>
<span class="nc" id="L99">            return res;</span>
        }
<span class="nc" id="L101">        res.add(&quot;Nishiya asked me if I could raise a sheep for him.&quot;);</span>

<span class="nc" id="L103">        final String questState = player.getQuest(QUEST_SLOT);</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (questState.equals(&quot;rejected&quot;)) {</span>
<span class="nc" id="L105">            res.add(&quot;I told Nishiya that I have to do other things now... maybe I have time for the task later.&quot;);</span>
        }
<span class="nc bnc" id="L107" title="All 2 branches missed.">        if (player.isQuestInState(QUEST_SLOT, &quot;start&quot;, &quot;handed_over&quot;, &quot;done&quot;)) {</span>
<span class="nc" id="L108">            res.add(&quot;I promised to take care of one of his sheep.&quot;);</span>
        }
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (player.isQuestInState(QUEST_SLOT, &quot;handed_over&quot;, &quot;done&quot;)) {</span>
<span class="nc" id="L111">            res.add(&quot;I handed over the grown sheep to Sato. I should return to Nishiya now.&quot;);</span>
        }
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if(questState.equals(&quot;done&quot;)) {</span>
<span class="nc" id="L114">            res.add(&quot;I returned to Nishiya. He was very happy I helped him.&quot;);</span>
        }
<span class="nc" id="L116">        return res;</span>
    }

    @Override
    public String getName() {
<span class="nc" id="L121">        return TITLE;</span>
    }

    /**
     * General information for the player related to the quest.
     */
    private void generalInformationDialogs() {
<span class="nc" id="L128">        final SpeakerNPC npc = npcs.get(&quot;Nishiya&quot;);</span>

<span class="nc" id="L130">        npc.add(ConversationStates.ATTENDING, &quot;Sato&quot;, null, ConversationStates.ATTENDING, &quot;Sato is the sheep buyer of Semos city. &quot; +</span>
                &quot;You will find him if you follow the path to the east.&quot;, null);
<span class="nc" id="L132">        npc.add(ConversationStates.QUEST_OFFERED, &quot;Sato&quot;, null, ConversationStates.QUEST_OFFERED, &quot;Sato is the sheep buyer of Semos city. &quot; +</span>
                &quot;You will find him if you follow the path to the east.&quot;, null);

<span class="nc" id="L135">        List&lt;String&gt; berryStrings = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L136">        berryStrings.add(&quot;red berries&quot;);</span>
<span class="nc" id="L137">        berryStrings.add(&quot;berries&quot;);</span>
<span class="nc" id="L138">        berryStrings.add(&quot;sheepfood&quot;);</span>
<span class="nc" id="L139">        berryStrings.add(&quot;sheep food&quot;);</span>
<span class="nc" id="L140">        npc.addReply(berryStrings, &quot;Sheep like to eat the red berries from the aeryberry bushes.&quot;);</span>

<span class="nc" id="L142">        npc.addReply(&quot;sheep&quot;, &quot;I sell fluffy sheep, it's my #job.&quot;);</span>
<span class="nc" id="L143">    }</span>
    /**
     * The step where the player speaks with Nishiya about quests and gets the sheep.
     */
    private void preparePlayerGetsSheepStep() {
<span class="nc" id="L148">        final SpeakerNPC npc = npcs.get(&quot;Nishiya&quot;);</span>

        // If quest is not done or started yet ask player for help (if he does not have a sheep already)
<span class="nc" id="L151">        ChatCondition playerHasNoSheep = new ChatCondition() {</span>
            @Override
			public boolean fire(Player player, Sentence sentence, Entity npc) {
<span class="nc bnc" id="L154" title="All 2 branches missed.">                return !player.hasSheep();</span>
            }
        };
<span class="nc" id="L157">        npc.add(</span>
                ConversationStates.ATTENDING,
                ConversationPhrases.QUEST_MESSAGES,
                new AndCondition(playerHasNoSheep,
                        new QuestNotInStateCondition(QUEST_SLOT, &quot;start&quot;),
                        new QuestNotInStateCondition(QUEST_SLOT, &quot;handed_over&quot;),
                        new QuestNotInStateCondition(QUEST_SLOT, &quot;done&quot;)),
                ConversationStates.QUEST_OFFERED,
                &quot;Lately I am very busy with all my sheep. &quot; +
                &quot;Would you be willing to take care of one of my sheep and hand it over to #Sato? &quot; +
                &quot;You only have to let it eat some red berries until it reaches a weight of &quot; + Sheep.MAX_WEIGHT + &quot;. &quot; +
                &quot;Would you do that?&quot;,
                new SetQuestAction(QUEST_SLOT, &quot;asked&quot;));

        // If quest is offered and player says no reject the quest
<span class="nc" id="L172">        npc.add(</span>
                ConversationStates.QUEST_OFFERED,
                ConversationPhrases.NO_MESSAGES,
                new AndCondition(playerHasNoSheep,
                        new QuestInStateCondition(QUEST_SLOT, &quot;asked&quot;)),
                ConversationStates.IDLE,
                &quot;Ok... then I have to work twice as hard these days...&quot;,
                new SetQuestAction(QUEST_SLOT, &quot;rejected&quot;));

        // If quest is still active but not handed over do not give an other sheep to the player
<span class="nc" id="L182">        npc.add(</span>
                ConversationStates.ATTENDING,
                ConversationPhrases.QUEST_MESSAGES,
                new AndCondition(
                    new QuestActiveCondition(QUEST_SLOT),
                    new NotCondition(new QuestInStateCondition(QUEST_SLOT, &quot;asked&quot;)),
                    new NotCondition(new QuestInStateCondition(QUEST_SLOT, &quot;handed_over&quot;))),
                ConversationStates.ATTENDING,
                &quot;I already gave you one of my sheep. &quot; +
                &quot;If you left it on its own I can sell you a new one. Just say #buy #sheep.&quot;,
                null);

        // If quest is offered and player says yes, give a sheep to him.
<span class="nc" id="L195">        List&lt;ChatAction&gt; sheepActions = new LinkedList&lt;ChatAction&gt;();</span>
<span class="nc" id="L196">        sheepActions.add(new SetQuestAction(QUEST_SLOT, &quot;start&quot;));</span>
<span class="nc" id="L197">        sheepActions.add(new ChatAction() {</span>
            @Override
			public void fire(Player player, Sentence sentence, EventRaiser npc) {
<span class="nc" id="L200">                final Sheep sheep = new Sheep(player);</span>
<span class="nc" id="L201">                StendhalRPAction.placeat(npc.getZone(), sheep, npc.getX(), npc.getY() + 1);</span>
<span class="nc" id="L202">            }</span>
        });
<span class="nc" id="L204">        npc.add(</span>
                ConversationStates.QUEST_OFFERED,
                ConversationPhrases.YES_MESSAGES,
                new AndCondition(playerHasNoSheep,
                        new QuestInStateCondition(QUEST_SLOT, &quot;asked&quot;)),
                ConversationStates.IDLE,
                &quot;Thanks! *smiles* Here is your fluffy fosterling. Be careful with her. &quot; +
                &quot;If she dies or if you leave her behind you have to buy the next sheep on your own. &quot; +
                &quot;Oh... and don't accidentally sell the sheep to Sato. Just talk to him when the sheep has grown up.&quot;,
                new MultipleActions(sheepActions));
<span class="nc" id="L214">    }</span>
    /**
     * The step where the player goes to Sato to give him the grown up sheep.
     */
    private void preparePlayerHandsOverSheepStep() {
        // Remove action
<span class="nc" id="L220">        final List&lt;ChatAction&gt; removeSheepAction = new LinkedList&lt;ChatAction&gt;();</span>
<span class="nc" id="L221">        removeSheepAction.add(new ChatAction() {</span>
            @Override
			public void fire(Player player, Sentence sentence, EventRaiser npc) {
                // remove sheep
<span class="nc" id="L225">                final Sheep sheep = player.getSheep();</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">                if(sheep != null) {</span>
<span class="nc" id="L227">                    player.removeSheep(sheep);</span>
<span class="nc" id="L228">                    player.notifyWorldAboutChanges();</span>
<span class="nc bnc" id="L229" title="All 2 branches missed.">                    if(npc.getEntity() instanceof SheepBuyerSpeakerNPC) {</span>
<span class="nc" id="L230">                        ((SheepBuyerSpeakerNPC)npc.getEntity()).moveSheep(sheep);</span>
                    } else {
                        // only to prevent that an error occurs and the sheep does not disappear
<span class="nc" id="L233">                        sheep.getZone().remove(sheep);</span>
                    }
                } else {
                    // should not happen
<span class="nc" id="L237">                    npc.say(&quot;What? What sheep? Did I miss something?&quot;);</span>
<span class="nc" id="L238">                    npc.setCurrentState(ConversationStates.IDLE);</span>
<span class="nc" id="L239">                    return;</span>
                }
<span class="nc" id="L241">            }</span>
        });
<span class="nc" id="L243">        removeSheepAction.add(new SetQuestAction(QUEST_SLOT, &quot;handed_over&quot;));</span>

        // Hand-Over condition
<span class="nc" id="L246">        ChatCondition playerHasFullWeightSheep = new ChatCondition() {</span>
            @Override
			public boolean fire(Player player, Sentence sentence, Entity npc) {
<span class="nc bnc" id="L249" title="All 4 branches missed.">                return player.hasSheep()</span>
                    &amp;&amp; player.getSheep().getWeight() &gt;= Sheep.MAX_WEIGHT;
            }
        };

        // Sato asks for sheep
<span class="nc" id="L255">        final SpeakerNPC npc = npcs.get(&quot;Sato&quot;);</span>
<span class="nc" id="L256">        npc.add(</span>
                ConversationStates.IDLE,
                ConversationPhrases.GREETING_MESSAGES,
                new AndCondition(
                        new QuestInStateCondition(QUEST_SLOT,&quot;start&quot;),
                        playerHasFullWeightSheep),
                ConversationStates.QUEST_ITEM_BROUGHT,
                &quot;Hello. What a nice and healthy sheep is following you there! Is that one for me?&quot;,
                null);

<span class="nc" id="L266">        npc.add(</span>
                ConversationStates.IDLE,
                ConversationPhrases.GREETING_MESSAGES,
                new AndCondition(
                        new QuestInStateCondition(QUEST_SLOT,&quot;start&quot;),
                        new NotCondition(playerHasFullWeightSheep)),
                ConversationStates.IDLE,
                &quot;Hello. You should have a sheep from Nishiya for me, he owes me one! But I want a full weight one, so come back when you have one. Bye!&quot;,
                null);

        // Player answers yes - Sheep is given to Sato
<span class="nc" id="L277">        npc.add(</span>
                ConversationStates.QUEST_ITEM_BROUGHT,
                ConversationPhrases.YES_MESSAGES,
                new AndCondition(
                        new QuestInStateCondition(QUEST_SLOT,&quot;start&quot;),
                        playerHasFullWeightSheep),
                ConversationStates.IDLE,
                &quot;I knew it! It is Nishiya's, right? I was already waiting for it. &quot; +
                &quot;It is a gift for a friend of mine and it would be a shame if I had no birthday present. &quot; +
                &quot;Give thanks to Nishiya.&quot;,
                new MultipleActions(removeSheepAction));

        // Player answers no - Sheep stays at player
<span class="nc" id="L290">        npc.add(</span>
                ConversationStates.QUEST_ITEM_BROUGHT,
                ConversationPhrases.NO_MESSAGES,
                new AndCondition(
                        new QuestInStateCondition(QUEST_SLOT,&quot;start&quot;),
                        playerHasFullWeightSheep),
                ConversationStates.IDLE,
                &quot;He wanted to send me one a while ago...&quot;,
                null);
        

<span class="nc" id="L301">		npc.add(</span>
				ConversationStates.ATTENDING, 
				ConversationPhrases.QUEST_MESSAGES,
						new QuestInStateCondition(QUEST_SLOT, &quot;handed_over&quot;),
				ConversationStates.ATTENDING, 
				&quot;Thank you for bringing me Nishiyas sheep! My friend was really happy about it.&quot;, null);
<span class="nc" id="L307">    }</span>

    /**
     * The step where the player returns to Nishiya to get his reward.
     */
    private void preparePlayerReturnsStep() {
<span class="nc" id="L313">        final List&lt;ChatAction&gt; reward = new LinkedList&lt;ChatAction&gt;();</span>
<span class="nc" id="L314">        reward.add(new ChatAction() {</span>
            @Override
			public void fire(Player player, Sentence sentence, EventRaiser npc) {
                // give XP to level 2
<span class="nc" id="L318">                int reward = Level.getXP( 2 ) - player.getXP();</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">                if(reward &gt; MIN_XP_GAIN) {</span>
<span class="nc" id="L320">                    player.addXP(reward);</span>
                } else {
<span class="nc" id="L322">                    player.addXP(MIN_XP_GAIN);</span>
                }
<span class="nc" id="L324">                player.notifyWorldAboutChanges();</span>
<span class="nc" id="L325">            }</span>
        });
<span class="nc" id="L327">        reward.add(new SetQuestAction(QUEST_SLOT, &quot;done&quot;));</span>
<span class="nc" id="L328">        reward.add(new IncreaseKarmaAction( 10 ));</span>

<span class="nc" id="L330">        final SpeakerNPC npc = npcs.get(&quot;Nishiya&quot;);</span>
        // Asks player if he handed over the sheep
<span class="nc" id="L332">        npc.add(</span>
                ConversationStates.IDLE,
                ConversationPhrases.GREETING_MESSAGES,
                new QuestInStateCondition(QUEST_SLOT, &quot;handed_over&quot;),
                ConversationStates.QUEST_ITEM_QUESTION,
                &quot;Did you already give the sheep to Sato?&quot;,
                null);
        // Player answers yes - give reward
<span class="nc" id="L340">        npc.add(</span>
                ConversationStates.QUEST_ITEM_QUESTION,
                ConversationPhrases.YES_MESSAGES,
                new QuestInStateCondition(QUEST_SLOT, &quot;handed_over&quot;),
                ConversationStates.IDLE,
                &quot;Thank you! You don't know how much I have to do these days. &quot; +
                &quot;You really helped me out.&quot;,
                new MultipleActions(reward));
        // Player answers no -
<span class="nc" id="L349">        npc.add(</span>
                ConversationStates.QUEST_ITEM_QUESTION,
                ConversationPhrases.NO_MESSAGES,
                new QuestInStateCondition(QUEST_SLOT, &quot;handed_over&quot;),
                ConversationStates.IDLE,
                &quot;Well... ok. But don't forget it. Sato needs the sheep very soon.&quot;,
                null);

        // Player asks for quest after solving the quest
<span class="nc" id="L358">        npc.add(ConversationStates.ATTENDING,</span>
                ConversationPhrases.QUEST_MESSAGES,
                new QuestCompletedCondition(QUEST_SLOT),
                ConversationStates.ATTENDING,
                &quot;Sorry. I have nothing to do for you at the moment. But thank you again for your help.&quot;,
                null);
<span class="nc" id="L364">    }</span>

    @Override
    public String getRegion() {
<span class="nc" id="L368">        return Region.SEMOS_CITY;</span>
    }

	@Override
	public String getNPCName() {
<span class="nc" id="L373">		return &quot;Nishiya&quot;;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>