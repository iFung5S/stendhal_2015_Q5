<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AthorFerry.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.athor.ship</a> &gt; <span class="el_source">AthorFerry.java</span></div><h1>AthorFerry.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.maps.athor.ship;

import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.core.events.TurnListener;
import games.stendhal.server.util.TimeUtil;

import java.util.LinkedList;
import java.util.List;

/**
 * This class simulates a ferry going back and forth between the mainland and
 * the island. Note that, even though this class lies in a maps package, this is
 * not a zone configurator.
 * 
 * NPCs that have to do with the ferry:
 * &lt;li&gt; Eliza - brings players from the mainland docks to the ferry.
 * &lt;li&gt;Jessica - brings players from the island docks to the ferry.
 * &lt;li&gt;Jackie - brings players from the ferry to the docks. Captain - the ship
 * captain.
 * &lt;li&gt;Laura - the ship galley maid.
 * &lt;li&gt;Ramon - offers blackjack on the ship.
 * 
 * @see games.stendhal.server.maps.athor.ship.CaptainNPC
 * @author daniel
 * 
 */
public final class AthorFerry implements TurnListener {

	/** How much it costs to board the ferry. */
	public static final int PRICE = 25;
	
	/** The Singleton instance. */
	private static AthorFerry instance;
	
	private Status current;

	

	

	/**
	 * A list of non-player characters that get notice when the ferry arrives or
	 * departs, so that they can react accordingly, e.g. inform nearby players.
	 */
	private final List&lt;IFerryListener&gt; listeners;

	

<span class="fc" id="L61">	private AthorFerry() {</span>
<span class="fc" id="L62">		listeners = new LinkedList&lt;IFerryListener&gt;();</span>
<span class="fc" id="L63">		current = Status.ANCHORED_AT_MAINLAND;</span>
<span class="fc" id="L64">	}</span>

	/**
	 * @return The Singleton instance.
	 */
	public static AthorFerry get() {
<span class="fc bfc" id="L70" title="All 2 branches covered.">		if (instance == null) {</span>
<span class="fc" id="L71">			instance = new AthorFerry();</span>

			// initiate the turn notification cycle
<span class="fc" id="L74">			SingletonRepository.getTurnNotifier().notifyInSeconds(1, instance);</span>

		}
<span class="fc" id="L77">		return instance;</span>
	}

	public Status getState() {
<span class="nc" id="L81">		return current;</span>
	}
	
	/**
	 * Gets a textual description of the ferry's status.
	 *
	 * @return A String representation of time remaining till next state.
	 */

	private String getRemainingSeconds() {
<span class="nc" id="L91">		final int secondsUntilNextState = SingletonRepository.getTurnNotifier()</span>
				.getRemainingSeconds(this);
<span class="nc" id="L93">		return TimeUtil.approxTimeUntil(secondsUntilNextState);</span>
	}

	/**
	 * Is called when the ferry has either arrived at or departed from a harbor.
	 * @param currentTurn the turn when this listener is called
	 */
	@Override
	public void onTurnReached(final int currentTurn) {
		// cycle to the next state

<span class="fc" id="L104">		current = current.next();</span>
<span class="fc bfc" id="L105" title="All 2 branches covered.">		for (final IFerryListener npc : listeners) {</span>
<span class="fc" id="L106">			npc.onNewFerryState(current);</span>
<span class="fc" id="L107">		}</span>
<span class="fc" id="L108">		SingletonRepository.getTurnNotifier().notifyInSeconds(current.duration(), this);</span>
<span class="fc" id="L109">	}</span>

	public void addListener(final IFerryListener npc) {
<span class="fc" id="L112">		listeners.add(npc);</span>
<span class="fc" id="L113">	}</span>
	
	/**
	 * Auto registers the listener to Athorferry.
	 * deregistration must be implemented if it is used for short living objects
	 * @author astridemma
	 *
	 */
	public abstract static class FerryListener implements IFerryListener {
<span class="fc" id="L122">		public FerryListener() {</span>
<span class="fc" id="L123">			SingletonRepository.getAthorFerry().addListener(this);</span>
<span class="fc" id="L124">		}</span>

		
	}

	public interface IFerryListener {
		void onNewFerryState(Status current);
	}

<span class="pc" id="L133">	public enum Status {</span>
<span class="fc" id="L134">		ANCHORED_AT_MAINLAND {</span>
			@Override
			Status next() {
<span class="fc" id="L137">				return DRIVING_TO_ISLAND;</span>
			}

			@Override
			int duration() {
<span class="nc" id="L142">				return 2 * 60;</span>
			}

			@Override
			public String toString() {
<span class="nc" id="L147">				return &quot;The ferry is currently anchored at the mainland. It will take off in &quot;</span>
						+ SingletonRepository.getAthorFerry().getRemainingSeconds() + &quot;.&quot;;
			}
		},
<span class="fc" id="L151">		DRIVING_TO_ISLAND {</span>
			@Override
			Status next() {
<span class="nc" id="L154">				return ANCHORED_AT_ISLAND;</span>
			}

			@Override
			int duration() {
<span class="fc" id="L159">				return 5 * 60;</span>
			}

			@Override
			public String toString() {
<span class="nc" id="L164">				return &quot;The ferry is currently sailing to the island. It will arrive in &quot;</span>
						+ SingletonRepository.getAthorFerry().getRemainingSeconds() + &quot;.&quot;;
			}

		},
<span class="fc" id="L169">		ANCHORED_AT_ISLAND {</span>
			@Override
			Status next() {
<span class="nc" id="L172">				return DRIVING_TO_MAINLAND;</span>
			}

			@Override
			int duration() {
<span class="nc" id="L177">				return 2 * 60;</span>
			}

			@Override
			public String toString() {
<span class="nc" id="L182">				return &quot;The ferry is currently anchored at the island. It will take off in &quot;</span>
						+ SingletonRepository.getAthorFerry().getRemainingSeconds() + &quot;.&quot;;
			}

		},
<span class="fc" id="L187">		DRIVING_TO_MAINLAND {</span>
			@Override
			Status next() {
<span class="nc" id="L190">				return ANCHORED_AT_MAINLAND;</span>
			}

			@Override
			int duration() {
<span class="nc" id="L195">				return 5 * 60;</span>
			}

			@Override
			public String toString() {
<span class="nc" id="L200">				return &quot;The ferry is currently sailing to the mainland. It will arrive in &quot;</span>
						+ SingletonRepository.getAthorFerry().getRemainingSeconds() + &quot;.&quot;;
			}

		};

		/**
		 * gives the following status.
		 * @return the next Status
		 */
		abstract Status next();

		/**
		 * how long will this state last.
		 * @return time in seconds;
		 */
		abstract int duration();
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>