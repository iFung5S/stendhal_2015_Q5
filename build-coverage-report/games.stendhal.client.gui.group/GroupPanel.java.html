<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>GroupPanel.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.client.gui.group</a> &gt; <span class="el_source">GroupPanel.java</span></div><h1>GroupPanel.java</h1><pre class="source lang-java linenums">/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.client.gui.group;

import games.stendhal.client.actions.SlashActionRepository;
import games.stendhal.client.entity.IEntity;
import games.stendhal.client.entity.Player;
import games.stendhal.client.entity.User;
import games.stendhal.client.gui.MousePopupAdapter;
import games.stendhal.client.gui.j2DClient;
import games.stendhal.client.gui.chatlog.HeaderLessEventLine;
import games.stendhal.client.gui.layout.SBoxLayout;
import games.stendhal.client.gui.layout.SLayout;
import games.stendhal.client.sprite.DataLoader;
import games.stendhal.common.NotificationType;

import java.awt.Component;
import java.awt.Insets;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.ComponentAdapter;
import java.awt.event.ComponentEvent;
import java.awt.event.MouseEvent;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.swing.BorderFactory;
import javax.swing.ImageIcon;
import javax.swing.JButton;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.JMenuItem;
import javax.swing.JPopupMenu;
import javax.swing.JTabbedPane;

import org.apache.log4j.Logger;

/**
 * A component for showing the information about the adventurer group the user
 * belongs to.
 */
class GroupPanel {
<span class="nc" id="L54">	private static final Logger logger = Logger.getLogger(GroupPanel.class);</span>
	/**
	 * The amount of pixels that popup menus will be shifted up and left from
	 * the clicking point.
	 */
	private static final int POPUP_OFFSET = 5;
	/**
	 * Width of the indenting of the member list compared to the other text 
	 * in the panel.
	 */
	private static final int LIST_INDENT = 5;
	/** Tooltip for inviting members for a new group */
	private static final String START_GROUP_TOOLTIP = &quot;Start a new group&quot;;
	/** Tooptip for inviting members to an existing group */
	private static final String INVITE_TOOLTIP = &quot;Invite a new member&quot;;
	/** Image used for the group message button */
<span class="nc" id="L70">	private static final ImageIcon MESSAGE_ICON = new ImageIcon(DataLoader.getResource(&quot;data/gui/chat.png&quot;));</span>
	/** Image used for the invite button */
<span class="nc" id="L72">	private static final ImageIcon INVITE_ICON = new ImageIcon(DataLoader.getResource(&quot;data/gui/buddy_online.png&quot;));</span>
	/** Image used for the leave group button */
<span class="nc" id="L74">	private static final ImageIcon LEAVE_ICON = new ImageIcon(DataLoader.getResource(&quot;data/gui/buddy_offline.png&quot;));</span>
	
	/** The main containing component. */
	private final JComponent pane;
	/**
	 * Text component showing general information about the group, like the
	 * loot mode or that the user does not belong to a group.
	 */
	private final JLabel header;
	/** Label showing the text &quot;Members:&quot;, if the user belongs to a group */
	private final JLabel memberLabel;
	/** Model of the member list. */
	private final MemberListModel memberList;
	/** Component part of the member list. */
	private final JList&lt;Member&gt; memberListComponent;
	/** Button for leaving the group. */
	private final JButton leaveGroupButton;
	/** Button for sending a group message. */
	private final JButton messageButton;
	/** Button for inviting new members or starting a group */
	private final JButton inviteButton;
	
	// Invite handling
	/** Currently active invites */
<span class="nc" id="L98">	private final Map&lt;String, JComponent&gt; invites = new HashMap&lt;String, JComponent&gt;();</span>
	private final JComponent inviteContainer;
	
	/** A flag for detecting if the component has been shown before */
<span class="nc" id="L102">	private boolean initialized = false;</span>
	
	/**
	 * Create a new GroupPanel.
	 */
<span class="nc" id="L107">	GroupPanel() {</span>
<span class="nc" id="L108">		pane = SBoxLayout.createContainer(SBoxLayout.VERTICAL, SBoxLayout.COMMON_PADDING);</span>
<span class="nc" id="L109">		header = new JLabel();</span>
<span class="nc" id="L110">		header.addMouseListener(new HeaderMouseListener());</span>
<span class="nc" id="L111">		pane.add(header);</span>
		// Request group status the first time the component is shown (when the
		// user switches to the group tab)
<span class="nc" id="L114">		pane.addComponentListener(new ComponentAdapter() {</span>
			@Override
			public void componentShown(ComponentEvent e) {
<span class="nc bnc" id="L117" title="All 2 branches missed.">				if (!initialized) {</span>
<span class="nc" id="L118">					String[] args = { &quot;status&quot; };</span>
<span class="nc" id="L119">					SlashActionRepository.get(&quot;group&quot;).execute(args, &quot;&quot;);</span>
<span class="nc" id="L120">					initialized = true;</span>
				}
				// Needed only once
<span class="nc" id="L123">				pane.removeComponentListener(this);</span>
<span class="nc" id="L124">			}</span>
		});
		
		// The optionally shown member label
<span class="nc" id="L128">		memberLabel = new JLabel(&quot;Members:&quot;);</span>
<span class="nc" id="L129">		pane.add(memberLabel);</span>
<span class="nc" id="L130">		memberLabel.setVisible(false);</span>
		
<span class="nc" id="L132">		memberList = new MemberListModel();</span>
<span class="nc" id="L133">		memberListComponent = new JList&lt;Member&gt;(memberList);</span>
<span class="nc" id="L134">		memberListComponent.setFocusable(false);</span>
<span class="nc" id="L135">		memberListComponent.setCellRenderer(new MemberCellRenderer());</span>
<span class="nc" id="L136">		memberListComponent.setOpaque(false);</span>
<span class="nc" id="L137">		memberListComponent.addMouseListener(new MemberListMouseListener());</span>
<span class="nc" id="L138">		memberListComponent.addComponentListener(new ComponentAdapter() {</span>
			@Override
			public void componentResized(ComponentEvent e) {
<span class="nc bnc" id="L141" title="All 2 branches missed.">				for (Member member : memberList){</span>
					// A fuzzy number that is hopefully good enough
<span class="nc" id="L143">					member.setMaxHPRepresentation(memberListComponent.getWidth() - 4);</span>
<span class="nc" id="L144">				}</span>
<span class="nc" id="L145">			}</span>
		});
		/*
		 * JList is too dumb to set its preferred width correctly. Using expand
		 * + borders as a workaround. Unfortunately that prevents the unused
		 * space being squeezed out if the panel is too narrow.
		 */
<span class="nc" id="L152">		memberListComponent.setBorder(BorderFactory.createEmptyBorder(0, LIST_INDENT, 0, LIST_INDENT));</span>
<span class="nc" id="L153">		pane.add(memberListComponent, SLayout.EXPAND_X);</span>
		
		// Add a place for the invitation buttons. It will usually be invisible 
<span class="nc" id="L156">		inviteContainer = SBoxLayout.createContainer(SBoxLayout.VERTICAL, SBoxLayout.COMMON_PADDING);</span>
<span class="nc" id="L157">		inviteContainer.setAlignmentX(Component.CENTER_ALIGNMENT);</span>
<span class="nc" id="L158">		pane.add(inviteContainer);</span>
		
		// Bottom row action buttons
<span class="nc" id="L161">		SBoxLayout.addSpring(pane);</span>
<span class="nc" id="L162">		JComponent buttonBox = SBoxLayout.createContainer(SBoxLayout.HORIZONTAL);</span>
<span class="nc" id="L163">		buttonBox.setAlignmentX(Component.RIGHT_ALIGNMENT);</span>
<span class="nc" id="L164">		pane.add(buttonBox);</span>
<span class="nc" id="L165">		SBoxLayout.addSpring(buttonBox);</span>
<span class="nc" id="L166">		messageButton = new JButton(MESSAGE_ICON);</span>
<span class="nc" id="L167">		messageButton.setEnabled(false);</span>
<span class="nc" id="L168">		messageButton.addActionListener(new ActionListener() {</span>
			@Override
			public void actionPerformed(ActionEvent e) {
<span class="nc" id="L171">				j2DClient.get().setChatLine(&quot;/p &quot;);</span>
<span class="nc" id="L172">			}</span>
		});
<span class="nc" id="L174">		messageButton.setFocusable(false);</span>
<span class="nc" id="L175">		messageButton.setToolTipText(&quot;Send a message to all group members&quot;);</span>
<span class="nc" id="L176">		buttonBox.add(messageButton);</span>
		
<span class="nc" id="L178">		inviteButton = new JButton(INVITE_ICON);</span>
<span class="nc" id="L179">		inviteButton.setFocusable(false);</span>
<span class="nc" id="L180">		inviteButton.setToolTipText(START_GROUP_TOOLTIP);</span>
<span class="nc" id="L181">		inviteButton.addActionListener(new InviteActionListener());</span>
<span class="nc" id="L182">		buttonBox.add(inviteButton);</span>
		
<span class="nc" id="L184">		leaveGroupButton = new JButton(LEAVE_ICON);</span>
<span class="nc" id="L185">		leaveGroupButton.setEnabled(false);</span>
<span class="nc" id="L186">		leaveGroupButton.addActionListener(new LeaveActionListener());</span>
<span class="nc" id="L187">		leaveGroupButton.setFocusable(false);</span>
<span class="nc" id="L188">		leaveGroupButton.setToolTipText(&quot;Resign from the group&quot;);</span>
<span class="nc" id="L189">		buttonBox.add(leaveGroupButton);</span>
		
		// We have no space to waste in the panel
<span class="nc" id="L192">		Insets oldMargin = messageButton.getMargin();</span>
<span class="nc" id="L193">		Insets margin = new Insets(oldMargin.top, 1, oldMargin.bottom, 1); </span>
<span class="nc" id="L194">		messageButton.setMargin(margin);</span>
<span class="nc" id="L195">		inviteButton.setMargin(margin);</span>
<span class="nc" id="L196">		leaveGroupButton.setMargin(margin);</span>
<span class="nc" id="L197">	}</span>
	
	/**
	 * Get the group panel component.
	 * 
	 * @return group information display component
	 */
	JComponent getComponent() {
<span class="nc" id="L205">		return pane;</span>
	}
	
	/**
	 * Set the header text.
	 * 
	 * @param text header contents
	 */
	void showHeader(String text) {
<span class="nc" id="L214">		header.setText(text);</span>
<span class="nc" id="L215">	}</span>
	
	/**
	 * Set the member list.
	 * 
	 * @param members list of members
	 */
	void setMembers(List&lt;String&gt; members) {
<span class="nc" id="L223">		memberList.setMembers(members);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">		boolean isInAGroup = members != null;</span>
<span class="nc" id="L225">		memberLabel.setVisible(isInAGroup);</span>
<span class="nc" id="L226">		leaveGroupButton.setEnabled(isInAGroup);</span>
<span class="nc" id="L227">		messageButton.setEnabled(isInAGroup);</span>
		// Disable for now if the user is in a group, and enable it again
		// if she is the group leader
<span class="nc bnc" id="L230" title="All 2 branches missed.">		inviteButton.setEnabled(!isInAGroup);</span>
<span class="nc bnc" id="L231" title="All 2 branches missed.">		if (!isInAGroup) {</span>
<span class="nc" id="L232">			inviteButton.setToolTipText(START_GROUP_TOOLTIP);</span>
		}
		// Enable any still valid invites at leaving a group
<span class="nc bnc" id="L235" title="All 2 branches missed.">		if (!isInAGroup) {</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">			for (JComponent button : invites.values()) {</span>
<span class="nc" id="L237">				button.setEnabled(true);</span>
<span class="nc" id="L238">			}</span>
		}
<span class="nc" id="L240">	}</span>
	
	/**
	 * Set the current leader of the group.
	 * 
	 * @param name leader name
	 */
	void setLeader(String name) {
<span class="nc" id="L248">		memberList.setLeader(name);</span>
		
<span class="nc bnc" id="L250" title="All 2 branches missed.">		if (name.equals(User.getCharacterName())) {</span>
<span class="nc" id="L251">			inviteButton.setEnabled(true);</span>
<span class="nc" id="L252">			inviteButton.setToolTipText(INVITE_TOOLTIP);</span>
		}
		// The same invite will not work more than once
<span class="nc" id="L255">		expireInvite(name);</span>
		// The others are still valid, but can not be used while a member of a
		// group
<span class="nc bnc" id="L258" title="All 2 branches missed.">		for (JComponent button : invites.values()) {</span>
<span class="nc" id="L259">			button.setEnabled(false);</span>
<span class="nc" id="L260">		}</span>
		/*
		 * If the user was already in a group at login time, she may get a group
		 * message before switching to the group tab. Suppress the initial
		 * status request in that case.
		 */
<span class="nc" id="L266">		initialized = true;</span>
<span class="nc" id="L267">	}</span>
	
	/**
	 * Add a join button for an invite, and switch to the group tab.
	 * 
	 * @param name group name
	 */
	void receiveInvite(final String name) {
<span class="nc" id="L275">		Component parent = pane.getParent();</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">		if (parent instanceof JTabbedPane) {</span>
<span class="nc" id="L277">			((JTabbedPane) parent).setSelectedComponent(pane);</span>
		}
<span class="nc bnc" id="L279" title="All 2 branches missed.">		if (invites.containsKey(name)) {</span>
<span class="nc" id="L280">			return;</span>
		}
<span class="nc" id="L282">		JButton joinButton = new JButton(&quot;Join &quot; + name);</span>
<span class="nc" id="L283">		joinButton.setToolTipText(&quot;Join the group led by &quot; + name);</span>
<span class="nc" id="L284">		joinButton.addActionListener(new ActionListener() {</span>
			@Override
			public void actionPerformed(ActionEvent e) {
<span class="nc" id="L287">				String[] args = { &quot;join&quot; };</span>
<span class="nc" id="L288">				SlashActionRepository.get(&quot;group&quot;).execute(args, name);</span>
<span class="nc" id="L289">			}</span>
		});
<span class="nc" id="L291">		invites.put(name, joinButton);</span>
<span class="nc" id="L292">		joinButton.setAlignmentX(Component.CENTER_ALIGNMENT);</span>
<span class="nc" id="L293">		inviteContainer.add(joinButton, SLayout.EXPAND_X);</span>
<span class="nc" id="L294">		inviteContainer.revalidate();</span>
<span class="nc" id="L295">	}</span>
	
	/**
	 * Remove the join button of an invite.
	 * 
	 * @param name group name
	 */
	void expireInvite(final String name) {
<span class="nc" id="L303">		JComponent button = invites.get(name);</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">		if (button != null) {</span>
<span class="nc" id="L305">			inviteContainer.remove(button);</span>
<span class="nc" id="L306">			inviteContainer.revalidate();</span>
		}
<span class="nc" id="L308">		invites.remove(name);</span>
<span class="nc" id="L309">	}</span>
	
	/**
	 * Called, when a player is added to the zone. The player is not necessarily
	 * a member of the group.
	 * 
	 * @param player added player
	 * @return &lt;code&gt;true&lt;/code&gt; if the added player was is member,
	 * 	&lt;code&gt;false&lt;/code&gt; otherwise. 
	 */
	boolean addPlayer(Player player) {
<span class="nc" id="L320">		Member member = memberList.getMember(player.getName());</span>
		
<span class="nc bnc" id="L322" title="All 2 branches missed.">		if (member != null) {</span>
<span class="nc" id="L323">			member.setHpRatio(player.getHpRatio());</span>
<span class="nc" id="L324">			member.setPresent(true);</span>
			/*
			 * Add last to avoid a spurious change event when setting the HP
			 * ratio. We must always trigger one manually at the end anyway to
			 * account for the presence change. 
			 */
<span class="nc" id="L330">			player.addChangeListener(new MemberHealthListener(member));</span>
<span class="nc" id="L331">			memberList.memberChanged(member);</span>
<span class="nc" id="L332">			return true;</span>
		}
		
<span class="nc" id="L335">		return false;</span>
	}
	
	/**
	 * Called for new members that are present at the zone.
	 * 
	 * @param players list of players on the zone
	 */
	void addPlayers(List&lt;Player&gt; players) {
<span class="nc bnc" id="L344" title="All 2 branches missed.">		for (Player player : players) {</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">			if (!addPlayer(player)) {</span>
<span class="nc" id="L346">				logger.error(&quot;Added player is not a member even though she should be. Player: &quot; + player.getName(), new Throwable());</span>
			}
<span class="nc" id="L348">		}</span>
<span class="nc" id="L349">	}</span>
	
	/**
	 * Called, when a player is removed from the zone. The player is not
	 * necessarily a member of the group.
	 * 
	 * @param player removed player
	 */
	void removePlayer(IEntity player) {
<span class="nc" id="L358">		Member member = memberList.getMember(player.getName());</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">		if (member != null) {</span>
<span class="nc" id="L360">			member.setPresent(false);</span>
<span class="nc" id="L361">			memberList.memberChanged(member);</span>
		}
<span class="nc" id="L363">	}</span>
	
	/**
	 * Listener for clicking the leave group button.
	 */
<span class="nc" id="L368">	private static class LeaveActionListener implements ActionListener {</span>
		@Override
		public void actionPerformed(ActionEvent arg0) {
<span class="nc" id="L371">			String[] args = { &quot;part&quot; };</span>
<span class="nc" id="L372">			SlashActionRepository.get(&quot;group&quot;).execute(args, &quot;&quot;);</span>
<span class="nc" id="L373">		}</span>
	}
	
	/**
	 * Listener for clicking the invite button
	 */
<span class="nc" id="L379">	private static class InviteActionListener implements ActionListener {</span>
		@Override
		public void actionPerformed(ActionEvent e) {
<span class="nc" id="L382">			j2DClient.get().setChatLine(&quot;/group invite &quot;);</span>
<span class="nc" id="L383">			j2DClient.get().addEventLine(new HeaderLessEventLine(&quot;Fill in the name of the player you want to invite&quot;, NotificationType.CLIENT));</span>
<span class="nc" id="L384">		}</span>
	}
	
	/**
	 * Listener for changing the loot mode.
	 */
	private static class LootmodeActionListener implements ActionListener {
		private final String mode;
		
		/**
		 * Create a LootmodeActionListener for changing to a specified mode.
		 * 
		 * @param mode new loot mode
		 */
<span class="nc" id="L398">		LootmodeActionListener(String mode) {</span>
<span class="nc" id="L399">			this.mode = mode;</span>
<span class="nc" id="L400">		}</span>
		
		@Override
		public void actionPerformed(ActionEvent e) {
<span class="nc" id="L404">			String[] args = { &quot;lootmode&quot; };</span>
<span class="nc" id="L405">			SlashActionRepository.get(&quot;group&quot;).execute(args, mode);</span>
<span class="nc" id="L406">		}</span>
	}
	
<span class="nc" id="L409">	private class HeaderMouseListener extends MousePopupAdapter {</span>
		@Override
		protected void showPopup(MouseEvent e) {
<span class="nc" id="L412">			Member me = memberList.getMember(User.getCharacterName());</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">			if (!me.isLeader()) {</span>
				// Only the leader should have the loot mode menu
<span class="nc" id="L415">				return;</span>
			}
<span class="nc" id="L417">			JPopupMenu popup = new JPopupMenu();</span>
<span class="nc" id="L418">			JMenuItem item = new JMenuItem(&quot;Shared&quot;);</span>
<span class="nc" id="L419">			item.addActionListener(new LootmodeActionListener(&quot;shared&quot;));</span>
<span class="nc" id="L420">			popup.add(item);</span>
			
<span class="nc" id="L422">			item = new JMenuItem(&quot;Single&quot;);</span>
<span class="nc" id="L423">			item.addActionListener(new LootmodeActionListener(&quot;single&quot;));</span>
<span class="nc" id="L424">			popup.add(item);</span>
			
<span class="nc" id="L426">			popup.show(header, e.getX() - POPUP_OFFSET, e.getY() - POPUP_OFFSET);</span>
<span class="nc" id="L427">		}</span>
	}
	
<span class="nc" id="L430">	private class MemberListMouseListener extends MousePopupAdapter {</span>
		@Override
		protected void showPopup(final MouseEvent e) {
<span class="nc" id="L433">			int index = memberListComponent.locationToIndex(e.getPoint());</span>
<span class="nc" id="L434">			Member member = memberListComponent.getModel().getElementAt(index);</span>

<span class="nc" id="L436">			Member me = memberList.getMember(User.getCharacterName());</span>
			// Show leader operations only if the user is the leader, and
			// only for the other members
<span class="nc bnc" id="L439" title="All 4 branches missed.">			boolean showLeaderOps = me.isLeader() &amp;&amp; (member != me);</span>
<span class="nc" id="L440">			final JPopupMenu popup = new MemberPopupMenu(member.getName(), showLeaderOps);</span>
<span class="nc" id="L441">			popup.show(memberListComponent, e.getX() - POPUP_OFFSET, e.getY() - POPUP_OFFSET);</span>
<span class="nc" id="L442">		}</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>