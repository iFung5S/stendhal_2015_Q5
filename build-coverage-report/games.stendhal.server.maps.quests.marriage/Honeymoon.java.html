<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>Honeymoon.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">stendhal</a> &gt; <a href="index.source.html" class="el_package">games.stendhal.server.maps.quests.marriage</a> &gt; <span class="el_source">Honeymoon.java</span></div><h1>Honeymoon.java</h1><pre class="source lang-java linenums">/* $Id$ */
/***************************************************************************
 *                   (C) Copyright 2003-2010 - Stendhal                    *
 ***************************************************************************
 ***************************************************************************
 *                                                                         *
 *   This program is free software; you can redistribute it and/or modify  *
 *   it under the terms of the GNU General Public License as published by  *
 *   the Free Software Foundation; either version 2 of the License, or     *
 *   (at your option) any later version.                                   *
 *                                                                         *
 ***************************************************************************/
package games.stendhal.server.maps.quests.marriage;

import games.stendhal.common.Direction;
import games.stendhal.common.NotificationType;
import games.stendhal.common.parser.ExpressionType;
import games.stendhal.common.parser.JokerExprMatcher;
import games.stendhal.common.parser.Sentence;
import games.stendhal.server.core.engine.SingletonRepository;
import games.stendhal.server.core.engine.StendhalRPZone;
import games.stendhal.server.entity.item.StackableItem;
import games.stendhal.server.entity.npc.ChatAction;
import games.stendhal.server.entity.npc.ConversationStates;
import games.stendhal.server.entity.npc.EventRaiser;
import games.stendhal.server.entity.npc.NPCList;
import games.stendhal.server.entity.npc.SpeakerNPC;
import games.stendhal.server.entity.npc.condition.TextHasNumberCondition;
import games.stendhal.server.entity.player.Player;
import games.stendhal.server.util.Area;

import java.awt.Rectangle;

class Honeymoon {
<span class="fc" id="L35">	private final NPCList npcs = SingletonRepository.getNPCList();</span>
	private MarriageQuestInfo marriage;

<span class="fc" id="L38">	public Honeymoon(final MarriageQuestInfo marriage) {</span>
<span class="fc" id="L39">		this.marriage = marriage;</span>
<span class="fc" id="L40">	}</span>

	private void honeymoonStep() {
<span class="fc" id="L43">		final SpeakerNPC linda = npcs.get(&quot;Linda&quot;);</span>
		// tell her you want a honeymoon
<span class="fc" id="L45">		linda.add(</span>
				ConversationStates.ATTENDING,
				&quot;honeymoon&quot;,
				null,
				ConversationStates.QUESTION_1, null,
<span class="fc" id="L50">				new ChatAction() {</span>
						@Override
						public void fire(final Player player, final Sentence sentence, final EventRaiser npc) {
<span class="fc" id="L53">                        final StendhalRPZone fadoHotel = npc.getZone();</span>
<span class="fc" id="L54">                        final Area hotelReception = new Area(fadoHotel, new Rectangle(11, 46, 19, 10));</span>

                        Player husband;
                        Player wife;
                        String partnerName;
<span class="fc" id="L59">                        husband = player;</span>
<span class="fc" id="L60">                        partnerName = husband.getQuest(marriage.getSpouseQuestSlot());</span>
<span class="fc" id="L61">                        wife = SingletonRepository.getRuleProcessor().getPlayer(partnerName);</span>
                        
<span class="pc bpc" id="L63" title="2 of 4 branches missed.">						if (!(player.hasQuest(marriage.getQuestSlot())) || !(&quot;just_married&quot;.equals(player.getQuest(marriage.getQuestSlot())))) {</span>
							// person is not just married
<span class="nc" id="L65">							npc.say(&quot;Sorry, our honeymoon suites are only available for just married customers.&quot;);</span>
<span class="nc" id="L66">							npc.setCurrentState(ConversationStates.ATTENDING);						</span>
<span class="pc bpc" id="L67" title="1 of 2 branches missed.">						} else if (wife == null) { </span>
							//wife is not online
<span class="nc" id="L69">                            npc.say(&quot;Come back when &quot; + partnerName + &quot; is with you - you're meant to have your honeymoon together!&quot;);</span>
<span class="nc" id="L70">                            npc.setCurrentState(ConversationStates.IDLE);</span>
<span class="pc bpc" id="L71" title="2 of 4 branches missed.">                        } else if (!(wife.hasQuest(marriage.getQuestSlot())</span>
                                     &amp;&amp; wife.getQuest(marriage.getSpouseQuestSlot()).equals(husband.getName()))) {
                        	//wife is not married to this husband
<span class="nc" id="L74">                            npc.say(&quot;Oh dear, this is embarassing. You seem to be married, but &quot; + partnerName + &quot; is not married to you.&quot;);</span>
<span class="nc" id="L75">                            npc.setCurrentState(ConversationStates.ATTENDING);</span>
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">                        } else if (!hotelReception.contains(wife)) {</span>
                        	//  wife has not bothered to come to reception desk
<span class="fc" id="L78">                            npc.say(&quot;Could you get &quot; + partnerName + &quot; to come to the reception desk, please. Then please read our catalogue here and tell me the room number that you would like.&quot;);</span>
                        }  else { 
                        	//wife and husband fulfill all conditions
<span class="nc" id="L81">							npc.say(&quot;How lovely! Please read our catalogue here and tell me the room number that you would like.&quot;);</span>
						}
<span class="fc" id="L83">					}</span>
				});
		// player says room number
<span class="fc" id="L86">		linda.addMatching(ConversationStates.QUESTION_1,</span>
				// match for all numbers as trigger expression
				ExpressionType.NUMERAL, new JokerExprMatcher(),
				new TextHasNumberCondition(1, 15),
				ConversationStates.IDLE, null,
<span class="fc" id="L91">				new ChatAction() {</span>
					@Override
					public void fire(final Player player, final Sentence sentence, final EventRaiser npc) {

<span class="fc" id="L95">                        final String room = Integer.toString(sentence.getNumeral().getAmount());</span>
<span class="fc" id="L96">                        final StendhalRPZone zone = SingletonRepository.getRPWorld().getZone(</span>
                                                                                       &quot;int_fado_lovers_room_&quot; + room);
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">						if (zone.getPlayers().size() &gt; 0) {</span>
<span class="nc" id="L99">							npc.say(&quot;Sorry, that room is currently occupied, would you give me your next choice please?&quot;);</span>
<span class="nc" id="L100">							npc.setCurrentState(ConversationStates.QUESTION_1);</span>
						} else {

							Player husband;
							Player wife;
							String partnerName;
<span class="fc" id="L106">							husband = player;</span>
<span class="fc" id="L107">							partnerName = husband.getQuest(marriage.getSpouseQuestSlot());</span>
<span class="fc" id="L108">							wife = SingletonRepository.getRuleProcessor().getPlayer(</span>
                                                                                partnerName);
<span class="fc" id="L110">							final StackableItem invite1 = (StackableItem) SingletonRepository.getEntityManager().getItem(</span>
																												  &quot;invitation scroll&quot;);
<span class="fc" id="L112">							invite1.setQuantity(1);</span>
<span class="fc" id="L113">                            final StackableItem invite2 = (StackableItem) SingletonRepository.getEntityManager().getItem(</span>
                                                                                                                  &quot;invitation scroll&quot;);
<span class="fc" id="L115">                            invite2.setQuantity(1);</span>
                            // 
<span class="fc" id="L117">							invite1.setInfoString(&quot;honeymoon,&quot; + partnerName);</span>
<span class="fc" id="L118">							invite2.setInfoString(&quot;honeymoon,&quot; + husband.getTitle());</span>
<span class="pc bpc" id="L119" title="2 of 4 branches missed.">							if (wife.equipToInventoryOnly(invite1) &amp;&amp;  husband.equipToInventoryOnly(invite2)) {</span>
<span class="fc" id="L120">								npc.say(&quot;Great choice! I will arrange that now.&quot;); </span>
<span class="fc" id="L121">								husband.setQuest(marriage.getQuestSlot(), &quot;done&quot;);</span>
<span class="fc" id="L122">								wife.setQuest(marriage.getQuestSlot(), &quot;done&quot;);</span>
<span class="fc" id="L123">								wife.teleport(zone, 5, 5, Direction.DOWN, player);</span>
<span class="fc" id="L124">								husband.teleport(zone, 6, 5, Direction.DOWN, player);</span>
								final String scrollmessage = &quot;Linda tells you: Use the scroll in your bag to return to the hotel, our special honeymoon suites are so private that they don't use normal entrances and exits!&quot;;
<span class="fc" id="L126">								wife.sendPrivateText(NotificationType.PRIVMSG, scrollmessage);</span>
<span class="fc" id="L127">                                husband.sendPrivateText(NotificationType.PRIVMSG, scrollmessage);</span>
<span class="fc" id="L128">								wife.notifyWorldAboutChanges();</span>
<span class="fc" id="L129">								husband.notifyWorldAboutChanges();</span>
<span class="fc" id="L130">								npc.setCurrentState(ConversationStates.IDLE);</span>
							} else {
<span class="nc" id="L132">								npc.say(&quot;You each need one space in your bags to take a scroll. Please make a space and then ask me again. Thank you.&quot;);</span>
							}
						}
<span class="fc" id="L135">					}</span>
				});

		// player says something which isn't a room number
//		npc.add(ConversationStates.QUESTION_1, &quot;&quot;,
//			new SpeakerNPC.ChatCondition() {
//				@Override public boolean fire(Player player, Sentence sentence, SpeakerNPC npc) {
//					return !ROOMS.contains(text);
//				}
//			}, ConversationStates.QUESTION_1,
//			&quot;Sorry, that's not a room number we have available.&quot;, null
//		);

<span class="fc" id="L148">	}</span>

	public void addToWorld() {
<span class="fc" id="L151">		honeymoonStep();</span>
<span class="fc" id="L152">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>